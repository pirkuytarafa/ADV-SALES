<!DOCTYPE html>
<html lang="id" class="dark">
<head>

<!--
=====================================================
INDEX FINAL – CLEAN & PRODUKSI
- Dark Mode theme-aware (Tailwind)
- Tidak ada inline background:#fff
- Tidak ada CSS !important pemaksa warna
- PO Release: cursor & hover biru
- Arsip PO: modal mengikuti Light/Dark mode
=====================================================
-->


<script>
  tailwind.config = { darkMode: 'class' }
</script>
<style>
:root{--adv-blue:#0B3A6F;--adv-blue-light:#0E63B6;--adv-green:#39B54A;--adv-green-dark:#1E7F3F;--adv-gold:#F5B301;--adv-gold-dark:#C98A00;--bg-main:#F8FAFC;--bg-card:#FFFFFF;--bg-soft:#F1F5F9;--text-main:#0F172A;--text-muted:#64748B;--border-soft:#E2E8F0}
html.dark{--bg-main:#071423;--bg-card:#0B1F36;--bg-soft:#0F2A47;--text-main:#E5EDFF;--text-muted:#9FB3D1;--border-soft:#1E3A5F}
body{background:var(--bg-main);color:var(--text-main)}
.card{background:var(--bg-card);border:1px solid var(--border-soft);border-radius:.9rem}
.text-main{color:var(--text-main)}.text-muted{color:var(--text-muted)}
.sidebar{background:linear-gradient(180deg,var(--adv-blue),#06182B);color:#E5EDFF}
.sidebar .nav-link{color:#CFE0FF}
.sidebar .nav-link.active{background:linear-gradient(135deg,var(--adv-green),var(--adv-green-dark));color:#fff}
</style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanta Sales App</title>

    <!-- PWA Manifest & Theme -->
    <meta name="theme-color" content="#2563EB"/>
    <link rel="manifest" id="manifest">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231D4ED8'/%3E%3Ctext x='50' y='68' font-size='50' fill='white' text-anchor='middle' font-family='sans-serif' font-weight='bold'%3EA%3C/text%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- SheetJS for Excel import -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
<!-- jsPDF & jsPDF-AutoTable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }

        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        /* === Sidebar collapse / expand (desktop & mobile) === */
        body.sidebar-collapsed #sidebar {
            transform: translateX(-100%) !important;
        }

        @media (min-width: 768px) {
            body #main-content {
                margin-left: 16rem;
            }
            body.sidebar-collapsed #main-content {
                margin-left: 0 !important;
            }
        }

        @media (max-width: 767px) {
            body #main-content {
                margin-left: 0 !important;
            }
        }

        .modal, .toast { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .details-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        
        /* Presentation Page Dropdowns - Ensure clickable */
        #presentation-page select {
            cursor: pointer;
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            appearance: menulist;
        }
        #presentation-page select:hover {
            background-color: #f9fafb;
        }
        #presentation-page select:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* === SLIDESHOW PRESENTATION STYLES === */
        .presentation-slideshow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 10000;
            display: none;
        }
        
        .presentation-slideshow.active {
            display: block;
        }
        
        .slide-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            padding: 3rem;
            box-sizing: border-box;
            overflow-y: auto;
            pointer-events: none;
        }
        
        .slide.active {
            opacity: 1 !important;
            z-index: 1;
            pointer-events: auto;
        }
        
        .slide-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .slide-bg-sales-dashboard .slide-content,
        .slide-bg-dga-dashboard .slide-content,
        .slide-bg-stock-dashboard .slide-content,
        .slide-bg-plan-dashboard .slide-content,
        .slide-bg-compare-fy .slide-content,
        .slide-bg-growth-dashboard .slide-content,
        .slide-bg-gradient-5 .slide-content {
            justify-content: flex-start;
        }
        .slide-bg-sales-dashboard,
        .slide-bg-dga-dashboard,
        .slide-bg-stock-dashboard,
        .slide-bg-plan-dashboard,
        .slide-bg-compare-fy,
        .slide-bg-growth-dashboard {
            padding: 1.5rem !important;
        }
        
        /* Slide Controls */
        .slide-controls {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 50px;
            display: flex;
            gap: 1rem;
            align-items: center;
            z-index: 10001;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .slide-controls.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .slide-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .slide-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }
        
        .slide-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .slide-counter {
            color: white;
            font-weight: 600;
            font-size: 1rem;
            min-width: 80px;
            text-align: center;
        }
        
        .slide-progress {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
            z-index: 10002;
        }
        
        .exit-slideshow {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(239, 68, 68, 0.8);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            z-index: 10001;
            transition: all 0.3s ease;
        }
        
        .exit-slideshow:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.05);
        }
        
        /* Slide Backgrounds */
        .slide-bg-gradient-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .slide-bg-gradient-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .slide-bg-gradient-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .slide-bg-gradient-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .slide-bg-gradient-5 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .slide-bg-gradient-6 {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }
        
        .slide-bg-dark {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%);
        }
        
        .slide-bg-advanta {
            background: linear-gradient(135deg, #003366 0%, #0a1628 60%, #001a33 100%);
            position: relative;
            overflow: hidden;
        }
        .slide-bg-advanta::before {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(16,185,129,0.15) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
        }
        .slide-bg-advanta::after {
            content: '';
            position: absolute;
            bottom: -80px;
            left: -80px;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59,130,246,0.12) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
        }
        .slide-bg-advanta .slide-content { position: relative; z-index: 1; }
        
        .slide-bg-sales-dashboard {
            background: linear-gradient(160deg, #0f172a 0%, #1e293b 40%, #0f172a 100%);
        }
        
        .slide-bg-dga-dashboard {
            background: linear-gradient(160deg, #0c1221 0%, #1a1f3d 50%, #0d1424 100%);
        }
        
        .slide-bg-stock-dashboard {
            background: linear-gradient(160deg, #041e21 0%, #0b2c3e 50%, #051f22 100%);
        }
        
        .slide-bg-plan-dashboard {
            background: linear-gradient(160deg, #1a0a2e 0%, #2d1b4e 50%, #1a0a2e 100%);
        }
        
        .slide-bg-compare-fy {
            background: linear-gradient(160deg, #1e0a0a 0%, #2d1b1b 40%, #0f172a 100%);
        }
        
        .slide-bg-growth-dashboard {
            background: linear-gradient(160deg, #0a1e0a 0%, #1b2d1b 50%, #0f1a0f 100%);
        }
        
        /* Dashboard Slide Components */
        .slide-dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid rgba(255,255,255,0.15);
        }
        .slide-dashboard-header h2 {
            font-size: 1.8rem;
            margin: 0;
        }
        .slide-dashboard-header .slide-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            opacity: 0.7;
            color: white;
            font-weight: 700;
        }
        .slide-kpi-grid {
            display: grid;
            gap: 0.75rem;
        }
        .slide-kpi-card {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }
        .slide-kpi-card:hover { transform: scale(1.02); }
        .slide-kpi-card .kpi-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255,255,255,0.65);
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .slide-kpi-card .kpi-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: white;
            line-height: 1.2;
        }
        .slide-kpi-card .kpi-sub {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
            margin-top: 0.15rem;
        }
        .slide-table-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .slide-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.9);
        }
        .slide-table thead th {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255,255,255,0.7);
        }
        .slide-table tbody td {
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .slide-table tbody tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .slide-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        .slide-badge-green { background: rgba(16,185,129,0.2); color: #34d399; }
        .slide-badge-red { background: rgba(239,68,68,0.2); color: #f87171; }
        .slide-badge-blue { background: rgba(59,130,246,0.2); color: #93c5fd; }
        .slide-badge-yellow { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .slide-chart-panel {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .slide-progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 9999px;
            overflow: hidden;
        }
        .slide-progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 1s ease;
        }
        .slide-footer {
            position: absolute;
            bottom: 1.5rem;
            left: 3rem;
            right: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.5rem;
        }
        
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-count-up {
            animation: countUp 0.6s ease-out forwards;
            opacity: 0;
        }
        
        /* Slide Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes floatAnimation {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .slide.slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        .slide.slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        .slide.fade-in-scale {
            animation: fadeInScale 0.6s ease-out;
        }
        
        /* Slideshow Settings Modal */
        .slideshow-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 11000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .slideshow-settings-modal.active {
            display: flex;
        }
        
        .settings-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-title {
            font-size: 2rem;
            font-weight: 800;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .slide-checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .slide-checkbox-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .slide-checkbox-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .slide-checkbox-item.selected {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
        }
        
        .slide-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 0.75rem;
        }
        
        .slide-checkbox-label {
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .slide-checkbox-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            margin-left: 2rem;
        }
        
        .settings-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        .settings-btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
        }
        
        .settings-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
        }
        
        .settings-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .settings-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Thumbnail Navigation */
        .thumbnail-nav {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .thumbnail-nav.visible {
            opacity: 1;
        }
        
        .thumbnail-item {
            width: 80px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .thumbnail-item:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .thumbnail-item.active {
            border: 3px solid #8b5cf6;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
        }
        
        .thumbnail-number {
            position: absolute;
            bottom: 2px;
            right: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 4px;
        }
        
        /* Timer Display */
        .slide-timer {
            position: fixed;
            top: 2rem;
            left: 2rem;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .timer-icon {
            width: 24px;
            height: 24px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* Slide Typography */
        .slide h1 {
            color: white;
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            animation: fadeInScale 0.8s ease-out;
        }
        
        .slide h2 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            animation: fadeInScale 0.8s ease-out 0.2s both;
        }
        
        .slide h3 {
            color: white;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 6px rgba(0, 0, 0, 0.3);
        }
        
        .slide p, .slide li {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.3rem;
            line-height: 1.8;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.2);
        }
        
        .slide .metric-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 0.5rem;
        }
        
        .slide .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
        }
        
        .slide .metric-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .slide-chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .slide {
                padding: 2rem 1.5rem;
            }
            .slide h1 {
                font-size: 2.5rem;
            }
            .slide h2 {
                font-size: 2rem;
            }
            .slide h3 {
                font-size: 1.5rem;
            }
            .slide p, .slide li {
                font-size: 1.1rem;
            }
        }
        
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; }
        .toast {
            display: flex; align-items: center; padding: 1rem 1.5rem; margin-bottom: 1rem;
            border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            opacity: 0; transform: translateX(100%);
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #ECFDF5; color: #065F46; border: 1px solid #A7F3D0; }
        .toast-error { background-color: #FEF2F2; color: #991B1B; border: 1px solid #FECACA; }
        .toast-info { background-color: #EFF6FF; color: #1E40AF; border: 1px solid #BFDBFE; }
        
        #nav-menu .nav-link {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
        }
        #nav-menu .nav-link span {
            text-align: left;
        }

        .nav-link.active { background-color: #EFF6FF; color: #1D4ED8; font-weight: 600; }
        .nav-link.active svg { color: #1D4ED8; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Batch Input Table Styles */
        #batch-input-table input[type="number"] {
            -moz-appearance: textfield;
            transition: all 0.2s ease;
        }
        #batch-input-table input[type="number"]::-webkit-outer-spin-button,
        #batch-input-table input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #batch-input-table input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        #batch-input-table .fm-input:focus { 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        #batch-input-table .odp-input:focus { 
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.25);
        }
        #batch-input-table .ft-input:focus { 
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.25);
        }
        #batch-input-table .ffd-input:focus { 
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.25);
        }
        #batch-input-table .display-input:focus { 
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.25);
        }
        
        /* Plan PO Table Styles */
        #plan-po-table {
            border-collapse: collapse;
        }
        #plan-po-table thead th {
            background-color: #0B3A6F;
            color: white;
            font-weight: 600;
        }
        #plan-po-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        html.dark #plan-po-table tbody tr:nth-child(even) {
            background-color: #1f2937;
        }
        #plan-po-table .plan-po-input {
            width: 100%;
            text-align: right;
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        #plan-po-table .plan-po-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        html.dark #plan-po-table .plan-po-input {
            background-color: #374151;
            border-color: #4b5563;
            color: white;
        }
        #plan-po-table .plan-po-total {
            background-color: #f0f9ff;
            font-weight: 600;
        }
        html.dark #plan-po-table .plan-po-total {
            background-color: #1e3a5f;
        }
        
        /* Shimmer Animation */
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .animate-shimmer {
            animation: shimmer 3s infinite;
        }
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Smooth Modal Transitions */
        #batch-input-modal.hidden {
            pointer-events: none;
        }
        #batch-input-modal:not(.hidden) {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Row Hover Effects */
        #batch-input-tbody tr {
            transition: background-color 0.2s ease;
        }
        
        /* Force white text in dark mode for batch input fields */
        .dark .fm-input,
        .dark .odp-input,
        .dark .ft-input,
        .dark .ffd-input,
        .dark .display-input {
            color: white !important;
            -webkit-text-fill-color: white !important;
        }
        
        /* Override autocomplete styles */
        .dark .fm-input:-webkit-autofill,
        .dark .odp-input:-webkit-autofill,
        .dark .ft-input:-webkit-autofill,
        .dark .ffd-input:-webkit-autofill,
        .dark .display-input:-webkit-autofill {
            -webkit-text-fill-color: white !important;
            -webkit-box-shadow: 0 0 0px 1000px #1f2937 inset !important;
        }
    </style>

<!-- STRONG OVERRIDE FOR TABLET: placed near end to win specificity -->
<style>
/* Force apply on tablet sizes */
@media (min-width: 641px) and (max-width: 1024px) {
  /* target multiple possible classes and inline elements */
  #dashboard-stats .stat-value,
  #dashboard-stats .stat-value *,
  #dashboard-stats .value,
  #dashboard-stats .value *,
  #dashboard-stats .stat-number,
  #dashboard-stats .stat-number * ,
  .stat-card .value,
  .stat-card .stat-number,
  .stat-card .stat-value {
    white-space: nowrap !important;
    overflow: visible !important;
    text-overflow: clip !important;
    display: inline-block !important;
    transform-origin: left center !important;
    transform: scale(0.78) !important; /* stronger scale to fit */
    font-size: 1.6rem !important;
    line-height: 1 !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  /* Ensure currency symbol stays attached */
  #dashboard-stats .stat-value::before,
  #dashboard-stats .value::before {
    content: '' !important;
    white-space: nowrap !important;
  }

  /* Make card layout stable */
  #dashboard-stats .card,
  #dashboard-stats .stat-card {
    display: flex !important;
    align-items: center !important;
    justify-content: flex-start !important;
    min-height: 3.4rem !important;
    padding: 0.9rem !important;
  }
}

/* Force higher specificity fallback */
body #dashboard-stats .stat-value,
body #dashboard-stats .value,
body #dashboard-stats .stat-number {
  -webkit-font-smoothing: antialiased;
}
</style>


<style>
/* --- Horizontal stat cards: label left, value right, prevent overlap --- */
#dashboard-stats .stat-card, #dashboard-stats .card {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 0.75rem !important;
  padding: 1rem !important;
  min-height: 3.2rem !important;
  box-sizing: border-box !important;
}

#dashboard-stats .stat-card .stat-label,
#dashboard-stats .card .stat-label,
#dashboard-stats .stat-card small,
#dashboard-stats .card small {
  flex: 0 0 auto;
  margin: 0;
  padding: 0;
  color: inherit;
  opacity: 0.9;
  font-size: 0.95rem !important;
  white-space: nowrap !important;
}

#dashboard-stats .stat-card .stat-value,
#dashboard-stats .card .stat-value,
#dashboard-stats .stat-card .value,
#dashboard-stats .card .value,
#dashboard-stats .stat-number,
#dashboard-stats .card .stat-number {
  flex: 1 1 auto;
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
  margin: 0;
  padding: 0;
  line-height: 1 !important;
}

/* Ensure numeric value uses a scalable font-size baseline we can adjust with JS */
#dashboard-stats .stat-value > .__autosizeText,
#dashboard-stats .value > .__autosizeText,
#dashboard-stats .stat-number > .__autosizeText {
  display: inline-block;
  white-space: nowrap;
  line-height: 1;
  font-weight: 700;
}

/* Keep card titles above values on very narrow screens */
@media (max-width: 640px) {
  #dashboard-stats .stat-card, #dashboard-stats .card {
    flex-direction: column !important;
    align-items: flex-start !important;
  }
  #dashboard-stats .stat-card .stat-value,
  #dashboard-stats .card .stat-value {
    text-align: left;
    white-space: normal;
  }
}
</style>


<style>
/* STRONG FORCE: make stat cards horizontal and prevent value overlap */
#dashboard-stats, #dashboard-stats .stats-row { display:block !important; }
#dashboard-stats .stat-card, #dashboard-stats .card, .stat-card, .card {
  display:flex !important;
  flex-direction:row !important;
  align-items:center !important;
  justify-content:space-between !important;
  gap:0.75rem !important;
  padding:1rem !important;
  min-height:3.4rem !important;
  box-sizing:border-box !important;
  max-width:100% !important;
  overflow:visible !important;
}

/* Label area fixed width so value can take remaining space */
#dashboard-stats .stat-label, .stat-card .stat-label, .card .stat-label {
  flex:0 0 40% !important;
  min-width:120px !important;
  max-width:45% !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  padding-right:0.5rem !important;
}

/* Value area uses remaining space and aligns right */
#dashboard-stats .stat-value, .stat-card .value, .card .stat-value {
  flex:1 1 60% !important;
  min-width:0 !important;
  text-align:right !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  display:block !important;
}

/* Ensure inner autosize text exists and won't break layout */
#dashboard-stats .__autosizeText, .__autosizeText {
  display:inline-block !important;
  white-space:nowrap !important;
  line-height:1 !important;
}

/* On very small screens, fall back to column */
@media (max-width:640px){
  #dashboard-stats .stat-card, #dashboard-stats .card { flex-direction:column !important; align-items:flex-start !important; }
  #dashboard-stats .stat-label { width:100% !important; max-width:100% !important; }
  #dashboard-stats .stat-value { width:100% !important; text-align:left !important; white-space:normal !important; }
}

/* Highest specificity fallback */
body #dashboard-stats .stat-card, body #dashboard-stats .card { display:flex !important; }
</style>


<!-- FINAL: force horizontal stat cards on all devices and style value/label -->
<style>
/* Force horizontal layout for stat cards across all devices */
#dashboard-stats .stat-card, #dashboard-stats .card, .stat-card, .card {
  display:flex !important;
  flex-direction:row !important;
  align-items:center !important;
  justify-content:space-between !important;
  gap:0.75rem !important;
  padding:1rem !important;
  min-height:3.4rem !important;
  box-sizing:border-box !important;
  width:100% !important;
  overflow:visible !important;
}

/* Label fixed area (left) */
#dashboard-stats .stat-label, .stat-card .stat-label, .card .stat-label {
  flex:0 0 32% !important;
  min-width:140px !important;
  max-width:45% !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  padding-right:0.75rem !important;
  color: inherit;
  opacity: 0.9;
  font-size: 0.95rem !important;
}

/* Value area uses remaining space, right-aligned */
#dashboard-stats .stat-value, .stat-card .value, .card .stat-value, #dashboard-stats .stat-number {
  flex:1 1 68% !important;
  min-width:0 !important;
  text-align:right !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  display:block !important;
  margin:0 !important;
  padding:0 !important;
  line-height:1 !important;
}

/* Inner autosize span */
#dashboard-stats .__autosizeText, .__autosizeText {
  display:inline-block !important;
  white-space:nowrap !important;
  line-height:1 !important;
  font-weight:700;
  -webkit-font-smoothing:antialiased;
}

/* Mobile fallback: stack vertically on very small screens */
@media (max-width:480px) {
  #dashboard-stats .stat-card, #dashboard-stats .card { flex-direction:column !important; align-items:flex-start !important; }
  #dashboard-stats .stat-label { width:100% !important; max-width:100% !important; }
  #dashboard-stats .stat-value { width:100% !important; text-align:left !important; white-space:normal !important; }
}
</style>


<style>
/* === Dashboard Visual Optimization (tanpa mengubah fitur) === */

/* Ruang antar bagian di dashboard */
#dashboard-page {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
}

/* Kartu-kartu di dashboard dibuat lebih lembut dan konsisten */
#dashboard-page .bg-white {
    border-radius: 0.9rem;
    border: 1px solid #E5E7EB;
    box-shadow: 0 12px 30px -18px rgba(15, 23, 42, 0.25);
}

/* Stat cards bagian atas: lebih rapat dan rapi */
#dashboard-stats {
    gap: 1rem;
}

#dashboard-stats .stat-card,
#dashboard-stats .card {
    background: #ffffff;
    border-radius: 0.9rem !important;
    border: 1px solid #E5E7EB !important;
    box-shadow: 0 12px 30px -20px rgba(15, 23, 42, 0.25);
    padding: 0.9rem 1rem !important;
}

/* Label & angka pada stat card */
#dashboard-stats .stat-label,
#dashboard-stats small {
    font-size: 0.8rem !important;
    color: #6B7280 !important;
}

#dashboard-stats .stat-value,
#dashboard-stats .stat-number {
    font-size: 1.1rem !important;
    font-weight: 700 !important;
}

/* Heading di kartu dashboard */
#dashboard-page h3 {
    letter-spacing: 0.01em;
}

/* Sales chart card: beri tinggi yang enak & responsif */
#salesChart {
    max-height: 360px;
}

@media (max-width: 768px) {
    #salesChart {
        max-height: 260px;
    }
}

/* Donut distributor chart */
#distributorChart {
    max-height: 260px;
}

/* Target Bulanan card: batasi tinggi tabel agar tidak kepanjangan dan tetap rapi */
#dashboard-target-summary {
    max-height: 410px;
    display: flex;
    flex-direction: column;
}

#dashboard-target-summary #dashboard-target-table-wrapper {
    margin-top: 0.5rem;
    overflow-y: auto;
}

/* Scrollbar halus untuk tabel target */
#dashboard-target-summary #dashboard-target-table-wrapper::-webkit-scrollbar {
    width: 6px;
}
#dashboard-target-summary #dashboard-target-table-wrapper::-webkit-scrollbar-thumb {
    background: #D1D5DB;
    border-radius: 3px;
}

/* Grid bawah: di layar besar, komposisi lebih seimbang */
#dashboard-page > .grid.grid-cols-1.xl\:grid-cols-3 {
    align-items: flex-start;
}

/* Kartu ringkasan KG per varietas */
#variety-kg-summary h4,
#variety-kg-summary h3 {
    font-size: 0.9rem;
}

/* Sedikit ruang di bawah judul "Grafik Penjualan Bulanan" agar nafas */
#dashboard-page canvas {
    margin-top: 0.5rem;
}
</style>

<style>
/* === Dashboard layout adjust: stat box tegak + bagian bawah bertumpuk === */

/* Stat cards: label di atas, angka di bawah (tidak mendatar) */
#dashboard-stats .stat-card,
#dashboard-stats .card {
  flex-direction: column !important;
  align-items: flex-start !important;
  justify-content: center !important;
}

/* Label penuh 1 baris di atas */
#dashboard-stats .stat-card .stat-label,
#dashboard-stats .card .stat-label {
  flex: none !important;
  width: 100% !important;
  max-width: 100% !important;
  padding-right: 0 !important;
  margin-bottom: 0.15rem !important;
  text-align: left !important;
}

/* Angka di bawah, rata kiri */
#dashboard-stats .stat-card .stat-value,
#dashboard-stats .card .stat-value,
#dashboard-stats .stat-number {
  flex: none !important;
  width: 100% !important;
  text-align: left !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

/* Grid bawah (grafik, target, distributor, dll) dibuat bertumpuk, tidak samping-sampingan */
#dashboard-page > .grid.grid-cols-1.xl\:grid-cols-3 {
  display: block !important;
}

/* Setiap kartu di grid bawah full width dan ada jarak vertikal */
#dashboard-page > .grid.grid-cols-1.xl\:grid-cols-3 > div {
  width: 100% !important;
  margin-bottom: 1.25rem;
}

#dashboard-page > .grid.grid-cols-1.xl\:grid-cols-3 > div:last-child {
  margin-bottom: 0;
}
</style>

<style>
/* === Dashboard stats: 2 kolom, 2 baris, pakai box rapi === */

/* Grid stat atas: default 1 kolom (mobile), 2 kolom di tablet & desktop */
#dashboard-stats {
  display: grid !important;
  grid-template-columns: repeat(1, minmax(0, 1fr));
  gap: 0.9rem;
}

@media (min-width: 768px) {
  #dashboard-stats {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* Pastikan setiap stat card tampil sebagai box */
#dashboard-stats .stat-card,
#dashboard-stats .card {
  background: #ffffff;
  border-radius: 0.9rem !important;
  border: 1px solid #E5E7EB !important;
  box-shadow: 0 10px 25px -18px rgba(15, 23, 42, 0.3);
}

<style>
/* Insentif table polishing */
#insentif-content table thead th {
    position: sticky;
    top: 0;
    background-color: #F9FAFB;
    z-index: 1;
}
#insentif-content table tbody tr:hover {
    background-color: #EEF2FF;
}
#insentif-content td, #insentif-content th {
    border-bottom: 1px solid #E5E7EB;
}
</style>
</style>

<style id="advanta-dark-fix">
/* === GLOBAL FORCE OVERRIDES (ANTI BENTROK) === */
html.dark body,
html.dark .bg-white,
html.dark [class*="bg-white"] {
  background-color: var(--bg-card) !important;
}

html.dark .bg-gray-50,
html.dark .bg-gray-100,
html.dark .bg-slate-50 {
  background-color: var(--bg-main) !important;
}

html.dark .text-gray-800,
html.dark .text-gray-700,
html.dark .text-gray-900 {
  color: var(--text-main) !important;
}

html.dark .text-gray-500,
html.dark .text-gray-400,
html.dark .text-slate-500 {
  color: var(--text-muted) !important;
}

html.dark .border,
html.dark .border-gray-200,
html.dark .border-gray-300 {
  border-color: var(--border-soft) !important;
}

/* === SIDEBAR ALWAYS DARK (OPEN OR CLOSED) === */
#sidebar,
html.dark #sidebar {
  background: linear-gradient(180deg, var(--adv-blue), #06182B) !important;
  color: #E5EDFF !important;
}

#sidebar .nav-link,
html.dark #sidebar .nav-link {
  color: #CFE0FF !important;
}

#sidebar .nav-link.active,
html.dark #sidebar .nav-link.active {
  background: linear-gradient(135deg, var(--adv-green), var(--adv-green-dark)) !important;
  color: #FFFFFF !important;
}

/* Header & main content safe */
html.dark header,
html.dark main {
  background-color: var(--bg-main);
}
</style>


<style id="advanta-dropdown-fix">
/* === DROPDOWN FIX FOR DARK MODE === */
/* Native select dropdown (browser popup) */
html.dark select {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
}

html.dark select option {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
}

/* Custom dropdown / menu (div based) */
html.dark .dropdown-menu,
html.dark .select-menu,
html.dark [role="listbox"] {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
}

html.dark .dropdown-menu *,
html.dark .select-menu *,
html.dark [role="option"] {
  color: #0F172A !important;
}

/* Hover & active state */
html.dark .dropdown-menu li:hover,
html.dark [role="option"]:hover {
  background-color: #F1F5F9 !important;
}
</style>


<style id="advanta-input-fix">
/* === INPUT & TEXTAREA FIX (WHITE BG MUST BE BLACK TEXT) === */
html.dark input,
html.dark textarea {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
}

/* Placeholder darker for visibility */
html.dark input::placeholder,
html.dark textarea::placeholder {
  color: #6B7280 !important;
  opacity: 1;
}

/* Disabled / readonly */
html.dark input:disabled,
html.dark textarea:disabled,
html.dark input[readonly],
html.dark textarea[readonly] {
  background-color: #F1F5F9 !important;
  color: #475569 !important;
}

/* Focus state */
html.dark input:focus,
html.dark textarea:focus,
html.dark select:focus {
  outline: none;
  border-color: var(--adv-green) !important;
  box-shadow: 0 0 0 2px rgba(57,181,74,0.35) !important;
}
</style>


<script>
/* =========================================================
   ADVANTA – GLOBAL CHART THEME (UI v1.0 LOCKED)
   ========================================================= */
const ADVANTA = {
  blue: "#0B3A6F",
  blueLight: "#0E63B6",
  green: "#39B54A",
  greenDark: "#1E7F3F",
  gold: "#F5B301",
  goldDark: "#C98A00",
  red: "#E5484D",
  redDark: "#8C1D18",
};

const ADVANTA_SERIES = [
  ADVANTA.blueLight,
  ADVANTA.green,
  ADVANTA.gold,
  ADVANTA.blue,
  ADVANTA.greenDark,
  ADVANTA.goldDark,
];

const ADVANTA_CHART_OPTIONS = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      labels: {
        color: "#E5EDFF",
        font: { weight: "500" },
      },
    },
    tooltip: {
      backgroundColor: "#0B1F36",
      titleColor: "#FFFFFF",
      bodyColor: "#E5EDFF",
      borderColor: "rgba(255,255,255,0.15)",
      borderWidth: 1,
    },
  },
  scales: {
    x: {
      ticks: { color: "#9FB3D1" },
      grid: { color: "rgba(255,255,255,0.05)" },
    },
    y: {
      ticks: { color: "#9FB3D1" },
      grid: { color: "rgba(255,255,255,0.05)" },
    },
  },
};
</script>


<!-- ================= ADVANTA FINAL PATCH v3 (REAL STRUCTURE) ================= -->

<!-- ================= END ADVANTA FINAL PATCH v3 ================= -->


<!-- ================= ADVANTA FINAL v8 (THEME AWARE) ================= -->
<style id="advanta-po-real-fix-corrected">
/* Ikuti tema, jangan paksa warna */
html.dark table tr.bg-white {
  background-color: var(--bg-card) !important;
  color: var(--text-main) !important;
}
html.dark table tr.bg-gray-50 {
  background-color: var(--bg-main) !important;
  color: var(--text-main) !important;
}
html.dark table tr svg,
html.dark table tr a {
  color: inherit !important;
  fill: currentColor !important;
}
</style>


<!-- ================= ADVANTA FINAL v9 (PO RELEASE CURSOR BLUE) ================= -->
<style id="advanta-po-release-cursor-blue">
/* PO RELEASE – cursor & hover biru */

/* asumsi tabel PO Release */
#po-release-table tbody tr {
  cursor: pointer;
}

/* hover biru lembut */
#po-release-table tbody tr:hover {
  background-color: rgba(37, 99, 235, 0.12); /* blue */
}

/* teks ikut biru saat hover */
#po-release-table tbody tr:hover td {
  color: #2563eb; /* blue-600 */
}
</style>
<!-- ================= END ADVANTA FINAL v9 ================= -->


<!-- ================= ADVANTA FINAL v10 (PO RELEASE GOLD SUMMARY) ================= -->
<style id="advanta-po-release-gold">
/* PO RELEASE – kotak summary jadi GOLD agar teks jelas */

#po-release-table tr.bg-white,
#po-release-table tr.bg-white td {
  background-color: #E6B84C !important; /* gold */
  color: #1F2937 !important;            /* dark gray */
  font-weight: 600;
}

#po-release-table tr.bg-white svg,
#po-release-table tr.bg-white a {
  color: #1F2937 !important;
  fill: #1F2937 !important;
}

/* hover lebih gelap */
#po-release-table tr.bg-white:hover td {
  background-color: #D4A93A !important;
}
</style>
<!-- ================= END ADVANTA FINAL v10 ================= -->


<!-- ======================================================
     ADVANTA FINAL v11 – PO RELEASE VISIBILITY FIX
     ====================================================== -->
<style id="advanta-po-release-v11">

/* === PO RELEASE: SEARCH INPUT (DARK + GOLD) === */
#po-release-search input,
#po-release-search textarea,
#po-release-search select {
  background-color: #0F172A !important;
  color: #FFFFFF !important;
  border: 1px solid #E6B84C !important;
}
#po-release-search input::placeholder {
  color: #CBD5E1 !important;
}
#po-release-search input:focus {
  outline: none;
  border-color: #E6B84C !important;
  box-shadow: 0 0 0 2px rgba(230,184,76,0.45) !important;
}

/* === PO RELEASE: SUMMARY ROW GOLD === */
#po-release-table tr.bg-white,
#po-release-table tr.bg-white td {
  background-color: #E6B84C !important;
  color: #1F2937 !important;
  font-weight: 600;
}
#po-release-table tr.bg-white svg,
#po-release-table tr.bg-white a {
  color: #1F2937 !important;
  fill: #1F2937 !important;
}
#po-release-table tr.bg-white:hover td {
  background-color: #D4A93A !important;
}

/* === PO RELEASE: HOVER & CURSOR === */
#po-release-table tbody tr {
  cursor: pointer;
}
#po-release-table tbody tr:hover:not(.bg-white) {
  background-color: rgba(37, 99, 235, 0.12);
}
#po-release-table tbody tr:hover td {
  color: #2563EB;
}

</style>
<!-- ================= END ADVANTA FINAL v11 ================= -->


<!-- =====================================================
 ADVANTA UI v1.4.1 – JS LEVEL FIX (ANTI INLINE WHITE)
 TARGET: PO RELEASE
 ===================================================== -->

<style id="advanta-po-release-final-style">
/* final visual authority */
.po-release-row {
  background-color: #0B1F36 !important;
  color: #E5EDFF !important;
}
.po-release-row:hover {
  background-color: #1E3A5F !important;
}
.po-release-row.is-selected {
  background-color: #E6B84C !important;
  color: #1F2937 !important;
  font-weight: 600;
}
.po-release-row * {
  color: inherit !important;
  fill: currentColor !important;
}
</style>

<script>
/* =====================================================
   PO RELEASE INLINE STYLE KILLER (FINAL)
   ===================================================== */
(function(){
  function cleanRows(){
    const rows = document.querySelectorAll(
      '#po-release-content div, #po-release-content [style]'
    );
    rows.forEach(r => {
      if (r.style && r.style.background) {
        r.style.background = '';
      }
      if (r.style && r.style.backgroundColor) {
        r.style.backgroundColor = '';
      }
      if (!r.classList.contains('po-release-row')) {
        r.classList.add('po-release-row');
      }
    });
  }

  // initial run
  document.addEventListener('DOMContentLoaded', cleanRows);

  // observe future renders
  const target = document.getElementById('po-release-content');
  if (target) {
    const observer = new MutationObserver(() => {
      cleanRows();
    });
    observer.observe(target, { childList: true, subtree: true });
  }
})();
</script>

<!-- ================= END UI v1.4.1 ================= -->


<!-- ================= ADVANTA MARKET LIGHT/DARK LOCK v1.5 ================= -->
<style>
/* Scope halaman Market */
.market-size-page,
.indonesia-market-size-page,
.product-per-area-page {
  --text-dark: #0F172A;
  --text-muted-dark: #475569;
  --text-light: #E5E7EB;
}

/* LIGHT MODE */
html:not(.dark) .market-size-page,
html:not(.dark) .indonesia-market-size-page,
html:not(.dark) .product-per-area-page {
  color: var(--text-dark);
}

html:not(.dark) .market-size-page p,
html:not(.dark) .indonesia-market-size-page p,
html:not(.dark) .product-per-area-page p,
html:not(.dark) .market-size-page span,
html:not(.dark) .indonesia-market-size-page span,
html:not(.dark) .product-per-area-page span,
html:not(.dark) .market-size-page th,
html:not(.dark) .market-size-page td {
  color: var(--text-dark) !important;
}

/* DARK MODE */
html.dark .market-size-page,
html.dark .indonesia-market-size-page,
html.dark .product-per-area-page {
  color: var(--text-light);
}
</style>
<!-- ================= END MARKET FIX ================= -->


<!-- ================= PO RELEASE – DIV BASED GOLD & GREEN (FINAL v3) ================= -->
<style id="advanta-po-release-div-gold-green">
/* HARD SCOPE: PO RELEASE ONLY */
#po-release-content * {
  transition: color .15s ease, background-color .15s ease;
}

/* ROW DETECTION (DIV BASED) */
#po-release-content [role="row"],
#po-release-content .po-row,
#po-release-content .row,
#po-release-content > div {
  cursor: pointer;
}

/* DEFAULT TEXT */
#po-release-content [role="row"] *,
#po-release-content .po-row *,
#po-release-content .row * {
  color: var(--text-main) !important;
}

/* HOVER = GREEN */
#po-release-content [role="row"]:hover,
#po-release-content .po-row:hover,
#po-release-content .row:hover {
  background-color: rgba(57,181,74,0.15) !important;
}
#po-release-content [role="row"]:hover *,
#po-release-content .po-row:hover *,
#po-release-content .row:hover * {
  color: var(--adv-green) !important;
}

/* SELECTED = GOLD */
#po-release-content .is-selected,
#po-release-content .is-selected * {
  background-color: var(--adv-gold) !important;
  color: #1F2937 !important;
  font-weight: 600;
}

/* ICONS FOLLOW TEXT */
#po-release-content svg,
#po-release-content svg * {
  fill: currentColor !important;
}
</style>

<script>
/* CLICK HANDLER FOR DIV-BASED PO RELEASE */
(function(){
  document.addEventListener('click', function(e){
    const row = e.target.closest(
      '#po-release-content [role="row"], #po-release-content .po-row, #po-release-content .row, #po-release-content > div'
    );
    if(!row) return;
    document.querySelectorAll('#po-release-content .is-selected')
      .forEach(r=>r.classList.remove('is-selected'));
    row.classList.add('is-selected');
  });
})();
</script>
<!-- ================= END PO RELEASE DIV FINAL v3 ================= -->


<!-- PO RELEASE FINAL FIX -->
<style>
div:has(> #page-title) {
  --po-green: #2e7d32;
  --po-gold: #C9A24D;
}
div:has(> #page-title) [role="row"]:hover,
div:has(> #page-title) > div:hover {
  background-color: rgba(46,125,50,0.15) !important;
}
div:has(> #page-title) [role="row"]:hover * {
  color: var(--po-green) !important;
}
div:has(> #page-title) .is-selected,
div:has(> #page-title) .is-selected * {
  background-color: var(--po-gold) !important;
  color: #1f2937 !important;
  font-weight: 600;
}
div:has(> #page-title) .bg-white {
  background-color: transparent !important;
}
</style>


<style id="force-dark-only">
html { color-scheme: dark; }
html, body { background-color:#071423 !important; color:#E5EDFF !important; }
.bg-white,[class*="bg-white"],.bg-gray-50,.bg-gray-100,.bg-slate-50{background-color:#0B1F36 !important;}
.text-gray-900,.text-gray-800,.text-gray-700{color:#E5EDFF !important;}
.text-gray-500,.text-gray-400,.text-slate-500{color:#9FB3D1 !important;}
.border,.border-gray-200,.border-gray-300{border-color:#1E3A5F !important;}
#sidebar{background:linear-gradient(180deg,#0B3A6F,#06182B) !important;color:#E5EDFF !important;}
input,textarea,select{background-color:#FFFFFF !important;color:#0F172A !important;}
</style>


<style id="force-white-input-black-text">
input,
textarea,
select {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
}
input::placeholder,
textarea::placeholder {
  color: #475569 !important;
  opacity: 1 !important;
}
select option {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
}
input:-webkit-autofill,
textarea:-webkit-autofill,
select:-webkit-autofill {
  -webkit-text-fill-color: #0F172A !important;
  box-shadow: 0 0 0px 1000px #FFFFFF inset !important;
}
input:disabled,
textarea:disabled,
input[readonly],
textarea[readonly] {
  background-color: #F1F5F9 !important;
  color: #334155 !important;
}
input:focus,
textarea:focus,
select:focus {
  outline: none !important;
  border-color: #39B54A !important;
  box-shadow: 0 0 0 2px rgba(57,181,74,0.35) !important;
}
</style>


<style id="market-size-modal-input-fix">
/* === MARKET SIZE EDIT MODAL – FORCE BLACK TEXT ON WHITE INPUT === */
#edit-market-size-modal input,
#edit-market-size-modal textarea,
#edit-market-size-modal select,
#edit-market-size-modal option {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
}

/* Placeholder */
#edit-market-size-modal input::placeholder,
#edit-market-size-modal textarea::placeholder {
  color: #475569 !important;
  opacity: 1 !important;
}

/* Readonly total field */
#edit-market-size-modal input[readonly] {
  background-color: #F8FAFC !important;
  color: #0F172A !important;
}

/* Chrome autofill */
#edit-market-size-modal input:-webkit-autofill {
  -webkit-text-fill-color: #0F172A !important;
  box-shadow: 0 0 0px 1000px #FFFFFF inset !important;
}
</style>


<!-- FIX: Tombol Batal agar teks hitam di Dark Mode -->
<style id="advanta-cancel-button-fix">
html.dark #edit-market-size-modal button {
  background-color: #FFFFFF !important;
  color: #0F172A !important;
  border-color: #CBD5E1 !important;
}
html.dark #edit-market-size-modal button:hover {
  background-color: #F1F5F9 !important;
  color: #0F172A !important;
}
html.dark #edit-market-size-modal button * {
  color: #0F172A !important;
}
</style>


<!-- FIX: Tombol Batal Edit Market Size – LIGHT MODE -->
<style id="advanta-cancel-button-light-fix">
html:not(.dark) #edit-market-size-modal button {
  background-color: #FFFFFF !important;
  color: #0F172A !important; /* hitam */
  border-color: #CBD5E1 !important;
}
html:not(.dark) #edit-market-size-modal button:hover {
  background-color: #F1F5F9 !important;
  color: #0F172A !important;
}
html:not(.dark) #edit-market-size-modal button * {
  color: #0F172A !important;
}
</style>


<!-- FORCE DARK MODE PERMANENT -->
<script id="force-dark-mode">
(function(){
  document.documentElement.classList.add('dark');
  localStorage.setItem('advanta-theme', 'dark');
  const observer = new MutationObserver(function(){
    if (!document.documentElement.classList.contains('dark')) {
      document.documentElement.classList.add('dark');
    }
  });
  observer.observe(document.documentElement, { attributes:true, attributeFilter:['class'] });
})();
</script>


<!-- ================= ADVANTA GLOBAL THEME LOCK (GOLD • NAVY • GREEN) ================= -->
<style id="advanta-global-theme-lock">
/* COLOR TOKENS */
:root {
  --adv-navy-main: #071423;
  --adv-navy-card: #0B1F36;
  --adv-navy-soft: #102A44;

  --adv-gold: #E6B84C;
  --adv-gold-dark: #C9A24D;

  --adv-green: #39B54A;
  --adv-green-dark: #1E7F3F;

  --adv-text-main: #E5EDFF;
  --adv-text-muted: #9FB3D1;
}

/* GLOBAL BACKGROUND */
html, body {
  background-color: var(--adv-navy-main) !important;
  color: var(--adv-text-main) !important;
}

/* CARDS / PANELS */
.card,
.bg-white,
[class*="bg-white"] {
  background-color: var(--adv-navy-card) !important;
  border: 1px solid rgba(230,184,76,0.25) !important;
  color: var(--adv-text-main) !important;
}

/* SIDEBAR */
#sidebar {
  background: linear-gradient(180deg, #071423, #0B3A6F) !important;
}
#sidebar .nav-link {
  color: #CFE0FF !important;
}
#sidebar .nav-link.active {
  background: linear-gradient(135deg, #10b981, #059669) !important;
  color: #ffffff !important;
  font-weight: 600 !important;
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3) !important;
}
#sidebar .nav-group-header {
  color: #E0E7FF !important;
}
#sidebar .nav-group-header:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

/* TABLE */
table thead th {
  color: var(--adv-gold) !important;
}
table tbody tr:hover {
  background-color: rgba(230,184,76,0.12) !important;
}

/* BUTTONS */
button,
.btn,
[role="button"] {
  border-radius: 0.6rem;
}
button.bg-blue-600,
button.primary {
  background-color: var(--adv-gold) !important;
  color: #1F2937 !important;
}
button.bg-blue-600:hover,
button.primary:hover {
  background-color: var(--adv-gold-dark) !important;
}

/* PROGRESS BAR */
.progress-bar,
[class*="progress"] > div {
  background-color: var(--adv-gold) !important;
}

/* SUCCESS / GREEN */
.text-green-600,
.text-green-500 {
  color: var(--adv-green) !important;
}
.bg-green-600,
.bg-green-500 {
  background-color: var(--adv-green-dark) !important;
}

/* MUTED TEXT */
.text-gray-400,
.text-gray-500,
.text-slate-500 {
  color: var(--adv-text-muted) !important;
}
</style>
<!-- ================= END ADVANTA GLOBAL THEME LOCK ================= -->


<!-- ===== ADVANTA MODAL SOLID FINAL FIX ===== -->
<style id="advanta-modal-solid-fix">
#edit-market-size-modal > div,
#edit-release-modal > div,
#release-po-modal > div,
#target-modal > div,
#indo-market-size-modal > div{
  opacity:1!important;
  background-color:#0B1F36!important;
  backdrop-filter:none!important;
  filter:none!important;
  transform:none!important;
  border:2px solid #334155!important;
  box-shadow:0 30px 70px rgba(0,0,0,.85)!important;
}
html:not(.dark) #edit-market-size-modal > div,
html:not(.dark) #edit-release-modal > div,
html:not(.dark) #release-po-modal > div{
  background:#fff!important;
  color:#0F172A!important;
}
#edit-market-size-modal input,
#edit-market-size-modal select,
#edit-market-size-modal textarea,
.modal input,.modal select,.modal textarea{
  background:#fff!important;
  color:#0F172A!important;
  border:1px solid #94A3B8!important;
}
#edit-market-size-modal input[readonly]{
  background:#F8FAFC!important;
}
.modal button.bg-blue-600,
.modal button.bg-green-600{
  background:#2563EB!important;
  color:#fff!important;
}
html.dark #edit-market-size-modal button:not(.bg-blue-600){
  background:#fff!important;
  color:#0F172A!important;
}
.fixed.inset-0.bg-black{
  background:rgba(0,0,0,.85)!important;
  backdrop-filter:blur(3px);
}
</style>
<!-- ===== END MODAL FIX ===== -->

</head>
<body class="bg-gray-50">

    <!-- Debug Panel for Tablet -->
    <div id="debug-panel" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.9); color: #0f0; padding: 10px; border-radius: 8px; max-width: 300px; max-height: 200px; overflow-y: auto; z-index: 9999; font-size: 10px; font-family: monospace; display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <strong style="color: #fff;">Debug Log</strong>
            <button onclick="document.getElementById('debug-panel').style.display='none'" style="background: #f00; color: #fff; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">X</button>
        </div>
        <div id="debug-content"></div>
    </div>

    <!-- Public DGA Form Page (Standalone for BS Input) -->
    <div id="public-dga-page" class="hidden fixed inset-0 min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-red-500 p-4 overflow-y-auto z-[9999]">
        <div id="toast-container-public" class="fixed top-6 right-6 z-50"></div>
        
        <div class="max-w-4xl mx-auto py-6">
            <!-- Header -->
            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6">
                <div class="flex items-center gap-4">
                    <div class="bg-gradient-to-br from-blue-600 to-purple-600 p-4 rounded-xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Form Input Kegiatan Batch</h1>
                        <p class="text-gray-600 mt-1">Silahkan isi kegiatan harian Anda</p>
                    </div>
                </div>
            </div>

            <!-- Status Panel -->
            <div id="connection-status" class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg p-4 mb-6">
                <div class="flex items-center gap-3">
                    <div id="status-icon" class="flex-shrink-0">
                        <div class="animate-spin rounded-full h-8 w-8 border-4 border-blue-200 border-t-blue-600"></div>
                    </div>
                    <div class="flex-1">
                        <div id="status-title" class="text-sm font-bold text-gray-700">Loading...</div>
                        <div id="status-message" class="text-xs text-gray-600 mt-1">Memuat data BS...</div>
                    </div>
                </div>
            </div>

            <!-- Form Card -->
            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8">
                <form id="public-dga-form" class="space-y-6">
                    <!-- Pilih BS -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            👤 Nama BS <span class="text-red-600">*</span>
                        </label>
                        <select id="public-bs-select" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all">
                            <option value="">-- Pilih Nama BS --</option>
                            <!-- Options will be populated dynamically from businessSolutions -->
                        </select>
                    </div>

                    <!-- Bulan -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            📅 Bulan <span class="text-red-600">*</span>
                        </label>
                        <input type="month" id="public-month-input" required 
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all">
                    </div>

                    <!-- Batch Input Table -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="block text-sm font-bold text-gray-700">
                                📊 Input Kegiatan per Minggu <span class="text-red-600">*</span>
                            </label>
                            <button type="button" onclick="addPublicBatchRow()" 
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Tambah Baris
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                                        <th class="px-4 py-3 text-left font-bold min-w-[120px]">Minggu</th>
                                        <th class="px-3 py-3 text-center font-bold bg-blue-500/30 min-w-[80px]">FM</th>
                                        <th class="px-3 py-3 text-center font-bold bg-green-500/30 min-w-[80px]">ODP</th>
                                        <th class="px-3 py-3 text-center font-bold bg-yellow-500/30 min-w-[80px]">FT</th>
                                        <th class="px-3 py-3 text-center font-bold bg-purple-500/30 min-w-[80px]">FFD</th>
                                        <th class="px-3 py-3 text-center font-bold bg-pink-500/30 min-w-[90px]">Display</th>
                                        <th class="px-4 py-3 text-left font-bold min-w-[150px]">Keterangan</th>
                                        <th class="px-3 py-3 text-center font-bold min-w-[80px]">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="public-batch-tbody">
                                    <!-- Rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex gap-4 pt-4">
                        <button type="submit" 
                            class="flex-1 px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all flex items-center justify-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Submit Semua Data
                        </button>
                        <button type="button" onclick="clearPublicBatchForm()" 
                            class="px-8 py-4 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-xl font-bold transition-all">
                            Reset
                        </button>
                    </div>

                    <!-- Info - Collapsible -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                        <button onclick="togglePublicInstructions()" class="w-full flex items-center justify-between font-bold text-blue-900 hover:text-blue-700 transition-colors">
                            <h4 class="flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Petunjuk Pengisian
                            </h4>
                            <svg id="instructions-toggle-icon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="public-instructions-content" class="hidden mt-3">
                        <ul class="list-disc list-inside space-y-1 text-sm text-blue-800">
                            <li>Pilih <strong>nama BS Anda</strong> dari dropdown</li>
                            <li>Pilih <strong>bulan kegiatan</strong></li>
                            <li>Klik "Tambah Baris" untuk menambah minggu baru</li>
                            <li>Pilih <strong>minggu (W1-W5)</strong> dan isi <strong>jumlah kegiatan</strong> untuk setiap tipe</li>
                            <li>Isi <strong>angka 0</strong> jika tidak ada kegiatan pada tipe tersebut</li>
                            <li>Tambah <strong>keterangan</strong> jika diperlukan (opsional)</li>
                            <li>Bisa input <strong>banyak minggu sekaligus</strong> untuk 1 bulan</li>
                            <li>Klik "Submit Semua Data" untuk menyimpan</li>
                            <li>Data akan otomatis masuk ke sistem ASM! ✅</li>
                        </ul>
                        
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <p class="text-xs font-semibold text-blue-900 mb-1">Jenis Kegiatan:</p>
                            <div class="grid grid-cols-2 gap-2 text-xs text-blue-700">
                                <div>• <strong>FM</strong> = Farmers Meeting</div>
                                <div>• <strong>ODP</strong> = One Day Promo</div>
                                <div>• <strong>FT</strong> = Field Trip</div>
                                <div>• <strong>FFD</strong> = Free From Dealer</div>
                                <div>• <strong>Display</strong> = Display/Branding</div>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <p class="text-xs font-semibold text-blue-900 mb-1">💡 Contoh:</p>
                            <p class="text-xs text-blue-700">W1: FM=5, ODP=3, FT=0, FFD=2, Display=1 berarti minggu pertama ada 5 kegiatan FM, 3 kegiatan ODP, dst.</p>
                        </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Data yang Sudah Diinput -->
            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8 mt-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Data Kegiatan yang Sudah Diinput
                    </h3>
                    <button onclick="refreshPublicDataDisplay()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg">
                        <div class="text-xs opacity-75 mb-1">FM</div>
                        <div id="public-summary-fm" class="text-3xl font-black">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white shadow-lg">
                        <div class="text-xs opacity-75 mb-1">ODP</div>
                        <div id="public-summary-odp" class="text-3xl font-black">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl p-4 text-white shadow-lg">
                        <div class="text-xs opacity-75 mb-1">FT</div>
                        <div id="public-summary-ft" class="text-3xl font-black">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white shadow-lg">
                        <div class="text-xs opacity-75 mb-1">FFD</div>
                        <div id="public-summary-ffd" class="text-3xl font-black">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl p-4 text-white shadow-lg">
                        <div class="text-xs opacity-75 mb-1">Display</div>
                        <div id="public-summary-display" class="text-3xl font-black">0</div>
                    </div>
                </div>

                <!-- Data Table - Rekap Format -->
                <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
                    <table class="w-full text-sm">
                        <thead class="bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold">Business Solution</th>
                                <th class="px-3 py-3 text-center font-bold bg-blue-500/30">FM</th>
                                <th class="px-3 py-3 text-center font-bold bg-green-500/30">ODP</th>
                                <th class="px-3 py-3 text-center font-bold bg-yellow-500/30">FT</th>
                                <th class="px-3 py-3 text-center font-bold bg-purple-500/30">FFD</th>
                                <th class="px-3 py-3 text-center font-bold bg-pink-500/30">Display</th>
                                <th class="px-4 py-3 text-center font-bold bg-orange-500/30">Total</th>
                            </tr>
                        </thead>
                        <tbody id="public-data-display-tbody" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center gap-2">
                                        <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 4 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                        </svg>
                                        <span>Memuat data...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot id="public-data-total-footer" class="bg-gradient-to-r from-blue-500 via-green-500 via-yellow-500 via-purple-500 via-pink-500 to-orange-500">
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center text-white mt-6">
                <p class="text-sm opacity-90">© 2026 Advanta Sales App - Public Form</p>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="hidden min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-indigo-100 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white/80 backdrop-blur-xl border border-slate-200 rounded-3xl shadow-2xl p-8 md:p-10 text-left">
            <div class="flex items-center justify-center mb-6 gap-3">
                <img src="data:image/png;base64,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" alt="Advanta Logo" class="w-24 h-auto object-contain mx-auto" />
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-1">Selamat Datang!</h2>
            <p class="text-gray-500 mb-8 text-sm md:text-base">Silakan masuk untuk melanjutkan ke dasbor Anda.</p>
            <button id="login-button" class="w-full flex items-center justify-center gap-3 py-3 px-4 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C44.57,34.036,48,29.69,48,24C48,22.659,47.862,21.35,47.611,20.083z"></path></svg>
                <span class="font-medium text-gray-700">Masuk dengan Google</span>
            </button>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-white text-gray-800 w-64 h-screen fixed top-0 left-0 shadow-lg z-30 -translate-x-full md:translate-x-0 flex flex-col">
            
<div class="px-4 py-2 flex items-center justify-center border-b border-gray-200">
  <img
    src="data:image/png;base64,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"
    alt="Advanta Logo"
    class="h-20 max-w-[180px] w-auto object-contain select-none"
    draggable="false"
  />
</div>

            <nav id="nav-menu" class="flex-1 overflow-y-auto px-3 py-1">
                <!-- Nav links will be injected here -->
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="main-content md:ml-64 p-4 md:p-8">
            <!-- Header -->
            <header class="flex items-center justify-between mb-6">
                <!-- Sidebar toggle -->
                <button id="menu-toggle" class="p-2 rounded-md text-gray-600 hover:bg-gray-200 z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <!-- Page title + user info -->
                <div class="flex-1 flex items-center justify-between gap-4 ml-2 md:ml-0">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-800">Dashboard</h2>
                    
                    <!-- Global Search - REMOVED -->

<div class="flex items-center gap-3">
                        <div id="user-profile" class="hidden sm:flex items-center gap-3">
                            <img id="user-photo" class="w-9 h-9 rounded-full object-cover" src="https://placehold.co/40x40/EFEFEF/333?text=U" alt="User Photo">
                            <div class="flex flex-col leading-tight">
                                <span id="user-name" class="text-sm font-semibold text-gray-800">User Name</span>
                                <span id="user-email" class="text-xs text-gray-500 truncate max-w-[180px] md:max-w-[220px]">user@email.com</span>
                            </div>
                        </div>
                        <button id="logout-button" class="flex items-center gap-1 px-3 py-1.5 rounded-md text-xs sm:text-sm bg-red-50 text-red-700 hover:bg-red-100 border border-red-100 transition-colors">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H9m4 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="hidden xs:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Page Content Container -->
            <div id="page-container">
                <!-- All pages will be rendered here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
            <h3 id="modal-title" class="text-lg font-bold">Konfirmasi</h3>
            <p id="modal-body" class="text-gray-600 my-4"></p>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="hideConfirmation()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Ya</button>
            </div>
        </div>
    </div>

    <div id="edit-release-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0">
            <h3 class="text-lg font-bold mb-2">Edit Tanggal Rilis PO</h3>
            <p id="edit-release-po-info" class="text-gray-600 text-sm mb-4"></p>
            <label for="edit-release-date-input" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Rilis</label>
            <input type="date" id="edit-release-date-input" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 mb-4" />
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeEditModal('edit-release-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">Batal</button>
                <button type="button" onclick="saveEditedReleaseDate()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">Simpan</button>
            </div>
        </div>
    </div>
    <div id="edit-distributor-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl transform scale-95 opacity-0">
            <h3 class="text-xl font-bold mb-6">Edit Distributor</h3>
            <form id="edit-distributor-form"><input type="hidden" id="edit-distributor-id"><div class="space-y-4"><div><label for="edit-distributor-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Distributor</label><input type="text" id="edit-distributor-name" class="w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="edit-distributor-address" class="block text-sm font-medium text-gray-700 mb-1">Alamat</label><textarea id="edit-distributor-address" rows="3" class="w-full p-2 border border-gray-300 rounded-md" required></textarea></div><div><label for="edit-distributor-cp" class="block text-sm font-medium text-gray-700 mb-1">Contact Person (CP)</label><input type="text" id="edit-distributor-cp" class="w-full p-2 border border-gray-300 rounded-md" required></div><div>
  <label class="block text-sm font-medium text-gray-700 mb-1">
    Pengelompokan Penjualan (Grup Distributor)
  </label>
  <div class="flex items-center gap-2">
    <input
      id="edit-distributor-merge-checkbox"
      type="checkbox"
      class="h-4 w-4 text-blue-600 border-gray-300 rounded"
    />
    <span class="text-sm text-gray-600">
      Gabungkan realisasi distributor ini ke distributor induk
    </span>
  </div>
  <select
    id="edit-distributor-merge-target"
    class="mt-2 w-full p-2 border border-gray-300 rounded-md"
    disabled
  >
    <option value="">Pilih Distributor Induk</option>
  </select>
  <p class="mt-1 text-xs text-gray-400">
    Contoh: centang di "Tani Guna" lalu pilih "Raccolta" sebagai induk.
    Semua penjualan Tani Guna akan ikut dihitung ke target Raccolta.
  </p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Logo</label><div class="flex items-center gap-4 mt-1"><img id="edit-logo-preview" src="https://placehold.co/100x40/EFEFEF/333?text=Logo" alt="Logo Preview" class="h-12 w-auto bg-gray-100 rounded border p-1 object-contain"><input type="file" id="edit-distributor-logo" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div></div></div><div class="flex justify-end gap-4 mt-8"><button type="button" onclick="closeEditModal('edit-distributor-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan Perubahan</button></div></form>
        </div>
    
    <div id="market-size-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xl transform scale-95 opacity-0">
            <h3 id="market-size-modal-title" class="text-xl font-bold mb-4 text-gray-800">Tambah Data Market Size</h3>
            <form id="market-size-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kabupaten</label>
                    <select id="market-kabupaten" class="w-full p-2 border rounded-md" required>
                        <option value="">Pilih Kabupaten</option>
                        <option value="Garut">Garut</option>
                        <option value="Bandung">Bandung</option>
                        <option value="Sumedang">Sumedang</option>
                        <option value="Tasikmalaya">Tasikmalaya</option>
                        <option value="Bandung Barat">Bandung Barat</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Crop</label>
                    <select id="market-crop" class="w-full p-2 border rounded-md" required>
                        <option value="">Pilih Varietas / Crop</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Qty (kg)</label>
                        <input type="text" id="market-qty" class="w-full p-2 border rounded-md" inputmode="numeric" autocomplete="off" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Harga per kg (Rp)</label>
                        <input type="text" id="market-price" class="w-full p-2 border rounded-md" inputmode="numeric" autocomplete="off" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total (Rp)</label>
                        <input type="text" id="market-total" class="w-full p-2 border rounded-md bg-gray-50" inputmode="numeric" autocomplete="off" readonly>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="market-cancel-button" class="px-4 py-2 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>
    
<div id="market-size-detail-modal" class="fixed inset-0 bg-black bg-opacity-40 z-40 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-xl max-h-[80vh] overflow-y-auto transform scale-95 opacity-0 transition-all p-5">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 id="market-size-detail-title" class="text-lg font-semibold text-gray-900">Detail Market Size</h3>
                <p id="market-size-detail-subtitle" class="text-xs text-gray-500 mt-1"></p>
            </div>
            <button id="market-size-detail-close" class="p-2 rounded-full hover:bg-gray-100 text-gray-500">
                <span class="sr-only">Tutup</span>
                ✕
            </button>
        </div>
        <div id="market-size-detail-body" class="divide-y divide-gray-100 text-sm">
            <!-- rows injected by JS -->
        </div>
    </div>
</div>

<div id="edit-variety-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg transform scale-95 opacity-0">
            <h3 class="text-xl font-bold mb-6">Edit Varietas</h3>
            <form id="edit-variety-form"><input type="hidden" id="edit-variety-id"><div class="space-y-4"><div><label for="edit-variety-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Varietas</label><input type="text" id="edit-variety-name" class="w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="edit-variety-price" class="block text-sm font-medium text-gray-700 mb-1">Harga (per pcs)</label><input type="number" id="edit-variety-price" class="w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="edit-variety-weight" class="block text-sm font-medium text-gray-700 mb-1">Bobot (gram)</label><input type="number" id="edit-variety-weight" class="w-full p-2 border border-gray-300 rounded-md" required></div></div><div class="flex justify-end gap-4 mt-8"><button type="button" onclick="closeEditModal('edit-variety-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan Perubahan</button></div></form>
        </div>
    </div>

    <!-- DGA: Add BS Modal - Not needed anymore, using inline form -->
    
    <div id="release-history-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col transform scale-95 opacity-0">
            <h3 class="text-lg font-bold mb-2">Histori Release PO</h3>
            <p id="release-history-subtitle" class="text-xs text-gray-500 mb-4"></p>
            <div id="release-history-body" class="flex-grow overflow-y-auto pr-2 text-xs"></div>
            <div class="flex justify-end gap-3 mt-4 pt-3 border-t">
                <button type="button"
                        onclick="closeEditModal('release-history-modal')"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">
                    Tutup
                </button>
            </div>
        </div>
    </div>

<div id="release-po-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 opacity-0">
            <h3 id="release-modal-title" class="text-xl font-bold mb-4">Release PO</h3>
            <div id="release-modal-body" class="overflow-y-auto pr-2"></div>
            <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                <button onclick="closeEditModal('release-po-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="release-modal-confirm-button" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Simpan Release</button>
            </div>
        </div>
    </div>
     <div id="target-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-6xl max-h-[95vh] flex flex-col transform scale-95 opacity-0">
            <h3 id="target-modal-title" class="text-xl font-bold mb-2">Set Target Penjualan</h3>
            <p id="target-modal-subtitle" class="text-sm text-gray-500 mb-6"></p>
            <div class="mt-4 flex flex-wrap gap-2">
                <button type="button" onclick="downloadTargetTemplateCurrentSelection()" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v4H4m4 6l4 4 4-4m-4 4V10"/>
                    </svg>
                    Download Template Excel (Varietas)
                </button>
                <button type="button" id="target-modal-import-button" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v4H4m4 6l4 4 4-4m-4 4V10"/>
                    </svg>
                    Import Excel (Varietas)
                </button>
                <input type="file" id="target-modal-import-input" accept=".xlsx,.xls" class="hidden">
            </div>
            <form id="target-form" class="flex-grow overflow-y-auto pr-4">
                <input type="hidden" id="editing-target-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 sticky top-0 bg-white py-4 z-10 border-b">
                    <div><label for="target-distributor" class="block text-sm font-medium text-gray-700">Distributor</label><select id="target-distributor" class="mt-1 w-full p-2 border rounded-md"></select></div>
                    <div><label for="target-year" class="block text-sm font-medium text-gray-700">Tahun Fiskal</label><select id="target-year" class="mt-1 w-full p-2 border rounded-md"></select></div>
                    <div><label for="target-unit" class="block text-sm font-medium text-gray-700">Satuan</label><select id="target-unit" class="mt-1 w-full p-2 border rounded-md"><option value="pcs">Pcs</option><option value="kg">Kg</option><option value="nominal">Nominal (Rp)</option></select></div>
                </div>
                <div id="target-items-container" class="space-y-4"></div>
                <button type="button" onclick="addTargetItem()" class="mt-4 flex items-center px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm transition-colors"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Tambah Varietas</button>
            </form>
            <div class="flex justify-end gap-4 mt-8 pt-4 border-t">
                <button type="button" onclick="closeEditModal('target-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button type="button" onclick="saveTarget()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Simpan Target</button>
            </div>
        </div>
    </div>

    
     <div id="target-breakdown-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-5xl max-h-[95vh] flex flex-col transform scale-95 opacity-0">
            <h3 class="text-xl font-bold mb-2">Breakdown Target Penjualan</h3>
            <p id="target-breakdown-subtitle" class="text-sm text-gray-500 mb-6"></p>
            <div id="target-breakdown-body" class="flex-grow overflow-y-auto pr-2"></div>
            <div class="flex justify-end gap-4 mt-8 pt-4 border-t">
                <button type="button"
                        onclick="closeEditModal('target-breakdown-modal')"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Batch Input BS Data -->
    <div id="batch-input-modal" class="modal hidden fixed inset-0 bg-gradient-to-br from-black/60 via-purple-900/30 to-pink-900/30 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-[0_20px_60px_-15px_rgba(0,0,0,0.5)] w-full max-w-6xl max-h-[95vh] flex flex-col transform scale-95 opacity-0 transition-all duration-300">
            <!-- Header with Animated Gradient -->
            <div class="relative bg-gradient-to-r from-purple-600 via-pink-600 to-red-500 px-8 py-6 rounded-t-2xl overflow-hidden">
                <!-- Animated Background Pattern -->
                <div class="absolute inset-0 opacity-20">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent animate-shimmer"></div>
                </div>
                <div class="relative flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-white/20 backdrop-blur-md rounded-xl shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <div>
                            <h3 class="text-3xl font-extrabold text-white flex items-center gap-2 tracking-tight">
                                Input Data BS Batch
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-white/25 backdrop-blur text-white">Premium</span>
                            </h3>
                            <p class="text-pink-100 text-sm mt-1.5 font-medium">✨ Input banyak data Business Solution sekaligus dengan mudah</p>
                        </div>
                    </div>
                    <button onclick="closeBatchInputModal()" class="group text-white hover:bg-white/25 active:bg-white/30 rounded-xl p-2.5 transition-all duration-200 backdrop-blur-sm hover:scale-110 hover:rotate-90 transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 bg-gradient-to-br from-gray-50 to-purple-50/30 dark:from-gray-800 dark:to-gray-900">
                <!-- Controls -->
                <div class="relative bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 dark:from-gray-800 dark:via-gray-700 dark:to-gray-800 rounded-xl p-6 mb-6 border-2 border-purple-200 dark:border-purple-700 shadow-lg overflow-hidden">
                    <!-- Decorative Background -->
                    <div class="absolute top-0 right-0 w-40 h-40 bg-purple-200 dark:bg-purple-900 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-pulse"></div>
                    <div class="absolute bottom-0 left-0 w-40 h-40 bg-pink-200 dark:bg-pink-900 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-pulse" style="animation-delay: 1s"></div>
                    
                    <div class="relative grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-bold text-gray-900 dark:text-white mb-2">
                                <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Bulan
                            </label>
                            <input type="month" id="batch-month" class="w-full px-4 py-3 border-2 border-purple-300 dark:border-purple-600 rounded-xl focus:ring-4 focus:ring-purple-500/30 focus:border-purple-500 transition-all duration-200 font-semibold text-gray-900 dark:text-white dark:bg-gray-800 shadow-sm hover:shadow-md bg-white">
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-sm font-bold text-gray-900 dark:text-white mb-2">
                                <svg class="w-4 h-4 text-pink-600 dark:text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                                Business Solution
                            </label>
                            <select id="batch-bs" class="w-full px-4 py-3 border-2 border-pink-300 dark:border-pink-600 rounded-xl focus:ring-4 focus:ring-pink-500/30 focus:border-pink-500 transition-all duration-200 font-semibold text-gray-900 dark:text-white dark:bg-gray-800 shadow-sm hover:shadow-md bg-white">
                                <option value="">Pilih BS</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="addBatchRow()" class="group w-full px-5 py-3 bg-gradient-to-r from-green-600 via-teal-600 to-cyan-600 text-white rounded-xl hover:from-green-700 hover:via-teal-700 hover:to-cyan-700 active:scale-95 font-bold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                                <span class="tracking-wide">Tambah Baris</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border-2 border-purple-200 dark:border-purple-700 shadow-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full table-fixed" id="batch-input-table">
                            <thead>
                                <tr class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white">
                                    <th class="px-3 py-3 text-center text-xs font-bold uppercase w-28">
                                        Minggu
                                    </th>
                                    <th class="px-2 py-3 text-center text-xs font-bold uppercase w-24">
                                        <div class="inline-block px-2 py-1 bg-blue-500 rounded-md text-white text-xs font-bold">FM</div>
                                    </th>
                                    <th class="px-2 py-3 text-center text-xs font-bold uppercase w-24">
                                        <div class="inline-block px-2 py-1 bg-green-500 rounded-md text-white text-xs font-bold">ODP</div>
                                    </th>
                                    <th class="px-2 py-3 text-center text-xs font-bold uppercase w-24">
                                        <div class="inline-block px-2 py-1 bg-yellow-500 rounded-md text-white text-xs font-bold">FT</div>
                                    </th>
                                    <th class="px-2 py-3 text-center text-xs font-bold uppercase w-24">
                                        <div class="inline-block px-2 py-1 bg-purple-500 rounded-md text-white text-xs font-bold">FFD</div>
                                    </th>
                                    <th class="px-2 py-3 text-center text-xs font-bold uppercase w-28">
                                        <div class="inline-block px-2 py-1 bg-pink-500 rounded-md text-white text-xs font-bold">Display</div>
                                    </th>
                                    <th class="px-3 py-3 text-left text-xs font-bold uppercase">
                                        Keterangan
                                    </th>
                                    <th class="px-2 py-3 text-center text-xs font-bold uppercase w-20">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="batch-input-tbody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                <!-- Rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Helper Text -->
                <div class="mt-6 relative bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-800 dark:via-gray-700 dark:to-gray-800 rounded-xl p-5 border-2 border-blue-200 dark:border-blue-700 shadow-lg overflow-hidden">
                    <!-- Decorative Elements -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-200 dark:bg-blue-900 rounded-full mix-blend-multiply filter blur-2xl opacity-40"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-purple-200 dark:bg-purple-900 rounded-full mix-blend-multiply filter blur-2xl opacity-40"></div>
                    
                    <div class="relative flex gap-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="text-sm flex-1">
                            <p class="font-extrabold text-gray-900 dark:text-white mb-2 text-base flex items-center gap-2">
                                💡 Tips & Trik Input Data
                            </p>
                            <ul class="space-y-2 text-gray-800 dark:text-gray-200">
                                <li class="flex items-start gap-2 group hover:translate-x-1 transition-transform duration-200">
                                    <span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold group-hover:scale-110 transition-transform">1</span>
                                    <span class="font-medium">Input angka kegiatan di setiap kolom (contoh: <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded font-bold">FM 1</span>, <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded font-bold">ODP 2</span>, dst)</span>
                                </li>
                                <li class="flex items-start gap-2 group hover:translate-x-1 transition-transform duration-200">
                                    <span class="flex-shrink-0 w-5 h-5 bg-green-500 text-white rounded-full flex items-center justify-center text-xs font-bold group-hover:scale-110 transition-transform">2</span>
                                    <span class="font-medium">Kolom yang kosong akan diabaikan (nilai default = <span class="px-2 py-0.5 bg-gray-100 text-gray-700 rounded font-bold">0</span>)</span>
                                </li>
                                <li class="flex items-start gap-2 group hover:translate-x-1 transition-transform duration-200">
                                    <span class="flex-shrink-0 w-5 h-5 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs font-bold group-hover:scale-110 transition-transform">3</span>
                                    <span class="font-medium">Klik tombol <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded font-bold">Tambah Baris</span> untuk menambah minggu lainnya</span>
                                </li>
                                <li class="flex items-start gap-2 group hover:translate-x-1 transition-transform duration-200">
                                    <span class="flex-shrink-0 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs font-bold group-hover:scale-110 transition-transform">4</span>
                                    <span class="font-medium">Klik ikon <span class="text-red-600 font-bold">🗑️ hapus</span> untuk menghapus baris yang tidak diperlukan</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-8 py-5 bg-gradient-to-r from-gray-50 via-purple-50 to-pink-50 dark:from-gray-800 dark:via-gray-700 dark:to-gray-800 border-t-2 border-purple-200 dark:border-purple-700 rounded-b-2xl flex justify-between items-center gap-4 backdrop-blur-sm">
                <div class="flex items-center gap-3 text-sm text-gray-800 dark:text-gray-200">
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                        <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span class="font-semibold text-gray-800 dark:text-white">Auto-save enabled</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeBatchInputModal()" class="group px-6 py-3 bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 hover:border-gray-400 active:scale-95 font-bold shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">
                        <svg class="w-5 h-5 group-hover:rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        <span>Batal</span>
                    </button>
                    <button onclick="saveBatchInput()" class="group relative px-8 py-3 bg-gradient-to-r from-purple-600 via-pink-600 to-red-500 text-white rounded-xl hover:from-purple-700 hover:via-pink-700 hover:to-red-600 active:scale-95 font-bold shadow-xl hover:shadow-2xl transition-all duration-200 flex items-center gap-2 overflow-hidden">
                        <!-- Shine Effect -->
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/25 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                        <svg class="w-5 h-5 relative z-10 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
                        <span class="relative z-10 tracking-wide">Simpan Semua Data</span>
                        <span class="relative z-10 px-2 py-0.5 bg-white/25 rounded text-xs font-bold">Ctrl+S</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Public Stock Input Page (for distributors) -->
    <div id="public-stock-input-page" style="display:none;" class="min-h-screen bg-gradient-to-br from-green-50 to-teal-50 py-4 px-2 md:px-4">
        <div class="w-full">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-xl shadow-lg p-6 text-white mb-6">
                <h1 class="text-3xl font-bold mb-2">📦 Input Stok Produk</h1>
                <p class="text-green-100" id="public-dist-name">Loading...</p>
            </div>

            <!-- Form -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <form id="public-stock-form">
                    <!-- Grid 2 Kolom untuk Form Compact -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Tanggal -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="public-stock-date" required class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                        </div>

                        <!-- Varietas -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Varietas</label>
                            <select id="public-stock-variety" onchange="clearStockForm()" required class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">-- Pilih Varietas --</option>
                            </select>
                        </div>

                        <!-- Qty -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Quantity (pcs)</label>
                            <input type="number" id="public-stock-qty" required min="1" placeholder="Masukkan jumlah" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                        </div>

                        <!-- No Lot -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">No Lot</label>
                            <input type="text" id="public-stock-lot" required placeholder="Contoh: LOT-2025-001" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                        </div>

                        <!-- Expired Date -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Expired</label>
                            <input type="date" id="public-stock-expired" placeholder="Tanggal kadaluarsa" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                        </div>

                        <!-- Release Date / Tanggal Turun PO -->
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Release/Turun PO <span class="text-red-500">*</span></label>
                            <input type="date" id="public-stock-release" required placeholder="Tanggal produksi/release" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                            <p class="text-xs text-gray-500 mt-0.5">⚠️ Penting untuk hitung aging benih yang akurat</p>
                        </div>
                    </div>

                    <!-- Keterangan - Full Width -->
                    <div class="mt-3">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Keterangan (Opsional)</label>
                        <textarea id="public-stock-notes" rows="2" placeholder="Tambahkan catatan jika diperlukan" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
                    </div>

                    <!-- Hidden field untuk Edit Mode -->
                    <input type="hidden" id="public-stock-edit-stockid" value="">

                    <!-- Submit Button -->
                    <button type="submit" id="public-stock-submit-btn" class="w-full mt-4 px-4 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg font-bold shadow-md hover:from-green-700 hover:to-teal-700 transition">
                        ✓ Submit Stok
                    </button>
                </form>

                <!-- Success Message -->
                <div id="public-stock-success" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                    <div class="text-green-600 text-5xl mb-2">✓</div>
                    <h3 class="text-xl font-bold text-green-800 mb-1">Data Berhasil Dikirim!</h3>
                    <p class="text-sm text-green-600">Terima kasih telah mengisi data stok</p>
                    <button onclick="resetPublicStockForm()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        Input Lagi
                    </button>
                </div>
            </div>

            <!-- Info Box -->
            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-800">
                        <p class="font-medium mb-1">Informasi:</p>
                        <ul class="list-disc list-inside space-y-1 text-blue-700">
                            <li>Pastikan data yang diisi sudah benar</li>
                            <li>No Lot harus sesuai dengan kemasan produk</li>
                            <li>Data akan langsung masuk ke sistem</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Data Stok yang Sudah Diinput -->
            <div id="public-stock-list-section" class="mt-6 bg-white rounded-xl shadow-lg p-6" style="display:none;">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Data Stok yang Sudah Diinput
                </h3>
                <div id="public-stock-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                    <!-- Data will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Update Stok -->
    <div id="update-stock-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-t-2xl sticky top-0">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit Stok Lengkap
                </h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Varietas</label>
                        <input type="text" id="modal-variety-name" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Entry <span class="text-red-500">*</span></label>
                        <input type="date" id="modal-date" required class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Release/Turun PO <span class="text-red-500">*</span></label>
                        <input type="date" id="modal-release-date" required class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">⚠️ Penting untuk hitung aging benih yang akurat</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Quantity <span class="text-red-500">*</span></label>
                        <input type="number" id="modal-qty" min="0" required class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Satuan/Unit</label>
                        <input type="text" id="modal-unit" placeholder="pcs, kg, box, dll" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">No Lot</label>
                        <input type="text" id="modal-lot-number" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Expired</label>
                        <input type="date" id="modal-expired" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Keterangan</label>
                        <textarea id="modal-notes" rows="2" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Catatan tambahan..."></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeUpdateStockModal()" class="flex-1 px-4 py-3 bg-gray-400 text-black rounded-lg font-extrabold hover:bg-gray-500 transition">
                        Batal
                    </button>
                    <button onclick="submitUpdateStock()" class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold hover:from-blue-700 hover:to-indigo-700 transition shadow-md">
                        💾 Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Edit Stock Modal -->
    <div id="admin-edit-stock-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-4 rounded-t-2xl sticky top-0">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit Stok Distributor
                </h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Distributor</label>
                        <input type="text" id="admin-modal-distributor" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm font-bold">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Varietas</label>
                        <input type="text" id="admin-modal-variety" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Entry <span class="text-red-500">*</span></label>
                        <input type="date" id="admin-modal-date" required class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Release/Turun PO <span class="text-red-500">*</span></label>
                        <input type="date" id="admin-modal-release-date" required class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">⚠️ Penting untuk hitung aging benih</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Quantity <span class="text-red-500">*</span></label>
                        <input type="number" id="admin-modal-qty" min="0" required class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Satuan/Unit</label>
                        <input type="text" id="admin-modal-unit" placeholder="pcs, kg, box, dll" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">No Lot</label>
                        <input type="text" id="admin-modal-lot-number" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Tanggal Expired</label>
                        <input type="date" id="admin-modal-expired" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-700 mb-1">Keterangan</label>
                        <textarea id="admin-modal-notes" rows="2" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Catatan tambahan..."></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeAdminEditStockModal()" class="flex-1 px-4 py-3 bg-gray-400 text-black rounded-lg font-extrabold hover:bg-gray-500 transition">
                        Batal
                    </button>
                    <button onclick="submitAdminEditStock()" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg font-bold hover:from-green-700 hover:to-teal-700 transition shadow-md">
                        💾 Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Toast Notification Container -->
    <div id="toast-container"></div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, deleteDoc, query, orderBy, limit, onSnapshot, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDteQy4ysCb5BMOSSfSZWRrrmfKgCuqE4M",
            authDomain: "advanta-sales-app.firebaseapp.com",
            projectId: "advanta-sales-app",
            storageBucket: "advanta-sales-app.firebasestorage.app",
            messagingSenderId: "863140785202",
            appId: "1:863140785202:web:49846813a3504e28d5a02b"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Make db and Firestore functions available globally for public stock form
            window.db = db;
            window.onSnapshot = onSnapshot;
            window.doc = doc;
            window.getDoc = getDoc;
            window.collection = collection;
            window.addDoc = addDoc;
            window.deleteDoc = deleteDoc;
            window.getDocs = getDocs;
            window.query = query;
            window.where = where;
            console.log('✅ Firebase initialized successfully');
            console.log('📝 IMPORTANT: Make sure Firestore rules allow public read for "sharedData" collection:');
            console.log('rules_version = "2";');
            console.log('service cloud.firestore {');
            console.log('  match /databases/{database}/documents {');
            console.log('    match /sharedData/{document=**} {');
            console.log('      allow read: if true;  // Public read');
            console.log('      allow write: if request.auth != null;  // Only authenticated users can write');
            console.log('    }');
            console.log('    match /{document=**} {');
            console.log('      allow read, write: if request.auth != null;');
            console.log('    }');
            console.log('  }');
            console.log('}');
        } catch (error) {
            console.warn("Firebase initialization failed, using local auth:", error);
            auth = null;
            db = null;
            window.db = null;
        }
        
        // --- Global State ---
        let currentUser = null;
        window.appState = {
            farmerReachMultipliers: {
                FM: 25,
                ODP: 25,
                FT: 20,
                FFD: 60,
                DISPLAY: 0
            }
        }; // Make appState global for access in other scripts
        
        // Unit conversion state
        window.currentDisplayUnit = 'pcs'; // 'pcs' or 'kg'
        
        // --- AUTHENTICATION ---
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loader = document.getElementById('loader');
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');

        const loginWithGoogle = async () => {
            if (!auth) {
                // Fallback to local/demo login
                console.log("Using demo login (Firebase not available)");
                const mockUser = {
                    uid: "demo_user_" + Date.now(),
                    displayName: "Demo User",
                    email: "demo@example.com",
                    photoURL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%230B3A6F'/%3E%3Ctext x='50' y='65' font-size='40' fill='white' text-anchor='middle' font-family='sans-serif' font-weight='bold'%3ED%3C/text%3E%3C/svg%3E"
                };
                simulateLogin(mockUser);
                return;
            }
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Authentication error:", error);
                showToast(`Login gagal: ${error.message}. Menggunakan mode demo...`, 'info');
                // Fallback to demo login
                const mockUser = {
                    uid: "demo_user_" + Date.now(),
                    displayName: "Demo User",
                    email: "demo@example.com",
                    photoURL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%230B3A6F'/%3E%3Ctext x='50' y='65' font-size='40' fill='white' text-anchor='middle' font-family='sans-serif' font-weight='bold'%3ED%3C/text%3E%3C/svg%3E"
                };
                simulateLogin(mockUser);
            }
        };

        const simulateLogin = (mockUser) => {
            currentUser = mockUser;
            loginPage.classList.add('hidden');
            appContainer.classList.remove('hidden');
            
            // Update UI with user info
            document.getElementById('user-name').textContent = mockUser.displayName;
            document.getElementById('user-email').textContent = mockUser.email;
            document.getElementById('user-photo').src = mockUser.photoURL;
            
            // Initialize the app UI
            initializeAppUI();
            loader.classList.add('hidden');
        };

        const logout = async () => {
            try {
                if (auth) {
                    await signOut(auth);
                }
            } catch (error) {
                console.error("Logout error:", error);
            }
            // Fallback logout
            currentUser = null;
            window.currentUser = null; // Clear global reference
            appState.currentUser = null;
            appState.activities = [];
            appContainer.classList.add('hidden');
            loginPage.classList.remove('hidden');
        };

        loginButton.onclick = loginWithGoogle;
        logoutButton.onclick = logout;

        // Listen for auth state changes (only if Firebase is initialized)
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    window.currentUser = user; // Expose to window for global access
                    
                    // Set current user in appState for filtering
                    appState.currentUser = user.email || user.uid;
                    
                    loginPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    
                    // Update UI with user info
                    document.getElementById('user-name').textContent = user.displayName;
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('user-photo').src = user.photoURL;
                    
                    // Load user data from Firestore
                    if (db) {
                        await window.loadData(user.uid);
                    }
                    
                    // Initialize the app UI
                    initializeAppUI();
                } else {
                    // User is signed out
                    currentUser = null;
                    window.currentUser = null; // Clear global reference
                    appState.currentUser = null;
                    appContainer.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                }
                loader.classList.add('hidden');
            });
        } else {
            // Firebase not available, hide loader and show login page
            loader.classList.add('hidden');
            loginPage.classList.remove('hidden');
        }
        
        // === CHECK FOR PUBLIC STOCK INPUT URL ===
        const urlParams = new URLSearchParams(window.location.search);
        const stockToken = urlParams.get('stock-input');
        
        if (stockToken) {
            // Show public stock input page
            document.getElementById('public-stock-input-page').style.display = 'block';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
            
            // Load stock link data and initialize public form
            initializePublicStockForm(stockToken);
        }
        
        // --- FIRESTORE DATA PERSISTENCE ---
        window.saveData = async () => {
            console.log('💾 saveData called, currentUser:', currentUser);
            if (!currentUser) {
                console.warn("No user logged in, cannot save data");
                showToast("Tidak dapat menyimpan: belum login", 'error');
                return;
            }
            
            console.log('📊 Saving data:');
            console.log('  - BS count:', appState.businessSolutions?.length || 0);
            console.log('  - DGA Activities count:', appState.dgaActivities?.length || 0);
            console.log('  - PO count:', appState.purchaseOrders?.length || 0);
            console.log('  - Stock Distributor count:', appState.stockDistributor?.length || 0);
            
            // Make a deep copy to avoid saving temporary calculated values
            const dataToSave = JSON.parse(JSON.stringify(window.appState));
            
            // Try to save to Firestore first (with merge to prevent data loss)
            if (db) {
                const userDocRef = doc(db, 'advantaUserData', currentUser.uid);
                try {
                    console.log('🔄 Reading current Firestore data before save...');
                    const docSnap = await getDoc(userDocRef);
                    
                    if (docSnap.exists()) {
                        const existingData = docSnap.data().data || {};
                        console.log('  - Existing stockDistributor count in Firestore:', (existingData.stockDistributor || []).length);
                        console.log('  - Current stockDistributor count in memory:', (dataToSave.stockDistributor || []).length);
                        
                        // MERGE stockDistributor: prioritize Firestore data to prevent loss
                        // Only keep items from memory that don't exist in Firestore
                        if (existingData.stockDistributor && existingData.stockDistributor.length > 0) {
                            const existingIds = new Set(existingData.stockDistributor.map(s => s.id));
                            const memoryOnlyItems = (dataToSave.stockDistributor || []).filter(s => !existingIds.has(s.id));
                            
                            // Combine: Firestore data + new items from memory
                            dataToSave.stockDistributor = [...existingData.stockDistributor, ...memoryOnlyItems];
                            console.log('  ✅ Merged stockDistributor. Final count:', dataToSave.stockDistributor.length);
                        } else if (!dataToSave.stockDistributor || dataToSave.stockDistributor.length === 0) {
                            // If memory is empty but Firestore has data, keep Firestore data
                            dataToSave.stockDistributor = existingData.stockDistributor || [];
                            console.log('  ⚠️ Memory empty, keeping Firestore data:', dataToSave.stockDistributor.length);
                        }
                        
                        // Also merge stockLinks to prevent loss
                        if (existingData.stockLinks && existingData.stockLinks.length > 0) {
                            const existingLinkTokens = new Set(existingData.stockLinks.map(l => l.token));
                            const memoryOnlyLinks = (dataToSave.stockLinks || []).filter(l => !existingLinkTokens.has(l.token));
                            dataToSave.stockLinks = [...existingData.stockLinks, ...memoryOnlyLinks];
                            console.log('  ✅ Merged stockLinks. Final count:', dataToSave.stockLinks.length);
                        }
                        
                        // Merge planPO to prevent duplicates and data loss
                        if (existingData.planPO && existingData.planPO.length > 0) {
                            const existingPlanIds = new Set(existingData.planPO.map(p => p.id));
                            const memoryOnlyPlans = (dataToSave.planPO || []).filter(p => !existingPlanIds.has(p.id));
                            dataToSave.planPO = [...existingData.planPO, ...memoryOnlyPlans];
                            console.log('  ✅ Merged planPO. Final count:', dataToSave.planPO.length);
                        } else if (!dataToSave.planPO || dataToSave.planPO.length === 0) {
                            // If memory is empty but Firestore has data, keep Firestore data
                            dataToSave.planPO = existingData.planPO || [];
                            console.log('  ⚠️ Memory empty, keeping Firestore planPO:', dataToSave.planPO.length);
                        }
                    } else {
                        console.log('  ℹ️ No existing document, creating new one');
                    }
                    
                    await setDoc(userDocRef, { data: dataToSave });
                    console.log("✅ Data saved to Firestore with merge");
                    showToast("Data tersimpan ke cloud", 'success');
                    return;
                } catch(error) {
                    console.error("❌ Error saving data to Firestore:", error);
                    // Don't show toast here, will save to localStorage below
                }
            }
            
            // Fallback to localStorage (for demo mode or when Firestore fails)
            try {
                const storageKey = 'advantaData_' + currentUser.uid;
                localStorage.setItem(storageKey, JSON.stringify(dataToSave));
                console.log("Data saved to localStorage with key:", storageKey);
                console.log("Stored BS count:", dataToSave.businessSolutions?.length || 0);
                showToast("✓ Data tersimpan", 'success');
            } catch(error) {
                console.error("Error saving data to localStorage:", error);
                showToast("Gagal menyimpan data.", 'error');
            }
        };
        
        window.loadData = async (userId) => {
            let savedData = null;
            
            // Set current user for filtering (use currentUser if available)
            if (currentUser) {
                appState.currentUser = currentUser.email || currentUser.uid;
            }
            
            // MIGRATION STEP 1: Clear old shared localStorage (one-time cleanup)
            const STORAGE_VERSION_KEY = 'advantaStorageVersion';
            const CURRENT_STORAGE_VERSION = '2.0'; // User-specific storage
            const oldVersion = localStorage.getItem(STORAGE_VERSION_KEY);
            
            if (oldVersion !== CURRENT_STORAGE_VERSION) {
                console.log('Migrating to new storage version:', CURRENT_STORAGE_VERSION);
                // Clear old shared localStorage
                localStorage.removeItem('advantaSharedBSList');
                localStorage.setItem(STORAGE_VERSION_KEY, CURRENT_STORAGE_VERSION);
                console.log('Old shared BS data cleared from localStorage');
            }
            
            // Try to load from Firestore first
            if (db) {
                const userDocRef = doc(db, 'advantaUserData', userId);
                try {
                    console.log('🔍 Loading data from Firestore for userId:', userId);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        savedData = docSnap.data().data;
                        console.log("✅ Data loaded from Firestore");
                        console.log('  - stockDistributor count:', (savedData?.stockDistributor || []).length);
                    } else {
                        console.log("⚠️ User document does not exist in Firestore");
                    }
                } catch (error) {
                    console.error("❌ Failed to load data from Firestore:", error);
                }
            }
            
            // Fallback to localStorage if Firestore fails or no data found
            if (!savedData) {
                try {
                    const localData = localStorage.getItem('advantaData_' + userId);
                    if (localData) {
                        savedData = JSON.parse(localData);
                        console.log("✅ Data loaded from localStorage (user-specific)");
                    } else {
                        console.log("⚠️ No user-specific data found in localStorage");
                        
                        // Try old keys as fallback for data recovery
                        const oldKeys = ['advantaData', 'advantaData_undefined', 'advantaData_null'];
                        for (const oldKey of oldKeys) {
                            const oldData = localStorage.getItem(oldKey);
                            if (oldData) {
                                try {
                                    const parsed = JSON.parse(oldData);
                                    if (parsed && (parsed.dgaActivities?.length > 0 || parsed.businessSolutions?.length > 0)) {
                                        console.log(`🔄 Found old data in "${oldKey}"! Migrating...`);
                                        savedData = parsed;
                                        
                                        // Save to correct location
                                        localStorage.setItem('advantaData_' + userId, oldData);
                                        
                                        // Remove old key
                                        localStorage.removeItem(oldKey);
                                        console.log(`✅ Data migrated from "${oldKey}" to "advantaData_${userId}"`);
                                        break;
                                    }
                                } catch (e) {
                                    console.log(`❌ Failed to parse data from "${oldKey}"`);
                                }
                            }
                        }
                        
                        // Try to find any localStorage keys that might contain old data
                        const allKeys = Object.keys(localStorage);
                        console.log("📦 Available localStorage keys:", allKeys.filter(k => k.includes('advanta')));
                    }
                } catch (error) {
                    console.error("Failed to load data from localStorage:", error);
                }
            }
            
            // Apply loaded data or use defaults
            if (savedData) {
                // Preserve currentUser before resetting appState
                const preservedCurrentUser = appState.currentUser;
                
                console.log('🔄 Merging savedData with defaultData...');
                console.log('  - savedData.stockDistributor:', (savedData.stockDistributor || []).length);
                console.log('  - defaultData.stockDistributor:', (window.defaultData.stockDistributor || []).length);
                
                window.appState = { ...JSON.parse(JSON.stringify(window.defaultData)), ...savedData };
                
                console.log('  - After merge, appState.stockDistributor:', (window.appState.stockDistributor || []).length);
                
                // CRITICAL: If savedData had stockDistributor but merge resulted in empty, restore it
                if (savedData.stockDistributor && savedData.stockDistributor.length > 0) {
                    if (!window.appState.stockDistributor || window.appState.stockDistributor.length === 0) {
                        console.error('⚠️ CRITICAL: stockDistributor was lost during merge! Restoring...');
                        window.appState.stockDistributor = savedData.stockDistributor;
                        console.log('  ✅ Restored stockDistributor:', window.appState.stockDistributor.length);
                    }
                }
                
                // Restore currentUser after merge
                if (preservedCurrentUser) {
                    window.appState.currentUser = preservedCurrentUser;
                }
                
                console.log('📊 Data loaded into appState:');
                console.log('  - Current User:', window.appState.currentUser);
                console.log('  - Business Solutions:', window.appState.businessSolutions?.length || 0);
                console.log('  - DGA Activities:', window.appState.dgaActivities?.length || 0);
                console.log('  - Purchase Orders:', window.appState.purchaseOrders?.length || 0);
                console.log('  - Stock Distributor:', window.appState.stockDistributor?.length || 0);
                
                // --- DATA MIGRATION LOGIC ---
                let needsSave = false;
                if (window.appState.purchaseOrders) {
                    window.appState.purchaseOrders.forEach(p => { 
                        // Ensure status exists
                        if (p.status === undefined) { p.status = 'Draft'; needsSave = true; }
                        
                        if (p.items) {
                            p.items.forEach(i => {
                                // Backfill variety details if missing
                                if (i.name === undefined || i.weight === undefined || i.price === undefined) {
                                    const variety = window.appState.varieties?.find(v => v.id == i.varietyId);
                                    if(variety) {
                                        i.name = i.name ?? variety.name; i.price = i.price ?? variety.price; i.weight = i.weight ?? variety.weight; needsSave = true;
                                    }
                                }

                                // **NEW MIGRATION**: Convert old `releasedQty` to new `releases` array
                                if (typeof i.releasedQty === 'number' && i.releasedQty > 0 && !Array.isArray(i.releases)) {
                                    i.releases = [{
                                        qty: i.releasedQty,
                                        date: p.poDate
                                    }];
                                    needsSave = true;
                                }
                                // Ensure `releases` is an array even if empty
                                if (!Array.isArray(i.releases)) {
                                    i.releases = [];
                                        needsSave = true;
                                }
                                
                                // We can now remove the old `releasedQty` field after migration
                            });
                        }
                    });
                }
                
                // **NEW MIGRATION**: Convert 'unknown' createdBy to current user
                if (appState.currentUser) {
                    console.log('🔄 Starting migration for user:', appState.currentUser);
                    
                    // Migrate BS with 'unknown' creator
                    if (Array.isArray(window.appState.businessSolutions)) {
                        console.log('📦 Total BS before migration:', window.appState.businessSolutions.length);
                        window.appState.businessSolutions.forEach((bs, idx) => {
                            console.log(`BS[${idx}]: "${bs.name}" - createdBy: ${bs.createdBy}`);
                            if (bs.createdBy === 'unknown' || bs.createdBy === undefined) {
                                bs.createdBy = appState.currentUser;
                                needsSave = true;
                                console.log(`✅ Migrated BS "${bs.name}" to ${appState.currentUser}`);
                            }
                        });
                    }
                    
                    // Migrate DGA activities with 'unknown' creator OR any createdBy (for data recovery)
                    if (Array.isArray(window.appState.dgaActivities)) {
                        console.log('📊 Total DGA activities RAW:', window.appState.dgaActivities.length);
                        
                        // Log all activities to see their createdBy
                        window.appState.dgaActivities.slice(0, 10).forEach((a, idx) => {
                            console.log(`Activity[${idx}]: "${a.bsName}" - type: ${a.type} - createdBy: "${a.createdBy}"`);
                        });
                        
                        let migratedCount = 0;
                        window.appState.dgaActivities.forEach((activity) => {
                            // Migrate if createdBy is missing OR different from current user
                            if (!activity.createdBy || activity.createdBy === 'unknown' || activity.createdBy === undefined) {
                                activity.createdBy = appState.currentUser;
                                migratedCount++;
                                needsSave = true;
                            }
                        });
                        
                        if (migratedCount > 0) {
                            console.log(`✅ Migrated ${migratedCount} DGA activities to ${appState.currentUser}`);
                        } else {
                            console.log(`⚠️ No activities to migrate. All ${window.appState.dgaActivities.length} activities have createdBy set.`);
                            
                            // Count how many belong to current user
                            const myActivities = window.appState.dgaActivities.filter(a => a.createdBy === appState.currentUser);
                            const otherActivities = window.appState.dgaActivities.filter(a => a.createdBy !== appState.currentUser);
                            console.log(`📊 Activities breakdown: ${myActivities.length} mine, ${otherActivities.length} others`);
                            
                            if (otherActivities.length > 0) {
                                console.log(`🔍 Other users' activities detected:`);
                                const otherUsers = [...new Set(otherActivities.map(a => a.createdBy))];
                                otherUsers.forEach(user => {
                                    const count = otherActivities.filter(a => a.createdBy === user).length;
                                    console.log(`  - ${user}: ${count} activities`);
                                });
                            }
                        }
                    }
                }

                if (needsSave) { 
                    console.log("Data migration performed."); 
                    await window.saveData(); 
                }
            } else {
                console.log("No previous data found, initializing with defaults.");
                window.appState = JSON.parse(JSON.stringify(window.defaultData));
                
                // Ensure currentUser is set even with defaults
                if (currentUser) {
                    window.appState.currentUser = currentUser.email || currentUser.uid;
                    console.log('✅ Set currentUser in default appState:', window.appState.currentUser);
                }
            }
            
            // MIGRATION: Migrate old BS data to new businessSolutions collection
            if (db && currentUser) {
                try {
                    const bsCollRef = collection(db, 'businessSolutions');
                    const existingQuery = query(bsCollRef, where('ownerEmail', '==', currentUser.email));
                    const existingSnap = await getDocs(existingQuery);
                    
                    // Only migrate if user has no BS in new collection yet
                    if (existingSnap.empty) {
                        let bsToMigrate = [];
                        
                        // Source 1: Old user-specific path
                        try {
                            const userBSRef = doc(db, 'advantaUserData', userId, 'private', 'businessSolutions');
                            const userBSSnap = await getDoc(userBSRef);
                            if (userBSSnap.exists()) {
                                const data = userBSSnap.data();
                                if (data.bsList && data.bsList.length > 0) {
                                    bsToMigrate = data.bsList;
                                    console.log('Found', bsToMigrate.length, 'BS in old user-specific path');
                                }
                            }
                        } catch (e) { console.log('No old user BS:', e.message); }
                        
                        // Source 2: Old shared path (only BS created by this user)
                        if (bsToMigrate.length === 0) {
                            try {
                                const oldBSRef = doc(db, 'sharedData', 'businessSolutions');
                                const oldBSSnap = await getDoc(oldBSRef);
                                if (oldBSSnap.exists()) {
                                    const data = oldBSSnap.data();
                                    if (data.bsList) {
                                        bsToMigrate = data.bsList.filter(bs => 
                                            bs.addedBy === currentUser.email || 
                                            bs.createdBy === currentUser.email ||
                                            bs.createdBy === appState.currentUser
                                        );
                                        console.log('Found', bsToMigrate.length, 'BS in old shared path for this user');
                                    }
                                }
                            } catch (e) { console.log('No old shared BS:', e.message); }
                        }
                        
                        // Source 3: Local appState
                        if (bsToMigrate.length === 0 && appState.businessSolutions?.length > 0) {
                            bsToMigrate = appState.businessSolutions.filter(bs =>
                                bs.createdBy === appState.currentUser || 
                                bs.createdBy === currentUser.email ||
                                !bs.createdBy
                            );
                            console.log('Found', bsToMigrate.length, 'BS in local appState');
                        }
                        
                        // Migrate to new collection
                        if (bsToMigrate.length > 0) {
                            console.log('🔄 Migrating', bsToMigrate.length, 'BS to new collection...');
                            for (const bs of bsToMigrate) {
                                await addDoc(bsCollRef, {
                                    name: bs.name,
                                    ownerEmail: currentUser.email,
                                    createdBy: currentUser.email,
                                    createdAt: bs.createdAt || bs.addedAt || new Date().toISOString()
                                });
                            }
                            console.log('✅ Migration complete:', bsToMigrate.length, 'BS migrated');
                        }
                    } else {
                        console.log('✅ BS already exists in new collection:', existingSnap.size, 'items');
                    }
                } catch (error) {
                    console.log('Migration check completed:', error.message);
                }
            }
        };

        // --- UI INITIALIZATION ---
        // This function will be called after user logs in and data is loaded.
        function initializeAppUI() {
            renderAllPages();
            ensureInsentifPage();
            initializeNav();
            refreshUI(); 
            resetPOForm();
            initGlobalSearch(); // Initialize global search
            // Initialize DGA after a short delay to ensure DOM is ready
            setTimeout(() => {
                window.initDGAPage();
            }, 100);
            showPage('dashboard'); 
        }

        // === DGA FUNCTIONS (Simplified) ===
        window.initDGAPage = function() {
            console.log('initDGAPage called');
            if (!appState.businessSolutions) appState.businessSolutions = [];
            if (!appState.dgaActivities) appState.dgaActivities = [];
            
            // Set default month to current
            const now = new Date();
            const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthInput = document.getElementById('dga-month-input');
            if (monthInput) monthInput.value = monthStr;
            
            // Setup event listeners for BS form
            const addBSForm = document.getElementById('add-bs-form');
            if (addBSForm) {
                console.log('BS form found, attaching listener');
                addBSForm.onsubmit = async function(e) {
                    e.preventDefault();
                    console.log('BS form submitted');
                    const nameInput = document.getElementById('bs-name-input');
                    const name = nameInput?.value.trim();
                    
                    if (!name) {
                        showToast('Nama BS harus diisi', 'error');
                        return false;
                    }
                    
                    // Save BS directly to Firestore collection
                    try {
                        if (db && currentUser) {
                            const bsCollRef = collection(db, 'businessSolutions');
                            await addDoc(bsCollRef, {
                                name: name,
                                ownerEmail: currentUser.email,
                                createdBy: appState.currentUser || currentUser.email,
                                createdAt: new Date().toISOString()
                            });
                            console.log('✅ BS saved to Firestore collection');
                        } else {
                            // Fallback: save locally
                            const newBS = { id: Date.now(), name: name, createdBy: appState.currentUser };
                            if (!appState.businessSolutions) appState.businessSolutions = [];
                            appState.businessSolutions.push(newBS);
                            await window.saveData();
                        }
                    } catch (err) {
                        console.error('❌ Error saving BS to Firestore:', err);
                        showToast('Gagal menyimpan BS: ' + err.message, 'error');
                        return false;
                    }
                    
                    // Reset form
                    nameInput.value = '';
                    
                    showToast(`BS "${name}" berhasil ditambahkan!`, 'success');
                    
                    return false;
                };
            } else {
                console.error('add-bs-form not found');
            }
            
            // Setup event listeners for activity form
            const dgaActivityForm = document.getElementById('dga-quick-add-form');
            if (dgaActivityForm) {
                dgaActivityForm.onsubmit = window.addDGAActivity;
            }
            
            // Setup filter listeners
            const filterMonth = document.getElementById('dga-filter-month');
            const filterBS = document.getElementById('dga-filter-bs');
            
            if (filterMonth) {
                filterMonth.onchange = window.renderDGATable;
            }
            if (filterBS) {
                filterBS.onchange = window.renderDGATable;
            }
            
            // Setup realtime listener for BS changes from Firestore
            window.setupBSRealtimeListener();
            
            // Setup realtime listener for DGA activities from Firestore
            window.setupDGAActivitiesRealtimeListener();
            
            // Setup realtime listener for Stock Distributor
            window.setupStockDistributorRealtimeListener();
            
            window.refreshDGAPage();
        };

        window.refreshDGAPage = function() {
            console.log('🔄 refreshDGAPage called');
            console.log('📦 Total BS:', appState.businessSolutions?.length);
            console.log('📊 Total Activities:', appState.dgaActivities?.length);
            
            window.populateBSDropdowns();
            window.populateMonthFilter();
            window.renderDGATable();
            window.updateDGASummary();
            
            console.log('✅ refreshDGAPage completed');
        };

        window.populateBSDropdowns = function() {
            const bsInput = document.getElementById('dga-bs-input');
            const bsFilter = document.getElementById('dga-filter-bs');
            
            if (!bsInput || !bsFilter) {
                console.log('⚠️ BS dropdowns not found');
                return;
            }
            
            console.log('=== Populating BS Dropdowns ===');
            console.log('Current user:', appState.currentUser);
            console.log('Total BS:', appState.businessSolutions?.length);
            
            // Log all BS
            if (appState.businessSolutions && appState.businessSolutions.length > 0) {
                appState.businessSolutions.forEach((bs, idx) => {
                    console.log(`  BS[${idx}]: "${bs.name}" - createdBy: "${bs.createdBy}"`);
                });
            }
            
            // BS is now loaded from Firestore collection filtered by ownerEmail
            // No local filtering needed - the realtime listener already filters
            const bsList = appState.businessSolutions || [];
            
            console.log('BS count for dropdowns:', bsList.length);
            
            bsInput.innerHTML = '<option value="">Pilih BS</option>' + 
                bsList.map(bs => `<option value="${bs.id}">${bs.name}</option>`).join('');
            
            bsFilter.innerHTML = '<option value="">Semua BS</option>' + 
                bsList.map(bs => `<option value="${bs.id}">${bs.name}</option>`).join('');
        };

        window.populateMonthFilter = function() {
            const monthFilter = document.getElementById('dga-filter-month');
            if (!monthFilter) return;
            
            console.log('📅 Populating month filter, total activities:', appState.dgaActivities?.length || 0);
            
            const activities = appState.dgaActivities || [];
            
            // Get unique months from activities
            const months = [...new Set(activities.map(a => a.month))].filter(m => m).sort().reverse();
            
            monthFilter.innerHTML = '<option value="">Semua Bulan</option>' +
                months.map(m => {
                    const date = new Date(m + '-01');
                    const label = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                    return `<option value="${m}">${label}</option>`;
                }).join('');
        };

        // Save BS list - now uses Firestore collection (legacy, kept for compatibility)
        window.saveSharedBSList = async function() {
            // BS is now saved directly to 'businessSolutions' collection per-document
            // This function is kept for backward compatibility but no longer needed
            console.log('ℹ️ saveSharedBSList called - BS now saved directly to collection');
        };

        // Setup realtime listener for BS changes from Firestore collection
        let bsRealtimeUnsubscribe = null;
        let stockDistributorRealtimeUnsubscribe = null;
        
        window.setupBSRealtimeListener = function() {
            // Unsubscribe from previous listener if exists
            if (bsRealtimeUnsubscribe) {
                bsRealtimeUnsubscribe();
                console.log('🔌 Disconnected previous BS listener');
            }
            
            if (!db || !currentUser) {
                console.log('⚠️ Firestore or user not available, realtime sync disabled');
                return;
            }
            
            try {
                // Listen to businessSolutions collection filtered by ownerEmail
                const bsCollRef = collection(db, 'businessSolutions');
                const bsQuery = query(bsCollRef, where('ownerEmail', '==', currentUser.email));
                
                console.log('📡 Setting up realtime BS listener for:', currentUser.email);
                
                bsRealtimeUnsubscribe = onSnapshot(bsQuery, (snapshot) => {
                    const cloudBSList = [];
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        cloudBSList.push({
                            id: data.id || docSnap.id,
                            firestoreId: docSnap.id,
                            name: data.name,
                            ownerEmail: data.ownerEmail,
                            createdBy: data.createdBy || data.ownerEmail,
                            createdAt: data.createdAt
                        });
                    });
                    
                    console.log('🔄 BS data updated from Firestore collection:', cloudBSList.length, 'items');
                    
                    // Update appState
                    appState.businessSolutions = cloudBSList;
                    
                    // Auto-fix old activities with mismatched bsId (e.g. numeric IDs from before migration)
                    if (appState.dgaActivities && cloudBSList.length > 0) {
                        const bsNameToNewId = {};
                        cloudBSList.forEach(bs => { bsNameToNewId[bs.name] = bs.id; });
                        
                        const bsIdSet = new Set(cloudBSList.map(bs => bs.id));
                        let fixedCount = 0;
                        
                        appState.dgaActivities.forEach(a => {
                            if (a.bsName && bsNameToNewId[a.bsName] && !bsIdSet.has(String(a.bsId))) {
                                console.log(`🔧 Fixing activity bsId: "${a.bsId}" → "${bsNameToNewId[a.bsName]}" for BS "${a.bsName}"`);
                                a.bsId = bsNameToNewId[a.bsName];
                                fixedCount++;
                            }
                        });
                        
                        if (fixedCount > 0) {
                            console.log(`✅ Fixed ${fixedCount} activities with stale bsId`);
                            if (typeof saveData === 'function') saveData();
                        }
                    }
                    
                    // Refresh UI
                    if (typeof window.refreshDGAPage === 'function') {
                        window.refreshDGAPage();
                    }
                    if (typeof window.refreshPresentation === 'function') {
                        window.refreshPresentation();
                    }
                    
                    console.log('✅ BS list synced:', cloudBSList.length, 'items');
                }, (error) => {
                    console.error('❌ BS Realtime listener error:', error);
                });
                
                console.log('✅ Realtime BS collection listener activated');
                
            } catch (error) {
                console.error('❌ Failed to setup BS realtime listener:', error);
            }
        };

        // Setup realtime listener for Stock Distributor changes
        window.setupStockDistributorRealtimeListener = function() {
            // Unsubscribe from previous listener if exists
            if (stockDistributorRealtimeUnsubscribe) {
                stockDistributorRealtimeUnsubscribe();
                console.log('🔌 Disconnected previous Stock Distributor listener');
            }
            
            if (!db || !currentUser) {
                console.log('⚠️ Firestore/User not available, stock realtime sync disabled');
                console.log('  - db:', !!db);
                console.log('  - currentUser:', !!currentUser);
                return;
            }
            
            try {
                const userDocRef = doc(db, 'advantaUserData', currentUser.uid);
                
                console.log('📡 Setting up realtime Stock Distributor listener for user:', currentUser.uid);
                console.log('  - Current stockDistributor count:', (appState.stockDistributor || []).length);
                
                stockDistributorRealtimeUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        const cloudStockData = userData.data?.stockDistributor || [];
                        
                        console.log('🔄 Stock Distributor data updated from Firestore:', cloudStockData.length, 'items');
                        
                        // Update appState if different from cloud
                        const currentStockIds = (appState.stockDistributor || []).map(s => s.id).sort();
                        const cloudStockIds = cloudStockData.map(s => s.id).sort();
                        
                        if (JSON.stringify(currentStockIds) !== JSON.stringify(cloudStockIds) || 
                            JSON.stringify(appState.stockDistributor) !== JSON.stringify(cloudStockData)) {
                            console.log('✨ Applying Stock changes from cloud...');
                            console.log('  - Old stock count:', (appState.stockDistributor || []).length);
                            console.log('  - New stock count:', cloudStockData.length);
                            appState.stockDistributor = cloudStockData;
                            
                            // Refresh UI if on stock page
                            if (typeof renderStockTable === 'function') {
                                console.log('🔄 Calling renderStockTable() to refresh UI...');
                                renderStockTable();
                                console.log('✅ Stock table refreshed');
                            }
                            
                            showToast('🔄 Stok diperbarui secara realtime', 'info');
                        } else {
                            console.log('✅ Stock data already up to date');
                        }
                    } else {
                        console.log('⚠️ User document does not exist in Firestore');
                    }
                }, (error) => {
                    console.error('❌ Stock Realtime listener error:', error);
                    console.error('  - Error code:', error.code);
                    console.error('  - Error message:', error.message);
                });
                
                console.log('✅ Realtime Stock Distributor listener activated');
                
            } catch (error) {
                console.error('❌ Failed to setup realtime Stock listener:', error);
            }
        };

        // Setup realtime listener for DGA Activities
        let dgaActivitiesRealtimeUnsubscribe = null;
        
        window.setupDGAActivitiesRealtimeListener = function() {
            // Unsubscribe from previous listener if exists
            if (dgaActivitiesRealtimeUnsubscribe) {
                dgaActivitiesRealtimeUnsubscribe();
                console.log('🔌 Disconnected previous DGA activities listener');
            }
            
            if (!db) {
                console.log('⚠️ Firestore not available, DGA activities realtime sync disabled');
                return;
            }
            
            // Get current user email for filtering
            const currentUserEmail = appState.currentUser;
            if (!currentUserEmail) {
                console.log('⚠️ No user logged in, DGA activities listener not started');
                return;
            }
            
            console.log('═══════════════════════════════════════════════════');
            console.log('📡 INITIALIZING DGA ACTIVITIES REALTIME LISTENER');
            console.log('═══════════════════════════════════════════════════');
            console.log('Current user:', currentUserEmail);
            console.log('🔒 SECURE MODE: Filter by ownerEmail at Firestore level');
            console.log('═══════════════════════════════════════════════════');
            
            try {
                // SECURE QUERY: Only fetch activities belonging to current user
                const activitiesRef = collection(db, 'dgaActivities');
                const secureQuery = query(activitiesRef, where('ownerEmail', '==', currentUserEmail));
                
                console.log('📡 Setting up SECURE realtime DGA activities listener...');
                console.log('🔐 Firestore query filter: ownerEmail ==', currentUserEmail);
                
                dgaActivitiesRealtimeUnsubscribe = onSnapshot(secureQuery, (snapshot) => {
                    console.log('🔄 DGA activities updated from Firestore:', snapshot.size, 'documents (filtered by ownerEmail)');
                    
                    const cloudActivities = [];
                    
                    snapshot.forEach((docSnapshot) => {
                        const data = docSnapshot.data();
                        
                        console.log('✅ Activity from Firestore:', {
                            id: docSnapshot.id,
                            bsName: data.bsName,
                            type: data.type,
                            week: data.week,
                            month: data.month,
                            ownerEmail: data.ownerEmail
                        });
                        
                        cloudActivities.push({
                            firestoreId: docSnapshot.id,
                            ...data
                        });
                    });
                    
                    console.log('📥 Received:', cloudActivities.length, 'activities (all owned by current user)');
                    console.log('📦 Sample activities:', cloudActivities.slice(0, 3));
                    
                    // Merge with local activities (keep ones not from public form)
                    const localActivities = appState.dgaActivities || [];
                    const localOnlyActivities = localActivities.filter(local => 
                        !local.source || local.source !== 'public-form'
                    );
                    
                    console.log('💾 Local activities (not from public form):', localOnlyActivities.length);
                    
                    // Combine: local activities + filtered cloud activities
                    const previousTotal = appState.dgaActivities.length;
                    appState.dgaActivities = [...localOnlyActivities, ...cloudActivities];
                    
                    console.log('✨ Total activities after merge:', appState.dgaActivities.length);
                    console.log('📊 Breakdown:', {
                        local: localOnlyActivities.length,
                        fromPublicForm: cloudActivities.length,
                        total: appState.dgaActivities.length
                    });
                    
                    // Save merged data locally
                    if (typeof saveData === 'function') {
                        saveData();
                    }
                    
                    // Refresh UI
                    console.log('🔄 Refreshing DGA page...');
                    if (typeof window.refreshDGAPage === 'function') {
                        window.refreshDGAPage();
                    }
                    
                    // Show notification only if new data arrived
                    const newDataCount = cloudActivities.length;
                    if (newDataCount > 0) {
                        const message = previousTotal === appState.dgaActivities.length 
                            ? `🔄 ${newDataCount} aktivitas dari public form (tidak ada perubahan)`
                            : `🔄 Data diperbarui! ${cloudActivities.length} aktivitas dari public form`;
                        showToast(message, 'success');
                    }
                    
                }, (error) => {
                    console.error('❌ DGA activities realtime listener error:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                });
                
                console.log('✅ Realtime DGA activities listener activated');
                
            } catch (error) {
                console.error('❌ Failed to setup DGA activities realtime listener:', error);
            }
        };

        window.addBS = async function(e) {
            e.preventDefault();
            const nameInput = document.getElementById('bs-name-input');
            
            if (!nameInput) {
                console.error('bs-name-input not found');
                return;
            }
            
            const name = nameInput.value.trim();
            if (!name) {
                showToast('Nama BS harus diisi', 'error');
                return;
            }
            
            // Save BS directly to Firestore collection
            try {
                if (db && currentUser) {
                    const bsCollRef = collection(db, 'businessSolutions');
                    await addDoc(bsCollRef, {
                        name: name,
                        ownerEmail: currentUser.email,
                        createdBy: appState.currentUser || currentUser.email,
                        createdAt: new Date().toISOString()
                    });
                    console.log('✅ BS saved to Firestore collection (batch add)');
                } else {
                    // Fallback: save locally
                    const newBS = { id: Date.now(), name: name, createdBy: appState.currentUser };
                    if (!appState.businessSolutions) appState.businessSolutions = [];
                    appState.businessSolutions.push(newBS);
                    await saveData();
                }
            } catch (err) {
                console.error('❌ Error saving BS to Firestore:', err);
                showToast('Gagal menyimpan BS: ' + err.message, 'error');
                return;
            }
            
            // Reset form
            nameInput.value = '';
            nameInput.focus();
            
            showToast(`BS "${name}" berhasil ditambahkan!`, 'success');
        };

        window.deleteBS = async function(bsId) {
            const bs = appState.businessSolutions?.find(b => b.id === bsId || b.firestoreId === bsId);
            if (!bs) {
                showToast('BS tidak ditemukan', 'error');
                return;
            }

            // Check if BS has activities
            const hasActivities = appState.dgaActivities?.some(act => act.bsId === bsId || act.bsId === bs.id);
            
            if (hasActivities) {
                const confirmMsg = `BS "${bs.name}" memiliki kegiatan. Hapus BS beserta semua kegiatannya?`;
                if (!confirm(confirmMsg)) return;
                
                // Delete all activities for this BS from Firestore
                if (db) {
                    try {
                        const actRef = collection(db, 'dgaActivities');
                        const actQuery = query(actRef, where('bsId', '==', bs.id || bsId));
                        const actSnap = await getDocs(actQuery);
                        for (const actDoc of actSnap.docs) {
                            await deleteDoc(actDoc.ref);
                        }
                        console.log('🗑️ Deleted', actSnap.size, 'activities for BS');
                    } catch (e) {
                        console.error('Error deleting BS activities:', e);
                    }
                }
                appState.dgaActivities = appState.dgaActivities.filter(act => act.bsId !== bsId && act.bsId !== bs.id);
            } else {
                const confirmMsg = `Hapus BS "${bs.name}"?`;
                if (!confirm(confirmMsg)) return;
            }
            
            // Delete from Firestore collection
            if (db && bs.firestoreId) {
                try {
                    const bsDocRef = doc(db, 'businessSolutions', bs.firestoreId);
                    await deleteDoc(bsDocRef);
                    console.log('✅ BS deleted from Firestore collection');
                } catch (e) {
                    console.error('Error deleting BS from Firestore:', e);
                }
            }
            
            // Remove BS from local list
            appState.businessSolutions = appState.businessSolutions.filter(b => b.id !== bsId && b.firestoreId !== bsId);
            await saveData();
            
            window.refreshDGAPage();
            showToast(`BS "${bs.name}" berhasil dihapus!`, 'success');
        };

        // Remove old addBS function - now inline in initDGAPage

        window.addDGAActivity = function(e) {
            e.preventDefault();
            
            const month = document.getElementById('dga-month-input')?.value;
            const week = document.getElementById('dga-week-input')?.value;
            const bsId = document.getElementById('dga-bs-input')?.value;
            const type = document.getElementById('dga-activity-type-input')?.value;
            const description = document.getElementById('dga-description-input')?.value.trim();
            
            if (!month || !week || !bsId || !type) {
                showToast('Mohon lengkapi semua field yang wajib', 'error');
                return;
            }
            
            const bs = appState.businessSolutions.find(b => b.id == bsId);
            
            const newActivity = {
                id: Date.now(),
                month: month,
                week: parseInt(week),
                bsId: bsId,
                bsName: bs ? bs.name : '',
                type: type,
                description: description || ''
            };
            
            // Set createdBy only if currentUser is available
            if (appState.currentUser) {
                newActivity.createdBy = appState.currentUser;
            } else {
                console.warn('⚠️ appState.currentUser is not set! Activity will be created without owner.');
            }
            
            if (!appState.dgaActivities) appState.dgaActivities = [];
            appState.dgaActivities.push(newActivity);
            
            console.log('✅ DGA Activity added:', newActivity);
            console.log('📊 Total activities now:', appState.dgaActivities.length);
            console.log('👤 Current user:', appState.currentUser);
            
            saveData();
            window.refreshDGAPage();
            
            // Reset form but keep month
            document.getElementById('dga-week-input').value = '';
            document.getElementById('dga-activity-type-input').value = '';
            document.getElementById('dga-description-input').value = '';
            
            showToast('Kegiatan berhasil ditambahkan', 'success');
        };

        window.renderDGATable = function() {
            const tbody = document.getElementById('dga-weekly-table-body');
            if (!tbody) return;

            const filterMonth = document.getElementById('dga-filter-month')?.value || '';
            const filterBS = document.getElementById('dga-filter-bs')?.value || '';

            // Debug log
            console.log('=== Rendering DGA Table ===');
            console.log('Total activities in appState:', appState.dgaActivities?.length);
            console.log('Current user:', appState.currentUser);
            
            // Log first 10 activities for debugging
            if (appState.dgaActivities && appState.dgaActivities.length > 0) {
                console.log('First 10 activities:');
                appState.dgaActivities.slice(0, 10).forEach((a, idx) => {
                    console.log(`  [${idx}] BS: "${a.bsName}" (ID: ${a.bsId}), type: ${a.type}, week: ${a.week}, month: ${a.month}, createdBy: "${a.createdBy}"`);
                });
            } else {
                console.log('⚠️ NO ACTIVITIES FOUND in appState.dgaActivities!');
            }

            let activities = (appState.dgaActivities || []).filter(a => {
                const match = a.createdBy === appState.currentUser || 
                    a.createdBy === undefined || 
                    a.createdBy === 'unknown' ||
                    !appState.currentUser;
                    
                if (!match && appState.dgaActivities.length <= 10) {
                    console.log(`  ❌ Filtered out activity: BS="${a.bsName}", createdBy="${a.createdBy}" (current: "${appState.currentUser}")`);
                }
                
                return match;
            });
            
            console.log('After user filter:', activities.length, 'activities');
            
            // Apply filters
            if (filterMonth) {
                activities = activities.filter(a => a.month === filterMonth);
                console.log('After month filter:', activities.length);
            }
            if (filterBS) {
                activities = activities.filter(a => a.bsId == filterBS);
                console.log('After BS filter:', activities.length);
            }

            // Initialize bsMap with business solutions created by current user
            const bsMap = {};
            const allBS = (appState.businessSolutions || []).filter(bs => 
                bs.createdBy === appState.currentUser || 
                bs.createdBy === undefined || 
                bs.createdBy === 'unknown' ||
                !appState.currentUser
            );
            
            console.log('Total BS:', appState.businessSolutions?.length, 'Filtered BS:', allBS.length);
            
            // Add user's BS to map even if they have no activities yet
            allBS.forEach(bs => {
                // Skip BS if filter is active and doesn't match
                if (filterBS && bs.id != filterBS) return;
                
                bsMap[bs.id] = {
                    id: bs.id,
                    name: bs.name,
                    weeks: { '1': [], '2': [], '3': [], '4': [], '5': [] }
                };
            });
            
            // Then add activities to their BS
            activities.forEach(activity => {
                let targetKey = activity.bsId;
                
                if (!bsMap[targetKey]) {
                    // bsId not found — try matching by bsName (handles old numeric IDs after migration)
                    const matchByName = Object.values(bsMap).find(bs => bs.name === activity.bsName);
                    if (matchByName) {
                        targetKey = matchByName.id;
                        console.log(`🔧 Activity bsId "${activity.bsId}" matched to BS "${matchByName.name}" (id: ${matchByName.id}) by name`);
                    } else {
                        // Truly orphaned activity — create placeholder
                        bsMap[targetKey] = {
                            id: targetKey,
                            name: activity.bsName,
                            weeks: { '1': [], '2': [], '3': [], '4': [], '5': [] }
                        };
                    }
                }
                if (!bsMap[targetKey].weeks[activity.week]) {
                    bsMap[targetKey].weeks[activity.week] = [];
                }
                bsMap[targetKey].weeks[activity.week].push(activity);
            });

            tbody.innerHTML = '';
            
            const bsList = Object.values(bsMap);
            if (bsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-12 text-center text-gray-700"><div class="flex flex-col items-center gap-2"><svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="font-bold text-gray-800">Belum ada BS</p><p class="text-sm text-gray-600">Tambahkan BS terlebih dahulu</p></div></td></tr>';
                return;
            }

            bsList.forEach(bs => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition';
                
                let rowHTML = `<td class="px-4 py-4 font-extrabold text-gray-900 border-r-2 border-gray-400 bg-white sticky left-0 z-10">
                    <div class="flex items-center gap-2 justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 shadow-sm"></div>
                            <span class="text-sm">${bs.name}</span>
                        </div>
                        <button 
                            onclick="deleteBS(${bs.id})" 
                            class="ml-2 text-red-600 hover:text-red-800 hover:bg-red-50 p-1.5 rounded-lg transition-all duration-200 group"
                            title="Hapus BS"
                        >
                            <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </td>`;

                // Render each week (W1-W5)
                const weekColors = {
                    '1': 'bg-blue-50 border-blue-100',
                    '2': 'bg-green-50 border-green-100',
                    '3': 'bg-yellow-50 border-yellow-100',
                    '4': 'bg-purple-50 border-purple-100',
                    '5': 'bg-pink-50 border-pink-100'
                };

                const badgeColors = {
                    'FM': 'bg-blue-600 text-white',
                    'ODP': 'bg-green-600 text-white',
                    'FT': 'bg-yellow-500 text-gray-900',
                    'FFD': 'bg-purple-600 text-white',
                    'DISPLAY': 'bg-pink-600 text-white'
                };

                for (let week = 1; week <= 5; week++) {
                    const weekActivities = bs.weeks[week.toString()] || [];
                    const cellClass = weekColors[week.toString()];
                    
                    if (weekActivities.length === 0) {
                        rowHTML += `<td class="px-4 py-4 text-center ${cellClass} border-r border-gray-200">
                            <span class="text-sm text-gray-700 font-extrabold">-</span>
                        </td>`;
                    } else {
                        // Aggregate activities by type
                        const typeCounts = {};
                        weekActivities.forEach(activity => {
                            const count = activity.count || 1; // Use activity.count if exists, else 1
                            if (!typeCounts[activity.type]) {
                                typeCounts[activity.type] = {
                                    count: 0,
                                    ids: [],
                                    descriptions: []
                                };
                            }
                            typeCounts[activity.type].count += count;
                            typeCounts[activity.type].ids.push(activity.id);
                            if (activity.description) {
                                typeCounts[activity.type].descriptions.push(activity.description);
                            }
                        });
                        
                        rowHTML += `<td class="px-3 py-3 ${cellClass} border-r border-gray-200">
                            <div class="flex flex-wrap gap-1.5 justify-center">`;
                        
                        // Display compact format: "FM 3", "FT 1", etc
                        Object.entries(typeCounts).forEach(([type, data]) => {
                            const badgeColor = badgeColors[type] || 'bg-gray-500 text-white';
                            const tooltip = data.descriptions.length > 0 
                                ? data.descriptions.join(', ') 
                                : 'Tidak ada keterangan';
                            
                            rowHTML += `
                                <div class="inline-flex items-center gap-1 group relative">
                                    <span class="inline-block px-3 py-1.5 ${badgeColor} rounded-lg text-sm font-extrabold shadow-md">${type} ${data.count}</span>
                                    <button onclick="window.deleteDGAActivitiesByIds([${data.ids.join(',')}])" 
                                            class="text-red-600 hover:text-red-800 hover:bg-red-50 rounded-full p-1 transition"
                                            title="Hapus semua ${type}">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                        </svg>
                                    </button>
                                    <div class="hidden group-hover:block absolute bottom-full left-0 mb-1 px-2 py-1 bg-gray-900 text-white text-xs rounded whitespace-nowrap z-10 shadow-lg">
                                        ${tooltip}
                                    </div>
                                </div>`;
                        });
                        
                        rowHTML += `</div></td>`;
                    }
                }

                // Calculate total for all weeks
                const totalCounts = {};
                for (let week = 1; week <= 5; week++) {
                    const weekActivities = bs.weeks[week.toString()] || [];
                    weekActivities.forEach(activity => {
                        const count = activity.count || 1;
                        if (!totalCounts[activity.type]) {
                            totalCounts[activity.type] = 0;
                        }
                        totalCounts[activity.type] += count;
                    });
                }

                // Display total column
                rowHTML += `<td class="px-4 py-4 bg-gradient-to-br from-orange-100 to-yellow-100 border-l-4 border-orange-500 font-semibold shadow-inner">
                    <div class="flex flex-wrap gap-2 justify-center">`;
                
                if (Object.keys(totalCounts).length === 0) {
                    rowHTML += `<span class="text-base text-gray-800 font-extrabold">-</span>`;
                } else {
                    Object.entries(totalCounts).forEach(([type, count]) => {
                        const badgeColor = badgeColors[type] || 'bg-gray-500 text-white';
                        rowHTML += `<span class="inline-block px-4 py-2 ${badgeColor} rounded-lg text-base font-black shadow-lg border-2 border-black/20">${type} ${count}</span>`;
                    });
                }
                
                rowHTML += `</div></td>`;

                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
            
            window.updateDGASummary();
        };

        window.updateDGASummary = function() {
            // Filter by current user first
            let activities = (appState.dgaActivities || []).filter(a => 
                a.createdBy === appState.currentUser || 
                a.createdBy === undefined || 
                a.createdBy === 'unknown' ||
                !appState.currentUser
            );
            
            console.log('📊 updateDGASummary: Total activities after user filter:', activities.length);
            
            // Get filter values
            const filterMonth = document.getElementById('dga-filter-month')?.value || '';
            const filterBS = document.getElementById('dga-filter-bs')?.value || '';
            
            // Filter activities
            let filtered = activities;
            if (filterMonth) filtered = filtered.filter(a => a.month === filterMonth);
            if (filterBS) filtered = filtered.filter(a => a.bsId == filterBS);
            
            console.log('📊 After month/BS filters:', filtered.length);
            
            // Count by type
            const counts = {
                'FM': 0,
                'ODP': 0,
                'FT': 0,
                'FFD': 0,
                'DISPLAY': 0
            };
            
            filtered.forEach(a => {
                const activityCount = a.count || 1;
                if (counts[a.type] !== undefined) counts[a.type] += activityCount;
            });
            
            // Calculate Farmer Reach using master data multipliers
            const multipliers = appState.farmerReachMultipliers || { FM: 25, ODP: 25, FT: 20, FFD: 60, DISPLAY: 0 };
            const farmerReach = (counts['FM'] * multipliers.FM) + 
                                (counts['ODP'] * multipliers.ODP) + 
                                (counts['FT'] * multipliers.FT) + 
                                (counts['FFD'] * multipliers.FFD);
            
            const fmEl = document.getElementById('dga-count-fm');
            const odpEl = document.getElementById('dga-count-odp');
            const ftEl = document.getElementById('dga-count-ft');
            const ffdEl = document.getElementById('dga-count-ffd');
            const displayEl = document.getElementById('dga-count-display');
            const farmerReachEl = document.getElementById('dga-farmer-reach');
            
            if (fmEl) fmEl.textContent = counts['FM'];
            if (odpEl) odpEl.textContent = counts['ODP'];
            if (ftEl) ftEl.textContent = counts['FT'];
            if (ffdEl) ffdEl.textContent = counts['FFD'];
            if (displayEl) displayEl.textContent = counts['DISPLAY'];
            if (farmerReachEl) farmerReachEl.textContent = farmerReach.toLocaleString('id-ID');
        };

        window.deleteDGAActivity = async function(id) {
            if (!confirm('Hapus kegiatan ini?')) return;
            
            // Cari activity yang akan dihapus untuk mendapatkan firestoreId
            const activityToDelete = appState.dgaActivities.find(a => a.id === id);
            
            // Hapus dari Firestore jika ada firestoreId
            if (activityToDelete && activityToDelete.firestoreId && window.db && window.deleteDoc && window.doc) {
                try {
                    await window.deleteDoc(window.doc(window.db, 'dgaActivities', activityToDelete.firestoreId));
                    console.log('✅ Deleted from Firestore:', activityToDelete.firestoreId);
                } catch (e) {
                    console.error('❌ Error deleting from Firestore:', e);
                }
            }
            
            appState.dgaActivities = appState.dgaActivities.filter(a => a.id !== id);
            saveData();
            window.refreshDGAPage();
            showToast('Kegiatan berhasil dihapus', 'success');
        };

        window.deleteDGAActivitiesByIds = async function(ids) {
            if (!confirm(`Hapus semua kegiatan ini (${ids.length} item)?`)) return;
            
            // Cari activities yang akan dihapus untuk mendapatkan firestoreId
            const activitiesToDelete = appState.dgaActivities.filter(a => ids.includes(a.id));
            let deletedCount = 0;
            
            // Hapus dari Firestore jika ada firestoreId
            if (window.db && window.deleteDoc && window.doc) {
                for (const activity of activitiesToDelete) {
                    if (activity.firestoreId) {
                        try {
                            await window.deleteDoc(window.doc(window.db, 'dgaActivities', activity.firestoreId));
                            deletedCount++;
                            console.log('✅ Deleted from Firestore:', activity.firestoreId);
                        } catch (e) {
                            console.error('❌ Error deleting from Firestore:', e);
                        }
                    }
                }
            }
            
            appState.dgaActivities = appState.dgaActivities.filter(a => !ids.includes(a.id));
            saveData();
            window.refreshDGAPage();
            showToast(`${deletedCount > 0 ? deletedCount : ids.length} kegiatan berhasil dihapus`, 'success');
        };

        // === DEBUG INFO MODAL ===
        window.claimAllData = async function() {
            if (!appState.currentUser) {
                alert('❌ Current user tidak ter-set! Refresh page dulu.');
                return;
            }
            
            if (!confirm(`Apakah Anda yakin ingin claim SEMUA data (BS dan DGA Activities) untuk user: ${appState.currentUser}?\n\nIni akan mengubah createdBy semua data menjadi milik Anda.`)) {
                return;
            }
            
            let claimedBS = 0;
            let claimedActivities = 0;
            
            // Claim all BS
            if (Array.isArray(appState.businessSolutions)) {
                appState.businessSolutions.forEach(bs => {
                    if (bs.createdBy !== appState.currentUser) {
                        bs.createdBy = appState.currentUser;
                        claimedBS++;
                    }
                });
            }
            
            // Claim all DGA activities
            if (Array.isArray(appState.dgaActivities)) {
                appState.dgaActivities.forEach(activity => {
                    if (activity.createdBy !== appState.currentUser) {
                        activity.createdBy = appState.currentUser;
                        claimedActivities++;
                    }
                });
            }
            
            // Save changes
            await saveData();
            await window.saveSharedBSList();
            
            alert(`✅ Data berhasil di-claim!\n\n📦 BS: ${claimedBS} claimed\n📊 DGA Activities: ${claimedActivities} claimed\n\nSilakan refresh page untuk melihat perubahan.`);
            
            window.location.reload();
        };
        
        window.showDebugInfo = function() {
            const totalBS = appState.businessSolutions?.length || 0;
            const totalActivities = appState.dgaActivities?.length || 0;
            const currentUserEmail = appState.currentUser || 'NOT SET';
            
            // Check localStorage for data
            const allKeys = Object.keys(localStorage).filter(k => k.includes('advanta'));
            let localStorageInfo = '<div class="text-xs space-y-1">';
            if (allKeys.length > 0) {
                allKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    let size = 0;
                    if (value) {
                        try {
                            const parsed = JSON.parse(value);
                            size = parsed.dgaActivities?.length || 0;
                        } catch(e) {}
                    }
                    localStorageInfo += `<div class="text-gray-600"><b>${key}:</b> ${size} activities</div>`;
                });
            } else {
                localStorageInfo += '<div class="text-gray-500">No localStorage data found</div>';
            }
            localStorageInfo += '</div>';
            
            // Filter BS by current user
            const filteredBS = (appState.businessSolutions || []).filter(bs => 
                bs.createdBy === appState.currentUser || 
                bs.createdBy === undefined || 
                bs.createdBy === 'unknown' ||
                !appState.currentUser
            );
            
            // Filter activities by current user
            const filteredActivities = (appState.dgaActivities || []).filter(a => 
                a.createdBy === appState.currentUser || 
                a.createdBy === undefined || 
                a.createdBy === 'unknown' ||
                !appState.currentUser
            );
            
            // Get BS details
            let bsDetails = '<div class="space-y-1">';
            if (appState.businessSolutions && appState.businessSolutions.length > 0) {
                appState.businessSolutions.forEach((bs, idx) => {
                    const isIncluded = filteredBS.includes(bs);
                    bsDetails += `<div class="flex items-center gap-2 text-xs ${isIncluded ? 'text-green-700' : 'text-red-500'}">
                        <span class="font-mono">${isIncluded ? '✅' : '❌'}</span>
                        <span class="font-bold">${bs.name}</span>
                        <span class="text-gray-500">(createdBy: ${bs.createdBy || 'undefined'})</span>
                    </div>`;
                });
            } else {
                bsDetails += '<div class="text-gray-500 text-xs">Tidak ada BS</div>';
            }
            bsDetails += '</div>';
            
            // Get activities sample
            let activitiesSample = '<div class="space-y-1">';
            if (appState.dgaActivities && appState.dgaActivities.length > 0) {
                appState.dgaActivities.slice(0, 10).forEach((a, idx) => {
                    const isIncluded = filteredActivities.includes(a);
                    activitiesSample += `<div class="flex items-center gap-2 text-xs ${isIncluded ? 'text-green-700' : 'text-red-500'}">
                        <span class="font-mono">${isIncluded ? '✅' : '❌'}</span>
                        <span><b>${a.bsName}</b> - ${a.type} - W${a.week} - ${a.month}</span>
                        <span class="text-gray-500">(createdBy: ${a.createdBy || 'undefined'})</span>
                    </div>`;
                });
                if (appState.dgaActivities.length > 10) {
                    activitiesSample += `<div class="text-gray-500 text-xs italic">... dan ${appState.dgaActivities.length - 10} lainnya</div>`;
                }
            } else {
                activitiesSample += '<div class="text-gray-500 text-xs">Tidak ada aktivitas</div>';
            }
            activitiesSample += '</div>';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[9999]';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-t-xl">
                        <h3 class="text-2xl font-bold flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Debug Information
                        </h3>
                        <p class="text-orange-100 text-sm mt-1">Status data aplikasi saat ini</p>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <!-- Summary -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-200">
                            <h4 class="font-bold text-lg text-blue-900 mb-3">📊 Ringkasan</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <div class="text-gray-600 text-xs mb-1">Current User</div>
                                    <div class="font-bold text-lg ${currentUserEmail === 'NOT SET' ? 'text-red-600' : 'text-green-600'}">${currentUserEmail}</div>
                                </div>
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <div class="text-gray-600 text-xs mb-1">Total BS</div>
                                    <div class="font-bold text-lg">${totalBS} <span class="text-sm text-gray-500">(${filteredBS.length} visible)</span></div>
                                </div>
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <div class="text-gray-600 text-xs mb-1">Total DGA Activities</div>
                                    <div class="font-bold text-lg ${totalActivities === 0 ? 'text-red-600' : 'text-green-600'}">${totalActivities} <span class="text-sm text-gray-500">(${filteredActivities.length} visible)</span></div>
                                </div>
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <div class="text-gray-600 text-xs mb-1">Login Status</div>
                                    <div class="font-bold text-lg ${currentUser ? 'text-green-600' : 'text-red-600'}">${currentUser ? '✅ Logged In' : '❌ Not Logged'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BS List -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-lg text-gray-900 mb-3">📦 Business Solutions (${totalBS})</h4>
                            <div class="max-h-48 overflow-y-auto bg-gray-50 rounded p-3">
                                ${bsDetails}
                            </div>
                        </div>
                        
                        <!-- Activities Sample -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-lg text-gray-900 mb-3">📋 DGA Activities Sample (10 pertama dari ${totalActivities})</h4>
                            <div class="max-h-64 overflow-y-auto bg-gray-50 rounded p-3">
                                ${activitiesSample}
                            </div>
                        </div>
                        
                        <!-- LocalStorage Info -->
                        <div class="border-2 border-yellow-300 rounded-lg p-4 bg-yellow-50">
                            <h4 class="font-bold text-lg text-gray-900 mb-3">💾 LocalStorage Keys</h4>
                            <div class="bg-white rounded p-3">
                                ${localStorageInfo}
                            </div>
                            <p class="text-xs text-gray-600 mt-2">Data mungkin tersimpan dengan key berbeda. Jika ada key dengan activities > 0, gunakan tombol "Fix Data" untuk restore.</p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex flex-col gap-3">
                            ${totalActivities === 0 && totalBS > 0 ? `
                            <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                                <h4 class="font-bold text-red-900 mb-2">⚠️ Data Tidak Muncul?</h4>
                                <p class="text-sm text-red-800 mb-3">
                                    BS ada (${totalBS}) tapi DGA Activities kosong (0). 
                                    Data mungkin ter-assign ke user lain atau tersimpan dengan createdBy yang salah.
                                </p>
                                <p class="text-xs text-red-700 mb-3">
                                    <strong>Solusi:</strong> Klik tombol "Claim All My Data" untuk mengambil alih semua data dan assign ke akun Anda.
                                </p>
                                <button onclick="claimAllData()" class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition">
                                    🔒 Claim All My Data
                                </button>
                            </div>
                            ` : ''}
                            <div class="flex gap-3">
                                <button onclick="this.closest('.fixed').remove()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition">
                                    Tutup
                                </button>
                                <button onclick="window.location.reload()" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition">
                                    🔄 Refresh Page
                                </button>
                            </div>
                            ${totalActivities === 0 ? `
                            <button onclick="alert('Fitur ini akan mencoba restore data dari localStorage. Klik Refresh Page terlebih dahulu, lalu coba tambah aktivitas baru. Jika masih kosong, berarti data belum pernah tersimpan.'); this.closest('.fixed').remove();" class="w-full px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-bold transition">
                                ⚠️ Tidak Ada Data - Klik untuk Tips
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on click outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        };

        // === BATCH INPUT MODAL FUNCTIONS ===
        window.openBatchInputModal = function() {
            const modal = document.getElementById('batch-input-modal');
            if (!modal) return;
            
            // Reset form
            document.getElementById('batch-month').value = new Date().toISOString().substr(0, 7);
            document.getElementById('batch-bs').value = '';
            document.getElementById('batch-input-tbody').innerHTML = '';
            
            // Populate BS dropdown - only show BS created by current user
            const bsSelect = document.getElementById('batch-bs');
            bsSelect.innerHTML = '<option value="">Pilih BS</option>';
            const allBS = (appState.businessSolutions || []).filter(bs => 
                bs.createdBy === appState.currentUser || 
                bs.createdBy === undefined || 
                bs.createdBy === 'unknown' ||
                !appState.currentUser
            );
            allBS.forEach(bs => {
                const opt = document.createElement('option');
                opt.value = bs.id;
                opt.textContent = bs.name;
                bsSelect.appendChild(opt);
            });
            
            // Add initial row
            addBatchRow();
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.bg-white').classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        // === PUBLIC DGA FORM FUNCTIONS ===
        window.openPublicDGAModal = function() {
            // Generate proper public form URL with owner parameter
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            const portPart = port ? `:${port}` : '';
            const basePath = window.location.pathname.replace('/index.html', '').replace(/\/$/, '');
            const ownerEmail = currentUser?.email || appState.currentUser || '';
            const publicURL = `${protocol}//${hostname}${portPart}${basePath}/?page=public-dga&owner=${encodeURIComponent(ownerEmail)}`;
            
            console.log('Generated Public URL:', publicURL);
            
            // Show modal with link
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full transform scale-95 opacity-0 transition-all" id="link-modal-content">
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-5 rounded-t-2xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                                    Link Public Form BS
                                </h3>
                                <p class="text-green-100 text-sm mt-1">Share link ini ke BS untuk input kegiatan batch</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white/20 rounded-lg p-2 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-2">🔗 Link Public Form:</label>
                            <div class="flex gap-2">
                                <input type="text" id="public-url-input" value="${publicURL}" readonly class="flex-1 px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded-lg text-sm font-mono" onclick="this.select()">
                                <button onclick="copyPublicLink()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                    Copy
                                </button>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4">
                            <h4 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Cara Menggunakan:
                            </h4>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-blue-800">
                                <li>Copy link di atas dengan klik tombol "Copy"</li>
                                <li>Share link ke BS melalui WhatsApp, Email, atau chat lainnya</li>
                                <li>BS buka link tersebut di browser mereka</li>
                                <li>BS pilih nama mereka sendiri dari dropdown</li>
                                <li>BS isi kegiatan batch mereka (bisa banyak sekaligus)</li>
                                <li>Setelah submit, data otomatis masuk ke sistem Anda! ✅</li>
                            </ol>
                        </div>
                        <div class="mt-4 flex gap-3">
                            <button onclick="shareViaWhatsApp()" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-lg">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                                Share via WhatsApp
                            </button>
                            <button onclick="window.open('${publicURL}', '_blank')" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-xl font-bold transition flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                Buka Form (Preview)
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-xl font-bold transition">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                const content = document.getElementById('link-modal-content');
                if (content) {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        };

        window.copyPublicLink = function() {
            const input = document.getElementById('public-url-input');
            input.select();
            document.execCommand('copy');
            
            showToast('Link berhasil di-copy! 📋', 'success');
        };

        window.shareViaWhatsApp = function() {
            const input = document.getElementById('public-url-input');
            let linkText = input.value;
            
            console.log('Sharing URL via WhatsApp:', linkText);
            
            // Ensure we have a valid URL
            if (!linkText || linkText === '') {
                alert('Link tidak tersedia');
                return;
            }
            
            const message = `Halo! Silakan isi form kegiatan DGA melalui link berikut:\n\n${linkText}\n\nTerima kasih!`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            
            console.log('WhatsApp URL:', whatsappUrl);
            window.open(whatsappUrl, '_blank');
        };

        // === BATCH INPUT MODAL FUNCTIONS (Duplicate - consider removing) ===
        window.openBatchInputModal = function() {
            const modal = document.getElementById('batch-input-modal');
            if (!modal) return;
            
            // Reset form
            document.getElementById('batch-month').value = new Date().toISOString().substr(0, 7);
            document.getElementById('batch-bs').value = '';
            document.getElementById('batch-input-tbody').innerHTML = '';
            
            // Populate BS dropdown - only show BS created by current user
            const bsSelect = document.getElementById('batch-bs');
            bsSelect.innerHTML = '<option value="">Pilih BS</option>';
            const allBS = (appState.businessSolutions || []).filter(bs => 
                bs.createdBy === appState.currentUser || 
                bs.createdBy === undefined || 
                bs.createdBy === 'unknown' ||
                !appState.currentUser
            );
            allBS.forEach(bs => {
                const opt = document.createElement('option');
                opt.value = bs.id;
                opt.textContent = bs.name;
                bsSelect.appendChild(opt);
            });
            
            // Add initial row
            addBatchRow();
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.bg-white').classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeBatchInputModal = function() {
            const modal = document.getElementById('batch-input-modal');
            if (!modal) return;
            
            modal.querySelector('.bg-white').classList.add('scale-95', 'opacity-0');
            modal.querySelector('.bg-white').classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        window.addBatchRow = function() {
            const tbody = document.getElementById('batch-input-tbody');
            if (!tbody) return;
            
            const rowCount = tbody.querySelectorAll('tr').length;
            const weekNum = (rowCount % 5) + 1; // Cycle through W1-W5
            
            const tr = document.createElement('tr');
            tr.className = 'group hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200';
            
            const weekColors = {
                1: 'bg-blue-50/50 dark:bg-blue-900/20',
                2: 'bg-green-50/50 dark:bg-green-900/20',
                3: 'bg-yellow-50/50 dark:bg-yellow-900/20',
                4: 'bg-purple-50/50 dark:bg-purple-900/20',
                5: 'bg-pink-50/50 dark:bg-pink-900/20'
            };
            
            tr.innerHTML = `
                <td class="px-3 py-3 border-b dark:border-gray-700 ${weekColors[weekNum]}">
                    <select class="week-select w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-bold text-gray-900 dark:text-white dark:bg-gray-700 bg-white text-sm transition-all cursor-pointer">
                        <option value="1" ${weekNum === 1 ? 'selected' : ''}>W1</option>
                        <option value="2" ${weekNum === 2 ? 'selected' : ''}>W2</option>
                        <option value="3" ${weekNum === 3 ? 'selected' : ''}>W3</option>
                        <option value="4" ${weekNum === 4 ? 'selected' : ''}>W4</option>
                        <option value="5" ${weekNum === 5 ? 'selected' : ''}>W5</option>
                    </select>
                </td>
                <td class="px-2 py-3 border-b dark:border-gray-700 bg-blue-50/50 dark:bg-blue-900/20">
                    <input type="number" min="0" value="0" class="fm-input w-full px-2 py-2 border-2 border-blue-300 dark:border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center font-bold text-base text-blue-900 dark:!text-white dark:bg-gray-800 bg-white transition-all" placeholder="0">
                </td>
                <td class="px-2 py-3 border-b dark:border-gray-700 bg-green-50/50 dark:bg-green-900/20">
                    <input type="number" min="0" value="0" class="odp-input w-full px-2 py-2 border-2 border-green-300 dark:border-green-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-center font-bold text-base text-green-900 dark:!text-white dark:bg-gray-800 bg-white transition-all" placeholder="0">
                </td>
                <td class="px-2 py-3 border-b dark:border-gray-700 bg-yellow-50/50 dark:bg-yellow-900/20">
                    <input type="number" min="0" value="0" class="ft-input w-full px-2 py-2 border-2 border-yellow-300 dark:border-yellow-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 text-center font-bold text-base text-yellow-900 dark:!text-white dark:bg-gray-800 bg-white transition-all" placeholder="0">
                </td>
                <td class="px-2 py-3 border-b dark:border-gray-700 bg-purple-50/50 dark:bg-purple-900/20">
                    <input type="number" min="0" value="0" class="ffd-input w-full px-2 py-2 border-2 border-purple-300 dark:border-purple-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-center font-bold text-base text-purple-900 dark:!text-white dark:bg-gray-800 bg-white transition-all" placeholder="0">
                </td>
                <td class="px-2 py-3 border-b dark:border-gray-700 bg-pink-50/50 dark:bg-pink-900/20">
                    <input type="number" min="0" value="0" class="display-input w-full px-2 py-2 border-2 border-pink-300 dark:border-pink-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-center font-bold text-base text-pink-900 dark:!text-white dark:bg-gray-800 bg-white transition-all" placeholder="0">
                </td>
                <td class="px-3 py-3 border-b dark:border-gray-700">
                    <input type="text" class="desc-input w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 text-sm font-medium text-gray-900 dark:text-white dark:bg-gray-700 bg-white transition-all" placeholder="Keterangan">
                </td>
                <td class="px-2 py-3 border-b dark:border-gray-700 text-center">
                    <button onclick="removeBatchRow(this)" class="p-2 text-red-500 dark:text-red-400 hover:text-white hover:bg-red-500 dark:hover:bg-red-600 rounded-lg transition-all duration-200" title="Hapus">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        };

        window.removeBatchRow = function(btn) {
            const tr = btn.closest('tr');
            if (tr) tr.remove();
        };

        window.saveBatchInput = async function() {
            // Show loading indicator
            showToast('⏳ Memproses data...', 'info');
            
            try {
                const month = document.getElementById('batch-month').value;
                const bsId = document.getElementById('batch-bs').value;
                
                if (!month) {
                    showToast('❌ Pilih bulan terlebih dahulu', 'error');
                    return;
                }
                
                if (!bsId) {
                    showToast('❌ Pilih Business Solution terlebih dahulu', 'error');
                    return;
                }
                
                const bsName = document.getElementById('batch-bs').selectedOptions[0].textContent;
                const tbody = document.getElementById('batch-input-tbody');
                const rows = tbody.querySelectorAll('tr');
                
                if (rows.length === 0) {
                    showToast('❌ Tambahkan minimal satu baris data', 'error');
                    return;
                }
                
                let addedCount = 0;
                const activityTypes = [
                    { class: 'fm-input', type: 'FM' },
                    { class: 'odp-input', type: 'ODP' },
                    { class: 'ft-input', type: 'FT' },
                    { class: 'ffd-input', type: 'FFD' },
                    { class: 'display-input', type: 'DISPLAY' }
                ];
                
                // Initialize dgaActivities array - FORCE it to be an array
                if (!appState.dgaActivities || !Array.isArray(appState.dgaActivities)) {
                    appState.dgaActivities = [];
                }
                
                rows.forEach(row => {
                    const week = row.querySelector('.week-select').value;
                    const description = row.querySelector('.desc-input').value.trim();
                    
                    activityTypes.forEach(({ class: className, type }) => {
                        const input = row.querySelector('.' + className);
                        const count = parseInt(input.value) || 0;
                        
                        // Only add if count > 0, and add just ONE activity with the count
                        if (count > 0) {
                            const newActivity = {
                                id: Date.now() + Math.random(),
                                month: month,
                                week: week,
                                bsId: parseInt(bsId),
                                bsName: bsName,
                                type: type,
                                count: count, // Store the count instead of creating multiple entries
                                description: description || `${type} W${week}`,
                                createdAt: new Date().toISOString()
                            };
                            
                            // Set createdBy only if currentUser is available
                            if (appState.currentUser) {
                                newActivity.createdBy = appState.currentUser;
                            }
                            
                            appState.dgaActivities.push(newActivity);
                            addedCount += count; // Count total for success message
                        }
                    });
                });
                
                if (addedCount === 0) {
                    showToast('❌ Tidak ada data yang diinput (semua kolom 0)', 'error');
                    return;
                }
                
                // Save to localStorage immediately
                showToast('💾 Menyimpan data...', 'info');
                try {
                    localStorage.setItem('advantaSalesData', JSON.stringify(appState));
                } catch (error) {
                    showToast('❌ Gagal menyimpan ke localStorage: ' + error.message, 'error');
                    return;
                }
                
                // Try save to Firestore if logged in
                if (currentUser && typeof window.saveData === 'function') {
                    try {
                        await window.saveData();
                    } catch (error) {
                        showToast('⚠️ Gagal menyimpan ke cloud, data tersimpan lokal', 'error');
                    }
                }
                
                // Refresh DGA page
                if (typeof window.refreshDGAPage === 'function') {
                    window.refreshDGAPage();
                }
                
                // Close modal
                if (typeof window.closeBatchInputModal === 'function') {
                    window.closeBatchInputModal();
                }
                
                // Show success
                showToast(`✅ Berhasil menambahkan ${addedCount} kegiatan!`, 'success');
                
            } catch (error) {
                showToast('💥 ERROR: ' + error.message, 'error');
                alert('Terjadi kesalahan:\n\n' + error.message + '\n\nStack: ' + error.stack);
            }
        };

        // === PRESENTATION FUNCTIONS ===
        let presentationCharts = {};

        window.refreshPresentation = async function() {
            // Reload data from Firebase if user is logged in
            if (currentUser && db) {
                try {
                    const userDocRef = doc(db, 'advantaUserData', currentUser.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const savedData = docSnap.data().data;
                        // Update appState with fresh data
                        window.appState = { ...window.appState, ...savedData };
                    }
                } catch (error) {
                    console.error("Error reloading data from Firebase:", error);
                }
            }
            
            // Initialize fiscal year dropdown on first load (2022-2080)
            const yearSelect = document.getElementById('pres-year');
            if (yearSelect && yearSelect.options.length === 1) {
                for (let year = 2022; year <= 2080; year++) {
                    const option = document.createElement('option');
                    option.value = 'FY ' + year + '/' + (year + 1); // Match plan PO format
                    option.textContent = 'FY ' + year + '-' + (year + 1);
                    yearSelect.appendChild(option);
                }
            }
            
            // Initialize distributor dropdown
            const distSelect = document.getElementById('pres-distributor');
            const allDistributors = appState.distributors || [];
            
            console.log('Distributor dropdown check:', {
                distSelectExists: !!distSelect,
                currentOptionsCount: distSelect ? distSelect.options.length : 0,
                distributorCount: allDistributors.length,
                expectedOptions: allDistributors.length + 1 // +1 for "Semua Distributor"
            });
            
            if (distSelect && allDistributors.length > 0) {
                const expectedOptionsCount = allDistributors.length + 1; // +1 for "Semua Distributor"
                
                // Only populate if options don't match expected count
                if (distSelect.options.length !== expectedOptionsCount) {
                    // Save current selection
                    const currentValue = distSelect.value;
                    
                    // Clear all options except the first
                    while (distSelect.options.length > 1) {
                        distSelect.remove(1);
                    }
                    
                    // Add distributor options
                    allDistributors.forEach(dist => {
                        const option = document.createElement('option');
                        option.value = dist.id;
                        option.textContent = dist.name;
                        distSelect.appendChild(option);
                    });
                    
                    // Restore selection if it was valid
                    if (currentValue && Array.from(distSelect.options).some(opt => opt.value === currentValue)) {
                        distSelect.value = currentValue;
                    }
                    
                    console.log('✅ Distributor dropdown populated with', distSelect.options.length, 'options');
                }
            } else if (!distSelect) {
                console.error('❌ pres-distributor element not found!');
            }
            
            // Skip adding event listeners since we use inline onchange
            
            // Initialize FY comparison dropdowns
            const fy1Select = document.getElementById('fy-compare-1');
            const fy2Select = document.getElementById('fy-compare-2');
            if (fy1Select && fy1Select.options.length === 1) {
                for (let year = 2022; year <= 2080; year++) {
                    const opt1 = document.createElement('option');
                    opt1.value = year;
                    opt1.textContent = 'FY ' + year + '-' + (year + 1);
                    fy1Select.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = year;
                    opt2.textContent = 'FY ' + year + '-' + (year + 1);
                    fy2Select.appendChild(opt2);
                }
            }
            
            // Get filter values
            const period = document.getElementById('pres-period')?.value || 'all';
            const selectedMonth = document.getElementById('pres-month')?.value || '';
            const selectedFiscalYear = document.getElementById('pres-year')?.value || '';
            const selectedDistributor = document.getElementById('pres-distributor')?.value || '';
            
            // Get ALL data from appState
            const allPOs = appState.purchaseOrders || [];
            
            // Handle dgaActivities - could be array or object
            let allDGA = [];
            if (Array.isArray(appState.dgaActivities)) {
                allDGA = appState.dgaActivities;
            } else if (appState.dgaActivities && typeof appState.dgaActivities === 'object') {
                // Convert object to array
                allDGA = Object.values(appState.dgaActivities).flat();
            }
            
            const allVarieties = appState.varieties || [];
            
            // Start with all data
            let pos = [...allPOs];
            let dgaActivities = [...allDGA];
            
            const now = new Date();
            
            // Apply DISTRIBUTOR filter first (if selected)
            if (selectedDistributor) {
                const distId = parseInt(selectedDistributor);
                pos = pos.filter(po => po.distributorId == distId);
                // DGA tidak difilter berdasarkan distributor - tetap tampilkan semua
            }
            
            // Apply FISCAL YEAR filter (if selected)
            // selectedFiscalYear is in format "FY 2025/2026"
            if (selectedFiscalYear) {
                // Extract year from "FY 2025/2026" format
                const fyMatch = selectedFiscalYear.match(/FY (\d+)/);
                const fyNum = fyMatch ? parseInt(fyMatch[1]) : null;
                
                if (fyNum) {
                    pos = pos.filter(po => {
                        if (!po.poDate) return false;
                        return getFiscalYear(new Date(po.poDate)) === fyNum;
                    });
                    dgaActivities = dgaActivities.filter(act => {
                        if (!act.month) return false;
                        return getFiscalYear(new Date(act.month + '-01')) === fyNum;
                    });
                }
            }
            
            // Apply MONTH filter (if selected)
            if (selectedMonth) {
                const monthNum = parseInt(selectedMonth);
                pos = pos.filter(po => {
                    if (!po.poDate) return false;
                    return (new Date(po.poDate).getMonth() + 1) === monthNum;
                });
                dgaActivities = dgaActivities.filter(act => {
                    if (!act.month) return false;
                    return (new Date(act.month + '-01').getMonth() + 1) === monthNum;
                });
            }
            
            // Apply PERIOD filter (if not "all")
            if (period !== 'all') {
                let startDate, endDate;
                
                if (period === 'week') {
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = now;
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (period === 'quarter') {
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                } else if (period === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                }
                
                if (startDate && endDate) {
                    // Filter POs that have releases in the selected period
                    pos = pos.filter(po => {
                        if (!po.items || !Array.isArray(po.items)) return false;
                        // Check if any item has releases in this period
                        return po.items.some(item => {
                            const releases = item.releases || [];
                            return releases.some(r => {
                                if (!r.releaseDate) return false;
                                const releaseDate = new Date(r.releaseDate);
                                return releaseDate >= startDate && releaseDate <= endDate;
                            });
                        });
                    });
                    dgaActivities = dgaActivities.filter(act => {
                        if (!act.month) return false;
                        const actDate = new Date(act.month + '-01');
                        return actDate >= startDate && actDate <= endDate;
                    });
                }
            }
            
            // Show data info on page with filter status
            const dataInfo = document.getElementById('pres-data-info');
            if (dataInfo) {
                let filterInfo = '';
                if (selectedDistributor) {
                    const selectedDist = allDistributors.find(d => d.id == selectedDistributor);
                    filterInfo += `Distributor: ${selectedDist ? selectedDist.name : 'Unknown'} `;
                }
                if (selectedFiscalYear) {
                    // Display the fiscal year as-is (already formatted)
                    filterInfo += `${selectedFiscalYear} `;
                }
                if (selectedMonth) {
                    const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                    filterInfo += `Bulan: ${months[parseInt(selectedMonth)]} `;
                }
                if (period !== 'all') filterInfo += `Periode: ${period} `;
                
                const filterText = filterInfo ? ` | 🔍 ${filterInfo}→ ${pos.length} PO, ${dgaActivities.length} DGA` : '';
                dataInfo.textContent = `📦 Total: ${allPOs.length} PO | ${allDGA.length} DGA | ${allDistributors.length} Dist | ${allVarieties.length} Varietas${filterText}`;
            }
            
            // Calculate metrics from filtered POs
            // Since POs are already filtered above, we just need to sum up all releases from filtered POs
            let totalQty = 0, totalSales = 0;
            pos.forEach(po => {
                if (po.items && Array.isArray(po.items)) {
                    po.items.forEach(item => {
                        const releases = item.releases || [];
                        releases.forEach(r => {
                            totalQty += r.qty || 0;
                            totalSales += (r.qty || 0) * (item.price || 0);
                        });
                    });
                }
            });
            
            // Update metrics cards
            document.getElementById('pres-total-po').textContent = pos.length;
            document.getElementById('pres-total-sales').textContent = 'Rp ' + totalSales.toLocaleString('id-ID');
            document.getElementById('pres-total-qty').textContent = totalQty.toLocaleString('id-ID');
            document.getElementById('pres-total-dga').textContent = dgaActivities.length;
            document.getElementById('pres-total-distributors').textContent = allDistributors.length;
            
            // Render charts
            renderSalesTrendChart(pos);
            renderTopVarietiesChart(pos);
            renderDGAChart(dgaActivities);
            renderPOStatusChart(pos);
            
            // Render tables
            renderRecentPOTable(pos);
            renderTopCustomers(pos);
            renderDGASummary(dgaActivities);
            renderStockDistributorTable();
            
            // Render growth varietas (menggunakan data terfilter)
            renderPresentationGrowth(pos, selectedFiscalYear);
            
            // Render Plan PO
            renderPresentationPlanPO(selectedDistributor, selectedMonth, selectedFiscalYear);
        };
        
        function renderPresentationPlanPO(selectedDistributor, selectedMonth, selectedFiscalYear) {
            const plans = appState.planPO || [];
            const distributors = appState.distributors || [];
            const varieties = appState.varieties || [];
            
            console.log('=== renderPresentationPlanPO DEBUG ===');
            console.log('Total plans in appState:', plans.length);
            console.log('All plans:', plans);
            console.log('Filters:', {
                selectedDistributor,
                selectedMonth,
                selectedFiscalYear
            });
            
            // Filter plans based on selection
            let filteredPlans = [...plans];
            
            if (selectedDistributor) {
                console.log('Filtering by distributor:', selectedDistributor);
                filteredPlans = filteredPlans.filter(p => p.distributorId == selectedDistributor);
                console.log('After distributor filter:', filteredPlans.length);
            }
            
            if (selectedMonth) {
                const monthNum = parseInt(selectedMonth);
                console.log('Filtering by month:', monthNum);
                filteredPlans = filteredPlans.filter(p => {
                    // Handle both number and string month formats
                    const planMonth = typeof p.month === 'number' ? p.month : parseInt(p.month);
                    console.log(`Plan ${p.id}: month=${p.month} (type: ${typeof p.month}), parsed=${planMonth}, match=${planMonth === monthNum}`);
                    return planMonth === monthNum;
                });
                console.log('After month filter:', filteredPlans.length);
            }
            
            if (selectedFiscalYear) {
                console.log('Filtering by fiscal year:', selectedFiscalYear);
                filteredPlans = filteredPlans.filter(p => {
                    const match = p.fiscalYear == selectedFiscalYear;
                    console.log(`Plan ${p.id}: fiscalYear="${p.fiscalYear}" == "${selectedFiscalYear}" = ${match}`);
                    return match;
                });
                console.log('After fiscal year filter:', filteredPlans.length);
            }
            
            console.log('Final filtered plans:', filteredPlans.length, filteredPlans);
            
            // Calculate summary - recalculate total if not exist
            const totalPlans = filteredPlans.length;
            let totalQty = 0;
            let totalValue = 0;
            
            filteredPlans.forEach(p => {
                const planQty = p.total || ((p.w1 || 0) + (p.w2 || 0) + (p.w3 || 0) + (p.w4 || 0) + (p.w5 || 0));
                totalQty += planQty;
                
                // Find variety to get price per KG
                const variety = varieties.find(v => v.id == p.varietyId);
                if (variety) {
                    const price = Number(variety.price || 0);
                    const unit = variety.unit || 'pcs';
                    const weight = Number(variety.weight || 0); // gram per pack
                    
                    let pricePerKg = 0;
                    if (unit === 'kg') {
                        // Harga sudah per KG
                        pricePerKg = price;
                    } else if (unit === 'pcs' && weight > 0) {
                        // Konversi harga per PCS ke harga per KG
                        const kgPerPack = weight / 1000;
                        pricePerKg = kgPerPack > 0 ? price / kgPerPack : 0;
                    }
                    
                    // Plan qty sudah dalam KG, kalikan dengan harga per KG
                    totalValue += planQty * pricePerKg;
                }
            });
            
            const uniqueDists = new Set(filteredPlans.map(p => p.distributorId)).size;
            const uniqueVars = new Set(filteredPlans.map(p => p.varietyId)).size;
            
            console.log('Summary - Plans:', totalPlans, 'Total Qty:', totalQty, 'Total Value:', totalValue, 'Dists:', uniqueDists, 'Vars:', uniqueVars);
            
            // Update summary cards
            document.getElementById('pres-plan-count').textContent = totalPlans;
            document.getElementById('pres-plan-total').textContent = totalQty.toLocaleString('id-ID', {minimumFractionDigits: 1});
            document.getElementById('pres-plan-dist').textContent = uniqueDists;
            document.getElementById('pres-plan-var').textContent = uniqueVars;
            document.getElementById('pres-plan-value').textContent = 'Rp ' + totalValue.toLocaleString('id-ID');
            
            // Render plan cards
            const cardsContainer = document.getElementById('pres-plan-cards');
            if (!cardsContainer) return;
            
            if (filteredPlans.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="font-semibold text-lg">Tidak ada Plan PO</p>
                        <p class="text-sm">Silakan tambahkan plan di menu Plan PO</p>
                    </div>
                `;
                return;
            }
            
            const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            // Get all POs for realization calculation
            const allPOs = appState.purchaseOrders || [];
            
            cardsContainer.innerHTML = filteredPlans.map(plan => {
                const dist = distributors.find(d => d.id == plan.distributorId);
                const variety = varieties.find(v => v.id == plan.varietyId);
                
                // Handle both number and string month formats
                let monthNum;
                if (typeof plan.month === 'number') {
                    monthNum = plan.month;
                } else if (typeof plan.month === 'string') {
                    // Try to parse as number first
                    monthNum = parseInt(plan.month);
                    // If not a number, find in monthNames array
                    if (isNaN(monthNum)) {
                        monthNum = monthNames.indexOf(plan.month);
                    }
                }
                monthNum = monthNum || 0;
                
                const monthName = monthNames[monthNum] || 'N/A';
                const fiscalYear = plan.fiscalYear || 'N/A';
                
                // Recalculate total from weeks
                const w1 = parseFloat(plan.w1) || 0;
                const w2 = parseFloat(plan.w2) || 0;
                const w3 = parseFloat(plan.w3) || 0;
                const w4 = parseFloat(plan.w4) || 0;
                const w5 = parseFloat(plan.w5) || 0;
                const planTotal = w1 + w2 + w3 + w4 + w5;
                
                // Calculate realization from POs
                let realizationTotal = 0;
                allPOs.forEach(po => {
                    // Match by distributor, fiscal year, and month
                    if (po.distributorId == plan.distributorId && po.fiscalYear == fiscalYear) {
                        const poDate = po.poDate ? new Date(po.poDate) : null;
                        const poMonth = poDate ? poDate.getMonth() + 1 : 0;
                        
                        if (poMonth == monthNum) {
                            // Sum released qty for this variety
                            if (po.items && Array.isArray(po.items)) {
                                po.items.forEach(item => {
                                    if (item.varietyId == plan.varietyId) {
                                        const releases = item.releases || [];
                                        releases.forEach(release => {
                                            const releaseQty = parseFloat(release.qty) || 0;
                                            realizationTotal += releaseQty;
                                        });
                                    }
                                });
                            }
                        }
                    }
                });
                
                // Calculate achievement percentage
                const achievementPct = planTotal > 0 ? (realizationTotal / planTotal) * 100 : 0;
                const achievementColor = achievementPct >= 100 ? '#10b981' : achievementPct >= 80 ? '#f59e0b' : '#ef4444';
                
                // Create weekly bars
                const weeks = [w1, w2, w3, w4, w5];
                const maxWeek = Math.max(...weeks);
                
                return `
                    <div class="bg-gradient-to-br from-white to-blue-50 rounded-lg shadow-md border border-blue-200 overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                        <div style="background: linear-gradient(to right, #2563eb, #4f46e5); padding: 8px 12px;">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div style="color: #fff; font-weight: 900; font-size: 15px; line-height: 1.2;">${variety?.name || 'Unknown Variety'}</div>
                                    <div style="color: #dbeafe; font-size: 10px; font-weight: 600;">${dist?.name || 'Unknown Distributor'}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 4px 8px; border-radius: 6px;">
                                    <div style="font-size: 9px; color: rgba(255,255,255,0.9); font-weight: 600;">Plan</div>
                                    <div style="color: #fff; font-weight: 900; font-size: 16px; line-height: 1;">${planTotal.toLocaleString('id-ID', {minimumFractionDigits: 1})} KG</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 10px;">
                            <!-- Achievement Summary - Compact -->
                            <div style="background: linear-gradient(to right, #f9fafb, #f3f4f6); border-radius: 6px; padding: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                                <div class="flex items-center justify-between gap-3" style="margin-bottom: 6px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 9px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 2px;">Realisasi</div>
                                        <div style="font-size: 14px; font-weight: 900; color: #000; line-height: 1;">${realizationTotal.toLocaleString('id-ID', {minimumFractionDigits: 1})} KG</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 9px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 2px;">Achievement</div>
                                        <div style="font-size: 14px; font-weight: 900; color: ${achievementColor}; line-height: 1;">${achievementPct.toFixed(1)}%</div>
                                    </div>
                                </div>
                                <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 6px; overflow: hidden;">
                                    <div style="background: ${achievementColor}; height: 6px; border-radius: 9999px; transition: all 0.5s; width: ${Math.min(achievementPct, 100)}%"></div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-1" style="font-size: 11px; margin-bottom: 8px;">
                                <svg style="width: 12px; height: 12px; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <span style="font-weight: 700; color: #000;">${monthName} ${fiscalYear}</span>
                            </div>
                            
                            <!-- Weekly Plan - Grid Layout -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;">
                                ${weeks.map((qty, idx) => {
                                    const percentage = maxWeek > 0 ? (qty / maxWeek) * 100 : 0;
                                    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#f97316', '#a855f7'];
                                    return `
                                        <div style="text-align: center;">
                                            <div style="font-size: 9px; font-weight: 700; color: #6b7280; margin-bottom: 2px;">W${idx + 1}</div>
                                            <div style="font-size: 11px; font-weight: 900; color: #000; line-height: 1; margin-bottom: 3px;">${qty.toFixed(0)}</div>
                                            <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 4px; overflow: hidden;">
                                                <div style="background: ${colors[idx]}; height: 4px; border-radius: 9999px; transition: all 0.5s; width: ${percentage}%"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSalesTrendChart(pos) {
            const ctx = document.getElementById('sales-trend-chart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (presentationCharts.salesTrend) {
                presentationCharts.salesTrend.destroy();
            }
            
            // Group by month (YYYY-MM format)
            const salesByMonth = {};
            pos.forEach(po => {
                if (!po.poDate) return;
                const date = new Date(po.poDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!salesByMonth[monthKey]) salesByMonth[monthKey] = 0;
                
                if (po.items && Array.isArray(po.items)) {
                    po.items.forEach(item => {
                        const releases = item.releases || [];
                        const qty = releases.reduce((sum, r) => sum + (parseInt(r.qty) || 0), 0);
                        salesByMonth[monthKey] += qty * (item.price || 0);
                    });
                }
            });
            
            const sortedMonths = Object.keys(salesByMonth).sort();
            const values = sortedMonths.map(m => salesByMonth[m]);
            
            presentationCharts.salesTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                        return `${monthNames[parseInt(month) - 1]} ${year}`;
                    }),
                    datasets: [{
                        label: 'Penjualan (Rp)',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTopVarietiesChart(pos) {
            const ctx = document.getElementById('top-varieties-chart');
            if (!ctx) return;
            
            if (presentationCharts.topVarieties) {
                presentationCharts.topVarieties.destroy();
            }
            
            // Count by variety from ACTUAL SALES (releases), not targets, CONVERTED TO KG
            const varietyKg = {};
            pos.forEach(po => {
                if (po.items && Array.isArray(po.items)) {
                    po.items.forEach(item => {
                        // Find variety by ID first, fallback to name matching
                        let variety = null;
                        if (item.varietyId) {
                            variety = appState.varieties?.find(v => v.id == item.varietyId);
                        }
                        if (!variety && item.name) {
                            variety = appState.varieties?.find(v => v.name === item.name);
                        }
                        
                        // Use CURRENT variety name from varieties data
                        const name = variety?.name || item.name || 'Unknown';
                        const releases = item.releases || [];
                        
                        // Sum up ONLY released/sold quantities (in pcs)
                        const soldQty = releases.reduce((sum, r) => sum + (parseInt(r.qty) || 0), 0);
                        
                        if (soldQty > 0) {
                            // Get weight (in grams)
                            const weightInGrams = variety?.weight || 1000; // Default 1kg if not found
                            
                            // Convert: (qty in pcs) * (weight in grams) / 1000 = kg
                            const kgSold = (soldQty * weightInGrams) / 1000;
                            
                            varietyKg[name] = (varietyKg[name] || 0) + kgSold;
                        }
                    });
                }
            });
            
            const sorted = Object.entries(varietyKg).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            // If no data, show empty chart
            if (sorted.length === 0) {
                presentationCharts.topVarieties = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Belum ada data penjualan'],
                        datasets: [{
                            label: 'Kg Terjual',
                            data: [0],
                            backgroundColor: ['#e5e7eb']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
                return;
            }
            
            presentationCharts.topVarieties = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([name]) => name),
                    datasets: [{
                        label: 'Kg Terjual',
                        data: sorted.map(([, kg]) => Math.round(kg * 100) / 100), // Round to 2 decimals
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('id-ID') + ' kg';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDGAChart(activities) {
            const tbody = document.getElementById('dga-bs-detail-body');
            if (!tbody) return;
            
            // Group activities by BS - only show user's BS
            const bsData = {};
            const allBS = (appState.businessSolutions || []).filter(bs => 
                bs.createdBy === appState.currentUser || 
                bs.createdBy === undefined || 
                bs.createdBy === 'unknown' ||
                !appState.currentUser
            );
            
            // Initialize totals
            const totals = { FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0, total: 0 };
            
            activities.forEach(activity => {
                const bsId = activity.bsId;
                if (!bsData[bsId]) {
                    bsData[bsId] = {
                        FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0, total: 0
                    };
                }
                const count = activity.count || 1;
                if (bsData[bsId][activity.type] !== undefined) {
                    bsData[bsId][activity.type] += count;
                    bsData[bsId].total += count;
                    // Add to grand totals
                    totals[activity.type] += count;
                    totals.total += count;
                }
            });
            
            if (Object.keys(bsData).length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                        <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="font-medium">Belum ada kegiatan DGA</p>
                    </div>
                </td></tr>`;
                return;
            }
            
            // Sort by total (descending)
            const sortedBS = Object.entries(bsData).sort((a, b) => b[1].total - a[1].total);
            
            tbody.innerHTML = sortedBS.map(([bsId, data]) => {
                const bs = allBS.find(b => b.id == bsId);
                const bsName = bs ? bs.name : `BS ${bsId}`;
                
                return `<tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-semibold text-gray-900">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                            ${bsName}
                        </div>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block px-2 py-1 ${data.FM > 0 ? 'bg-blue-100 text-blue-800 font-semibold' : 'text-gray-400'} rounded text-xs">${data.FM}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block px-2 py-1 ${data.ODP > 0 ? 'bg-green-100 text-green-800 font-semibold' : 'text-gray-400'} rounded text-xs">${data.ODP}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block px-2 py-1 ${data.FT > 0 ? 'bg-yellow-100 text-yellow-800 font-semibold' : 'text-gray-400'} rounded text-xs">${data.FT}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block px-2 py-1 ${data.FFD > 0 ? 'bg-purple-100 text-purple-800 font-semibold' : 'text-gray-400'} rounded text-xs">${data.FFD}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="inline-block px-2 py-1 ${data.DISPLAY > 0 ? 'bg-pink-100 text-pink-800 font-semibold' : 'text-gray-400'} rounded text-xs">${data.DISPLAY}</span>
                    </td>
                    <td class="px-3 py-3 text-center bg-gray-50">
                        <span class="inline-block px-2.5 py-1 bg-gray-800 text-white font-bold rounded-md text-xs">${data.total}</span>
                    </td>
                </tr>`;
            }).join('') + 
            // Add totals row at the bottom
            `<tr class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 border-t-4 border-yellow-400 shadow-xl">
                <td class="px-4 py-4 font-extrabold uppercase tracking-wide">
                    <div class="flex items-center gap-2">
                        <svg class="w-6 h-6 text-yellow-300" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 3a1 1 0 000 2h11a1 1 0 100-2H3zM3 7a1 1 0 000 2h7a1 1 0 100-2H3zM3 11a1 1 0 100 2h4a1 1 0 100-2H3zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z"/>
                        </svg>
                        <span class="text-white text-base font-black">TOTAL KEGIATAN</span>
                    </div>
                </td>
                <td class="px-3 py-4 text-center bg-blue-700">
                    <div class="inline-flex items-center justify-center px-3 py-2 bg-white text-blue-700 font-black rounded-lg shadow-lg text-base border-2 border-blue-300">
                        ${totals.FM}
                    </div>
                </td>
                <td class="px-3 py-4 text-center bg-green-700">
                    <div class="inline-flex items-center justify-center px-3 py-2 bg-white text-green-700 font-black rounded-lg shadow-lg text-base border-2 border-green-300">
                        ${totals.ODP}
                    </div>
                </td>
                <td class="px-3 py-4 text-center bg-yellow-600">
                    <div class="inline-flex items-center justify-center px-3 py-2 bg-white text-yellow-700 font-black rounded-lg shadow-lg text-base border-2 border-yellow-300">
                        ${totals.FT}
                    </div>
                </td>
                <td class="px-3 py-4 text-center bg-purple-700">
                    <div class="inline-flex items-center justify-center px-3 py-2 bg-white text-purple-700 font-black rounded-lg shadow-lg text-base border-2 border-purple-300">
                        ${totals.FFD}
                    </div>
                </td>
                <td class="px-3 py-4 text-center bg-pink-700">
                    <div class="inline-flex items-center justify-center px-3 py-2 bg-white text-pink-700 font-black rounded-lg shadow-lg text-base border-2 border-pink-300">
                        ${totals.DISPLAY}
                    </div>
                </td>
                <td class="px-3 py-4 text-center bg-gradient-to-r from-yellow-500 to-orange-500">
                    <div class="inline-flex items-center justify-center px-4 py-2 bg-white text-gray-900 font-black rounded-lg shadow-2xl text-xl border-4 border-yellow-300 ring-2 ring-white">
                        ${totals.total}
                    </div>
                </td>
            </tr>`;
        }
        
        function renderPOStatusChart(pos) {
            const ctx = document.getElementById('po-status-chart');
            if (!ctx) return;
            
            if (presentationCharts.poStatus) {
                presentationCharts.poStatus.destroy();
            }
            
            const statusCounts = { Draft: 0, Released: 0, Completed: 0 };
            pos.forEach(po => {
                const status = po.status || 'Draft';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            presentationCharts.poStatus = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'PO Count',
                        data: Object.values(statusCounts),
                        backgroundColor: ['#94a3b8', '#3b82f6', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function renderRecentPOTable(pos) {
            const tbody = document.getElementById('pres-recent-po');
            if (!tbody) return;
            
            const recent = pos.sort((a, b) => new Date(b.poDate) - new Date(a.poDate)).slice(0, 10);
            
            tbody.innerHTML = recent.map(po => {
                let total = 0;
                po.items.forEach(item => {
                    const releases = item.releases || [];
                    const qty = releases.reduce((sum, r) => sum + (r.qty || 0), 0);
                    total += qty * (item.price || 0);
                });
                
                return `<tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-xs">${new Date(po.poDate).toLocaleDateString('id-ID')}</td>
                    <td class="px-3 py-2 text-xs">${po.distributor || '-'}</td>
                    <td class="px-3 py-2 text-xs text-right font-semibold">Rp ${total.toLocaleString('id-ID')}</td>
                </tr>`;
            }).join('');
        }
        
        function renderTopCustomers(pos) {
            const container = document.getElementById('pres-top-customers');
            if (!container) return;
            
            const customerSales = {};
            pos.forEach(po => {
                // Get distributor name - check multiple sources
                let name = 'Tidak Diketahui';
                
                // First: check if distributor is a string (direct name)
                if (typeof po.distributor === 'string' && po.distributor && po.distributor.trim()) {
                    name = po.distributor.trim();
                } 
                // Second: check distributorName field
                else if (po.distributorName && po.distributorName.trim()) {
                    name = po.distributorName.trim();
                }
                // Third: check if distributor is an object with name
                else if (po.distributor && typeof po.distributor === 'object' && po.distributor.name) {
                    name = po.distributor.name;
                }
                // Fourth: try to get from distributors array using distributorId
                else if (po.distributorId && appState.distributors) {
                    const dist = appState.distributors.find(d => d.id == po.distributorId);
                    if (dist && dist.name) {
                        name = dist.name;
                    }
                }
                
                let total = 0;
                if (po.items && Array.isArray(po.items)) {
                    po.items.forEach(item => {
                        const releases = item.releases || [];
                        const qty = releases.reduce((sum, r) => sum + (parseInt(r.qty) || 0), 0);
                        total += qty * (item.price || 0);
                    });
                }
                
                if (total > 0) {
                    customerSales[name] = (customerSales[name] || 0) + total;
                }
            });
            
            const sorted = Object.entries(customerSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxSales = sorted[0]?.[1] || 1;
            
            container.innerHTML = sorted.map(([name, sales]) => {
                const percentage = (sales / maxSales) * 100;
                return `<div class="space-y-1">
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-gray-700">${name}</span>
                        <span class="text-green-600 font-bold">Rp ${sales.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderDGASummary(activities) {
            const container = document.getElementById('pres-dga-summary');
            if (!container) return;
            
            const counts = { FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0 };
            activities.forEach(a => {
                const activityCount = a.count || 1;
                if (counts[a.type] !== undefined) counts[a.type] += activityCount;
            });
            
            // Calculate Farmer Reach using master data multipliers
            const multipliers = appState.farmerReachMultipliers || {
                FM: 25, ODP: 25, FT: 20, FFD: 60, DISPLAY: 0
            };
            const farmerReach = (counts['FM'] * multipliers.FM) + 
                              (counts['ODP'] * multipliers.ODP) + 
                              (counts['FT'] * multipliers.FT) + 
                              (counts['FFD'] * multipliers.FFD);
            
            const colors = {
                FM: 'from-blue-500 to-blue-600',
                ODP: 'from-green-500 to-green-600',
                FT: 'from-yellow-500 to-yellow-600',
                FFD: 'from-purple-500 to-purple-600',
                DISPLAY: 'from-pink-500 to-pink-600'
            };
            
            container.innerHTML = Object.entries(counts).map(([type, count]) => {
                return `<div class="bg-gradient-to-br ${colors[type]} rounded-lg p-4 text-white shadow-md">
                    <div class="text-xs font-medium opacity-90">${type}</div>
                    <div class="text-2xl font-bold mt-1">${count}</div>
                </div>`;
            }).join('') + 
            `<div class="bg-gradient-to-br from-orange-500 via-amber-500 to-yellow-500 rounded-lg p-4 text-white shadow-xl ring-2 ring-orange-300">
                <div class="flex items-center gap-1.5 mb-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    <div class="text-xs font-bold opacity-90">FARMER REACH</div>
                </div>
                <div class="text-3xl font-black mt-1">${farmerReach.toLocaleString('id-ID')}</div>
                <div class="text-xs font-medium opacity-80 mt-1">Petani Terjangkau</div>
            </div>`;
        }

        function renderPresentationGrowth(pos, fiscalYear) {
            const container = document.getElementById('pres-variety-growth-content');
            if (!container) return;
            
            // Get varieties from appState
            const allVarieties = appState.varieties || [];
            
            // Determine fiscal years to compare
            // Handle empty string or null fiscalYear
            let currentFY;
            if (fiscalYear && fiscalYear !== '' && !isNaN(parseInt(fiscalYear))) {
                currentFY = parseInt(fiscalYear);
            } else {
                currentFY = getFiscalYear(new Date());
            }
            const previousFY = currentFY - 1;
            
            // Calculate ACTUAL SALES per variety for both fiscal years (in KG)
            // Using the SAME logic as renderTopVarietiesChart for accuracy
            const currentYearSales = {};
            const previousYearSales = {};
            const currentYearQty = {};
            const previousYearQty = {};
            const currentYearNominal = {};
            const previousYearNominal = {};
            const varietyNames = {}; // Store variety names for lookup
            
            // Process ALL POs from appState (not filtered) to get both years
            const allPOs = appState.purchaseOrders || [];
            
            allPOs.forEach(po => {
                if (!po.items || !Array.isArray(po.items)) return;
                
                po.items.forEach(item => {
                    // Find variety by ID first, fallback to name matching (same as Top Varietas)
                    let variety = null;
                    if (item.varietyId) {
                        variety = allVarieties.find(v => v.id == item.varietyId);
                    }
                    if (!variety && item.name) {
                        variety = allVarieties.find(v => v.name === item.name);
                    }
                    
                    // Use variety ID as key (for grouping), name for display
                    const varietyKey = variety?.id || item.varietyId || item.name || 'Unknown';
                    const varietyName = variety?.name || item.name || 'Unknown';
                    varietyNames[varietyKey] = varietyName;
                    
                    // Get weight (in grams), default 1kg if not found
                    const weightInGrams = variety?.weight || item.weight || 1000;
                    
                    // Get price
                    const price = parseFloat(item.price) || 0;
                    
                    // Process each release record
                    const releases = item.releases || [];
                    releases.forEach(release => {
                        // Get release date
                        const releaseDate = release.date || release.releaseDate;
                        if (!releaseDate) return;
                        
                        const parsedDate = new Date(releaseDate);
                        if (isNaN(parsedDate.getTime())) return;
                        
                        // Determine fiscal year of this release
                        const releaseFY = getFiscalYear(parsedDate);
                        
                        // Get qty released (in pcs)
                        const qtyReleased = parseInt(release.qty) || 0;
                        if (qtyReleased <= 0) return;
                        
                        // Convert to KG: (qty in pcs) * (weight in grams) / 1000
                        const kgReleased = (qtyReleased * weightInGrams) / 1000;
                        
                        // Calculate nominal
                        const nominal = qtyReleased * price;
                        
                        // Add to appropriate fiscal year bucket
                        if (releaseFY === currentFY) {
                            currentYearSales[varietyKey] = (currentYearSales[varietyKey] || 0) + kgReleased;
                            currentYearQty[varietyKey] = (currentYearQty[varietyKey] || 0) + qtyReleased;
                            currentYearNominal[varietyKey] = (currentYearNominal[varietyKey] || 0) + nominal;
                        } else if (releaseFY === previousFY) {
                            previousYearSales[varietyKey] = (previousYearSales[varietyKey] || 0) + kgReleased;
                            previousYearQty[varietyKey] = (previousYearQty[varietyKey] || 0) + qtyReleased;
                            previousYearNominal[varietyKey] = (previousYearNominal[varietyKey] || 0) + nominal;
                        }
                    });
                });
            });
            
            // Note: Sales data comes ONLY from PO Releases (actual sales)
            // Stock Distributor is inventory data and NOT included
            
            // Calculate growth for each variety
            const growthData = [];
            const allVarietyKeys = new Set([...Object.keys(currentYearSales), ...Object.keys(previousYearSales)]);
            
            allVarietyKeys.forEach(varietyKey => {
                const varietyName = varietyNames[varietyKey] || varietyKey;
                
                const current = currentYearSales[varietyKey] || 0;
                const previous = previousYearSales[varietyKey] || 0;
                const growth = previous > 0 ? ((current - previous) / previous * 100) : (current > 0 ? 100 : 0);
                const absoluteGrowth = current - previous;
                
                growthData.push({
                    name: varietyName,
                    current: current,
                    previous: previous,
                    growth: growth,
                    absoluteGrowth: absoluteGrowth,
                    currentQty: currentYearQty[varietyKey] || 0,
                    previousQty: previousYearQty[varietyKey] || 0,
                    currentNominal: currentYearNominal[varietyKey] || 0,
                    previousNominal: previousYearNominal[varietyKey] || 0
                });
            });
            
            // Sort by absolute growth (descending)
            growthData.sort((a, b) => Math.abs(b.absoluteGrowth) - Math.abs(a.absoluteGrowth));
            
            // Debug log
            console.log('Growth Varietas Debug:', {
                currentFY,
                previousFY,
                totalPOs: allPOs.length,
                currentYearSalesCount: Object.keys(currentYearSales).length,
                previousYearSalesCount: Object.keys(previousYearSales).length,
                growthDataCount: growthData.length,
                currentYearSales,
                previousYearSales,
                growthData
            });
            
            // Render growth cards dengan tampilan yang lebih canggih
            if (growthData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="inline-flex items-center justify-center w-20 h-20 mb-4 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full">
                            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div class="font-bold text-lg">Tidak ada data untuk ditampilkan</div>
                        <div class="text-sm mt-2">Belum ada data release di FY ${currentFY}-${currentFY+1} atau FY ${previousFY}-${previousFY+1}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <style>
                    @keyframes fadeInUp {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    @keyframes shimmer {
                        0% { background-position: -1000px 0; }
                        100% { background-position: 1000px 0; }
                    }
                    .growth-card {
                        animation: fadeInUp 0.5s ease-out forwards;
                        opacity: 0;
                    }
                    .growth-card:hover {
                        transform: translateY(-4px);
                    }
                    .growth-card:hover .growth-shine {
                        animation: shimmer 2s infinite;
                    }
                    .growth-shine {
                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                        background-size: 1000px 100%;
                    }
                </style>
                <div class="mb-6 p-5 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-xl border-2 border-blue-400 shadow-lg">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center shadow-lg backdrop-blur-sm">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-white">Analisis Pertumbuhan Penjualan</div>
                            <div class="text-sm text-white mt-0.5">
                                <span class="inline-flex items-center gap-1.5">
                                    <span class="font-bold text-yellow-300">FY ${currentFY}-${currentFY + 1}</span>
                                    <svg class="w-4 h-4 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                    <span class="font-bold text-white">FY ${previousFY}-${previousFY + 1}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    ${growthData.map((item, index) => {
                        const isPositive = item.growth >= 0;
                        const growthColor = isPositive ? 'text-emerald-600' : 'text-rose-600';
                        const gradientFrom = isPositive ? 'from-emerald-50' : 'from-rose-50';
                        const gradientTo = isPositive ? 'to-green-50' : 'to-red-50';
                        const borderColor = isPositive ? 'border-emerald-300' : 'border-rose-300';
                        const badgeBg = isPositive ? 'bg-emerald-100' : 'bg-rose-100';
                        const badgeText = isPositive ? 'text-emerald-700' : 'text-rose-700';
                        const icon = isPositive ? '🚀' : '📉';
                        const progressPercent = Math.min(Math.abs(item.growth), 100);
                        const progressGradient = isPositive ? 'from-emerald-400 to-green-500' : 'from-rose-400 to-red-500';
                        const shadowColor = isPositive ? 'shadow-emerald-100' : 'shadow-rose-100';
                        
                        return `
                            <div class="growth-card relative bg-white rounded-xl border-2 ${borderColor} p-5 transition-all duration-300 hover:shadow-2xl ${shadowColor} overflow-hidden" style="animation-delay: ${index * 0.1}s;">
                                <div class="growth-shine absolute inset-0 pointer-events-none"></div>
                                <div class="relative z-10">
                                    <div class="flex items-start justify-between mb-4">
                                        <div>
                                            <div class="font-bold text-gray-900 text-lg mb-1">${item.name}</div>
                                            <div class="inline-flex items-center gap-1 px-2.5 py-1 ${badgeBg} ${badgeText} rounded-full text-xs font-semibold">
                                                <span>${icon}</span>
                                                <span>${isPositive ? '+' : ''}${item.growth.toFixed(1)}%</span>
                                            </div>
                                        </div>
                                        <div class="text-4xl opacity-80">${icon}</div>
                                    </div>
                                    
                                    <div class="space-y-3 mb-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-gray-500 font-medium">FY ${currentFY}-${currentFY + 1}</span>
                                            <span class="font-bold text-blue-600 text-base">${item.current.toLocaleString('id-ID', {maximumFractionDigits: 1})} KG</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-gray-500 font-medium">FY ${previousFY}-${previousFY + 1}</span>
                                            <span class="font-semibold text-gray-500 text-sm">${item.previous.toLocaleString('id-ID', {maximumFractionDigits: 1})} KG</span>
                                        </div>
                                    </div>
                                    
                                    <div class="pt-3 border-t-2 border-gray-100">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Pertumbuhan</span>
                                            <span class="text-xl font-black ${growthColor}">${isPositive ? '↑' : '↓'} ${Math.abs(item.growth).toFixed(1)}%</span>
                                        </div>
                                        <div class="relative w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                                            <div class="absolute inset-0 bg-gradient-to-r ${progressGradient} rounded-full transition-all duration-1000 ease-out" style="width: ${progressPercent}%"></div>
                                        </div>
                                        <div class="text-xs text-gray-600 mt-2 font-semibold text-center">
                                            <span class="${growthColor}">${isPositive ? '+' : ''}${item.absoluteGrowth.toLocaleString('id-ID', {maximumFractionDigits: 1})} KG</span>
                                            <span class="text-gray-400 mx-1">•</span>
                                            <span class="text-gray-500">${isPositive ? 'Peningkatan' : 'Penurunan'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Chart Visualisasi Growth Varietas -->
                <div class="mt-8 bg-white rounded-xl shadow-lg border-2 border-gray-200 p-6 overflow-hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center shadow-md">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-gray-800">Grafik Pertumbuhan Varietas</h4>
                                <p class="text-xs text-gray-500">Perbandingan penjualan per varietas</p>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span class="inline-flex items-center gap-2">
                                <span class="w-3 h-3 bg-blue-500 rounded"></span>
                                <span>FY ${currentFY}-${currentFY + 1}</span>
                            </span>
                            <span class="inline-flex items-center gap-2 ml-4">
                                <span class="w-3 h-3 bg-gray-400 rounded"></span>
                                <span>FY ${previousFY}-${previousFY + 1}</span>
                            </span>
                        </div>
                    </div>
                    <div style="height: 400px;">
                        <canvas id="growth-variety-chart"></canvas>
                    </div>
                </div>
            `;
            
            // Render Chart setelah DOM dimuat
            setTimeout(() => {
                const chartCanvas = document.getElementById('growth-variety-chart');
                if (chartCanvas && growthData.length > 0) {
                    // Destroy existing chart if any
                    if (presentationCharts.growthVariety) {
                        presentationCharts.growthVariety.destroy();
                    }
                    
                    // Limit to top 10 varieties for better readability
                    const topVarieties = growthData.slice(0, 10);
                    
                    const ctx = chartCanvas.getContext('2d');
                    presentationCharts.growthVariety = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: topVarieties.map(item => item.name),
                            datasets: [
                                {
                                    label: `FY ${currentFY}-${currentFY + 1}`,
                                    data: topVarieties.map(item => item.current),
                                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                    borderColor: 'rgb(59, 130, 246)',
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    hoverBackgroundColor: 'rgba(59, 130, 246, 1)'
                                },
                                {
                                    label: `FY ${previousFY}-${previousFY + 1}`,
                                    data: topVarieties.map(item => item.previous),
                                    backgroundColor: 'rgba(156, 163, 175, 0.6)',
                                    borderColor: 'rgb(156, 163, 175)',
                                    borderWidth: 2,
                                    borderRadius: 6,
                                    hoverBackgroundColor: 'rgba(156, 163, 175, 0.8)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            const varietyIndex = context.dataIndex;
                                            const variety = topVarieties[varietyIndex];
                                            const datasetIndex = context.datasetIndex;
                                            
                                            const label = context.dataset.label;
                                            const weight = context.parsed.y;
                                            const qty = datasetIndex === 0 ? variety.currentQty : variety.previousQty;
                                            const nominal = datasetIndex === 0 ? variety.currentNominal : variety.previousNominal;
                                            
                                            return [
                                                label,
                                                'Qty: ' + qty.toLocaleString('id-ID') + ' pcs',
                                                'Berat: ' + weight.toLocaleString('id-ID', {maximumFractionDigits: 1}) + ' KG',
                                                'Nominal: Rp ' + nominal.toLocaleString('id-ID')
                                            ];
                                        },
                                        afterBody: function(context) {
                                            const varietyIndex = context[0].dataIndex;
                                            const variety = topVarieties[varietyIndex];
                                            if (variety && typeof variety.growth === 'number') {
                                                const growthValue = variety.growth.toFixed(1);
                                                const growthText = variety.growth >= 0 ? '+' + growthValue : growthValue;
                                                const icon = variety.growth >= 0 ? '📈' : '📉';
                                                return '\n' + icon + ' Growth: ' + growthText + '%';
                                            }
                                            return '';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString('id-ID') + ' KG';
                                        },
                                        font: {
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 11,
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // === DEBUG HELPER FOR TABLET ===
        window.debugLog = function(message, data) {
            const panel = document.getElementById('debug-panel');
            const content = document.getElementById('debug-content');
            if (panel && content) {
                panel.style.display = 'block';
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.style.borderBottom = '1px solid #333';
                logEntry.style.padding = '3px 0';
                logEntry.innerHTML = `<span style="color:#888">${time}</span> ${message}${data ? ' | ' + JSON.stringify(data) : ''}`;
                content.appendChild(logEntry);
                content.scrollTop = content.scrollHeight;
            }
        };

        // === METRIC DETAIL MODAL FUNCTIONS ===
        let currentFilteredPOs = [];
        let currentFilteredDGA = [];
        
        window.showMetricDetail = function(type) {
            try {
                debugLog('🔵 Opening modal', {type: type});
                
                // Reset pagination to page 1
                modalPagination.po.page = 1;
                modalPagination.sales.page = 1;
                modalPagination.qty.page = 1;
                modalPagination.dga.page = 1;
                
                const modal = document.getElementById('metric-detail-modal');
                const header = document.getElementById('metric-detail-header');
                const title = document.getElementById('metric-detail-title');
                const icon = document.getElementById('metric-detail-icon');
                const content = document.getElementById('metric-detail-content');
                
                if (!modal) {
                    debugLog('❌ Modal not found!');
                    return;
                }
                if (!header) {
                    debugLog('❌ Header not found!');
                    return;
                }
                if (!title) {
                    debugLog('❌ Title not found!');
                    return;
                }
                if (!icon) {
                    debugLog('❌ Icon not found!');
                    return;
                }
                if (!content) {
                    debugLog('❌ Content not found!');
                    return;
                }
                debugLog('✅ All elements found');
                
                // Get current filtered data
                const period = document.getElementById('pres-period')?.value || 'all';
                const selectedMonth = document.getElementById('pres-month')?.value || '';
                const selectedFiscalYear = document.getElementById('pres-year')?.value || '';
                const selectedDistributor = document.getElementById('pres-distributor')?.value || '';
                debugLog('📊 Filters', {period, month: selectedMonth, fy: selectedFiscalYear, dist: selectedDistributor});
                
                let pos = [...(appState.purchaseOrders || [])];
                let dgaActivities = [];
                if (Array.isArray(appState.dgaActivities)) {
                    // Filter DGA activities by current user
                    dgaActivities = [...appState.dgaActivities].filter(a => 
                        a.createdBy === appState.currentUser || 
                        a.createdBy === undefined || 
                        a.createdBy === 'unknown' ||
                        !appState.currentUser
                    );
                } else if (appState.dgaActivities && typeof appState.dgaActivities === 'object') {
                    // Filter DGA activities by current user
                    dgaActivities = Object.values(appState.dgaActivities).flat().filter(a => 
                        a.createdBy === appState.currentUser || 
                        a.createdBy === undefined || 
                        a.createdBy === 'unknown' ||
                        !appState.currentUser
                    );
                }
                
                // Apply distributor filter first
                if (selectedDistributor) {
                    const distId = parseInt(selectedDistributor);
                    pos = pos.filter(po => po.distributorId == distId);
                    dgaActivities = dgaActivities.filter(act => act.distributorId == distId);
                }
                
                // Apply fiscal year filter at RELEASE level (fallback to poDate)
                const now = new Date();
                if (selectedFiscalYear) {
                    // Parse "FY 2025/2026" format to get the year number
                    let fyNum;
                    if (selectedFiscalYear.startsWith('FY ')) {
                        const yearMatch = selectedFiscalYear.match(/FY (\d{4})/);
                        fyNum = yearMatch ? parseInt(yearMatch[1]) : null;
                    } else {
                        fyNum = parseInt(selectedFiscalYear);
                    }
                    
                    if (!fyNum || isNaN(fyNum)) {
                        console.error('❌ Invalid fiscal year:', selectedFiscalYear);
                    } else {
                        console.log('📅 Filtering by Fiscal Year:', selectedFiscalYear, '→', fyNum);
                        
                        // Filter POs: keep PO if poDate falls in selected FY
                        // Then filter releases within: use releaseDate if available, otherwise keep all releases of matching PO
                        pos = pos.filter(po => {
                            if (!po.poDate) return false;
                            return getFiscalYear(new Date(po.poDate)) === fyNum;
                        });
                        
                        // Additionally filter releases by releaseDate when available
                        pos = pos.map(po => {
                            if (!po.items || !Array.isArray(po.items)) return po;
                            
                            const filteredItems = po.items.map(item => {
                                const releases = item.releases || [];
                                const filteredReleases = releases.filter(r => {
                                    // If release has a date, check it matches FY
                                    if (r.releaseDate) {
                                        return getFiscalYear(new Date(r.releaseDate)) === fyNum;
                                    }
                                    // If no releaseDate, keep it (PO already matched by poDate)
                                    return true;
                                });
                                
                                if (filteredReleases.length === 0) return null;
                                return { ...item, releases: filteredReleases };
                            }).filter(item => item !== null);
                            
                            if (filteredItems.length === 0) return null;
                            return { ...po, items: filteredItems };
                        }).filter(po => po !== null);
                        
                        console.log('✅ After FY filter:', pos.length, 'POs');
                        
                        dgaActivities = dgaActivities.filter(act => act.month && getFiscalYear(new Date(act.month + '-01')) === fyNum);
                    }
                }
                
                // Apply month filter (fallback to poDate)
                if (selectedMonth) {
                    const monthNum = parseInt(selectedMonth);
                    console.log('📅 Filtering by Month:', monthNum);
                    
                    // Filter POs: keep PO if poDate month matches
                    pos = pos.filter(po => {
                        if (!po.poDate) return false;
                        return (new Date(po.poDate).getMonth() + 1) === monthNum;
                    });
                    
                    // Additionally filter releases by releaseDate when available
                    pos = pos.map(po => {
                        if (!po.items || !Array.isArray(po.items)) return po;
                        
                        const filteredItems = po.items.map(item => {
                            const releases = item.releases || [];
                            const filteredReleases = releases.filter(r => {
                                // If release has a date, check month matches
                                if (r.releaseDate) {
                                    return (new Date(r.releaseDate).getMonth() + 1) === monthNum;
                                }
                                // If no releaseDate, keep it (PO already matched by poDate)
                                return true;
                            });
                            
                            if (filteredReleases.length === 0) return null;
                            return { ...item, releases: filteredReleases };
                        }).filter(item => item !== null);
                        
                        if (filteredItems.length === 0) return null;
                        return { ...po, items: filteredItems };
                    }).filter(po => po !== null);
                    
                    console.log('✅ After month filter:', pos.length, 'POs');
                    
                    dgaActivities = dgaActivities.filter(act => act.month && (new Date(act.month + '-01').getMonth() + 1) === monthNum);
                }
                if (period !== 'all') {
                    let startDate, endDate;
                    if (period === 'week') {
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        endDate = now;
                    } else if (period === 'month') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    } else if (period === 'quarter') {
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                    } else if (period === 'year') {
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31);
                    }
                    if (startDate && endDate) {
                        console.log('📅 Filtering by period:', period, 'Range:', startDate.toISOString(), 'to', endDate.toISOString());
                        
                        // Filter POs by poDate first, then filter releases if they have releaseDate
                        pos = pos.filter(po => {
                            if (!po.poDate) return false;
                            const poDate = new Date(po.poDate);
                            return poDate >= startDate && poDate <= endDate;
                        });
                        
                        // Additionally filter releases by releaseDate when available
                        pos = pos.map(po => {
                            if (!po.items || !Array.isArray(po.items)) return po;
                            
                            const filteredItems = po.items.map(item => {
                                const releases = item.releases || [];
                                const filteredReleases = releases.filter(r => {
                                    if (r.releaseDate) {
                                        const releaseDate = new Date(r.releaseDate);
                                        return releaseDate >= startDate && releaseDate <= endDate;
                                    }
                                    // No releaseDate, keep it (PO already matched by poDate)
                                    return true;
                                });
                                
                                if (filteredReleases.length === 0) return null;
                                return { ...item, releases: filteredReleases };
                            }).filter(item => item !== null);
                            
                            if (filteredItems.length === 0) return null;
                            return { ...po, items: filteredItems };
                        }).filter(po => po !== null);
                        
                        console.log('✅ After period filter:', pos.length, 'POs');
                        
                        dgaActivities = dgaActivities.filter(act => {
                            if (!act.month) return false;
                            const actDate = new Date(act.month + '-01');
                            return actDate >= startDate && actDate <= endDate;
                        });
                    }
                }
                
                currentFilteredPOs = pos;
                currentFilteredDGA = dgaActivities;
                
                console.log('📊 Filtered data:', {
                    type: type,
                    totalPOs: pos.length,
                    totalDGA: dgaActivities.length,
                    period: period,
                    month: selectedMonth,
                    fiscalYear: selectedFiscalYear,
                    distributor: selectedDistributor
                });
                
                // Configure modal based on type
                switch(type) {
                    case 'po':
                        header.className = 'bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-5 flex items-center justify-between';
                        icon.innerHTML = '<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
                        title.textContent = 'Detail Purchase Orders';
                        content.innerHTML = renderPODetail(pos);
                        break;
                    case 'sales':
                        console.log('💰 Rendering sales detail with', pos.length, 'POs');
                        header.className = 'bg-gradient-to-r from-green-500 to-green-600 px-6 py-5 flex items-center justify-between';
                        icon.innerHTML = '<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                        title.textContent = 'Detail Total Sales';
                        content.innerHTML = renderSalesDetail(pos);
                        console.log('✅ Sales detail rendered');
                        break;
                    case 'qty':
                        header.className = 'bg-gradient-to-r from-yellow-500 to-orange-500 px-6 py-5 flex items-center justify-between';
                        icon.innerHTML = '<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>';
                        title.textContent = 'Detail Total Qty';
                        content.innerHTML = renderQtyDetail(pos);
                        break;
                    case 'dga':
                        header.className = 'bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-5 flex items-center justify-between';
                        icon.innerHTML = '<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>';
                        title.textContent = 'Detail Aktivitas DGA';
                        content.innerHTML = renderDGADetail(dgaActivities);
                        break;
                    case 'distributors':
                        header.className = 'bg-gradient-to-r from-red-500 to-red-600 px-6 py-5 flex items-center justify-between';
                        icon.innerHTML = '<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>';
                        title.textContent = 'Detail Distributors';
                        content.innerHTML = renderDistributorsDetail();
                        break;
                }
                
                debugLog('🎨 Setting display flex');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                debugLog('✅ Modal opened successfully');
            } catch (error) {
                debugLog('❌ ERROR', {msg: error.message, stack: error.stack});
            }
        }
        
        window.closeMetricDetailModal = function() {
            try {
                debugLog('🔴 Closing modal');
                const modal = document.getElementById('metric-detail-modal');
                if (!modal) {
                    debugLog('❌ Modal not found when closing!');
                    return;
                }
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                debugLog('✅ Modal closed');
            } catch (error) {
                debugLog('❌ ERROR closing', {msg: error.message});
            }
        }
        
        // Pagination state for modals
        let modalPagination = {
            po: { page: 1, perPage: 10 },
            sales: { page: 1, perPage: 10 },
            qty: { page: 1, perPage: 10 },
            dga: { page: 1, perPage: 10 }
        };
        
        function renderPODetail(pos) {
            if (pos.length === 0) {
                return '<div class="text-center py-12"><div class="text-6xl mb-4">📋</div><p class="text-gray-500 text-lg font-semibold">Tidak ada Purchase Order</p><p class="text-gray-400 text-sm mt-2">Cobalah filter periode atau distributor yang berbeda</p></div>';
            }
            
            // Pagination
            const { page, perPage } = modalPagination.po;
            const totalPages = Math.ceil(pos.length / perPage);
            const startIdx = (page - 1) * perPage;
            const endIdx = startIdx + perPage;
            const paginatedPOs = pos.slice(startIdx, endIdx);
            
            let html = '<div class="space-y-3">';
            paginatedPOs.forEach((po, idx) => {
                const statusColors = {
                    'Draft': 'bg-gray-500 text-white',
                    'Released': 'bg-green-600 text-white',
                    'Partial': 'bg-yellow-500 text-white',
                    'Completed': 'bg-blue-600 text-white',
                    'Fully Released': 'bg-emerald-600 text-white'
                };
                const globalIdx = startIdx + idx + 1;
                html += `
                    <div class="bg-white rounded-xl p-5 border-l-4 border-blue-500 hover:shadow-lg transition-all shadow-md">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">#${globalIdx}</div>
                                <h4 class="text-lg font-bold text-blue-700">${po.poNumber || 'N/A'}</h4>
                                <p class="text-sm text-gray-700 font-medium mt-1">${po.distributor || 'N/A'}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[po.status] || statusColors['Draft']}">${po.status || 'Draft'}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-gray-600">📅 Tanggal:</span> <span class="font-semibold text-gray-800">${po.poDate || '-'}</span></div>
                            <div><span class="text-gray-600">💰 Total:</span> <span class="font-bold text-green-600">Rp ${(po.total || 0).toLocaleString('id-ID')}</span></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Pagination controls
            if (totalPages > 1) {
                html += `
                    <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
                        <div class="text-sm text-gray-600">
                            Menampilkan ${startIdx + 1}-${Math.min(endIdx, pos.length)} dari ${pos.length} PO
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="changePOPage(-1)" ${page === 1 ? 'disabled' : ''} 
                                class="px-4 py-2 rounded-lg font-semibold transition-all ${page === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}">
                                ← Prev
                            </button>
                            <span class="px-4 py-2 bg-gray-100 rounded-lg font-semibold text-gray-700">
                                ${page} / ${totalPages}
                            </span>
                            <button onclick="changePOPage(1)" ${page === totalPages ? 'disabled' : ''} 
                                class="px-4 py-2 rounded-lg font-semibold transition-all ${page === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}">
                                Next →
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        window.changePOPage = function(delta) {
            const totalPages = Math.ceil((appState.purchaseOrders || []).length / modalPagination.po.perPage);
            const newPage = modalPagination.po.page + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                modalPagination.po.page = newPage;
                const content = document.getElementById('metric-detail-content');
                if (content) {
                    content.innerHTML = renderPODetail(appState.purchaseOrders || []);
                }
            }
        };
        
        function renderSalesDetail(pos) {
            console.log('🎨 renderSalesDetail called with', pos.length, 'POs');
            
            // Group by variety with weight info
            const salesByVariety = {};
            let totalSales = 0;
            let totalQtyPcs = 0;
            
            pos.forEach(po => {
                console.log('📦 PO:', po.poNumber, 'Items:', po.items?.length || 0);
                if (po.items && Array.isArray(po.items)) {
                    po.items.forEach(item => {
                        const releases = item.releases || [];
                        console.log('  📋 Item:', item.variety || 'N/A', 'Releases:', releases.length, 'Price:', item.price);
                        releases.forEach((r, idx) => {
                            const qty = r.qty || 0;
                            const price = item.price || 0;
                            const sales = qty * price;
                            console.log('    💰 Release', idx+1, '- Qty:', qty, 'Price:', price, 'Sales:', sales, 'Date:', r.releaseDate);
                            // Find variety name from appState.varieties
                            const variety = appState.varieties?.find(v => v.id == item.varietyId);
                            const varietyName = variety ? variety.name : (item.variety || 'Unknown');
                            const weight = variety?.weight || 0; // weight in grams
                            
                            if (!salesByVariety[varietyName]) {
                                salesByVariety[varietyName] = { qtyPcs: 0, sales: 0, weight: weight };
                            }
                            salesByVariety[varietyName].qtyPcs += qty;
                            salesByVariety[varietyName].sales += sales;
                            totalSales += sales;
                            totalQtyPcs += qty;
                        });
                    });
                }
            });
            
            const sorted = Object.entries(salesByVariety).sort((a, b) => b[1].sales - a[1].sales);
            
            console.log('📊 Sales summary:', {
                varieties: sorted.length,
                totalSales: totalSales,
                totalQtyPcs: totalQtyPcs
            });
            
            if (sorted.length === 0) {
                console.log('⚠️ No sales data found');
                return '<div class=\"text-center py-12\"><div class=\"text-6xl mb-4\">📊</div><p class=\"text-gray-500 text-lg font-semibold\">Tidak ada data penjualan</p><p class=\"text-gray-400 text-sm mt-2\">Cobalah filter periode atau distributor yang berbeda</p></div>';
            }
            
            // Calculate total in KG
            let totalQtyKg = 0;
            sorted.forEach(([variety, data]) => {
                totalQtyKg += (data.qtyPcs * data.weight) / 1000;
            });
            
            let html = `
                <div class=\"bg-gradient-to-r from-green-100 to-emerald-100 rounded-xl p-6 mb-6 border-2 border-green-300\">
                    <div class=\"flex justify-between items-center mb-4\">
                        <div class=\"text-sm font-semibold\" style=\"color: #374151;\">Satuan Tampilan:</div>
                        <div class=\"flex items-center gap-2 bg-white rounded-lg p-1 shadow-sm\">
                            <button onclick=\"toggleSalesUnit('pcs')\" id=\"sales-unit-pcs\" class=\"px-4 py-2 rounded-md font-semibold transition-all bg-green-600 text-white\">
                                PCS
                            </button>
                            <button onclick=\"toggleSalesUnit('kg')\" id=\"sales-unit-kg\" class=\"px-4 py-2 rounded-md font-semibold transition-all text-gray-600 hover:bg-gray-100\">
                                KG
                            </button>
                        </div>
                    </div>
                    <div class=\"grid grid-cols-2 gap-6\">
                        <div class=\"text-center\">
                            <div class=\"text-sm font-semibold mb-1\" style=\"color: #374151;\">Total Sales</div>
                            <div class=\"text-3xl font-black\" style=\"color: #15803d;\">Rp ${totalSales.toLocaleString('id-ID')}</div>
                        </div>
                        <div class=\"text-center\">
                            <div class=\"text-sm font-semibold mb-1\" style=\"color: #374151;\">Total Qty</div>
                            <div id=\"sales-total-qty\" class=\"text-3xl font-black\" style=\"color: #15803d;\" data-pcs=\"${totalQtyPcs}\" data-kg=\"${totalQtyKg.toFixed(2)}\">${totalQtyPcs.toLocaleString('id-ID')} <span class=\"text-lg\">PCS</span></div>
                        </div>
                    </div>
                </div>
                <div class=\"overflow-x-auto\">
                    <table class=\"w-full\">
                        <thead class=\"bg-gradient-to-r from-green-500 to-emerald-500 text-white\">
                            <tr>
                                <th class=\"px-4 py-3 text-left\">#</th>
                                <th class=\"px-4 py-3 text-left\">Varietas</th>
                                <th class=\"px-4 py-3 text-center\">Qty</th>
                                <th class=\"px-4 py-3 text-right\">Sales</th>
                                <th class=\"px-4 py-3 text-center\">% Share</th>
                            </tr>
                        </thead>
                        <tbody class=\"divide-y divide-gray-200\">
            `;
            
            sorted.forEach(([variety, data], idx) => {
                const percentage = ((data.sales / totalSales) * 100).toFixed(1);
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f0fdf4';
                const qtyKg = (data.qtyPcs * data.weight) / 1000;
                html += `
                    <tr class=\"hover:bg-green-100 transition-colors\" style=\"background-color: ${bgColor};\">
                        <td class=\"px-4 py-3 font-semibold\" style=\"color: #1f2937;\">${idx + 1}</td>
                        <td class=\"px-4 py-3 font-bold\" style=\"color: #111827;\">${variety}</td>
                        <td class=\"px-4 py-3 text-center font-semibold sales-qty\" style=\"color: #1e40af;\" data-pcs=\"${data.qtyPcs}\" data-kg=\"${qtyKg.toFixed(2)}\">${data.qtyPcs.toLocaleString('id-ID')} <span class=\"unit-label\">PCS</span></td>
                        <td class=\"px-4 py-3 text-right font-bold\" style=\"color: #15803d;\">Rp ${data.sales.toLocaleString('id-ID')}</td>
                        <td class=\"px-4 py-3 text-center\">
                            <div class=\"inline-flex items-center gap-2\">
                                <div class=\"w-16 h-2 bg-gray-200 rounded-full overflow-hidden\">
                                    <div class=\"h-full bg-gradient-to-r from-green-400 to-green-600\" style=\"width: ${percentage}%\"></div>
                                </div>
                                <span class=\"text-xs font-semibold\" style=\"color: #374151;\">${percentage}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        // Toggle function for sales unit
        window.toggleSalesUnit = function(unit) {
            const pcsBtn = document.getElementById('sales-unit-pcs');
            const kgBtn = document.getElementById('sales-unit-kg');
            const totalQtyEl = document.getElementById('sales-total-qty');
            const qtyElements = document.querySelectorAll('.sales-qty');
            
            if (unit === 'pcs') {
                pcsBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all bg-green-600 text-white';
                kgBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all text-gray-600 hover:bg-gray-100';
                
                // Update total
                const totalPcs = parseFloat(totalQtyEl.dataset.pcs);
                totalQtyEl.innerHTML = `${totalPcs.toLocaleString('id-ID')} <span class=\"text-lg\">PCS</span>`;
                
                // Update all rows
                qtyElements.forEach(el => {
                    const pcs = parseFloat(el.dataset.pcs);
                    el.innerHTML = `${pcs.toLocaleString('id-ID')} <span class=\"unit-label\">PCS</span>`;
                });
            } else {
                pcsBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all text-gray-600 hover:bg-gray-100';
                kgBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all bg-green-600 text-white';
                
                // Update total
                const totalKg = parseFloat(totalQtyEl.dataset.kg);
                totalQtyEl.innerHTML = `${totalKg.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2})} <span class=\"text-lg\">KG</span>`;
                
                // Update all rows
                qtyElements.forEach(el => {
                    const kg = parseFloat(el.dataset.kg);
                    el.innerHTML = `${kg.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2})} <span class=\"unit-label\">KG</span>`;
                });
            }
        };
        
        function renderQtyDetail(pos) {
            // Group by variety with weight info
            const qtyByVariety = {};
            let totalQtyPcs = 0;
            
            pos.forEach(po => {
                if (po.items && Array.isArray(po.items)) {
                    po.items.forEach(item => {
                        const releases = item.releases || [];
                        releases.forEach(r => {
                            const qty = r.qty || 0;
                            // Find variety name from appState.varieties
                            const variety = appState.varieties?.find(v => v.id == item.varietyId);
                            const varietyName = variety ? variety.name : (item.variety || 'Unknown');
                            const weight = variety?.weight || 0; // weight in grams
                            
                            if (!qtyByVariety[varietyName]) {
                                qtyByVariety[varietyName] = { qtyPcs: 0, weight: weight };
                            }
                            qtyByVariety[varietyName].qtyPcs += qty;
                            totalQtyPcs += qty;
                        });
                    });
                }
            });
            
            const sorted = Object.entries(qtyByVariety).sort((a, b) => b[1].qtyPcs - a[1].qtyPcs);
            
            if (sorted.length === 0) {
                return '<div class=\"text-center py-12\"><div class=\"text-6xl mb-4\">📦</div><p class=\"text-gray-500 text-lg font-semibold\">Tidak ada data quantity</p><p class=\"text-gray-400 text-sm mt-2\">Cobalah filter periode atau distributor yang berbeda</p></div>';
            }
            
            // Calculate total in KG
            let totalQtyKg = 0;
            sorted.forEach(([variety, data]) => {
                totalQtyKg += (data.qtyPcs * data.weight) / 1000;
            });
            
            let html = `
                <div class=\"bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-6 mb-6 border-2 border-orange-300\">
                    <div class=\"flex justify-between items-center mb-4\">
                        <div class=\"text-sm font-semibold text-gray-700\">Satuan Tampilan:</div>
                        <div class=\"flex items-center gap-2 bg-white rounded-lg p-1 shadow-sm\">
                            <button onclick=\"toggleQtyUnit('pcs')\" id=\"qty-unit-pcs\" class=\"px-4 py-2 rounded-md font-semibold transition-all bg-orange-600 text-white\">
                                PCS
                            </button>
                            <button onclick=\"toggleQtyUnit('kg')\" id=\"qty-unit-kg\" class=\"px-4 py-2 rounded-md font-semibold transition-all text-gray-600 hover:bg-gray-100\">
                                KG
                            </button>
                        </div>
                    </div>
                    <div class=\"text-center\">
                        <div class=\"text-sm text-gray-600 mb-1\">Total Units Sold</div>
                        <div id=\"qty-total\" class=\"text-4xl font-black text-orange-600\" data-pcs=\"${totalQtyPcs}\" data-kg=\"${totalQtyKg.toFixed(2)}\">${totalQtyPcs.toLocaleString('id-ID')} <span class=\"text-2xl\">PCS</span></div>
                    </div>
                </div>
                <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">
            `;
            
            sorted.forEach(([variety, data], idx) => {
                const percentage = ((data.qtyPcs / totalQtyPcs) * 100).toFixed(1);
                const qtyKg = (data.qtyPcs * data.weight) / 1000;
                const colors = [
                    'from-blue-400 to-blue-600',
                    'from-green-400 to-green-600',
                    'from-yellow-400 to-orange-600',
                    'from-purple-400 to-purple-600',
                    'from-pink-400 to-pink-600',
                    'from-indigo-400 to-indigo-600'
                ];
                const color = colors[idx % colors.length];
                
                html += `
                    <div class=\"bg-gradient-to-br ${color} rounded-xl p-5 text-white shadow-lg transform hover:scale-105 transition-all\">
                        <div class=\"text-xs opacity-75 mb-1\">#${idx + 1}</div>
                        <div class=\"font-bold text-lg mb-2\">${variety}</div>
                        <div class=\"flex items-end justify-between\">
                            <div>
                                <div class=\"qty-value text-3xl font-black\" data-pcs=\"${data.qtyPcs}\" data-kg=\"${qtyKg.toFixed(2)}\">${data.qtyPcs.toLocaleString('id-ID')}</div>
                                <div class=\"qty-unit-label text-xs opacity-75 mt-1\">PCS</div>
                            </div>
                            <div class=\"text-right\">
                                <div class=\"text-2xl font-bold\">${percentage}%</div>
                                <div class=\"text-xs opacity-75\">Share</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // Toggle function for qty unit
        window.toggleQtyUnit = function(unit) {
            const pcsBtn = document.getElementById('qty-unit-pcs');
            const kgBtn = document.getElementById('qty-unit-kg');
            const totalEl = document.getElementById('qty-total');
            const valueElements = document.querySelectorAll('.qty-value');
            const labelElements = document.querySelectorAll('.qty-unit-label');
            
            if (unit === 'pcs') {
                pcsBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all bg-orange-600 text-white';
                kgBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all text-gray-600 hover:bg-gray-100';
                
                // Update total
                const totalPcs = parseFloat(totalEl.dataset.pcs);
                totalEl.innerHTML = `${totalPcs.toLocaleString('id-ID')} <span class=\"text-2xl\">PCS</span>`;
                
                // Update all cards
                valueElements.forEach(el => {
                    const pcs = parseFloat(el.dataset.pcs);
                    el.textContent = pcs.toLocaleString('id-ID');
                });
                
                labelElements.forEach(el => {
                    el.textContent = 'PCS';
                });
            } else {
                pcsBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all text-gray-600 hover:bg-gray-100';
                kgBtn.className = 'px-4 py-2 rounded-md font-semibold transition-all bg-orange-600 text-white';
                
                // Update total
                const totalKg = parseFloat(totalEl.dataset.kg);
                totalEl.innerHTML = `${totalKg.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2})} <span class=\"text-2xl\">KG</span>`;
                
                // Update all cards
                valueElements.forEach(el => {
                    const kg = parseFloat(el.dataset.kg);
                    el.textContent = kg.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                });
                
                labelElements.forEach(el => {
                    el.textContent = 'KG';
                });
            }
        };
        
        function renderDGADetail(activities) {
            if (activities.length === 0) {
                return '<div class=\"text-center py-12\"><div class=\"text-6xl mb-4\">👥</div><p class=\"text-gray-500 text-lg font-semibold\">Tidak ada aktivitas DGA</p><p class=\"text-gray-400 text-sm mt-2\">Cobalah filter periode atau distributor yang berbeda</p></div>';
            }
            
            // Group by type
            const byType = { FM: [], ODP: [], FT: [], FFD: [], DISPLAY: [] };
            activities.forEach(act => {
                if (byType[act.type]) {
                    byType[act.type].push(act);
                }
            });
            
            const typeColors = {
                FM: { bg: 'from-blue-500 to-blue-600', light: 'bg-blue-50', border: 'border-blue-300' },
                ODP: { bg: 'from-green-500 to-green-600', light: 'bg-green-50', border: 'border-green-300' },
                FT: { bg: 'from-yellow-500 to-orange-500', light: 'bg-yellow-50', border: 'border-yellow-300' },
                FFD: { bg: 'from-purple-500 to-purple-600', light: 'bg-purple-50', border: 'border-purple-300' },
                DISPLAY: { bg: 'from-pink-500 to-pink-600', light: 'bg-pink-50', border: 'border-pink-300' }
            };
            
            const typeNames = {
                FM: 'Farmers Meeting',
                ODP: 'One Day Promo',
                FT: 'Field Trip',
                FFD: 'Farmer Field Day',
                DISPLAY: 'Display'
            };
            
            let html = '';
            Object.entries(byType).forEach(([type, acts]) => {
                if (acts.length === 0) return;
                
                const colors = typeColors[type];
                html += `
                    <div class=\"mb-6\">
                        <div class=\"bg-gradient-to-r ${colors.bg} text-white px-4 py-3 rounded-t-xl font-bold flex items-center justify-between\">
                            <span>${typeNames[type]}</span>
                            <span class=\"bg-white/20 px-3 py-1 rounded-full text-sm\">${acts.length} aktivitas</span>
                        </div>
                        <div class=\"bg-white border-2 ${colors.border} rounded-b-xl p-4 space-y-2\">
                `;
                
                acts.forEach((act, idx) => {
                    html += `
                        <div class=\"${colors.light} rounded-lg p-4 hover:shadow-md transition-all border ${colors.border}\">
                            <div class=\"flex justify-between items-start\">
                                <div class=\"flex-1\">
                                    <div class=\"text-xs mb-1\" style=\"color: #6b7280;\">#${idx + 1}</div>
                                    <div class=\"font-bold\" style=\"color: #111827;\">${act.bsName || 'N/A'}</div>
                                    <div class=\"text-sm mt-1\" style=\"color: #374151;\">📍 ${act.location || '-'}</div>
                                    <div class=\"text-sm\" style=\"color: #374151;\">📅 ${act.month || '-'}</div>
                                </div>
                                <div class=\"text-right\">
                                    <div class=\"text-2xl font-black\" style=\"color: #111827;\">${act.count || 1}</div>
                                    <div class=\"text-xs\" style=\"color: #6b7280;\">Aktivitas</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            return html;
        }
        
        function renderDistributorsDetail() {
            const distributors = appState.distributors || [];
            
            if (distributors.length === 0) {
                return '<div class=\"text-center py-12\"><div class=\"text-6xl mb-4\">🏢</div><p class=\"text-gray-500 text-lg font-semibold\">Tidak ada data distributor</p><p class=\"text-gray-400 text-sm mt-2\">Tambahkan distributor di menu Data Master</p></div>';
            }
            
            let html = '<div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">';
            
            distributors.forEach((dist, idx) => {
                html += `
                    <div class=\"bg-gradient-to-br from-red-50 to-pink-50 rounded-xl p-5 border-2 border-red-200 hover:shadow-xl transition-all\">
                        <div class=\"flex items-start gap-4\">
                            <div class=\"w-16 h-16 rounded-lg overflow-hidden bg-white shadow-md flex items-center justify-center\">
                                ${dist.logo ? 
                                    `<img src=\"${dist.logo}\" alt=\"${dist.name}\" class=\"w-full h-full object-contain\">` :
                                    `<div class=\"text-2xl font-bold text-gray-400\">${dist.name.charAt(0)}</div>`
                                }
                            </div>
                            <div class=\"flex-1\">
                                <div class=\"text-xs mb-1\" style=\"color: #6b7280;\">#${idx + 1}</div>
                                <h4 class=\"font-bold text-lg mb-2\" style=\"color: #111827;\">${dist.name}</h4>
                                <div class=\"space-y-1 text-sm\" style=\"color: #374151;\">
                                    <div class=\"flex items-start gap-2\">
                                        <svg class=\"w-4 h-4 mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
                                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\"></path>
                                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\"></path>
                                        </svg>
                                        <span class=\"flex-1\">${dist.address || '-'}</span>
                                    </div>
                                    <div class=\"flex items-center gap-2\">
                                        <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
                                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"></path>
                                        </svg>
                                        <span>${dist.cp || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderStockDistributorTable() {
            const tbody = document.getElementById('pres-stock-table');
            const countEl = document.getElementById('pres-stock-count');
            const summaryEl = document.getElementById('pres-stock-summary');
            if (!tbody) return;
            
            const stocks = appState.stockDistributor || [];
            const distributors = appState.distributors || [];
            const varieties = appState.varieties || [];
            
            // Update count
            if (countEl) {
                countEl.textContent = `${stocks.length} item`;
            }
            
            if (stocks.length === 0) {
                if (summaryEl) summaryEl.innerHTML = '';
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                        <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <p class="font-medium">Belum ada data stok distributor</p>
                    </div>
                </td></tr>`;
                return;
            }

            // === SUMMARY BY VARIETY ===
            if (summaryEl) {
                const summaryMap = {};
                stocks.forEach(stock => {
                    const variety = varieties.find(v => v.id == stock.varietyId);
                    const varName = variety ? variety.name : 'N/A';
                    const varietyWeight = variety?.weight || 1000;
                    const stockUnit = stock.unit || 'KG';
                    let qtyKG = parseFloat(stock.qty || 0);
                    
                    if (stockUnit !== 'KG') {
                        qtyKG = (qtyKG * varietyWeight) / 1000;
                    }
                    
                    if (!summaryMap[varName]) {
                        summaryMap[varName] = { totalKG: 0, totalPCS: 0, lots: new Set(), distributors: new Set(), weight: varietyWeight };
                    }
                    summaryMap[varName].totalKG += qtyKG;
                    const pcs = (qtyKG * 1000) / varietyWeight;
                    summaryMap[varName].totalPCS += pcs;
                    if (stock.lotNumber) summaryMap[varName].lots.add(stock.lotNumber);
                    
                    const dist = distributors.find(d => d.id == stock.distributorId);
                    if (dist) summaryMap[varName].distributors.add(dist.name);
                });
                
                const summaryArr = Object.entries(summaryMap).sort((a, b) => b[1].totalKG - a[1].totalKG);
                const totalAllKG = summaryArr.reduce((s, [, v]) => s + v.totalKG, 0);
                
                const colors = [
                    { bg: '#ecfdf5', bgEnd: '#d1fae5', border: '#34d399', title: '#047857', badge: '#d1fae5', badgeText: '#047857' },
                    { bg: '#eff6ff', bgEnd: '#dbeafe', border: '#60a5fa', title: '#1d4ed8', badge: '#dbeafe', badgeText: '#1d4ed8' },
                    { bg: '#fffbeb', bgEnd: '#fef3c7', border: '#fbbf24', title: '#b45309', badge: '#fef3c7', badgeText: '#b45309' },
                    { bg: '#faf5ff', bgEnd: '#f3e8ff', border: '#a78bfa', title: '#7c3aed', badge: '#f3e8ff', badgeText: '#7c3aed' },
                    { bg: '#fff1f2', bgEnd: '#ffe4e6', border: '#fb7185', title: '#be123c', badge: '#ffe4e6', badgeText: '#be123c' },
                    { bg: '#ecfeff', bgEnd: '#cffafe', border: '#22d3ee', title: '#0e7490', badge: '#cffafe', badgeText: '#0e7490' },
                    { bg: '#fff7ed', bgEnd: '#ffedd5', border: '#fb923c', title: '#c2410c', badge: '#ffedd5', badgeText: '#c2410c' },
                    { bg: '#f0fdfa', bgEnd: '#ccfbf1', border: '#2dd4bf', title: '#0f766e', badge: '#ccfbf1', badgeText: '#0f766e' },
                ];
                
                summaryEl.innerHTML = `
                    <h5 style="color:#e2e8f0;font-size:0.875rem;font-weight:800;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem;">Summary per Varietas</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-2">
                        ${summaryArr.map(([varName, data], i) => {
                            const c = colors[i % colors.length];
                            const pct = totalAllKG > 0 ? ((data.totalKG / totalAllKG) * 100).toFixed(1) : 0;
                            return `
                            <div style="background:linear-gradient(135deg,${c.bg},${c.bgEnd});border-left:4px solid ${c.border};border-radius:0.75rem;padding:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);" class="hover:shadow-md transition-shadow">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
                                    <span style="font-weight:700;color:${c.title};font-size:0.875rem;">${varName}</span>
                                    <span style="font-size:0.75rem;background:${c.badge};color:${c.badgeText};padding:2px 8px;border-radius:9999px;font-weight:600;">${pct}%</span>
                                </div>
                                <div style="display:flex;align-items:baseline;gap:4px;margin-bottom:4px;">
                                    <span style="font-size:1.25rem;font-weight:800;color:#111827;">${data.totalKG.toLocaleString('id-ID', {maximumFractionDigits: 2})}</span>
                                    <span style="font-size:0.75rem;font-weight:800;color:#374151;">KG</span>
                                </div>
                                <div style="font-size:0.75rem;font-weight:700;color:#374151;margin-bottom:0.5rem;">
                                    ${data.totalPCS.toLocaleString('id-ID', {maximumFractionDigits: 0})} PCS
                                </div>
                                <div style="display:flex;flex-wrap:wrap;gap:4px;">
                                    ${[...data.lots].map(lot => `<span style="display:inline-block;padding:2px 6px;background:rgba(255,255,255,0.85);border-radius:4px;font-size:10px;font-family:monospace;color:#1f2937;font-weight:600;border:1px solid #d1d5db;">${lot}</span>`).join('')}
                                </div>
                                <div style="margin-top:6px;font-size:10px;color:#4b5563;font-weight:700;">${[...data.distributors].join(', ')}</div>
                            </div>`;
                        }).join('')}
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;background:#1e293b;border-radius:0.5rem;padding:10px 16px;margin-top:0.75rem;">
                        <span style="font-size:0.875rem;font-weight:700;color:#e2e8f0;">Total Semua Varietas</span>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="font-size:1.125rem;font-weight:800;color:#f1f5f9;">${totalAllKG.toLocaleString('id-ID', {maximumFractionDigits: 2})} <span style="font-size:0.75rem;font-weight:700;color:#cbd5e1;">KG</span></span>
                            <span style="color:#64748b;">|</span>
                            <span style="font-size:0.875rem;font-weight:700;color:#e2e8f0;">${summaryArr.length} varietas</span>
                            <span style="color:#64748b;">|</span>
                            <span style="font-size:0.875rem;font-weight:700;color:#e2e8f0;">${stocks.length} item</span>
                        </div>
                    </div>
                `;
            }

            // === DETAIL TABLE ===
            // Sort by date (newest first)
            const sortedStocks = [...stocks].sort((a, b) => {
                const dateA = new Date(a.date || 0);
                const dateB = new Date(b.date || 0);
                return dateB - dateA;
            });
            
            tbody.innerHTML = sortedStocks.map((stock, idx) => {
                const distributor = distributors.find(d => d.id == stock.distributorId);
                const variety = varieties.find(v => v.id == stock.varietyId);
                const distName = distributor ? distributor.name : 'N/A';
                const varName = variety ? variety.name : 'N/A';
                const stockUnit = stock.unit || 'KG';
                const varietyWeight = variety?.weight || 1000;
                
                // Hitung kedua nilai
                let qtyKG = parseFloat(stock.qty || 0);
                let qtyPCS = qtyKG;
                
                if (stockUnit === 'KG') {
                    qtyPCS = (qtyKG * 1000) / varietyWeight;
                } else {
                    qtyKG = (qtyPCS * varietyWeight) / 1000;
                }
                
                return `<tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-700">${formatDate(stock.date)}</td>
                    <td class="px-4 py-3 text-gray-900 font-medium">${distName}</td>
                    <td class="px-4 py-3 text-gray-700">${varName}</td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <span id="qty-value-${idx}" class="font-semibold text-gray-900">${qtyKG.toLocaleString('id-ID', {maximumFractionDigits: 2})}</span>
                            <div class="relative inline-flex items-center cursor-pointer" onclick="toggleStockUnit(${idx}, ${qtyKG}, ${qtyPCS})">
                                <div id="unit-toggle-${idx}" class="flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold transition-all bg-green-100 text-green-800 hover:bg-green-200">
                                    <span id="unit-label-${idx}">KG</span>
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-mono">${stock.lotNumber || '-'}</span>
                    </td>
                    <td class="px-4 py-3 text-gray-600 text-xs">${stock.notes || '-'}</td>
                </tr>`;
            }).join('');
        }
        
        window.toggleStockUnit = function(idx, qtyKG, qtyPCS) {
            const qtyElement = document.getElementById(`qty-value-${idx}`);
            const unitLabel = document.getElementById(`unit-label-${idx}`);
            const unitToggle = document.getElementById(`unit-toggle-${idx}`);
            
            if (!qtyElement || !unitLabel || !unitToggle) return;
            
            const currentUnit = unitLabel.textContent;
            
            if (currentUnit === 'KG') {
                // Switch to PCS
                qtyElement.textContent = qtyPCS.toLocaleString('id-ID', {maximumFractionDigits: 2});
                unitLabel.textContent = 'PCS';
                unitToggle.className = 'flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold transition-all bg-blue-100 text-blue-800 hover:bg-blue-200';
            } else {
                // Switch to KG
                qtyElement.textContent = qtyKG.toLocaleString('id-ID', {maximumFractionDigits: 2});
                unitLabel.textContent = 'KG';
                unitToggle.className = 'flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold transition-all bg-green-100 text-green-800 hover:bg-green-200';
            }
        };

        window.toggleStockView = function() {
            const summary = document.getElementById('pres-stock-summary');
            const detail = document.getElementById('stock-detail-wrapper');
            const btnSummary = document.getElementById('stock-view-summary');
            const btnDetail = document.getElementById('stock-view-detail');
            if (!summary || !detail) return;

            const showingDetail = !detail.classList.contains('hidden');
            if (showingDetail) {
                // Switch to Summary
                detail.classList.add('hidden');
                summary.classList.remove('hidden');
                btnSummary.className = 'px-3 py-1 rounded-full text-xs font-semibold transition-all bg-white text-cyan-700';
                btnDetail.className = 'px-3 py-1 rounded-full text-xs font-semibold transition-all text-white';
            } else {
                // Switch to Detail
                summary.classList.add('hidden');
                detail.classList.remove('hidden');
                btnSummary.className = 'px-3 py-1 rounded-full text-xs font-semibold transition-all text-white';
                btnDetail.className = 'px-3 py-1 rounded-full text-xs font-semibold transition-all bg-white text-cyan-700';
            }
        };

        // FY Comparison Functions
        window.toggleFYComparison = function() {
            const panel = document.getElementById('fy-compare-panel');
            const btn = document.getElementById('fy-compare-btn');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.classList.add('bg-white/40');
            } else {
                panel.classList.add('hidden');
                btn.classList.remove('bg-white/40');
            }
        };

        window.refreshFYComparison = function() {
            const fy1 = document.getElementById('fy-compare-1')?.value;
            const fy2 = document.getElementById('fy-compare-2')?.value;
            
            if (!fy1 || !fy2) {
                document.getElementById('fy-comparison-results').classList.add('hidden');
                return;
            }
            
            // Calculate metrics for FY1
            const fy1Data = calculateFYMetricsDetailed(parseInt(fy1));
            // Calculate metrics for FY2
            const fy2Data = calculateFYMetricsDetailed(parseInt(fy2));
            
            // Update headers
            document.getElementById('fy1-header').innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>FY ${fy1}-${parseInt(fy1) + 1}`;
            document.getElementById('fy2-header').innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>FY ${fy2}-${parseInt(fy2) + 1}`;
            document.getElementById('fy-comparison-title').textContent = 
                `FY ${fy1}-${parseInt(fy1) + 1} vs FY ${fy2}-${parseInt(fy2) + 1}`;
            
            // Update FY1 data
            document.getElementById('fy1-po').textContent = fy1Data.po.toLocaleString('id-ID');
            document.getElementById('fy1-sales').textContent = 'Rp ' + fy1Data.sales.toLocaleString('id-ID');
            document.getElementById('fy1-qty').textContent = fy1Data.qty.toLocaleString('id-ID');
            document.getElementById('fy1-dga').textContent = fy1Data.dga.toLocaleString('id-ID');
            
            // Update FY2 data
            document.getElementById('fy2-po').textContent = fy2Data.po.toLocaleString('id-ID');
            document.getElementById('fy2-sales').textContent = 'Rp ' + fy2Data.sales.toLocaleString('id-ID');
            document.getElementById('fy2-qty').textContent = fy2Data.qty.toLocaleString('id-ID');
            document.getElementById('fy2-dga').textContent = fy2Data.dga.toLocaleString('id-ID');
            
            // Calculate differences and percentages
            const diffPO = fy2Data.po - fy1Data.po;
            const diffSales = fy2Data.sales - fy1Data.sales;
            const diffQty = fy2Data.qty - fy1Data.qty;
            const diffDGA = fy2Data.dga - fy1Data.dga;
            
            const pctPO = fy1Data.po > 0 ? ((diffPO / fy1Data.po) * 100).toFixed(1) : 0;
            const pctSales = fy1Data.sales > 0 ? ((diffSales / fy1Data.sales) * 100).toFixed(1) : 0;
            const pctQty = fy1Data.qty > 0 ? ((diffQty / fy1Data.qty) * 100).toFixed(1) : 0;
            const pctDGA = fy1Data.dga > 0 ? ((diffDGA / fy1Data.dga) * 100).toFixed(1) : 0;
            
            // Update differences with percentages
            updateDiffElement('diff-po', diffPO, pctPO, false);
            updateDiffElement('diff-sales', diffSales, pctSales, true);
            updateDiffElement('diff-qty', diffQty, pctQty, false);
            updateDiffElement('diff-dga', diffDGA, pctDGA, false);
            
            // Update growth badge
            const overallGrowth = pctSales;
            document.getElementById('fy-growth-value').textContent = (overallGrowth >= 0 ? '+' : '') + overallGrowth + '%';
            document.getElementById('fy-growth-value').className = 'text-2xl font-bold ' + (overallGrowth >= 0 ? 'text-green-300' : 'text-red-300');
            
            // Render comparison chart
            renderFYComparisonChart(fy1Data, fy2Data, fy1, fy2);
            
            // Update insights
            updateComparisonInsights(fy1Data, fy2Data);
            
            // Show results
            document.getElementById('fy-comparison-results').classList.remove('hidden');
        };
        
        function updateDiffElement(id, diff, pct, isRupiah) {
            const prefix = diff >= 0 ? '+' : '';
            const valueText = isRupiah ? prefix + 'Rp ' + Math.abs(diff).toLocaleString('id-ID') : prefix + diff.toLocaleString('id-ID');
            const pctColor = diff >= 0 ? 'bg-green-500 text-white' : 'bg-red-500 text-white';
            
            document.getElementById(id).textContent = valueText;
            document.getElementById(id).className = (id.includes('sales') ? 'text-sm' : 'text-xl') + ' font-extrabold text-white';
            document.getElementById(id + '-pct').textContent = (pct >= 0 ? '+' : '') + pct + '%';
            document.getElementById(id + '-pct').className = 'text-xs font-bold px-2 py-1 rounded-full ' + pctColor;
        }

        function calculateFYMetricsDetailed(fiscalYear) {
            const allPOs = appState.purchaseOrders || [];
            let allDGA = [];
            if (Array.isArray(appState.dgaActivities)) {
                allDGA = appState.dgaActivities;
            } else if (appState.dgaActivities && typeof appState.dgaActivities === 'object') {
                allDGA = Object.values(appState.dgaActivities).flat();
            }
            
            // Get distributor filter
            const selectedDistributor = document.getElementById('pres-distributor')?.value || '';
            
            // Filter by distributor first (if selected)
            let filteredPOs = allPOs;
            let filteredDGA = allDGA;
            if (selectedDistributor) {
                const distId = parseInt(selectedDistributor);
                filteredPOs = filteredPOs.filter(po => po.distributorId == distId);
                filteredDGA = filteredDGA.filter(act => act.distributorId == distId);
            }
            
            // Filter by fiscal year
            const pos = filteredPOs.filter(po => {
                if (!po.poDate) return false;
                return getFiscalYear(new Date(po.poDate)) === fiscalYear;
            });
            
            const dgaActivities = filteredDGA.filter(act => {
                if (!act.month) return false;
                return getFiscalYear(new Date(act.month + '-01')) === fiscalYear;
            });
            
            // Calculate metrics by month
            const monthlyData = {};
            for (let m = 4; m <= 15; m++) {
                const month = m > 12 ? m - 12 : m;
                const year = m > 12 ? fiscalYear + 1 : fiscalYear;
                const key = `${year}-${String(month).padStart(2, '0')}`;
                monthlyData[key] = { sales: 0, qty: 0, po: 0 };
            }
            
            // Calculate metrics
            let qty = 0, sales = 0;
            pos.forEach(po => {
                // Add PO count to monthly data (once per PO, not per item)
                const monthKey = po.poDate ? po.poDate.substring(0, 7) : null;
                if (monthKey && monthlyData[monthKey]) {
                    monthlyData[monthKey].po += 1;
                }
                
                if (po.items && Array.isArray(po.items)) {
                    po.items.forEach(item => {
                        const releases = item.releases || [];
                        const releasedQty = releases.reduce((sum, r) => sum + (r.qty || 0), 0);
                        qty += releasedQty;
                        sales += releasedQty * (item.price || 0);
                        
                        // Add qty and sales to monthly data
                        if (monthKey && monthlyData[monthKey]) {
                            monthlyData[monthKey].qty += releasedQty;
                            monthlyData[monthKey].sales += releasedQty * (item.price || 0);
                        }
                    });
                }
            });
            
            return {
                po: pos.length,
                sales: sales,
                qty: qty,
                dga: dgaActivities.length,
                monthlyData: monthlyData
            };
        }

        function renderFYComparisonChart(fy1Data, fy2Data, fy1, fy2) {
            const canvas = document.getElementById('fy-comparison-chart');
            if (!canvas) return;
            
            // Destroy existing chart
            if (window.fyComparisonChartInstance) {
                window.fyComparisonChartInstance.destroy();
            }
            
            // Prepare data - sama dengan dashboard
            const months = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];
            const fy1Sales = [];
            const fy2Sales = [];
            
            // Get all released items
            const allReleasedItems = [];
            (appState.purchaseOrders || []).forEach(po => {
                if (!po.items || !Array.isArray(po.items)) return;
                po.items.forEach(item => {
                    if (!item.releases || !Array.isArray(item.releases)) return;
                    item.releases.forEach(rel => {
                        if (rel.date) {
                            allReleasedItems.push({
                                releaseDate: rel.date,
                                releaseQty: rel.qty || 0,
                                price: item.price || 0
                            });
                        }
                    });
                });
            });
            
            // Calculate monthly sales for each FY
            for (let m = 4; m <= 15; m++) {
                const monthIdx = m > 12 ? m - 12 : m;
                const year1 = m > 12 ? parseInt(fy1) + 1 : parseInt(fy1);
                const year2 = m > 12 ? parseInt(fy2) + 1 : parseInt(fy2);
                
                let fy1MonthSales = 0;
                let fy2MonthSales = 0;
                
                allReleasedItems.forEach(item => {
                    const d = new Date(item.releaseDate);
                    if (isNaN(d)) return;
                    
                    const itemYear = d.getFullYear();
                    const itemMonth = d.getMonth() + 1;
                    
                    if (itemYear === year1 && itemMonth === monthIdx) {
                        fy1MonthSales += item.releaseQty * item.price;
                    }
                    if (itemYear === year2 && itemMonth === monthIdx) {
                        fy2MonthSales += item.releaseQty * item.price;
                    }
                });
                
                fy1Sales.push(fy1MonthSales / 1000000); // Convert to millions
                fy2Sales.push(fy2MonthSales / 1000000);
            }
            
            const ctx = canvas.getContext('2d');
            window.fyComparisonChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: `FY ${fy1}-${parseInt(fy1) + 1}`,
                        data: fy1Sales,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: 'rgb(59, 130, 246)',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }, {
                        label: `FY ${fy2}-${parseInt(fy2) + 1}`,
                        data: fy2Sales,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 10,
                        pointBackgroundColor: 'rgb(16, 185, 129)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: 'rgb(16, 185, 129)',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#e5e7eb',
                                font: { size: 12, weight: 'bold' },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#e5e7eb',
                            bodyColor: '#e5e7eb',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Rp ' + (context.parsed.y * 1000000).toLocaleString('id-ID');
                                },
                                afterBody: function(tooltipItems) {
                                    if (tooltipItems.length === 2) {
                                        const fy1Value = tooltipItems[0].parsed.y;
                                        const fy2Value = tooltipItems[1].parsed.y;
                                        const diff = fy2Value - fy1Value;
                                        const growth = fy1Value > 0 ? ((diff / fy1Value) * 100).toFixed(1) : 0;
                                        const growthText = growth >= 0 ? '+' + growth + '%' : growth + '%';
                                        const diffText = (diff >= 0 ? '+' : '') + 'Rp ' + (diff * 1000000).toLocaleString('id-ID');
                                        return ['\n━━━━━━━━━━━━━━━', '📊 Growth: ' + growthText, '💰 Difference: ' + diffText];
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return 'Rp ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateComparisonInsights(fy1Data, fy2Data) {
            // Find best month
            let bestMonth = '';
            let bestValue = 0;
            const months = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];
            
            for (let m = 4; m <= 15; m++) {
                const month = m > 12 ? m - 12 : m;
                const year2 = m > 12 ? parseInt(document.getElementById('fy-compare-2').value) + 1 : parseInt(document.getElementById('fy-compare-2').value);
                const key = `${year2}-${String(month).padStart(2, '0')}`;
                const sales = fy2Data.monthlyData[key]?.sales || 0;
                
                if (sales > bestValue) {
                    bestValue = sales;
                    bestMonth = months[m - 4];
                }
            }
            
            document.getElementById('best-month').textContent = bestMonth || '-';
            document.getElementById('best-month-value').textContent = 'Rp ' + bestValue.toLocaleString('id-ID');
            
            // Calculate average growth
            const totalGrowth = ((fy2Data.sales - fy1Data.sales) / fy1Data.sales * 100);
            const avgGrowth = (totalGrowth / 12).toFixed(1);
            document.getElementById('avg-growth').textContent = (avgGrowth >= 0 ? '+' : '') + avgGrowth + '% per bulan';
            
            // Total comparison
            const perfDiff = fy2Data.sales - fy1Data.sales;
            let perfText = '';
            let perfIcon = '';
            if (perfDiff > 0) {
                perfText = 'Performa Meningkat';
                perfIcon = '📈';
            } else if (perfDiff < 0) {
                perfText = 'Performa Menurun';
                perfIcon = '📉';
            } else {
                perfText = 'Performa Stabil';
                perfIcon = '➡️';
            }
            document.getElementById('total-comparison').textContent = perfIcon + ' ' + perfText;
        }

        function formatDiff(value, isRupiah = false) {
            const prefix = value >= 0 ? '+' : '';
            if (isRupiah) {
                return prefix + 'Rp ' + Math.abs(value).toLocaleString('id-ID');
            }
            return prefix + value.toLocaleString('id-ID');
        }

        window.clearFYComparison = function() {
            document.getElementById('fy-compare-1').value = '';
            document.getElementById('fy-compare-2').value = '';
            document.getElementById('fy-comparison-results').classList.add('hidden');
        };

        // Add event listeners for DGA (removed old listeners)

    </script>
    
<script>
    // --- PWA Setup ---
    if ('serviceWorker' in navigator) {
        const swContent = `
            const CACHE_NAME = 'advanta-sales-app-v23';
            const URLS_TO_CACHE = ['/', 'https://cdn.tailwindcss.com', 'https://cdn.jsdelivr.net/npm/chart.js', 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js', 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap'];
            self.addEventListener('install', event => { event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(URLS_TO_CACHE))); });
            self.addEventListener('fetch', event => { event.respondWith(caches.match(event.request).then(response => response || fetch(event.request))); });
            self.addEventListener('activate', event => {
                event.waitUntil(caches.keys().then(cacheNames => {
                    return Promise.all(cacheNames.map(cacheName => { if (cacheName !== CACHE_NAME) { return caches.delete(cacheName); } }));
                }));
            });
        `;
        const swBlob = new Blob([swContent], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).then(reg => console.log('SW registration successful', reg)).catch(err => console.log('SW registration failed', err));
    }
    const manifest = {
      "name": "Advanta Sales App", "short_name": "Advanta", "start_url": ".", "display": "standalone", "background_color": "#FFFFFF", "theme_color": "#2563EB", "description": "Aplikasi untuk manajemen sales order Advanta.",
      "icons": [{"src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231D4ED8'/%3E%3Ctext x='50' y='68' font-size='50' fill='white' text-anchor='middle' font-family='sans-serif' font-weight='bold'%3EA%3C/text%3E%3C/svg%3E", "sizes": "192x192", "type": "image/svg+xml"}, {"src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231D4ED8'/%3E%3Ctext x='50' y='68' font-size='50' fill='white' text-anchor='middle' font-family='sans-serif' font-weight='bold'%3EA%3C/text%3E%3C/svg%3E", "sizes": "512x512", "type": "image/svg+xml"}]
    };
    document.getElementById('manifest').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
    
    // --- Initial Default Data ---
    window.defaultData = {
        distributors: [],
        varieties: [ { id: 1, name: 'Madu 59 F1', price: 95000, unit: 'pcs', weight: 250 }, { id: 2, name: 'Jagung Hibrida Perkasa', price: 85000, unit: 'pcs', weight: 1000 }, { id: 3, name: 'Padi Unggul Nusantara', price: 120000, unit: 'kg', weight: 1000 }, { id: 4, name: 'Cabai Rawit Setan', price: 75000, unit: 'pcs', weight: 10 }, ],
        purchaseOrders: [],
        targets: [],
        marketSize: [],
        indonesiaMarketSize: [],
        businessSolutions: [],
        dgaActivities: [],
        stockDistributor: [],
        stockLinks: [],
        planPO: [],
        masterKabupaten: ['Garut', 'Bandung', 'Sumedang', 'Tasikmalaya', 'Bandung Barat'],
        masterProvinsi: [
            'Aceh','Sumatera Utara','Sumatera Barat','Riau','Kepulauan Riau','Jambi','Sumatera Selatan',
            'Bangka Belitung','Bengkulu','Lampung','DKI Jakarta','Jawa Barat','Jawa Tengah','DI Yogyakarta',
            'Jawa Timur','Banten','Bali','Nusa Tenggara Barat','Nusa Tenggara Timur','Kalimantan Barat',
            'Kalimantan Tengah','Kalimantan Selatan','Kalimantan Timur','Kalimantan Utara','Sulawesi Utara',
            'Sulawesi Tengah','Sulawesi Selatan','Sulawesi Tenggara','Gorontalo','Sulawesi Barat',
            'Maluku','Maluku Utara','Papua Barat','Papua','Papua Tengah','Papua Pegunungan',
            'Papua Selatan','Papua Barat Daya'
        ],

        masterVarietas: ['Jagung Manis', 'Cabai', 'Padi']
    };
    
    // --- Application State ---
    let poCounter = 0;
    let laporanData = null; 
    
    // --- UTILITY ---
    function formatRupiah(angka, withRp = true) { 
        if (isNaN(angka)) return (withRp ? 'Rp 0' : '0');
        const formatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka); 
        return withRp ? formatted : formatted.replace(/\s*Rp\s*/, '');
    }
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
    }
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const typeClass = { success: 'toast-success', error: 'toast-error', info: 'toast-info' }[type];
        toast.className = `toast ${typeClass}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
    
    // === GLOBAL SEARCH FUNCTION ===
    function initGlobalSearch() {
        const searchInput = document.getElementById('global-search-input');
        const searchResults = document.getElementById('global-search-results');
        
        if (!searchInput || !searchResults) return;
        
        let searchTimeout;
        
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim().toLowerCase();
            
            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                performGlobalSearch(query, searchResults);
            }, 300);
        });
        
        // Close results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });
        
        // Show results when focusing input with text
        searchInput.addEventListener('focus', (e) => {
            if (e.target.value.trim().length >= 2) {
                performGlobalSearch(e.target.value.trim().toLowerCase(), searchResults);
            }
        });
    }
    
    function performGlobalSearch(query, resultsContainer) {
        const results = [];
        
        // Search in Purchase Orders
        (appState.purchaseOrders || []).forEach(po => {
            const matches = [];
            if (po.poNumber?.toLowerCase().includes(query)) matches.push('PO Number');
            if (po.distributor?.toLowerCase().includes(query)) matches.push('Distributor');
            if (po.shipmentAddress?.toLowerCase().includes(query)) matches.push('Address');
            
            if (matches.length > 0) {
                results.push({
                    type: 'PO',
                    title: po.poNumber || 'N/A',
                    subtitle: po.distributor || 'Unknown',
                    matches: matches,
                    action: () => {
                        showPage('new-po');
                        setTimeout(() => {
                            const searchBox = document.getElementById('search-po');
                            if (searchBox) {
                                searchBox.value = po.poNumber;
                                searchBox.dispatchEvent(new Event('keyup'));
                            }
                        }, 100);
                    }
                });
            }
        });
        
        // Search in Distributors
        (appState.distributors || []).forEach(dist => {
            const matches = [];
            if (dist.name?.toLowerCase().includes(query)) matches.push('Name');
            if (dist.address?.toLowerCase().includes(query)) matches.push('Address');
            if (dist.contact?.toLowerCase().includes(query)) matches.push('Contact');
            
            if (matches.length > 0) {
                results.push({
                    type: 'Distributor',
                    title: dist.name || 'N/A',
                    subtitle: dist.address || 'No address',
                    matches: matches,
                    action: () => {
                        showPage('distributors');
                        setTimeout(() => {
                            const searchBox = document.getElementById('search-distributor');
                            if (searchBox) {
                                searchBox.value = dist.name;
                                searchBox.dispatchEvent(new Event('keyup'));
                            }
                        }, 100);
                    }
                });
            }
        });
        
        // Search in Varieties
        (appState.varieties || []).forEach(variety => {
            if (variety.name?.toLowerCase().includes(query)) {
                results.push({
                    type: 'Varietas',
                    title: variety.name,
                    subtitle: `Rp ${(variety.price || 0).toLocaleString('id-ID')} - ${variety.weight}g`,
                    matches: ['Name'],
                    action: () => {
                        showPage('varieties');
                        setTimeout(() => {
                            const searchBox = document.getElementById('search-variety');
                            if (searchBox) {
                                searchBox.value = variety.name;
                                searchBox.dispatchEvent(new Event('keyup'));
                            }
                        }, 100);
                    }
                });
            }
        });
        
        // Search in Business Solutions
        (appState.businessSolutions || []).forEach(bs => {
            if (bs.name?.toLowerCase().includes(query)) {
                results.push({
                    type: 'Business Solution',
                    title: bs.name,
                    subtitle: 'DGA Business Solution',
                    matches: ['Name'],
                    action: () => {
                        showPage('dga');
                    }
                });
            }
        });
        
        // Render results
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="p-4 text-center text-gray-500 text-sm">
                    <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    No results found for "${query}"
                </div>
            `;
        } else {
            resultsContainer.innerHTML = results.slice(0, 10).map(result => `
                <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0" onclick='${JSON.stringify(result.action)}'>
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 mt-1">
                            <span class="px-2 py-1 text-xs font-semibold rounded ${
                                result.type === 'PO' ? 'bg-blue-100 text-blue-700' :
                                result.type === 'Distributor' ? 'bg-green-100 text-green-700' :
                                result.type === 'Varietas' ? 'bg-purple-100 text-purple-700' :
                                'bg-gray-100 text-gray-700'
                            }">${result.type}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 truncate">${result.title}</div>
                            <div class="text-sm text-gray-500 truncate">${result.subtitle}</div>
                            <div class="text-xs text-gray-400 mt-1">Matches: ${result.matches.join(', ')}</div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners after rendering
            resultsContainer.querySelectorAll('[onclick]').forEach((el, idx) => {
                el.removeAttribute('onclick');
                el.addEventListener('click', () => {
                    results[idx].action();
                    resultsContainer.classList.add('hidden');
                    document.getElementById('global-search-input').value = '';
                });
            });
            
            if (results.length > 10) {
                resultsContainer.innerHTML += `
                    <div class="p-2 text-center text-xs text-gray-500 bg-gray-50">
                        Showing 10 of ${results.length} results
                    </div>
                `;
            }
        }
        
        resultsContainer.classList.remove('hidden');
    }
    
    function generatePONumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const prefix = `PO-${year}${month}-`;
        let maxSeq = 0;
        appState.purchaseOrders.forEach(po => { if (po.poNumber.startsWith(prefix)) { const seq = parseInt(po.poNumber.replace(prefix, '')); if (seq > maxSeq) maxSeq = seq; } });
        return `${prefix}${String(maxSeq + 1).padStart(3, '0')}`;
    }
    function getFiscalYear(date) { return date.getMonth() >= 3 ? date.getFullYear() : date.getFullYear() - 1; }
    
    // **NEW HELPER**: Calculates total released quantity for an item from its `releases` array.
// Hanya menghitung qty positif (benar-benar sudah dirilis).
    function getReleasedQty(item) {
        if (!Array.isArray(item.releases)) return 0;
        return item.releases.reduce((sum, release) => {
            const qty = Number(release.qty || 0);
            return qty > 0 ? sum + qty : sum;
        }, 0);
    }

    // Total qty yang dibatalkan SEBELUM rilis (bukan retur penjualan).
    function getCancelledQty(item) {
        return Number(item.cancelledQty || 0);
    }


    
    // --- Market Size & Product Per Area ---
    let marketSizeQtyChart = null;
    let productAreaBarChart = null;
    let productAreaDonutChart = null;
    let editingMarketSizeId = null; // id record yang sedang diedit


    // --- Indonesian Market Size (per Provinsi) ---
    let indoMarketSizeQtyChart = null;
    let editingIndoMarketSizeId = null;

    function getMasterProvinsiList() {
        if (!appState.masterProvinsi) appState.masterProvinsi = [];
        if (appState.masterProvinsi.length === 0) {
            appState.masterProvinsi = [
                'Aceh','Sumatera Utara','Sumatera Barat','Riau','Kepulauan Riau','Jambi','Sumatera Selatan',
                'Bangka Belitung','Bengkulu','Lampung','DKI Jakarta','Jawa Barat','Jawa Tengah','DI Yogyakarta',
                'Jawa Timur','Banten','Bali','Nusa Tenggara Barat','Nusa Tenggara Timur','Kalimantan Barat',
                'Kalimantan Tengah','Kalimantan Selatan','Kalimantan Timur','Kalimantan Utara','Sulawesi Utara',
                'Sulawesi Tengah','Sulawesi Selatan','Sulawesi Tenggara','Gorontalo','Sulawesi Barat',
                'Maluku','Maluku Utara','Papua Barat','Papua','Papua Tengah','Papua Pegunungan',
                'Papua Selatan','Papua Barat Daya'
            ];
        }
        return appState.masterProvinsi;
    }

    function getIndoMarketSizeData() {
        if (!appState.indonesiaMarketSize) appState.indonesiaMarketSize = [];
        return appState.indonesiaMarketSize;
    }

    function addIndoMarketSizeRecord(record) {
        const list = getIndoMarketSizeData();
        const withId = { id: Date.now(), ...record };
        list.push(withId);
        saveData();
        updateIndoMarketSizeViews();
        showToast('Data Indonesian market size berhasil disimpan', 'success');
    }

    function updateIndoMarketSizeRecord(id, record) {
        const list = getIndoMarketSizeData();
        const idx = list.findIndex(r => r.id === id);
        if (idx === -1) {
            showToast('Data Indonesian market size yang akan diupdate tidak ditemukan', 'error');
            return;
        }
        list[idx] = { ...list[idx], ...record };
        saveData();
        updateIndoMarketSizeViews();
        showToast('Data Indonesian market size berhasil diupdate', 'success');
    }

    function deleteIndoMarketSizeByCrop(provinsi, crop) {
        const list = getIndoMarketSizeData();
        const before = list.length;
        appState.indonesiaMarketSize = list.filter(r =>
            r.crop !== crop ||
            (provinsi !== 'all' && r.provinsi !== provinsi)
        );
        if (appState.indonesiaMarketSize.length === before) {
            showToast('Tidak ada data Indonesian market size yang dihapus.', 'info');
            return;
        }
        saveData();
        updateIndoMarketSizeViews();
        showToast('Data Indonesian market size berhasil dihapus.', 'success');
    }

    function calculateIndoMarketAggregates() {
        const data = getIndoMarketSizeData();
        const totalRp = data.reduce((sum, r) => sum + (Number(r.totalRp) || 0), 0);

        const qtyPerProv = {};
        const provList = getMasterProvinsiList();
        provList.forEach(p => qtyPerProv[p] = 0);
        data.forEach(r => {
            const prov = r.provinsi;
            const qty = Number(r.qtyKg) || 0;
            if (!prov || !qty) return;
            if (!qtyPerProv[prov]) qtyPerProv[prov] = 0;
            qtyPerProv[prov] += qty;
        });

        return { totalRp, qtyPerProv };
    }

    function getIndoProductAreaDataForProvinsi(provinsi) {
        const data = getIndoMarketSizeData();
        const filtered = provinsi && provinsi !== 'all'
            ? data.filter(r => r.provinsi === provinsi)
            : data.slice();

        const byCrop = {};
        filtered.forEach(r => {
            const key = r.crop || 'Lainnya';
            if (!byCrop[key]) {
                byCrop[key] = { crop: key, qtyKg: 0, totalRp: 0, ids: [] };
            }
            byCrop[key].qtyKg += Number(r.qtyKg) || 0;
            byCrop[key].totalRp += Number(r.totalRp) || 0;
            if (r.id != null) byCrop[key].ids.push(r.id);
        });

        return Object.values(byCrop);
    }

    function updateIndoMarketSizeViews() {
        const { totalRp, qtyPerProv } = calculateIndoMarketAggregates();
        const totalEl = document.getElementById('indo-market-total-rp');
        if (totalEl) totalEl.textContent = formatRupiah(totalRp, true);

        const ctx = document.getElementById('indoMarketSizeQtyChart');
        if (ctx) {
            const labels = getMasterProvinsiList();
            const values = labels.map(p => qtyPerProv[p] || 0);

            if (indoMarketSizeQtyChart) indoMarketSizeQtyChart.destroy();
            indoMarketSizeQtyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ label: 'Qty (kg)', data: values }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements) => {
                        if (!elements || elements.length === 0) return;
                        const index = elements[0].index;
                        const prov = labels[index];
                        openIndoMarketSizeDetailModal(prov);
                    }
                }
            });
        }

        // tabel segment crop per provinsi (mirip product-area)
        const dataByCrop = getIndoProductAreaDataForProvinsi('all');
        const tbody = document.getElementById('indo-market-table-body');
        if (tbody) {
            if (!dataByCrop.length) {
                tbody.innerHTML = `<tr><td colspan="5" class="py-3 px-3 text-left text-gray-500 text-sm">Belum ada data Indonesian market size.</td></tr>`;
            } else {
                tbody.innerHTML = dataByCrop.map((row, idx) => {
                    const idsJson = JSON.stringify(row.ids || []);
                    const cropSafe = (row.crop || '').replace(/"/g, '&quot;');
                    return `
                    <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="py-2 px-3">${idx + 1}</td>
                        <td class="py-2 px-3">${row.crop}</td>
                        <td class="py-2 px-3">${(row.qtyKg || 0).toLocaleString('id-ID')}</td>
                        <td class="py-2 px-3">${formatRupiah(row.totalRp || 0, true)}</td>
                        <td class="py-2 px-3 whitespace-nowrap">
                            <button type="button" class="text-xs text-blue-600 hover:underline mr-2" onclick='openIndoMarketSizeEditFromSegment("all", "${cropSafe}", ${idsJson})'>Edit</button>
                            <button type="button" class="text-xs text-red-600 hover:underline" onclick='confirmDeleteIndoMarketSizeFromSegment("all", "${cropSafe}")'>Hapus</button>
                        </td>
                    </tr>`;
                }).join('');
            }
        }
    }

    function openIndoMarketSizeDetailModal(provinsi) {
        const modal = document.getElementById('indo-market-size-detail-modal');
        if (!modal) return;
        const titleEl = document.getElementById('indo-market-size-detail-title');
        const subtitleEl = document.getElementById('indo-market-size-detail-subtitle');
        const bodyEl = document.getElementById('indo-market-size-detail-body');
        if (titleEl) titleEl.textContent = 'Detail Indonesian Market Size';
        if (subtitleEl) subtitleEl.textContent = provinsi && provinsi !== 'all' ? `Provinsi ${provinsi}` : 'Semua provinsi';

        const dataByCrop = getIndoProductAreaDataForProvinsi(provinsi);
        if (!dataByCrop || !dataByCrop.length) {
            bodyEl.innerHTML = '<div class="py-6 text-sm text-gray-500 text-left">Belum ada data Indonesian market size untuk provinsi ini.</div>';
        } else {
            const totalQty = dataByCrop.reduce((s, r) => s + (Number(r.qtyKg) || 0), 0);
            const totalRp = dataByCrop.reduce((s, r) => s + (Number(r.totalRp) || 0), 0);
            const headerHtml = `
                <div class="mb-4 space-y-2">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 text-[11px] text-blue-700">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <span>Total Qty: <span class="font-semibold">${totalQty.toLocaleString('id-ID')} kg</span></span>
                    </div>
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 text-[11px] text-emerald-700">
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <span>Total Nilai: <span class="font-semibold">${formatRupiah(totalRp, true)}</span></span>
                    </div>
                </div>
                <div class="text-[11px] text-gray-500 mb-2">Rincian per varietas</div>
            `;
            const listHtml = dataByCrop.map((row, idx) => {
                const qty = Number(row.qtyKg) || 0;
                const total = Number(row.totalRp) || 0;
                const avg = qty > 0 ? total / qty : 0;
                return `
                    <div class="flex items-center justify-between px-3 py-2 rounded-lg ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <div class="flex flex-col">
                            <span class="text-xs font-medium text-gray-900">${row.crop}</span>
                            <span class="text-[11px] text-gray-500">Qty: ${qty.toLocaleString('id-ID')} kg</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-semibold text-gray-900">${formatRupiah(total, true)}</div>
                            <div class="text-[11px] text-gray-400">Avg: ${formatRupiah(avg, true)}/kg</div>
                        </div>
                    </div>`;
            }).join('');
            bodyEl.innerHTML = headerHtml + '<div class="space-y-1">' + listHtml + '</div>';
        }

        modal.classList.remove('hidden');
        const inner = modal.querySelector('.transform');
        if (inner) inner.classList.remove('scale-95', 'opacity-0');

        const closeBtn = document.getElementById('indo-market-size-detail-close');
        if (closeBtn && !closeBtn._listenerAttached) {
            closeBtn.onclick = () => {
                const inner = modal.querySelector('.transform');
                if (inner) inner.classList.add('scale-95', 'opacity-0');
                modal.classList.add('hidden');
            };
            closeBtn._listenerAttached = true;
        }
        if (!modal._backdropListenerAttached) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    const inner = modal.querySelector('.transform');
                    if (inner) inner.classList.add('scale-95', 'opacity-0');
                    modal.classList.add('hidden');
                }
            });
            modal._backdropListenerAttached = true;
        }
    }

    function recalcIndoMarketTotal() {
        const qtyInput = document.getElementById('indo-market-qty');
        const priceInput = document.getElementById('indo-market-price');
        const totalInput = document.getElementById('indo-market-total');
        if (!qtyInput || !priceInput || !totalInput) return;
        const qty = cleanNumber(qtyInput.value);
        const price = cleanNumber(priceInput.value);
        const total = qty * price;
        totalInput.value = total > 0 ? formatNumberId(total) : '';
    }

    function openIndoMarketSizeEditFromSegment(provinsi, crop, ids) {
        const data = getIndoMarketSizeData();
        let record = null;
        if (Array.isArray(ids) && ids.length) {
            record = data.find(r => ids.includes(r.id));
        } else {
            record = data.find(r => r.crop === crop && (provinsi === 'all' || r.provinsi === provinsi));
        }
        if (!record) {
            showToast('Data Indonesian market size untuk crop ini tidak ditemukan.', 'error');
            return;
        }
        editingIndoMarketSizeId = record.id;
        const provSelect = document.getElementById('indo-market-provinsi');
        const cropSelect = document.getElementById('indo-market-crop');
        const qtyInput = document.getElementById('indo-market-qty');
        const priceInput = document.getElementById('indo-market-price');
        if (provSelect) provSelect.value = record.provinsi;
        if (cropSelect) cropSelect.value = record.crop;
        const qty = Number(record.qtyKg) || 0;
        const price = qty > 0 ? Math.round((Number(record.totalRp) || 0) / qty) : 0;
        if (qtyInput) qtyInput.value = qty ? formatNumberId(qty) : '';
        if (priceInput) priceInput.value = price ? formatNumberId(price) : '';
        const titleEl = document.getElementById('indo-market-size-modal-title');
        if (titleEl) titleEl.textContent = 'Edit Data Indonesian Market Size';
        recalcIndoMarketTotal();
        const modal = document.getElementById('indo-market-size-modal');
        if (!modal) return;
        modal.classList.remove('hidden');
        const inner = modal.querySelector('.transform');
        if (inner) inner.classList.remove('scale-95', 'opacity-0');
    }

    function confirmDeleteIndoMarketSizeFromSegment(provinsi, crop) {
        const provLabel = provinsi === 'all' ? 'semua provinsi' : `provinsi ${provinsi}`;
        showConfirmation(
            'Konfirmasi Hapus Data Indonesian Market Size',
            `Yakin ingin menghapus data Indonesian Market Size untuk crop "${crop}" di ${provLabel}?`,
            () => {
                deleteIndoMarketSizeByCrop(provinsi, crop);
                hideConfirmation();
            }
        );
    }

    function initIndoMarketSizePage() {
        console.log('initIndoMarketSizePage dipanggil');

        const provSelect = document.getElementById('indo-market-provinsi');
        const cropSelect = document.getElementById('indo-market-crop');
        const qtyInput = document.getElementById('indo-market-qty');
        const priceInput = document.getElementById('indo-market-price');
        const totalInput = document.getElementById('indo-market-total');
        const addBtn = document.getElementById('indo-market-add-button');

        // isi dropdown provinsi & crop
        if (provSelect) {
            const list = getMasterProvinsiList();
            provSelect.innerHTML = '<option value="">Pilih Provinsi</option>' +
                list.map(p => `<option value="${p}">${p}</option>`).join('');
        }
        if (cropSelect) {
            const list = getMasterVarietasList();
            cropSelect.innerHTML = '<option value="">Pilih Varietas / Crop</option>' +
                list.map(v => `<option value="${v}">${v}</option>`).join('');
        }

        // modal
        let modal = document.getElementById('indo-market-size-modal');
        if (modal && !modal._movedToBody) {
            document.body.appendChild(modal);
            modal._movedToBody = true;
        }

        if (addBtn && !addBtn._listenerAttached) {
            addBtn.onclick = () => {
                editingIndoMarketSizeId = null;
                const form = document.getElementById('indo-market-size-form');
                if (form) form.reset();
                const titleEl = document.getElementById('indo-market-size-modal-title');
                if (titleEl) titleEl.textContent = 'Tambah Data Indonesian Market Size';
                recalcIndoMarketTotal();
                const modal = document.getElementById('indo-market-size-modal');
                if (!modal) return;
                modal.classList.remove('hidden');
                const inner = modal.querySelector('.transform');
                if (inner) inner.classList.remove('scale-95', 'opacity-0');
            };
            addBtn._listenerAttached = true;
        }

        if (qtyInput) attachNumericFormatter(qtyInput, recalcIndoMarketTotal);
        if (priceInput) attachNumericFormatter(priceInput, recalcIndoMarketTotal);

        const form = document.getElementById('indo-market-size-form');
        const cancelBtn = document.getElementById('indo-market-cancel-button');
        if (cancelBtn && !cancelBtn._listenerAttached) {
            cancelBtn.onclick = () => {
                const modal = document.getElementById('indo-market-size-modal');
                if (modal) {
                    const inner = modal.querySelector('.transform');
                    if (inner) inner.classList.add('scale-95', 'opacity-0');
                    modal.classList.add('hidden');
                }
            };
            cancelBtn._listenerAttached = true;
        }

        if (form && !form._listenerAttached) {
            form.onsubmit = (e) => {
                e.preventDefault();
                const prov = document.getElementById('indo-market-provinsi').value;
                const crop = document.getElementById('indo-market-crop').value;
                const qty = cleanNumber(document.getElementById('indo-market-qty').value);
                const price = cleanNumber(document.getElementById('indo-market-price').value);
                const total = qty * price;
                if (!prov || !crop) {
                    showToast('Provinsi dan Crop wajib diisi', 'error');
                    return;
                }
                if (editingIndoMarketSizeId) {
                    updateIndoMarketSizeRecord(editingIndoMarketSizeId, {
                        provinsi: prov,
                        crop,
                        qtyKg: qty,
                        totalRp: total
                    });
                    editingIndoMarketSizeId = null;
                    const titleEl = document.getElementById('indo-market-size-modal-title');
                    if (titleEl) titleEl.textContent = 'Tambah Data Indonesian Market Size';
                } else {
                    addIndoMarketSizeRecord({ provinsi: prov, crop, qtyKg: qty, totalRp: total });
                }
                form.reset();
                const modal = document.getElementById('indo-market-size-modal');
                if (modal) {
                    const inner = modal.querySelector('.transform');
                    if (inner) inner.classList.add('scale-95', 'opacity-0');
                    modal.classList.add('hidden');
                }
            };
            form._listenerAttached = true;
        }

        updateIndoMarketSizeViews();
    }

    function getMasterKabupatenList() {
        if (!appState.masterKabupaten) appState.masterKabupaten = [];
        if (appState.masterKabupaten.length === 0) {
            appState.masterKabupaten = ['Garut', 'Bandung', 'Sumedang', 'Tasikmalaya', 'Bandung Barat'];
        }
        return appState.masterKabupaten;
    }

    function getMasterVarietasList() {
        if (!appState.masterVarietas) appState.masterVarietas = [];
        return appState.masterVarietas;
    }

    function refreshKabupatenSelects() {
        const kabList = getMasterKabupatenList();

        const marketKabSelect = document.getElementById('market-kabupaten');
        if (marketKabSelect) {
            marketKabSelect.innerHTML =
                '<option value="">Pilih Kabupaten</option>' +
                kabList.map(k => `<option value="${k}">${k}</option>`).join('');
        }

        const productAreaSelect = document.getElementById('product-area-kabupaten');
        if (productAreaSelect) {
            const current = productAreaSelect.value || 'all';
            productAreaSelect.innerHTML =
                '<option value="all">Semua Kabupaten</option>' +
                kabList.map(k => `<option value="${k}">${k}</option>`).join('');
            if (kabList.includes(current)) {
                productAreaSelect.value = current;
            } else {
                productAreaSelect.value = 'all';
            }
        }
    }

    
    function refreshCropSelect() {
        const varList = getMasterVarietasList();
        const cropSelect = document.getElementById('market-crop');
        if (cropSelect) {
            cropSelect.innerHTML =
                '<option value="">Pilih Varietas / Crop</option>' +
                varList.map(v => `<option value="${v}">${v}</option>`).join('');
        }
    }

function getMarketSizeData() {
        if (!appState.marketSize) appState.marketSize = [];
        return appState.marketSize;
    }

    function addMarketSizeRecord(record) {
        const list = getMarketSizeData();
        const withId = { id: Date.now(), ...record };
        list.push(withId);
        saveData();
        updateMarketSizeViews();
        showToast('Data market size berhasil disimpan', 'success');
    }

    function updateMarketSizeRecord(id, record) {
        const list = getMarketSizeData();
        const idx = list.findIndex(r => r.id === id);
        if (idx === -1) {
            showToast('Data market size yang akan diupdate tidak ditemukan', 'error');
            return;
        }
        list[idx] = { ...list[idx], ...record };
        saveData();
        updateMarketSizeViews();
        showToast('Data market size berhasil diupdate', 'success');
    }

    function deleteMarketSizeByCrop(kabupaten, crop) {
        const list = getMarketSizeData();
        const before = list.length;
        appState.marketSize = list.filter(r =>
            r.crop !== crop ||
            (kabupaten !== 'all' && r.kabupaten !== kabupaten)
        );
        if (appState.marketSize.length === before) {
            showToast('Tidak ada data yang dihapus.', 'info');
            return;
        }
        saveData();
        updateMarketSizeViews();
        showToast('Data market size berhasil dihapus.', 'success');
    }

    function importMarketSizeFromSheet(workbook) {
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        if (!rows || rows.length < 2) {
            showToast('File Excel tidak berisi data', 'error');
            return;
        }

        const header = rows[0].map(h => String(h || '').trim().toLowerCase());
        const idxKab = header.findIndex(h => h.includes('kab'));
        const idxCrop = header.findIndex(h => h.includes('crop') || h.includes('produk') || h.includes('varietas'));
        const idxQty = header.findIndex(h => h.includes('qty') || h.includes('kg'));
        const idxTotal = header.findIndex(h => h.includes('total') || (h.includes('rp') && !h.includes('%')));

        if (idxKab === -1 || idxCrop === -1 || idxQty === -1 || idxTotal === -1) {
            showToast('Header kolom tidak dikenali. Pastikan ada kolom Kabupaten, Crop, Qty, Total.', 'error');
            return;
        }

        const imported = [];
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;
            const kab = String(row[idxKab] || '').trim();
            const crop = String(row[idxCrop] || '').trim();
            const qty = Number(row[idxQty] || 0);
            const total = Number(row[idxTotal] || 0);
            if (!kab || !crop || (!qty && !total)) continue;
            imported.push({ kabupaten: kab, crop, qtyKg: qty, totalRp: total });
        }

        if (imported.length === 0) {
            showToast('Tidak ada baris data valid yang ditemukan', 'error');
            return;
        }

        const list = getMarketSizeData();
        imported.forEach(rec => list.push({ id: Date.now() + Math.random(), ...rec }));
        saveData();
        updateMarketSizeViews();
        showToast(`Berhasil import ${imported.length} baris data market size`, 'success');
    }

    function calculateMarketAggregates() {
        const data = getMarketSizeData();
        const totalRp = data.reduce((sum, r) => sum + (Number(r.totalRp) || 0), 0);

        const qtyPerKab = {};
        const kabList = getMasterKabupatenList();
        kabList.forEach(k => qtyPerKab[k] = 0);
        data.forEach(r => {
            const kab = r.kabupaten;
            const qty = Number(r.qtyKg) || 0;
            if (!kab || !qty) return;
            if (!qtyPerKab[kab]) qtyPerKab[kab] = 0;
            qtyPerKab[kab] += qty;
        });

        return { totalRp, qtyPerKab };
    }

    
    function getProductAreaDataForKabupaten(kabupaten) {
        const data = getMarketSizeData();
        const filtered = kabupaten && kabupaten !== 'all'
            ? data.filter(r => r.kabupaten === kabupaten)
            : data.slice();

        const byCrop = {};
        filtered.forEach(r => {
            const key = r.crop || 'Lainnya';
            if (!byCrop[key]) {
                byCrop[key] = { crop: key, qtyKg: 0, totalRp: 0, ids: [] };
            }
            byCrop[key].qtyKg += Number(r.qtyKg) || 0;
            byCrop[key].totalRp += Number(r.totalRp) || 0;
            if (r.id != null) byCrop[key].ids.push(r.id);
        });

        return Object.values(byCrop);
    }
    
    function openMarketSizeDetailModal(kabupaten) {
        const modal = document.getElementById('market-size-detail-modal');
        if (!modal) return;

        const titleEl = document.getElementById('market-size-detail-title');
        const subtitleEl = document.getElementById('market-size-detail-subtitle');
        const bodyEl = document.getElementById('market-size-detail-body');
        if (!bodyEl) return;

        // ---- Simple summary text ----
        if (titleEl) titleEl.textContent = 'Detail Market Size';
        if (subtitleEl) {
            subtitleEl.textContent = kabupaten && kabupaten !== 'all'
                ? `Kabupaten ${kabupaten}`
                : 'Semua kabupaten';
        }

        const dataByCrop = getProductAreaDataForKabupaten(kabupaten);
        if (!dataByCrop || dataByCrop.length === 0) {
            bodyEl.innerHTML = '<div class="py-6 text-sm text-gray-500 text-left">Belum ada data market size untuk kabupaten ini.</div>';
        } else {
            const totalQty = dataByCrop.reduce((s, r) => s + (Number(r.qtyKg) || 0), 0);
            const totalRp = dataByCrop.reduce((s, r) => s + (Number(r.totalRp) || 0), 0);

            const headerHtml = `
                <div class="mb-4 space-y-2">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 text-[11px] text-blue-700">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        <span>Total Qty: <span class="font-semibold">${totalQty.toLocaleString('id-ID')} kg</span></span>
                    </div>
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 text-[11px] text-emerald-700">
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <span>Total Nilai: <span class="font-semibold">${formatRupiah(totalRp, true)}</span></span>
                    </div>
                </div>
                <div class="text-[11px] text-gray-500 mb-2">Rincian per varietas</div>
            `;

            const listHtml = dataByCrop.map((row, idx) => {
                const qty = Number(row.qtyKg) || 0;
                const total = Number(row.totalRp) || 0;
                const avg = qty > 0 ? total / qty : 0;
                return `
                    <div class="flex items-center justify-between px-3 py-2 rounded-lg ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        <div class="flex flex-col">
                            <span class="text-xs font-medium text-gray-900">${row.crop}</span>
                            <span class="text-[11px] text-gray-500">Qty: ${qty.toLocaleString('id-ID')} kg</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-semibold text-gray-900">${formatRupiah(total, true)}</div>
                            <div class="text-[11px] text-gray-400">Avg: ${formatRupiah(avg, true)}/kg</div>
                        </div>
                    </div>
                `;
            }).join('');

            bodyEl.innerHTML = headerHtml + '<div class="space-y-1">' + listHtml + '</div>';
        }

        // Show modal with small animation
        modal.classList.remove('hidden');
        const inner = modal.querySelector('.transform');
        if (inner) {
            inner.classList.remove('scale-95', 'opacity-0');
        }

        const closeBtn = document.getElementById('market-size-detail-close');
        if (closeBtn && !closeBtn._listenerAttached) {
            closeBtn.onclick = () => {
                const inner = modal.querySelector('.transform');
                if (inner) inner.classList.add('scale-95', 'opacity-0');
                modal.classList.add('hidden');
            };
            closeBtn._listenerAttached = true;
        }

        // Close when clicking backdrop
        if (!modal._backdropListenerAttached) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    const inner = modal.querySelector('.transform');
                    if (inner) inner.classList.add('scale-95', 'opacity-0');
                    modal.classList.add('hidden');
                }
            });
            modal._backdropListenerAttached = true;
        }
    }




    function updateMarketSizeViews() {
        // Total card
        const { totalRp, qtyPerKab } = calculateMarketAggregates();
        const totalEl = document.getElementById('market-total-rp');
        if (totalEl) {
            totalEl.textContent = formatRupiah(totalRp, true);
        }

        // Bar chart qty per kabupaten
        const ctx = document.getElementById('marketSizeQtyChart');
        if (ctx) {
            const labels = getMasterKabupatenList();
            const values = labels.map(k => qtyPerKab[k] || 0);

            if (marketSizeQtyChart) marketSizeQtyChart.destroy();
            marketSizeQtyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Qty (kg)',
                        data: values,
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements, chart) => {
                        if (!elements || elements.length === 0) return;
                        const index = elements[0].index;
                        const kabupaten = labels[index];
                        if (!kabupaten) return;
                        openMarketSizeDetailModal(kabupaten);
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.formattedValue} kg`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value.toLocaleString('id-ID')
                            }
                        }
                    },
                    animation: {
                        duration: 700,
                        easing: 'easeOutCubic'
                    }
                }
            });
        }

        // Update product area views too (current kabupaten selection)
        const kabSelect = document.getElementById('product-area-kabupaten');
        const selectedKab = kabSelect ? kabSelect.value : 'all';
        updateProductAreaViews(selectedKab);
    }

    
    function updateProductAreaViews(kabupaten) {
    const provSelect = document.getElementById('product-area-provinsi');
    const kabSelect  = document.getElementById('product-area-kabupaten');

    const selectedProv = provSelect ? (provSelect.value || 'all') : 'all';
    const selectedKab  = (typeof kabupaten !== 'undefined')
        ? (kabupaten || 'all')
        : (kabSelect ? (kabSelect.value || 'all') : 'all');

    // Jika provinsi dipilih (bukan "all") → pakai Indonesian Market Size
    const useIndo = provSelect && selectedProv && selectedProv !== 'all';

    const dataByCrop = useIndo
        ? getIndoProductAreaDataForProvinsi(selectedProv)   // dari Indonesian Market Size
        : getProductAreaDataForKabupaten(selectedKab);      // dari Market Size per Kabupaten

    const labels = dataByCrop.map(d => d.crop);
    const totals = dataByCrop.map(d => d.totalRp);
    const qtys   = dataByCrop.map(d => d.qtyKg);

    // --- Bar chart Total Rp per crop ---
    const barCtx = document.getElementById('productAreaBarChart');
    if (barCtx) {
        if (productAreaBarChart) productAreaBarChart.destroy();
        productAreaBarChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Total (Rp)',
                    data: totals,
                    backgroundColor: '#3B82F6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => formatRupiah(ctx.raw, true) } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => formatRupiah(value, false)
                        }
                    }
                }
            }
        });
    }

    // --- Donut chart persentase per crop ---
    const donutCtx = document.getElementById('productAreaDonutChart');
    if (donutCtx) {
        if (productAreaDonutChart) productAreaDonutChart.destroy();
        const totalAll = totals.reduce((s, v) => s + v, 0) || 1;
        productAreaDonutChart = new Chart(donutCtx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data: totals,
                    backgroundColor: labels.map((_, i) => {
                        const base = [59, 130, 246]; // #3B82F6
                        const factor = 0.2 + 0.8 * (i + 1) / (labels.length + 1);
                        return `rgba(${base[0]}, ${base[1]}, ${base[2]}, ${factor.toFixed(2)})`;
                    })
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const value = ctx.raw || 0;
                                const pct = (value / totalAll) * 100;
                                return `${ctx.label}: ${formatRupiah(value, true)} (${pct.toFixed(1)}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }

    // --- Tabel Segment Crop (edit/hapus sinkron dengan sumber data) ---
    const tbody = document.getElementById('product-area-table-body');
    if (tbody) {
        if (!dataByCrop.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="py-3 px-3 text-left text-gray-500 text-sm">
                        Belum ada data untuk filter ini.
                    </td>
                </tr>`;
        } else {
            const safeKab  = selectedKab || 'all';
            const safeProv = selectedProv || 'all';

            tbody.innerHTML = dataByCrop.map((row, idx) => {
                const idsJson  = JSON.stringify(row.ids || []);
                const cropSafe = (row.crop || '').replace(/"/g, '&quot;');

                // Jika pakai Indonesian Market Size → pakai fungsi edit/hapus Indo
                const editHandler = useIndo
                    ? `openIndoMarketSizeEditFromSegment("${safeProv}", "${cropSafe}", ${idsJson})`
                    : `openMarketSizeEditFromSegment("${safeKab}", "${cropSafe}", ${idsJson})`;

                const deleteHandler = useIndo
                    ? `confirmDeleteIndoMarketSizeFromSegment("${safeProv}", "${cropSafe}")`
                    : `confirmDeleteMarketSizeFromSegment("${safeKab}", "${cropSafe}")`;

                return `
                <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="py-2 px-3">${idx + 1}</td>
                    <td class="py-2 px-3">${row.crop}</td>
                    <td class="py-2 px-3">${(row.qtyKg || 0).toLocaleString('id-ID')}</td>
                    <td class="py-2 px-3">${formatRupiah(row.totalRp || 0, true)}</td>
                    <td class="py-2 px-3 whitespace-nowrap">
                        <button type="button"
                            class="text-xs text-blue-600 hover:underline mr-2"
                            onclick='${editHandler}'>
                            Edit
                        </button>
                        <button type="button"
                            class="text-xs text-red-600 hover:underline"
                            onclick='${deleteHandler}'>
                            Hapus
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }
    }
}


    function openMarketSizeEditFromSegment(kabupaten, crop, ids) {
        const data = getMarketSizeData();
        let record = null;

        if (Array.isArray(ids) && ids.length) {
            record = data.find(r => ids.includes(r.id));
        } else {
            record = data.find(r =>
                r.crop === crop &&
                (kabupaten === 'all' || r.kabupaten === kabupaten)
            );
        }

        if (!record) {
            showToast('Data market size untuk crop ini tidak ditemukan.', 'error');
            return;
        }

        editingMarketSizeId = record.id;

        refreshKabupatenSelects();
        refreshCropSelect();

        const kabSelect = document.getElementById('market-kabupaten');
        const cropSelect = document.getElementById('market-crop');
        const qtyInput = document.getElementById('market-qty');
        const priceInput = document.getElementById('market-price');

        if (kabSelect) kabSelect.value = record.kabupaten;
        if (cropSelect) cropSelect.value = record.crop;

        const qty = Number(record.qtyKg) || 0;
        const price = qty > 0 ? Math.round((Number(record.totalRp) || 0) / qty) : 0;

        if (qtyInput) qtyInput.value = qty ? formatNumberId(qty) : '';
        if (priceInput) priceInput.value = price ? formatNumberId(price) : '';

        const titleEl = document.getElementById('market-size-modal-title');
        if (titleEl) titleEl.textContent = 'Edit Data Market Size';

        recalcMarketTotal();

        const modal = document.getElementById('market-size-modal');
        if (!modal) return;
        modal.classList.remove('hidden');
        const inner = modal.querySelector('.transform');
        if (inner) inner.classList.remove('scale-95', 'opacity-0');
    }

    function confirmDeleteMarketSizeFromSegment(kabupaten, crop) {
        const kabLabel = kabupaten === 'all' ? 'semua kabupaten' : `kabupaten ${kabupaten}`;
        showConfirmation(
            'Konfirmasi Hapus Data Market Size',
            `Yakin ingin menghapus data Market Size untuk crop "${crop}" di ${kabLabel}?`,
            () => {
                deleteMarketSizeByCrop(kabupaten, crop);
                hideConfirmation();
            }
        );
    }


    function renderMasterDataLists() {
        const kabList = getMasterKabupatenList();
        const varList = getMasterVarietasList();

        const kabUl = document.getElementById('master-kabupaten-list');
        if (kabUl) {
            kabUl.innerHTML = kabList.length
                ? kabList.map((k, i) => `
                    <li class="flex items-center justify-between px-3 py-2 text-sm">
                        <span class="truncate">${k}</span>
                        <div class="flex gap-2">
                            <button type="button"
                                    class="text-xs text-blue-600 hover:underline"
                                    onclick="editKabupaten(${i})">
                                Edit
                            </button>
                            <button type="button"
                                    class="text-xs text-red-600 hover:underline"
                                    onclick="deleteKabupaten(${i})">
                                Hapus
                            </button>
                        </div>
                    </li>
                `).join('')
                : '<li class="px-3 py-2 text-sm text-gray-500">Belum ada kabupaten.</li>';
        }

        const varUl = document.getElementById('master-varietas-list');
        if (varUl) {
            varUl.innerHTML = varList.length
                ? varList.map((v, i) => `
                    <li class="flex items-center justify-between px-3 py-2 text-sm">
                        <span class="truncate">${v}</span>
                        <div class="flex gap-2">
                            <button type="button"
                                    class="text-xs text-blue-600 hover:underline"
                                    onclick="editVarietas(${i})">
                                Edit
                            </button>
                            <button type="button"
                                    class="text-xs text-red-600 hover:underline"
                                    onclick="deleteVarietas(${i})">
                                Hapus
                            </button>
                        </div>
                    </li>
                `).join('')
                : '<li class="px-3 py-2 text-sm text-gray-500">Belum ada varietas/crop.</li>';
        }
    }

    async function handleAddKabupaten(event) {
        event.preventDefault();
        const input = document.getElementById('master-kabupaten-input');
        const val = (input.value || '').trim();
        if (!val) return false;

        if (!appState.masterKabupaten) appState.masterKabupaten = [];
        if (appState.masterKabupaten.includes(val)) {
            showToast('Kabupaten sudah ada di master data.', 'info');
            return false;
        }

        appState.masterKabupaten.push(val);
        await saveData();
        renderMasterDataLists();
        refreshKabupatenSelects();
        refreshCropSelect();
        showToast('Kabupaten berhasil ditambahkan.', 'success');
        input.value = '';
        return false;
    }

    async function handleAddVarietas(event) {
        event.preventDefault();
        const input = document.getElementById('master-varietas-input');
        const val = (input.value || '').trim();
        if (!val) return false;

        if (!appState.masterVarietas) appState.masterVarietas = [];
        if (appState.masterVarietas.includes(val)) {
            showToast('Varietas / crop sudah ada di master data.', 'info');
            return false;
        }

        appState.masterVarietas.push(val);
        await saveData();
        renderMasterDataLists();
        refreshCropSelect();
        showToast('Varietas / crop berhasil ditambahkan.', 'success');
        input.value = '';
        return false;
    }

    async function editKabupaten(index) {
        const current = appState.masterKabupaten[index];
        const edited = prompt('Edit nama kabupaten:', current);
        if (edited === null) return;

        const val = edited.trim();
        if (!val) {
            showToast('Nama kabupaten tidak boleh kosong.', 'error');
            return;
        }
        if (appState.masterKabupaten.includes(val) && val !== current) {
            showToast('Nama kabupaten sudah ada.', 'info');
            return;
        }

        appState.masterKabupaten[index] = val;
        await saveData();
        renderMasterDataLists();
        refreshKabupatenSelects();
        refreshCropSelect();
        showToast('Kabupaten berhasil diupdate.', 'success');
    }

    async function deleteKabupaten(index) {
        const nama = appState.masterKabupaten[index];
        if (!confirm(`Hapus kabupaten "${nama}" dari master data?`)) return;

        appState.masterKabupaten.splice(index, 1);
        await saveData();
        renderMasterDataLists();
        refreshKabupatenSelects();
        showToast('Kabupaten berhasil dihapus.', 'success');
    }

    async function editVarietas(index) {
        const current = appState.masterVarietas[index];
        const edited = prompt('Edit nama varietas / crop:', current);
        if (edited === null) return;

        const val = edited.trim();
        if (!val) {
            showToast('Nama varietas/crop tidak boleh kosong.', 'error');
            return;
        }
        if (appState.masterVarietas.includes(val) && val !== current) {
            showToast('Nama varietas/crop sudah ada.', 'info');
            return;
        }

        appState.masterVarietas[index] = val;
        await saveData();
        renderMasterDataLists();
        refreshCropSelect();
        showToast('Varietas / crop berhasil diupdate.', 'success');
    }

    async function deleteVarietas(index) {
        const nama = appState.masterVarietas[index];
        if (!confirm(`Hapus varietas / crop "${nama}" dari master data?`)) return;

        appState.masterVarietas.splice(index, 1);
        await saveData();
        renderMasterDataLists();
        refreshCropSelect();
        showToast('Varietas / crop berhasil dihapus.', 'success');
    }

    function initMasterDataPage() {
        getMasterKabupatenList();
        getMasterVarietasList();
        renderMasterDataLists();
        refreshKabupatenSelects();
    }



    
    function cleanNumber(str) {
        if (str === null || str === undefined) return 0;
        const cleaned = String(str).replace(/\./g, '').replace(/[^0-9]/g, '');
        return cleaned ? Number(cleaned) : 0;
    }

    function formatNumberId(num) {
        if (!num) return '';
        const s = Math.floor(num).toString();
        return s.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function attachNumericFormatter(input, onChange) {
        if (!input || input._formatted) return;
        input.addEventListener('input', () => {
            const numeric = cleanNumber(input.value);
            input.value = numeric ? formatNumberId(numeric) : '';
            if (typeof onChange === 'function') onChange();
        });
        input._formatted = true;
    }


function recalcMarketTotal() {
        const qtyInput = document.getElementById('market-qty');
        const priceInput = document.getElementById('market-price');
        const totalInput = document.getElementById('market-total');
        if (!qtyInput || !priceInput || !totalInput) return;

        const qty = cleanNumber(qtyInput.value);
        const price = cleanNumber(priceInput.value);
        const total = qty * price;

        totalInput.value = total > 0 ? formatNumberId(total) : '';
    }

    // =============================================
    // PLAN PO FUNCTIONS
    // =============================================
    
    function initPlanPOPage() {
        console.log('=== Init Plan PO Page ===');
        
        // Initialize plan PO data if not exists
        if (!appState.planPO) {
            appState.planPO = [];
            console.log('Created new planPO array');
        }
        
        // Migrate old data: convert month names to numbers
        const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        let migrated = false;
        appState.planPO.forEach(plan => {
            if (typeof plan.month === 'string' && isNaN(parseInt(plan.month))) {
                const monthIndex = monthNames.indexOf(plan.month);
                if (monthIndex > 0) {
                    plan.month = monthIndex;
                    migrated = true;
                    console.log(`Migrated plan ${plan.id}: ${monthNames[monthIndex]} -> ${monthIndex}`);
                }
            }
        });
        
        if (migrated) {
            console.log('Migration completed, saving data...');
            saveData();
        }
        
        console.log('Current appState:', {
            distributors: appState.distributors?.length || 0,
            varieties: appState.varieties?.length || 0,
            planPO: appState.planPO?.length || 0
        });
        
        // Add global debug function for troubleshooting
        window.debugPlanPO = function() {
            console.log('=== 🔍 DEBUG PLAN PO ===');
            console.log('📊 Total Plans:', appState.planPO?.length || 0);
            console.log('📦 Distributors:', appState.distributors?.length || 0);
            console.log('🌾 Varieties:', appState.varieties?.length || 0);
            console.log('');
            console.log('📋 Plan Details:');
            (appState.planPO || []).forEach((plan, i) => {
                const dist = appState.distributors?.find(d => d.id == plan.distributorId);
                const variety = appState.varieties?.find(v => v.id == plan.varietyId);
                console.log(`  Plan ${i + 1}:`, {
                    id: plan.id,
                    month: plan.month,
                    fiscalYear: plan.fiscalYear,
                    distributorId: plan.distributorId,
                    distributorName: dist?.name || '❌ NOT FOUND',
                    varietyId: plan.varietyId,
                    varietyName: variety?.name || '❌ NOT FOUND',
                    total: plan.total
                });
            });
            console.log('');
            console.log('💡 Tip: Jika distributor/variety NOT FOUND, check ID-nya tidak cocok!');
            console.log('=======================');
        };
        
        console.log('💡 Tip: Ketik debugPlanPO() di console untuk melihat detail data');
        
        // Populate form dropdowns
        populatePlanPOFormSelects();
        
        // Populate filter fiscal year dropdown
        populatePlanPOFilterYear();
        
        // Add event listeners for auto-calculate total - with slight delay to ensure DOM ready
        setTimeout(() => {
            ['plan-po-w1', 'plan-po-w2', 'plan-po-w3', 'plan-po-w4', 'plan-po-w5'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculatePlanPOTotal);
                    input.addEventListener('change', calculatePlanPOTotal);
                    console.log('Event listener added for', id);
                }
            });
        }, 100);
        
        renderPlanPOTable();
    }
    
    function populatePlanPOFormSelects() {
        // Populate Fiscal Years
        const fiscalYearSelect = document.getElementById('plan-po-fiscal-year');
        if (fiscalYearSelect) {
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let i = currentYear - 2; i <= currentYear + 3; i++) {
                years.push(`FY ${i}/${i+1}`);
            }
            fiscalYearSelect.innerHTML = '<option value="">Pilih Tahun Fiskal</option>' +
                years.map(y => `<option value="${y}">${y}</option>`).join('');
        }
        
        // Populate Distributors
        const distSelect = document.getElementById('plan-po-distributor');
        if (distSelect) {
            const distributors = appState.distributors || [];
            distSelect.innerHTML = '<option value="">Pilih Distributor</option>' +
                distributors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        }
        
        // Populate Varieties
        const varietySelect = document.getElementById('plan-po-variety');
        if (varietySelect) {
            const varieties = appState.varieties || [];
            varietySelect.innerHTML = '<option value="">Pilih Varietas</option>' +
                varieties.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        }
    }
    
    function togglePlanPOForm() {
        const formContainer = document.getElementById('plan-po-form-container');
        const btn = document.getElementById('toggle-plan-form-btn');
        
        if (formContainer.classList.contains('hidden')) {
            formContainer.classList.remove('hidden');
            btn.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>Tutup Form`;
            resetPlanPOForm();
        } else {
            formContainer.classList.add('hidden');
            btn.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>Tambah Plan PO`;
        }
    }
    
    function calculatePlanPOTotal() {
        console.log('calculatePlanPOTotal called');
        const w1 = parseFloat(document.getElementById('plan-po-w1').value) || 0;
        const w2 = parseFloat(document.getElementById('plan-po-w2').value) || 0;
        const w3 = parseFloat(document.getElementById('plan-po-w3').value) || 0;
        const w4 = parseFloat(document.getElementById('plan-po-w4').value) || 0;
        const w5 = parseFloat(document.getElementById('plan-po-w5').value) || 0;
        const total = w1 + w2 + w3 + w4 + w5;
        console.log('Total calculated:', total, {w1, w2, w3, w4, w5});
        
        const totalDisplay = document.getElementById('plan-po-total-display');
        if (totalDisplay) {
            totalDisplay.value = total.toLocaleString('id-ID', {minimumFractionDigits: 1, maximumFractionDigits: 1});
            console.log('Total display updated to:', totalDisplay.value);
        } else {
            console.error('Total display element not found');
        }
    }
    
    function updatePlanPOCalendar() {
        const monthValue = document.getElementById('plan-po-month').value;
        const fiscalYearValue = document.getElementById('plan-po-fiscal-year').value;
        const calendarDiv = document.getElementById('plan-po-calendar');
        const calendarContent = document.getElementById('plan-po-calendar-content');
        
        if (!monthValue || !fiscalYearValue) {
            calendarDiv.classList.add('hidden');
            return;
        }
        
        // Extract year from fiscal year (e.g., "FY 2025/2026" -> 2025)
        const year = parseInt(fiscalYearValue.match(/\d{4}/)[0]);
        const month = parseInt(monthValue) - 1; // 0-based for Date object
        
        // Get first and last day of month
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const totalDays = lastDay.getDate();
        
        // Calculate weeks
        const weeks = [];
        let currentWeek = { week: 1, start: 1, end: 0, days: [] };
        
        for (let day = 1; day <= totalDays; day++) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay(); // 0 = Sunday
            
            currentWeek.days.push(day);
            currentWeek.end = day;
            
            // End week on Saturday or last day of month
            if (dayOfWeek === 6 || day === totalDays) {
                weeks.push({...currentWeek});
                if (day < totalDays) {
                    currentWeek = { week: weeks.length + 1, start: day + 1, end: 0, days: [] };
                }
            }
        }
        
        // Display calendar
        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        calendarContent.innerHTML = weeks.map(week => `
            <div style="padding: 12px; background: white; border: 3px solid #2563eb; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="font-weight: 900; color: #000 !important; margin-bottom: 0.5rem; font-size: 20px;">W${week.week}</div>
                <div style="font-size: 16px; font-weight: 700; color: #000 !important;">${week.start}-${week.end} ${monthNames[month]}</div>
                <div style="font-size: 14px; font-weight: 700; color: #000 !important; margin-top: 0.25rem;">${week.days.length} hari</div>
            </div>
        `).join('');
        
        calendarDiv.classList.remove('hidden');
    }
    
    function savePlanPOEntry(event) {
        event.preventDefault();
        
        const editId = document.getElementById('plan-po-edit-id').value;
        const month = parseInt(document.getElementById('plan-po-month').value); // Parse as integer
        const fiscalYear = document.getElementById('plan-po-fiscal-year').value;
        const distributorId = document.getElementById('plan-po-distributor').value;
        const varietyId = document.getElementById('plan-po-variety').value;
        const w1 = parseFloat(document.getElementById('plan-po-w1').value) || 0;
        const w2 = parseFloat(document.getElementById('plan-po-w2').value) || 0;
        const w3 = parseFloat(document.getElementById('plan-po-w3').value) || 0;
        const w4 = parseFloat(document.getElementById('plan-po-w4').value) || 0;
        const w5 = parseFloat(document.getElementById('plan-po-w5').value) || 0;
        
        if (!appState.planPO) appState.planPO = [];
        
        console.log('📝 Saving plan PO entry:');
        console.log('  - Edit mode:', !!editId);
        console.log('  - Current planPO count:', appState.planPO.length);
        console.log('  - Month:', month, '(type:', typeof month, ')');
        console.log('  - Fiscal Year:', fiscalYear);
        console.log('  - Distributor ID:', distributorId);
        console.log('  - Variety ID:', varietyId);
        console.log('  - Total:', w1 + w2 + w3 + w4 + w5);
        
        const planEntry = {
            id: editId || Date.now().toString(),
            month: month,  // Simpan sebagai angka integer
            fiscalYear,
            distributorId,
            varietyId,
            w1,
            w2,
            w3,
            w4,
            w5,
            total: w1 + w2 + w3 + w4 + w5,
            createdAt: editId ? undefined : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        if (editId) {
            // Update existing
            const index = appState.planPO.findIndex(p => p.id === editId);
            if (index !== -1) {
                appState.planPO[index] = { ...appState.planPO[index], ...planEntry };
                console.log('✅ Plan PO updated at index', index);
                showToast('Plan PO berhasil diupdate!', 'success');
            }
        } else {
            // Check for duplicate before adding new
            const duplicateIndex = appState.planPO.findIndex(p => 
                p.month == month && 
                p.fiscalYear == fiscalYear && 
                p.distributorId == distributorId && 
                p.varietyId == varietyId
            );
            
            if (duplicateIndex !== -1) {
                console.warn('⚠️ Duplicate found! Updating existing instead of adding new');
                appState.planPO[duplicateIndex] = { ...appState.planPO[duplicateIndex], ...planEntry };
                showToast('Plan PO sudah ada, data telah diupdate!', 'info');
            } else {
                // Add new
                appState.planPO.push(planEntry);
                console.log('✅ New Plan PO added. Total count:', appState.planPO.length);
                showToast('Plan PO berhasil ditambahkan!', 'success');
            }
        }
        
        // Save to database
        saveData();
        
        // Reset form and hide
        resetPlanPOForm();
        document.getElementById('plan-po-form-container').classList.add('hidden');
        document.getElementById('toggle-plan-form-btn').innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>Tambah Plan PO`;
        
        // Refresh table
        renderPlanPOTable();
    }
    
    function resetPlanPOForm() {
        document.getElementById('plan-po-form').reset();
        document.getElementById('plan-po-edit-id').value = '';
        document.getElementById('plan-po-total-display').value = '0,0';
        document.getElementById('plan-po-w1').value = '0';
        document.getElementById('plan-po-w2').value = '0';
        document.getElementById('plan-po-w3').value = '0';
        document.getElementById('plan-po-w4').value = '0';
        document.getElementById('plan-po-w5').value = '0';
        document.getElementById('plan-po-calendar').classList.add('hidden');
    }
    
    function cancelPlanPOForm() {
        resetPlanPOForm();
        document.getElementById('plan-po-form-container').classList.add('hidden');
        document.getElementById('toggle-plan-form-btn').innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>Tambah Plan PO`;
    }
    
    function renderPlanPOTable() {
        const tbody = document.getElementById('plan-po-table-body');
        const emptyDiv = document.getElementById('plan-po-empty');
        
        if (!tbody) {
            console.error('plan-po-table-body not found');
            return;
        }
        
        const plans = appState.planPO || [];
        const distributors = appState.distributors || [];
        const varieties = appState.varieties || [];
        
        console.log('=== RENDERING PLAN PO TABLE ===');
        console.log('  - Total Plans:', plans.length);
        console.log('  - Total Distributors:', distributors.length);
        console.log('  - Total Varieties:', varieties.length);
        
        if (plans.length > 0) {
            console.log('  - Sample Plan:', plans[0]);
        }
        
        // Get filter values
        const filterMonth = document.getElementById('filter-plan-month')?.value || '';
        const filterYear = document.getElementById('filter-plan-year')?.value || '';
        
        console.log('  - Filter Month:', filterMonth || 'None');
        console.log('  - Filter Year:', filterYear || 'None');
        
        // Apply filters
        let filteredPlans = [...plans];
        if (filterMonth) {
            filteredPlans = filteredPlans.filter(p => {
                const planMonth = typeof p.month === 'number' ? p.month : parseInt(p.month);
                return planMonth == parseInt(filterMonth);
            });
        }
        if (filterYear) {
            filteredPlans = filteredPlans.filter(p => p.fiscalYear == filterYear);
        }
        
        console.log('  - Filtered Plans:', filteredPlans.length);
        
        // Check if there are no plans at all or no filtered results
        if (plans.length === 0) {
            tbody.innerHTML = '';
            if (emptyDiv) {
                emptyDiv.classList.remove('hidden');
                emptyDiv.innerHTML = `
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p style="font-weight: 700; font-size: 18px; color: #000 !important; margin-bottom: 0.5rem;">Belum ada Plan PO</p>
                    <p style="font-size: 14px; font-weight: 600; color: #374151 !important;">Klik tombol "Tambah Plan PO" untuk membuat plan baru</p>
                `;
            }
            return;
        }
        
        if (filteredPlans.length === 0) {
            // No results after filtering
            tbody.innerHTML = '';
            if (emptyDiv) {
                emptyDiv.classList.remove('hidden');
                emptyDiv.innerHTML = `
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p style="font-weight: 700; font-size: 18px; color: #000 !important; margin-bottom: 0.5rem;">Tidak ada data yang sesuai filter</p>
                    <p style="font-size: 14px; font-weight: 600; color: #374151 !important;">Coba ubah atau reset filter Anda</p>
                `;
            }
            return;
        }
        
        if (emptyDiv) emptyDiv.classList.add('hidden');
        
        // Build table rows
        const rows = filteredPlans.map((plan, index) => {
            const dist = distributors.find(d => d.id == plan.distributorId);
            const variety = varieties.find(v => v.id == plan.varietyId);
            
            if (!dist) {
                console.warn(`⚠️ Plan ${index + 1}: Distributor ID ${plan.distributorId} not found!`);
            }
            if (!variety) {
                console.warn(`⚠️ Plan ${index + 1}: Variety ID ${plan.varietyId} not found!`);
            }
            
            return `
                <tr style="background: white !important;">
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; font-size: 16px; font-weight: 900; color: #000 !important; background: #f1f5f9 !important;">${dist?.name || 'Unknown'}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; font-size: 16px; font-weight: 900; color: #000 !important; background: #f1f5f9 !important;">${variety?.name || 'Unknown'}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; text-align: right; font-size: 17px; font-weight: 900; color: #000 !important; background: #ffffff !important;">${(plan.w1 || 0).toLocaleString('id-ID', {minimumFractionDigits: 1})}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; text-align: right; font-size: 17px; font-weight: 900; color: #000 !important; background: #ffffff !important;">${(plan.w2 || 0).toLocaleString('id-ID', {minimumFractionDigits: 1})}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; text-align: right; font-size: 17px; font-weight: 900; color: #000 !important; background: #ffffff !important;">${(plan.w3 || 0).toLocaleString('id-ID', {minimumFractionDigits: 1})}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; text-align: right; font-size: 17px; font-weight: 900; color: #000 !important; background: #ffffff !important;">${(plan.w4 || 0).toLocaleString('id-ID', {minimumFractionDigits: 1})}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; text-align: right; font-size: 17px; font-weight: 900; color: #000 !important; background: #ffffff !important;">${(plan.w5 || 0).toLocaleString('id-ID', {minimumFractionDigits: 1})}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; text-align: right; font-weight: 900; font-size: 18px; background: #fef08a !important; color: #000 !important;">${(plan.total || 0).toLocaleString('id-ID', {minimumFractionDigits: 1})}</td>
                    <td style="padding: 12px 18px; border: 2px solid #334155 !important; text-align: center; font-size: 14px; background: #ffffff !important;">
                        <div class="flex justify-center gap-2">
                            <button onclick="editPlanPO('${plan.id}')" class="p-1 bg-blue-500 text-white rounded hover:bg-blue-600" title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deletePlanPO('${plan.id}')" class="p-1 bg-red-500 text-white rounded hover:bg-red-600" title="Hapus">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = rows;
    }
    
    function editPlanPO(planId) {
        const plan = appState.planPO.find(p => p.id === planId);
        if (!plan) {
            showToast('Plan PO tidak ditemukan', 'error');
            return;
        }
        
        // Show form
        const formContainer = document.getElementById('plan-po-form-container');
        formContainer.classList.remove('hidden');
        document.getElementById('toggle-plan-form-btn').innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>Tutup Form`;
        
        // Fill form - convert month name to number if needed
        const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        let monthNum = plan.month;
        
        // If month is stored as name (string), convert to number
        if (typeof plan.month === 'string') {
            monthNum = monthNames.indexOf(plan.month);
            if (monthNum === -1) monthNum = plan.month; // fallback if not found
        }
        
        document.getElementById('plan-po-edit-id').value = plan.id;
        document.getElementById('plan-po-month').value = monthNum;
        document.getElementById('plan-po-fiscal-year').value = plan.fiscalYear;
        document.getElementById('plan-po-distributor').value = plan.distributorId;
        document.getElementById('plan-po-variety').value = plan.varietyId;
        document.getElementById('plan-po-w1').value = plan.w1 || 0;
        document.getElementById('plan-po-w2').value = plan.w2 || 0;
        document.getElementById('plan-po-w3').value = plan.w3 || 0;
        document.getElementById('plan-po-w4').value = plan.w4 || 0;
        document.getElementById('plan-po-w5').value = plan.w5 || 0;
        
        calculatePlanPOTotal();
        updatePlanPOCalendar();
        
        // Scroll to form
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function deletePlanPO(planId) {
        if (!confirm('Apakah Anda yakin ingin menghapus Plan PO ini?')) {
            return;
        }
        
        const index = appState.planPO.findIndex(p => p.id === planId);
        if (index !== -1) {
            appState.planPO.splice(index, 1);
            saveData();
            showToast('Plan PO berhasil dihapus', 'success');
            renderPlanPOTable();
        }
    }
    
    function exportPlanPOToExcel() {
        const plans = appState.planPO || [];
        const distributors = appState.distributors || [];
        const varieties = appState.varieties || [];
        
        if (plans.length === 0) {
            showToast('Tidak ada data untuk diexport', 'error');
            return;
        }
        
        // Prepare data for Excel
        const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        const data = [];
        
        // Header row
        data.push(['Bulan', 'Tahun Fiskal', 'Distributor', 'ID Hybrids', 'W1', 'W2', 'W3', 'W4', 'W5', 'Total PO']);
        
        // Data rows
        plans.forEach(plan => {
            const dist = distributors.find(d => d.id == plan.distributorId);
            const variety = varieties.find(v => v.id == plan.varietyId);
            
            // Convert month number to name for display if it's a number
            const monthDisplay = typeof plan.month === 'number' ? monthNames[plan.month] : plan.month;
            
            data.push([
                monthDisplay || '-',
                plan.fiscalYear || '-',
                dist?.name || 'Unknown',
                variety?.name || 'Unknown',
                plan.w1 || 0,
                plan.w2 || 0,
                plan.w3 || 0,
                plan.w4 || 0,
                plan.w5 || 0,
                plan.total || 0
            ]);
        });
        
        // Create workbook
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Plan PO');
        
        // Style header row
        ws['!cols'] = [
            { wch: 12 }, // Bulan
            { wch: 15 }, // Tahun Fiskal
            { wch: 30 }, // Distributor
            { wch: 20 }, // ID Hybrids
            { wch: 10 }, // W1
            { wch: 10 }, // W2
            { wch: 10 }, // W3
            { wch: 10 }, // W4
            { wch: 10 }, // W5
            { wch: 12 }  // Total PO
        ];
        
        // Generate filename with date
        const dateStr = new Date().toISOString().split('T')[0];
        const filename = `Plan_PO_${dateStr}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, filename);
        showToast('File Excel berhasil diexport!', 'success');
    }

    // Populate filter fiscal year dropdown
    function populatePlanPOFilterYear() {
        const filterYearSelect = document.getElementById('filter-plan-year');
        if (!filterYearSelect) return;
        
        const currentYear = new Date().getFullYear();
        const years = [];
        for (let i = currentYear - 2; i <= currentYear + 3; i++) {
            years.push(`FY ${i}/${i+1}`);
        }
        
        // Keep "Semua Tahun" option and add years
        filterYearSelect.innerHTML = '<option value="">Semua Tahun</option>' +
            years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    // Filter plan PO table based on selected month and year
    function filterPlanPOTable() {
        renderPlanPOTable();
    }

    // Reset plan PO filters
    function resetPlanPOFilter() {
        document.getElementById('filter-plan-month').value = '';
        document.getElementById('filter-plan-year').value = '';
        renderPlanPOTable();
        showToast('Filter direset', 'info');
    }


function initMarketSizePage() {
        console.log('initMarketSizePage dipanggil');

        // Pastikan dropdown pakai master kabupaten & varietas
        refreshKabupatenSelects();
        refreshCropSelect();

        // Siapkan modal: pastikan berada langsung di body agar tidak tersembunyi oleh parent lain
        let modal = document.getElementById('market-size-modal');
        if (modal && !modal._movedToBody) {
            console.log('Memindahkan #market-size-modal ke <body>');
            document.body.appendChild(modal);
            modal._movedToBody = true;
        } else {
            console.log('Modal sudah di body atau tidak ditemukan saat init:', modal);
        }

        // Wire buttons & inputs
        const addBtn = document.getElementById('market-add-button');
        const qtyInput = document.getElementById('market-qty');
        const priceInput = document.getElementById('market-price');
        const totalInput = document.getElementById('market-total');
        const importBtn = document.getElementById('market-import-button');
        const importInput = document.getElementById('market-import-input');

        if (addBtn && !addBtn._listenerAttached) {
            console.log('market-add-button ditemukan', addBtn);
            addBtn.onclick = () => {
                console.log('Tombol Tambah Data diklik');
                editingMarketSizeId = null;
                const form = document.getElementById('market-size-form');
                if (form) form.reset();
                const titleEl = document.getElementById('market-size-modal-title');
                if (titleEl) titleEl.textContent = 'Tambah Data Market Size';
                recalcMarketTotal();
                const modal = document.getElementById('market-size-modal');
                console.log('Elemen modal:', modal);
                if (!modal) {
                    console.error('Modal #market-size-modal TIDAK ditemukan di DOM');
                    return;
                }
                modal.classList.remove('hidden');
                const inner = modal.querySelector('.transform');
                console.log('Inner modal:', inner);
                if (inner) {
                    inner.classList.remove('scale-95', 'opacity-0');
                } else {
                    console.warn('Elemen .transform di dalam modal tidak ditemukan');
                }
            };
            addBtn._listenerAttached = true;
        } else {
            console.warn('market-add-button tidak ditemukan ATAU listener sudah terpasang');
        }

        if (importBtn && importInput && !importBtn._listenerAttached) {
            console.log('market-import-button ditemukan');
            importBtn.onclick = () => {
                console.log('Tombol Import Excel diklik');
                importInput.click();
            };
            importInput.onchange = (e) => {
                const file = e.target.files && e.target.files[0];
                console.log('File dipilih:', file && file.name);
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('Workbook Excel terbaca, mulai import...');
                        importMarketSizeFromSheet(workbook);
                    } catch (err) {
                        console.error('Error baca Excel:', err);
                        showToast('Gagal membaca file Excel', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            importBtn._listenerAttached = true;
        }

        // Hitung total otomatis saat qty / harga berubah
        if (qtyInput) {
            attachNumericFormatter(qtyInput, recalcMarketTotal);
        }
        if (priceInput) {
            attachNumericFormatter(priceInput, recalcMarketTotal);
        }

        // Modal events
        const form = document.getElementById('market-size-form');
        const cancelBtn = document.getElementById('market-cancel-button');
        if (cancelBtn && !cancelBtn._listenerAttached) {
            cancelBtn.onclick = () => {
                console.log('Batal Market Size diklik');
                const modal = document.getElementById('market-size-modal');
                if (modal) {
                    const inner = modal.querySelector('.transform');
                    if (inner) {
                        inner.classList.add('scale-95', 'opacity-0');
                    }
                    modal.classList.add('hidden');
                }
            };
            cancelBtn._listenerAttached = true;
        }
        
        if (form && !form._listenerAttached) {
            form.onsubmit = (e) => {
                e.preventDefault();
                const kab = document.getElementById('market-kabupaten').value;
                const crop = document.getElementById('market-crop').value;
                const qty = cleanNumber(document.getElementById('market-qty').value);
                const price = cleanNumber(document.getElementById('market-price').value);
                const total = qty * price;
                console.log('Submit Market Size:', { kab, crop, qty, price, total, editingMarketSizeId });
                if (!kab || !crop) {
                    showToast('Kabupaten dan Crop wajib diisi', 'error');
                    return;
                }

                if (editingMarketSizeId) {
                    updateMarketSizeRecord(editingMarketSizeId, {
                        kabupaten: kab,
                        crop,
                        qtyKg: qty,
                        totalRp: total
                    });
                    editingMarketSizeId = null;
                    const titleEl = document.getElementById('market-size-modal-title');
                    if (titleEl) titleEl.textContent = 'Tambah Data Market Size';
                } else {
                    addMarketSizeRecord({ kabupaten: kab, crop, qtyKg: qty, totalRp: total });
                }

                form.reset();
                const modal = document.getElementById('market-size-modal');
                if (modal) {
                    const inner = modal.querySelector('.transform');
                    if (inner) {
                        inner.classList.add('scale-95', 'opacity-0');
                    }
                    modal.classList.add('hidden');
                }
            };
            form._listenerAttached = true;
        }
updateMarketSizeViews();
    }



function initProductAreaPage() {
    const provSelect = document.getElementById('product-area-provinsi');
    const kabSelect  = document.getElementById('product-area-kabupaten');

    // Isi dropdown provinsi dari master provinsi (sinkron dengan Indonesian Market Size)
    if (provSelect && !provSelect._initialized) {
        const provList = getMasterProvinsiList(); // sudah ada untuk Indo Market Size
        provSelect.innerHTML =
            '<option value="all">Semua Provinsi (Indonesia)</option>' +
            provList.map(p => `<option value="${p}">${p}</option>`).join('');
        provSelect._initialized = true;
    }

    // Listener perubahan provinsi
    if (provSelect && !provSelect._listenerAttached) {
        provSelect.addEventListener('change', () => {
            // ketika provinsi dipilih, cukup panggil updateProductAreaViews
            updateProductAreaViews(kabSelect ? kabSelect.value : 'all');
        });
        provSelect._listenerAttached = true;
    }

    // Listener perubahan kabupaten (tetap seperti sebelumnya)
    if (kabSelect && !kabSelect._listenerAttached) {
        kabSelect.addEventListener('change', () => {
            updateProductAreaViews(kabSelect.value);
        });
        kabSelect._listenerAttached = true;
    }

    // Initial render
    updateProductAreaViews(kabSelect ? kabSelect.value : 'all');
}

// Helper: update status PO (Draft / Partially Released / Fully Released)
    // berdasarkan total Ordered, Released, dan Cancelled.
    function updatePOStatusFromItems(poIndex) {
        const po = appState.purchaseOrders[poIndex];
        if (!po) return;
        const totalOrdered = po.items.reduce((sum, i) => sum + (i.qty || 0), 0);
        const totalReleased = po.items.reduce((sum, i) => sum + getReleasedQty(i), 0);
        const totalCancelled = po.items.reduce((sum, i) => sum + getCancelledQty(i), 0);

        if (totalReleased + totalCancelled >= totalOrdered && totalOrdered > 0) {
            po.status = 'Fully Released';
        } else if (totalReleased > 0 || totalCancelled > 0) {
            po.status = 'Partially Released';
        } else {
            po.status = 'Draft';
        }
    }


    // --- Page Navigation & Sidebar Logic---
    const pageTitle = document.getElementById('page-title');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const navMenu = document.getElementById('nav-menu');

    
    const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7m-9 2v8m4-8v8m5-8v8m-14-8v8"></path></svg>` },
        
        { 
            type: 'group', 
            label: 'Purchase Order', 
            icon: `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
            items: [
                { id: 'new-po', label: 'Buat PO Baru', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>` },
                { id: 'plan-po', label: 'Plan PO', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>` },
                { id: 'draft-po', label: 'Draft PO', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"></path></svg>` },
                { id: 'po-release', label: 'PO Release', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` },
                { id: 'arsip-po', label: 'Arsip PO', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v4H4V4zm0 6h16v10H4V10zm4 2h8"></path></svg>` },
            ]
        },

        { 
            type: 'group', 
            label: 'Analytics', 
            icon: `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>`,
            items: [
                { id: 'target', label: 'Target', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6a6 6 0 100 12 6 6 0 000-12zm0 3a3 3 0 110 6 3 3 0 010-6z"></path></svg>` },
                { id: 'dga', label: 'DGA', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>` },
                { id: 'presentation', label: 'Presentation', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>` },
                { id: 'insentif', label: 'Insentif', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15.5l-3.09 1.63.59-3.44-2.5-2.44 3.46-.5L12 7.5l1.54 3.25 3.46.5-2.5 2.44.59 3.44L12 15.5zM5 20h14v2H5z"></path></svg>` },
                { id: 'laporan', label: 'Laporan', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 012-2h8m-6 8h6M9 5h12"></path></svg>` },
            ]
        },

        { 
            type: 'group', 
            label: 'Market Data', 
            icon: `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            items: [
                { id: 'market-size', label: 'Market Size', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h4v12H4zM10 10h4v8h-4zM16 4h4v14h-4z"></path></svg>` },
                { id: 'indo-market', label: 'Indonesian Market', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h4v12H4zM10 10h4v8h-4zM16 4h4v14h-4z"></path></svg>` },
                { id: 'product-area', label: 'Product Per Area', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h18v4H3V4zm0 6h8v10H3V10zm10 0h8v10h-8V10z"></path></svg>` },
            ]
        },

        { 
            type: 'group', 
            label: 'Master Data', 
            icon: `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>`,
            items: [
                { id: 'master-data', label: 'Master Data', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h10M4 18h6"></path></svg>` },
                { id: 'distributors', label: 'Distributor', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7l9-4 9 4v10l-9 4-9-4V7z"></path></svg>` },
                { id: 'varieties', label: 'Varietas', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h6m-7 8h14a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>` },
                { id: 'stok-distributor', label: 'Stok Distributor', icon: `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>` },
            ]
        },

        { type: 'divider' },
        { id: 'settings', label: 'Pengaturan', icon: `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>` },
    ];

    
    function initializeNav() {
        navMenu.innerHTML = navItems.map(item => {
            if (item.type === 'divider') {
                return '<hr class="my-1.5 border-gray-200">';
            }
            if (item.type === 'group') {
                const groupId = item.label.replace(/\s+/g, '-').toLowerCase();
                const submenuItems = item.items.map(subitem => 
                    `<a href="#" onclick="showPage('${subitem.id}')" id="nav-${subitem.id}" class="nav-link flex items-center gap-2 py-1.5 px-3 pl-9 text-xs rounded-md text-blue-100 hover:bg-blue-700 hover:text-white transition-colors">
                        ${subitem.icon}<span>${subitem.label}</span>
                    </a>`
                ).join('');
                
                return `
                    <div class="nav-group">
                        <a href="#" onclick="toggleNavGroup('${groupId}'); return false;" class="nav-group-header flex items-center justify-between py-2 px-3 text-sm rounded-md text-blue-50 hover:bg-blue-800 font-medium transition-colors">
                            <div class="flex items-center gap-2">
                                ${item.icon}<span>${item.label}</span>
                            </div>
                            <svg id="chevron-${groupId}" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </a>
                        <div id="submenu-${groupId}" class="submenu hidden">
                            ${submenuItems}
                        </div>
                    </div>
                `;
            }
            return `<a href="#" onclick="showPage('${item.id}')" id="nav-${item.id}" class="nav-link flex items-center gap-2 py-2 px-3 text-sm rounded-md text-blue-100 hover:bg-blue-700 hover:text-white transition-colors">
                        ${item.icon}<span>${item.label}</span>
                    </a>`;
        }).join('');
    }

    function toggleNavGroup(groupId) {
        const submenu = document.getElementById(`submenu-${groupId}`);
        const chevron = document.getElementById(`chevron-${groupId}`);
        
        if (submenu.classList.contains('hidden')) {
            submenu.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            submenu.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }

    // Sidebar state helpers
    function applySidebarState() {
        const collapsed = document.body.classList.contains('sidebar-collapsed');

        if (collapsed) {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        } else {
            if (window.innerWidth < 768) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }
    }

    function hideSidebar() {
        document.body.classList.add('sidebar-collapsed');
        applySidebarState();
    }

    function toggleSidebar() {
        document.body.classList.toggle('sidebar-collapsed');
        applySidebarState();
    }

    function showPage(pageId, context = null) {
        // Close any open modals first
        const metricModal = document.getElementById('metric-detail-modal');
        if (metricModal) {
            metricModal.style.display = 'none';
        }
        document.body.style.overflow = 'auto';
        
        document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
        const pageElement = document.getElementById(pageId + '-page');
        if (pageElement) pageElement.style.display = 'block';
        
        // Update page title - show only for dashboard, hide for other pages
        if (pageId === 'dashboard') {
            pageTitle.style.display = 'block';
            pageTitle.textContent = 'Dashboard';
        } else {
            pageTitle.style.display = 'none';
        }

        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.getElementById(`nav-${pageId}`)?.classList.add('active');

        if (window.innerWidth < 768) hideSidebar();
        
        const pageInitializers = {
            'dashboard': createCharts,
            'laporan': setupLaporanPage,
            'insentif': initInsentifPage,
            'arsip-po': renderArsipPOTable,
            'distributors': renderDistributorCards,
            'target': renderTargetPage,
            'new-po': () => { if(!context) resetPOForm(); },
            'plan-po': initPlanPOPage,
            'market-size': initMarketSizePage,
            'indo-market': initIndoMarketSizePage,
            'product-area': initProductAreaPage,
            'master-data': initMasterDataPage,
            'dga': window.refreshDGAPage,
            'presentation': window.refreshPresentation,
            'settings': loadFarmerReachConfig,
            'stok-distributor': () => {
                console.log('📦 Loading Stok Distributor page...');
                console.log('  - Current stockDistributor count:', (appState.stockDistributor || []).length);
                populateStockFilters();
                
                // Ensure data is loaded before rendering
                if (!appState.stockDistributor) {
                    console.warn('⚠️ stockDistributor is not initialized, initializing to empty array');
                    appState.stockDistributor = [];
                }
                
                renderStockTable();
                console.log('✅ Stok Distributor page loaded');
            }
        };
        pageInitializers[pageId]?.();
        window.scrollTo(0, 0);
    }
    document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', hideSidebar);

    window.addEventListener('resize', applySidebarState);

    if (window.innerWidth >= 768) {
        document.body.classList.remove('sidebar-collapsed');
    } else {
        document.body.classList.add('sidebar-collapsed');
    }
    applySidebarState();


    // --- RENDER FUNCTIONS ---
    function renderAllPages() {
        document.getElementById('page-container').innerHTML = `
            <div id="dashboard-page" class="page" style="display:none;">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3">
                    <div class="flex items-center gap-2">
                        <label for="dashboard-fiscal-year-select" class="text-sm text-gray-600">Fiscal Year</label>
                        <select id="dashboard-fiscal-year-select" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="all">Semua</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="dashboard-distributor-filter" class="text-sm text-gray-600">Distributor</label>
                        <select id="dashboard-distributor-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="all">Semua</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="dashboard-variety-filter" class="text-sm text-gray-600">Varietas</label>
                        <select id="dashboard-variety-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="all">Semua</option>
                        </select>
                    </div>
                </div>
                <div id="dashboard-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
                <div id="dashboard-target-summary" class="bg-white p-6 rounded-lg shadow-sm mb-8"></div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm xl:col-span-2"><h3 class="font-bold text-lg mb-4">Grafik Penjualan Bulanan (Berdasarkan Tanggal Rilis)</h3><canvas id="salesChart"></canvas></div>
                    <div class="space-y-8">
                        <div id="variety-growth-summary" class="bg-white p-6 rounded-lg shadow-sm"></div>
                        <div id="variety-kg-summary" class="bg-white p-6 rounded-lg shadow-sm"></div>
                    </div>
                </div>

            <div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-3">
                    <h3 class="text-lg font-semibold">Compare Penjualan antar Fiscal Year</h3>
                    <div class="flex flex-wrap items-center gap-2 text-sm">
                        <span id="compare-distributor-label" class="text-gray-600"></span>
                        <label for="compare-fiscal-year-1" class="text-gray-600">FY 1</label>
                        <select id="compare-fiscal-year-1" class="border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"></select>
                        <label for="compare-fiscal-year-2" class="text-gray-600">FY 2</label>
                        <select id="compare-fiscal-year-2" class="border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"></select>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="compareSalesChart"></canvas>
                </div>
            </div>

            </div>

            <div id="new-po-page" class="page" style="display:none;"><div class="bg-white p-8 rounded-lg shadow-sm"><h3 class="text-xl font-bold mb-6">Formulir Purchase Order</h3><form id="po-form-fields"><input type="hidden" id="editing-po-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="distributor-select" class="block text-sm font-medium text-gray-700 mb-1">Distributor</label><select id="distributor-select" onchange="updateShipmentAddress()" class="w-full p-2 border rounded-md"></select></div><div><label for="po-number" class="block text-sm font-medium text-gray-700 mb-1">No PO</label><div class="flex items-center"><input type="text" id="po-number" class="w-full p-2 border rounded-md flex-grow" placeholder="Ketik atau generate No PO"><button type="button" onclick="document.getElementById('po-number').value = generatePONumber()" class="ml-2 p-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" title="Generate New PO Number"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg></button></div></div><div><label for="po-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal PO</label><input type="date" id="po-date" class="w-full p-2 border rounded-md"></div><div><label for="shipment-address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Kirim</label><textarea id="shipment-address" rows="3" class="w-full p-2 bg-gray-100 border rounded-md" readonly></textarea></div></div><div class="mt-8"><h4 class="font-bold mb-4">Item Pesanan</h4><div id="po-items-container" class="space-y-4"></div><button type="button" onclick="addPOItem()" class="mt-4 flex items-center px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Tambah Item</button></div><div class="mt-8"><h4 class="font-bold mb-4">Opsi Pembayaran</h4><div class="space-y-4"><div class="flex items-start p-3 border rounded-md"><input id="payment-cod" type="checkbox" onchange="updatePONotes()" class="h-5 w-5 mt-1 text-blue-600 rounded"><div class="ml-3 text-sm"><label for="payment-cod" class="font-medium">Payment COD/CBD</label><p class="text-xs text-gray-500">Cash Discount 4,5 % & Retailer Program 2 %</p></div></div><div class="flex items-start p-3 border rounded-md"><input id="payment-bg" type="checkbox" onchange="updatePONotes()" class="h-5 w-5 mt-1 text-blue-600 rounded"><div class="ml-3 text-sm"><label for="payment-bg" class="font-medium">Payment Cover BG / Cek</label><p class="text-xs text-gray-500">Retailer Program 2%</p></div></div></div></div><div class="mt-8"><label for="po-notes" class="block text-sm font-medium">Note</label><textarea id="po-notes" rows="4" class="w-full p-2 mt-1 border rounded-md"></textarea></div></form><div class="mt-8 flex justify-end"><button id="save-po-button" onclick="savePO()" class="px-6 py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700">Simpan PO</button></div></div></div>
            <div id="draft-po-page" class="page" style="display:none;"><div class="bg-white p-4 md:p-8 rounded-lg shadow-sm"><div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><h3 class="text-xl font-bold">Draft PO</h3><input type="text" id="search-draft-po" onkeyup="renderDraftPOTable()" placeholder="Cari No PO atau Distributor..." class="p-2 border rounded-md w-full max-w-xs"></div><div class="hidden md:block"><table class="min-w-full"><thead><tr class="bg-gray-50"><th class="py-2 px-4 text-left">No PO</th><th class="py-2 px-4 text-left">Tanggal PO</th><th class="py-2 px-4 text-left">Distributor</th><th class="py-2 px-4 text-left">Total</th><th class="py-2 px-4 text-left">Aksi</th></tr></thead><tbody id="draft-po-table-body"></tbody></table></div><div id="draft-po-card-container" class="md:hidden space-y-4"></div><div id="draft-po-empty" class="hidden"></div></div></div>
            <div id="po-release-page" class="page" style="display:none;"><div class="bg-white p-4 md:p-8 rounded-lg shadow-sm"><div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
    <h3 class="text-xl font-bold">PO Release</h3>
    <div class="flex flex-wrap items-center gap-2">
        <button type="button"
                onclick="downloadPOReleaseTemplate()"
                class="px-4 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4h16v4H4m4 6l4 4 4-4m-4 4V10"/>
            </svg>
            Download Template Excel
        </button>

        <button type="button"
                id="po-release-import-button"
                class="px-4 py-2 bg-gray-100 text-gray-700 text-sm rounded-md hover:bg-gray-200 flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4h16v4H4m4 6l4 4 4-4m-4 4V10"/>
            </svg>
            Import Excel
        </button>
        <input type="file" id="po-release-import-input" accept=".xlsx,xls" class="hidden">

        <input type="text"
               id="search-release-po"
               onkeyup="renderPOReleaseTable()"
               placeholder="Cari No PO atau Distributor."
               class="p-2 border rounded-md w-full max-w-xs">
    </div>
</div><div class="hidden md:block overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="py-2 px-4 text-left">No PO</th><th class="py-2 px-4 text-left">Distributor</th><th class="py-2 px-4 text-left">Qty (Dirilis/Dipesan)</th><th class="py-2 px-4 text-left">Nilai Dirilis</th><th class="py-2 px-4 text-left">Aksi</th></tr></thead><tbody id="po-release-table-body"></tbody></table></div><div id="po-release-card-container" class="md:hidden space-y-4"></div><div id="po-release-empty" class="hidden"></div></div></div>
            <div id="arsip-po-page" class="page" style="display:none;"><div class="bg-white p-4 md:p-8 rounded-lg shadow-sm"><div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><h3 class="text-xl font-bold">Arsip PO (Fully Released)</h3><input type="text" id="search-arsip-po" onkeyup="renderArsipPOTable()" placeholder="Cari No PO atau Distributor..." class="p-2 border rounded-md w-full max-w-xs"></div><div class="hidden md:block"><table class="min-w-full"><thead><tr class="bg-gray-50"><th class="py-2 px-4 text-left">No PO</th><th class="py-2 px-4 text-left">Tanggal PO</th><th class="py-2 px-4 text-left">Distributor</th><th class="py-2 px-4 text-left">Total</th><th class="py-2 px-4 text-left">Aksi</th></tr></thead><tbody id="arsip-po-table-body"></tbody></table></div><div id="arsip-po-card-container" class="md:hidden space-y-4"></div><div id="arsip-po-empty" class="hidden"></div></div></div>
            
            <div id="plan-po-page" class="page" style="display:none;">
                <div class="bg-white p-4 md:p-8 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-2xl font-black text-gray-900">Plan PO</h3>
                        <div class="flex flex-wrap items-center gap-3">
                            <button onclick="togglePlanPOForm()" id="toggle-plan-form-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-md hover:bg-blue-700 flex items-center shadow-md">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Tambah Plan PO
                            </button>
                            <button onclick="exportPlanPOToExcel()" class="px-4 py-2 bg-green-600 text-white text-sm font-bold rounded-md hover:bg-green-700 flex items-center shadow-md">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Export Excel
                            </button>
                        </div>
                    </div>

                    <!-- Form Input Plan PO -->
                    <div id="plan-po-form-container" class="hidden mb-6 p-6 border-2 border-blue-300 rounded-lg bg-gradient-to-br from-blue-50 to-blue-100 shadow-lg">
                        <h4 class="text-xl font-bold mb-4" style="color: #000 !important; font-weight: 900 !important;">Form Plan PO</h4>
                        <form id="plan-po-form" onsubmit="savePlanPOEntry(event)">
                            <input type="hidden" id="plan-po-edit-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label for="plan-po-month" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">Bulan</label>
                                    <select id="plan-po-month" onchange="updatePlanPOCalendar()" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 16px;" required>
                                        <option value="">Pilih Bulan</option>
                                        <option value="1">Januari</option>
                                        <option value="2">Februari</option>
                                        <option value="3">Maret</option>
                                        <option value="4">April</option>
                                        <option value="5">Mei</option>
                                        <option value="6">Juni</option>
                                        <option value="7">Juli</option>
                                        <option value="8">Agustus</option>
                                        <option value="9">September</option>
                                        <option value="10">Oktober</option>
                                        <option value="11">November</option>
                                        <option value="12">Desember</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="plan-po-fiscal-year" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">Tahun Fiskal</label>
                                    <select id="plan-po-fiscal-year" onchange="updatePlanPOCalendar()" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 16px;" required>
                                        <option value="">Pilih Tahun Fiskal</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="plan-po-distributor" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">Distributor</label>
                                    <select id="plan-po-distributor" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 16px;" required>
                                        <option value="">Pilih Distributor</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="plan-po-variety" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">Varietas</label>
                                    <select id="plan-po-variety" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 16px;" required>
                                        <option value="">Pilih Varietas</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Calendar Display -->
                            <div id="plan-po-calendar" class="hidden mb-4 p-4 bg-white rounded-lg border-2 border-blue-600 shadow-lg" style="background: white !important;">
                                <h5 style="font-size: 22px; font-weight: 900; color: #000 !important; margin-bottom: 1rem; text-shadow: none !important;">Kalender Mingguan</h5>
                                <div id="plan-po-calendar-content" class="grid grid-cols-5 gap-2"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
                                <div>
                                    <label for="plan-po-w1" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">W1</label>
                                    <input type="number" id="plan-po-w1" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 18px;" step="0.1" min="0" value="0" required>
                                </div>
                                <div>
                                    <label for="plan-po-w2" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">W2</label>
                                    <input type="number" id="plan-po-w2" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 18px;" step="0.1" min="0" value="0" required>
                                </div>
                                <div>
                                    <label for="plan-po-w3" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">W3</label>
                                    <input type="number" id="plan-po-w3" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 18px;" step="0.1" min="0" value="0" required>
                                </div>
                                <div>
                                    <label for="plan-po-w4" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">W4</label>
                                    <input type="number" id="plan-po-w4" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 18px;" step="0.1" min="0" value="0" required>
                                </div>
                                <div>
                                    <label for="plan-po-w5" style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">W5</label>
                                    <input type="number" id="plan-po-w5" style="width: 100%; padding: 12px; border: 2px solid #333; border-radius: 6px; background: white; font-weight: 700; color: #000 !important; font-size: 18px;" step="0.1" min="0" value="0" required>
                                </div>
                                <div class="flex items-end">
                                    <div class="w-full">
                                        <label style="display: block; font-size: 16px; font-weight: 900; color: #000 !important; margin-bottom: 0.5rem;">Total PO</label>
                                        <input type="text" id="plan-po-total-display" style="width: 100%; padding: 12px; border: 3px solid #16a34a; border-radius: 6px; background: #dcfce7; font-weight: 900; color: #166534 !important; font-size: 20px;" readonly value="0,0">
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="cancelPlanPOForm()" style="padding: 10px 20px; background: #d1d5db; color: #000; font-weight: 700; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                    Batal
                                </button>
                                <button type="submit" style="padding: 10px 20px; background: #2563eb; color: #fff; font-weight: 700; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                    Simpan
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Filter Section -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="filter-plan-month" class="block text-sm font-bold text-gray-700 mb-2">Filter Bulan</label>
                                <select id="filter-plan-month" onchange="filterPlanPOTable()" class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white font-semibold text-gray-800 hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all cursor-pointer">
                                    <option value="">Semua Bulan</option>
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3">Maret</option>
                                    <option value="4">April</option>
                                    <option value="5">Mei</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">Agustus</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-plan-year" class="block text-sm font-bold text-gray-700 mb-2">Filter Tahun Fiskal</label>
                                <select id="filter-plan-year" onchange="filterPlanPOTable()" class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white font-semibold text-gray-800 hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all cursor-pointer">
                                    <option value="">Semua Tahun</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="resetPlanPOFilter()" class="w-full px-4 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Reset Filter
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabel Hasil Plan PO -->
                    <div class="overflow-x-auto" style="border: 3px solid #334155 !important; border-radius: 8px; overflow: hidden; background: white !important;">
                        <table class="min-w-full" id="plan-po-table" style="border-collapse: collapse !important; background: white !important;">
                            <thead style="background: #1e40af !important;">
                                <tr style="background: #1e40af !important; color: #ffffff !important;">
                                    <th style="padding: 14px 18px; text-align: left; font-weight: 900; border: 2px solid #1e3a8a !important; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">Distributor</th>
                                    <th style="padding: 14px 18px; text-align: left; font-weight: 900; border: 2px solid #1e3a8a !important; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">ID Hybrids</th>
                                    <th style="padding: 14px 18px; text-align: center; font-weight: 900; border: 2px solid #1e3a8a !important; width: 90px; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">W1</th>
                                    <th style="padding: 14px 18px; text-align: center; font-weight: 900; border: 2px solid #1e3a8a !important; width: 90px; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">W2</th>
                                    <th style="padding: 14px 18px; text-align: center; font-weight: 900; border: 2px solid #1e3a8a !important; width: 90px; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">W3</th>
                                    <th style="padding: 14px 18px; text-align: center; font-weight: 900; border: 2px solid #1e3a8a !important; width: 90px; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">W4</th>
                                    <th style="padding: 14px 18px; text-align: center; font-weight: 900; border: 2px solid #1e3a8a !important; width: 90px; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">W5</th>
                                    <th style="padding: 14px 18px; text-align: center; font-weight: 900; border: 2px solid #1e3a8a !important; width: 110px; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">Total PO</th>
                                    <th style="padding: 14px 18px; text-align: center; font-weight: 900; border: 2px solid #1e3a8a !important; width: 110px; font-size: 16px; background: #1e40af !important; color: #ffffff !important;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="plan-po-table-body" style="background: white !important;"></tbody>
                        </table>
                    </div>
                    <div id="plan-po-empty" class="hidden text-center py-8">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p style="font-weight: 700; font-size: 18px; color: #000 !important; margin-bottom: 0.5rem;">Belum ada Plan PO</p>
                        <p style="font-size: 14px; font-weight: 600; color: #374151 !important;">Klik tombol "Tambah Plan PO" untuk membuat plan baru</p>
                    </div>
                </div>
            </div>
            
            <div id="target-page" class="page" style="display:none;">
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-100">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <h3 class="text-xl font-bold">Target Penjualan</h3>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="exportTargetToPDF()" class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Export PDF (Ringkasan)
                            </button>
                            <button onclick="exportTargetToCSV()" class="px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Export CSV (Ringkasan)
                            </button>
                            <button onclick="exportAllTargetBreakdownToPDF()" class="px-4 py-2 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Export PDF (Semua Breakdown)
                            </button>
                            <button onclick="exportAllTargetBreakdownToCSV()" class="px-4 py-2 bg-emerald-600 text-white text-sm rounded-md hover:bg-emerald-700 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Export CSV (Semua Breakdown)
                            </button>
                            
                            <button onclick="openTargetModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center text-sm">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                Buat Target Baru
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-md border flex flex-wrap items-end gap-4 mb-4" id="target-filter-row">
                        <div>
                            <label for="target-year-filter" class="block text-sm font-medium text-gray-700">Tahun Fiskal</label>
                            <select id="target-year-filter" class="mt-1 p-2 border rounded-md min-w-[160px]"></select>
                        </div>
                        <div>
                            <label for="target-distributor-filter" class="block text-sm font-medium text-gray-700">Distributor</label>
                            <select id="target-distributor-filter" class="mt-1 p-2 border rounded-md min-w-[200px]">
                                <option value="all">Semua</option>
                            </select>
                        </div>
                    </div>
                    <div id="target-list-container"></div>
                </div>
            </div><div id="laporan-page" class="page" style="display:none;">
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-100">
                    <h3 class="text-xl font-bold mb-6">Laporan Penjualan</h3>
                    <div class="bg-gray-50 p-4 rounded-md border flex flex-wrap items-end gap-4 mb-6">
                        <div><label for="laporan-type" class="block text-sm font-medium text-gray-700">Jenis Laporan</label><select id="laporan-type" class="mt-1 p-2 border rounded-md"></select></div>
                        <div><label for="laporan-unit" class="block text-sm font-medium text-gray-700">Satuan</label><select id="laporan-unit" class="mt-1 p-2 border rounded-md"></select></div>
                        <div id="laporan-month-selector-div"><label for="laporan-month" class="block text-sm font-medium text-gray-700">Bulan</label><select id="laporan-month" class="mt-1 p-2 border rounded-md"></select></div>
                        <div><label for="laporan-year" class="block text-sm font-medium text-gray-700">Tahun Fiskal</label><select id="laporan-year" class="mt-1 p-2 border rounded-md"></select></div>
                        <button onclick="generateLaporan()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Tampilkan Laporan</button>
                    </div>
                    <div id="laporan-content" class="space-y-8"></div>
                </div>
            </div>
            <div id="distributors-page" class="page" style="display:none;"><div class="bg-white p-8 rounded-lg shadow-sm"><h3 class="text-xl font-bold mb-4">Data Distributor</h3><div class="mb-6 p-4 border rounded-md bg-gray-50"><h4 class="font-semibold mb-2">Tambah Distributor Baru</h4><form id="add-distributor-form"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div class="lg:col-span-1"><label class="text-sm font-medium text-gray-700">Nama</label><input type="text" id="new-distributor-name" class="w-full mt-1 p-2 border rounded-md" required></div><div class="lg:col-span-1"><label class="text-sm font-medium text-gray-700">Alamat</label><input type="text" id="new-distributor-address" class="w-full mt-1 p-2 border rounded-md" required></div><div class="lg:col-span-1"><label class="text-sm font-medium text-gray-700">Contact Person</label><input type="text" id="new-distributor-cp" class="w-full mt-1 p-2 border rounded-md" required></div><div class="lg:col-span-1"><label class="text-sm font-medium text-gray-700">Logo</label><input type="file" id="new-distributor-logo" class="w-full text-sm mt-1 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*"></div></div><button type="submit" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Tambah</button></form></div><div><input type="text" id="search-distributor" onkeyup="renderDistributorCards()" placeholder="Cari Distributor..." class="p-2 border rounded-md w-full max-w-xs mb-4"></div><div id="distributor-card-container" class="space-y-4"></div><div id="distributor-empty" class="hidden"></div></div></div>
            <div id="varieties-page" class="page" style="display:none;"><div class="bg-white p-8 rounded-lg shadow-sm"><h3 class="text-xl font-bold mb-4">Data Varietas</h3><div class="mb-6 p-4 border rounded-md bg-gray-50"><h4 class="font-semibold mb-2">Tambah Varietas Baru</h4><form id="add-variety-form"><div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><input type="text" id="new-variety-name" placeholder="Nama Varietas" class="p-2 border rounded-md md:col-span-2" required><input type="number" id="new-variety-price" placeholder="Harga (Rp)" class="p-2 border rounded-md" required><input type="number" id="new-variety-weight" placeholder="Bobot (gr)" class="p-2 border rounded-md" required></div><button type="submit" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md">Tambah</button></form></div><div><input type="text" id="search-variety" onkeyup="renderVarietyTable()" placeholder="Cari Varietas..." class="p-2 border rounded-md w-full max-w-xs mb-4"></div><div class="overflow-x-auto"><table class="min-w-full"><thead><tr class="bg-gray-50"><th class="py-2 px-4 text-left">Nama Varietas</th><th class="py-2 px-4 text-left">Harga</th><th class="py-2 px-4 text-left">Bobot</th><th class="py-2 px-4 text-left">Aksi</th></tr></thead><tbody id="variety-table-body"></tbody></table></div><div id="variety-empty" class="hidden"></div></div></div>

            <!-- Stok Distributor Page -->
            <div id="stok-distributor-page" class="page" style="display:none;">
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-xl shadow-lg p-6 text-white">
                        <h3 class="text-3xl font-bold mb-2">📦 Stok Distributor</h3>
                        <p class="text-green-100">Kelola dan Monitor Stok Produk di Distributor</p>
                    </div>

                    <!-- Generate Link Section -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h4 class="text-lg font-bold mb-4">🔗 Generate Link Input Stok</h4>
                        <p class="text-sm text-gray-600 mb-4">Buat link khusus untuk distributor agar bisa mengisi stok mereka</p>
                        <div class="flex gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Distributor</label>
                                <select id="select-dist-for-link" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">-- Pilih Distributor --</option>
                                </select>
                            </div>
                            <button onclick="generateStockLink()" class="px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg font-medium shadow-md hover:from-green-700 hover:to-teal-700 transition">
                                Generate Link
                            </button>
                        </div>
                        <div id="generated-link-container" class="mt-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Link Generated:</label>
                            <div class="flex gap-2">
                                <input type="text" id="generated-link-input" readonly class="flex-1 p-3 border border-gray-300 rounded-lg bg-gray-50 text-sm" />
                                <button onclick="copyStockLink()" class="px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                                    📋 Copy
                                </button>
                                <button onclick="shareViaWhatsApp()" class="px-4 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                    </svg>
                                    Share WA
                                </button>
                                <button onclick="openStockLink()" class="px-4 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition">
                                    🔗 Open
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex flex-wrap gap-3 items-center">
                            <span class="text-xs font-semibold text-gray-600 uppercase">Filter:</span>
                            <select id="stock-filter-dist" onchange="renderStockTable()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                                <option value="">Semua Distributor</option>
                            </select>
                            <select id="stock-filter-variety" onchange="renderStockTable()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                                <option value="">Semua Varietas</option>
                            </select>
                            <input type="month" id="stock-filter-month" onchange="renderStockTable()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500" />
                        </div>
                    </div>

                    <!-- Stock Data Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-teal-50 border-b border-gray-200 flex items-center justify-between">
                            <h4 class="text-lg font-bold text-gray-800">📊 Data Stok Masuk</h4>
                            <button onclick="exportStockToPDF()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2 text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Export PDF
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Tanggal</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Distributor</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Varietas</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Qty</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">No Lot</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Expired</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase" title="Berapa lama lagi sampai expired">Sisa Waktu ⏱️</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase" title="Dihitung dari Tanggal Release/Turun PO (jika tersedia) untuk akurasi kualitas benih">Aging (hari) ⓘ</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Keterangan</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="stock-empty-state" class="hidden px-6 py-12 text-center">
                            <div class="text-gray-400 mb-2">
                                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 font-medium">Belum ada data stok</p>
                            <p class="text-sm text-gray-400 mt-1">Generate link dan bagikan ke distributor untuk mulai input stok</p>
                        </div>
                    </div>
                </div>
            </div>

            
            <div id="master-data-page" class="page" style="display:none;">
    <div class="bg-white p-8 rounded-lg shadow-sm">
        <h3 class="text-xl font-bold mb-6">Master Data</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Master Kabupaten -->
            <div>
                <h4 class="font-semibold mb-3">Master Kabupaten</h4>
                <form id="master-kabupaten-form"
                      class="flex gap-2 mb-4"
                      onsubmit="return handleAddKabupaten(event)">
                    <input
                        type="text"
                        id="master-kabupaten-input"
                        class="flex-1 p-2 border rounded-md"
                        placeholder="Nama kabupaten..."
                        required
                    />
                    <button
                        type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm"
                    >
                        Tambah
                    </button>
                </form>
                <div class="border rounded-md max-h-72 overflow-y-auto">
                    <ul id="master-kabupaten-list" class="divide-y"></ul>
                </div>
            </div>

            <!-- Master Varietas (nama crop) -->
            <div>
                <h4 class="font-semibold mb-3">Master Varietas / Crop</h4>
                <form id="master-varietas-form"
                      class="flex gap-2 mb-4"
                      onsubmit="return handleAddVarietas(event)">
                    <input
                        type="text"
                        id="master-varietas-input"
                        class="flex-1 p-2 border rounded-md"
                        placeholder="Nama varietas / crop..."
                        required
                    />
                    <button
                        type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm"
                    >
                        Tambah
                    </button>
                </form>
                <div class="border rounded-md max-h-72 overflow-y-auto">
                    <ul id="master-varietas-list" class="divide-y"></ul>
                </div>
            </div>
        </div>

        <p class="mt-6 text-xs text-gray-500">
            Master kabupaten digunakan untuk dropdown Market Size dan Product Per Area.
        </p>
    </div>
</div>
<div id="market-size-page" class="page" style="display:none;">
                <div class="bg-[#1E3A8A] text-white p-6 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold">Total Market Size</h3>
                        <p class="text-sm text-blue-100">Nilai pasar keseluruhan (Rp)</p>
                    </div>
                    <div id="market-total-rp" class="text-3xl font-bold tracking-tight">Rp 0</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Market Size per Kabupaten (Qty Kg)</h3>
                            <p class="text-sm text-gray-500">Distribusi volume per kabupaten prioritas</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="market-add-button" class="flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Tambah Data
                            </button>
                            <button id="market-import-button" class="flex items-center px-4 py-2 rounded-md bg-gray-100 text-gray-700 text-sm hover:bg-gray-200">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v4H4zm4 6l4 4 4-4m-4 4V10"></path>
                                </svg>
                                Import Excel
                            </button>
                            <input type="file" id="market-import-input" accept=".xlsx,.xls" class="hidden">
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="marketSizeQtyChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="indo-market-page" class="page" style="display:none;">
                <div class="bg-[#1E3A8A] text-white p-6 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold">Indonesian Market Size</h3>
                        <p class="text-sm text-blue-100">Nilai pasar keseluruhan di Indonesia (Rp)</p>
                    </div>
                    <div id="indo-market-total-rp" class="text-3xl font-bold tracking-tight">Rp 0</div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Market Size per Provinsi (Qty Kg)</h3>
                            <p class="text-sm text-gray-500">Distribusi volume per provinsi di Indonesia</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="indo-market-add-button" class="flex items-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Tambah Data
                            </button>
                        </div>
                    </div>
                    <div class="h-80 mb-8">
                        <canvas id="indoMarketSizeQtyChart"></canvas>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Segment Crop (Indonesia)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50 text-left">
                                        <th class="py-2 px-3">No</th>
                                        <th class="py-2 px-3">Crop</th>
                                        <th class="py-2 px-3">Qty (kg)</th>
                                        <th class="py-2 px-3">Total (Rp)</th>
                                        <th class="py-2 px-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="indo-market-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Indonesian Market Size -->
            <div id="indo-market-size-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 overflow-y-auto">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xl transform scale-95 opacity-0">
                    <h3 id="indo-market-size-modal-title" class="text-xl font-bold mb-4 text-gray-800">Tambah Data Indonesian Market Size</h3>
                    <form id="indo-market-size-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Provinsi</label>
                            <select id="indo-market-provinsi" class="w-full p-2 border rounded-md" required>
                                <option value="">Pilih Provinsi</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Crop</label>
                            <select id="indo-market-crop" class="w-full p-2 border rounded-md" required>
                                <option value="">Pilih Varietas / Crop</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Qty (kg)</label>
                                <input type="text" id="indo-market-qty" class="w-full p-2 border rounded-md" inputmode="numeric" autocomplete="off" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Harga per kg (Rp)</label>
                                <input type="text" id="indo-market-price" class="w-full p-2 border rounded-md" inputmode="numeric" autocomplete="off" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Total (Rp)</label>
                                <input type="text" id="indo-market-total" class="w-full p-2 border rounded-md bg-gray-50" inputmode="numeric" autocomplete="off" readonly>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" id="indo-market-cancel-button" class="px-4 py-2 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300">Batal</button>
                            <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Detail modal Indonesian Market Size -->
            <div id="indo-market-size-detail-modal" class="fixed inset-0 bg-black bg-opacity-40 z-40 flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-2xl shadow-lg w-full max-w-xl max-h-[80vh] overflow-y-auto transform scale-95 opacity-0 transition-all p-5">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 id="indo-market-size-detail-title" class="text-lg font-semibold text-gray-900">Detail Indonesian Market Size</h3>
                            <p id="indo-market-size-detail-subtitle" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                        <button id="indo-market-size-detail-close" class="p-2 rounded-full hover:bg-gray-100 text-gray-500">
                            <span class="sr-only">Tutup</span>
                            ✕
                        </button>
                    </div>
                    <div id="indo-market-size-detail-body" class="divide-y divide-gray-100 text-sm"></div>
                </div>
            </div>


            <div id="product-area-page" class="page" style="display:none;">
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="xl:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            
<div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
    <div>
        <h3 class="text-lg font-bold text-gray-800">Product Per Area</h3>
        <p class="text-sm text-gray-500">
            Total (Rp) per crop berdasarkan kabupaten (local) atau provinsi (Indonesian market size)
        </p>
    </div>

    <div class="flex flex-col sm:flex-row gap-3">
        <!-- Filter Provinsi (Indonesian Market Size) -->
        <div>
            <label for="product-area-provinsi" class="block text-sm font-medium text-gray-700 mb-1">
                Filter Provinsi (Indonesia)
            </label>
            <select id="product-area-provinsi" class="p-2 border rounded-md min-w-[180px]">
                <option value="all">Semua Provinsi (Indonesia)</option>
                <!-- opsi akan diisi otomatis dari getMasterProvinsiList() -->
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
                Jika pilih provinsi &ne; "Semua", data diambil dari Indonesian Market Size.
            </p>
        </div>

        <!-- Filter Kabupaten (Market Size lokal) -->
        <div>
            <label for="product-area-kabupaten" class="block text-sm font-medium text-gray-700 mb-1">
                Filter Kabupaten (Local)
            </label>
            <select id="product-area-kabupaten" class="p-2 border rounded-md min-w-[180px]">
                <option value="all">Semua Kabupaten</option>
                <!-- opsi akan diisi otomatis oleh refreshKabupatenSelects() -->
            </select>
            <p class="mt-1 text-[11px] text-gray-400">
                Dipakai jika provinsi = "Semua Provinsi (Indonesia)".
            </p>
        </div>
    </div>
</div>
                            <div class="h-80">
                                <canvas id="productAreaBarChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm overflow-x-auto">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Segment Crop</h3>
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50 text-left">
                                        <th class="py-2 px-3">No</th>
                                        <th class="py-2 px-3">Crop</th>
                                        <th class="py-2 px-3">Qty (kg)</th>
                                        <th class="py-2 px-3">Total (Rp)</th>
                                        <th class="py-2 px-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="product-area-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Persentase Market per Crop</h3>
                            <div class="h-72 flex items-center justify-center">
                                <canvas id="productAreaDonutChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DGA Page -->
            <div id="dga-page" class="page" style="display:none;">
                <div class="space-y-6">
                    <!-- Debug Button (Floating) -->
                    <button onclick="showDebugInfo()" class="fixed bottom-6 right-6 z-50 px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-full shadow-2xl font-bold text-sm flex items-center gap-2 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Debug Info</span>
                    </button>
                    
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold mb-2">DGA - Demand Generation Activity</h3>
                                <p class="text-blue-100 text-sm">Kelola aktivitas Business Solution per minggu</p>
                            </div>
                            <button onclick="openPublicDGAModal()" class="group relative px-6 py-3 bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2 border-2 border-white/30">
                                <svg class="w-5 h-5 group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                                <span>Link Public BS</span>
                            </button>
                        </div>
                    </div>

                    <!-- Legend/Info Box -->
                    <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-4 border-2 border-indigo-200">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-indigo-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="flex-1">
                                <h4 class="text-sm font-extrabold text-indigo-900 mb-2">📚 Jenis Kegiatan DGA:</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3 text-xs">
                                    <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm border border-blue-200">
                                        <span class="inline-block px-2.5 py-1 bg-blue-600 text-white rounded-md font-bold">FM</span>
                                        <span class="font-semibold text-gray-700">Farmers Meeting</span>
                                    </div>
                                    <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm border border-green-200">
                                        <span class="inline-block px-2.5 py-1 bg-green-600 text-white rounded-md font-bold">ODP</span>
                                        <span class="font-semibold text-gray-700">One Day Promo</span>
                                    </div>
                                    <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm border border-yellow-200">
                                        <span class="inline-block px-2.5 py-1 bg-yellow-500 text-gray-900 rounded-md font-bold">FT</span>
                                        <span class="font-semibold text-gray-700">Field Trial/Study</span>
                                    </div>
                                    <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm border border-purple-200">
                                        <span class="inline-block px-2.5 py-1 bg-purple-600 text-white rounded-md font-bold">FFD</span>
                                        <span class="font-semibold text-gray-700">Farm Field Day</span>
                                    </div>
                                    <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm border border-pink-200">
                                        <span class="inline-block px-2.5 py-1 bg-pink-600 text-white rounded-md font-bold">DISPLAY</span>
                                        <span class="font-semibold text-gray-700">Product Display</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Add BS Section -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-medium text-gray-700">Business Solution:</span>
                            <form id="add-bs-form" class="flex-1 flex gap-2" style="display:inline-flex;">
                                <input type="text" id="bs-name-input" placeholder="Nama BS baru" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium text-sm shadow transition whitespace-nowrap">
                                    + Tambah BS
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Compact Input Form -->
                    <div class="bg-white rounded-xl shadow-sm border border-blue-200 p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Input Data Cepat
                            </h4>
                            <button onclick="openBatchInputModal()" class="group relative px-5 py-2.5 bg-gradient-to-r from-purple-600 via-pink-600 to-red-500 text-white rounded-xl hover:from-purple-700 hover:via-pink-700 hover:to-red-600 active:scale-95 font-bold text-sm shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2 overflow-hidden">
                                <!-- Animated background -->
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                                <svg class="w-5 h-5 relative z-10 group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span class="relative z-10">Input Data BS Batch</span>
                                <span class="relative z-10 px-2 py-0.5 bg-white/25 backdrop-blur-sm rounded-md text-xs font-extrabold">Pro</span>
                            </button>
                        </div>
                        <form id="dga-quick-add-form" class="space-y-3">
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                <input type="month" id="dga-month-input" class="px-3 py-2 border-2 border-gray-400 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Bulan" required>
                                <select id="dga-week-input" class="px-3 py-2 border-2 border-gray-400 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Minggu</option>
                                    <option value="1">W1</option>
                                    <option value="2">W2</option>
                                    <option value="3">W3</option>
                                    <option value="4">W4</option>
                                    <option value="5">W5</option>
                                </select>
                                <select id="dga-bs-input" class="px-3 py-2 border-2 border-gray-400 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Pilih BS</option>
                                </select>
                                <select id="dga-activity-type-input" class="px-3 py-2 border-2 border-gray-400 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Pilih Kegiatan</option>
                                    <option value="FM">FM - Farmers Meeting</option>
                                    <option value="ODP">ODP - One Day Promo</option>
                                    <option value="FT">FT - Field Trial/Study</option>
                                    <option value="FFD">FFD - Farm Field Day</option>
                                    <option value="DISPLAY">DISPLAY - Product Display</option>
                                </select>
                                <input type="text" id="dga-description-input" class="px-3 py-2 border-2 border-gray-400 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Keterangan">
                            </div>
                            <button type="submit" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 font-medium shadow-md transition">
                                ✓ Tambah Kegiatan
                            </button>
                        </form>
                    </div>

                    <!-- Filter Bar -->
                    <div class="bg-gradient-to-r from-gray-100 to-gray-50 rounded-lg p-4 border-2 border-gray-300 shadow-sm">
                        <div class="flex flex-wrap gap-3 items-center">
                            <span class="text-xs font-extrabold text-gray-800 uppercase tracking-wider">🔍 Filter:</span>
                            <select id="dga-filter-month" class="px-3 py-2 border-2 border-gray-400 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Semua Bulan</option>
                            </select>
                            <select id="dga-filter-bs" class="px-3 py-2 border-2 border-gray-400 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Semua BS</option>
                            </select>
                        </div>
                    </div>

                    <!-- Weekly Grid Table -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4">
                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Tabel Kegiatan Mingguan
                            </h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gradient-to-r from-gray-100 to-gray-50 border-b-2 border-gray-300">
                                        <th class="px-4 py-3 text-left text-xs font-extrabold text-gray-900 uppercase tracking-wider w-36 sticky left-0 bg-white z-20">Business Solution</th>
                                        <th class="px-4 py-3 text-center text-xs font-extrabold text-blue-900 uppercase tracking-wider bg-blue-50 border-l border-blue-200">W1</th>
                                        <th class="px-4 py-3 text-center text-xs font-extrabold text-green-900 uppercase tracking-wider bg-green-50 border-l border-green-200">W2</th>
                                        <th class="px-4 py-3 text-center text-xs font-extrabold text-yellow-900 uppercase tracking-wider bg-yellow-50 border-l border-yellow-200">W3</th>
                                        <th class="px-4 py-3 text-center text-xs font-extrabold text-purple-900 uppercase tracking-wider bg-purple-50 border-l border-purple-200">W4</th>
                                        <th class="px-4 py-3 text-center text-xs font-extrabold text-pink-900 uppercase tracking-wider bg-pink-50 border-l border-pink-200">W5</th>
                                        <th class="px-4 py-3 text-center text-sm font-black text-orange-950 uppercase tracking-wider bg-gradient-to-br from-orange-200 to-yellow-200 border-l-4 border-orange-500 shadow-lg">📊 TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody id="dga-weekly-table-body" class="divide-y divide-gray-200">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div class="bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg p-5 border-l-4 border-blue-700 shadow-lg">
                            <div class="text-xs font-black text-blue-800 uppercase tracking-wide">FM</div>
                            <div class="text-xs font-semibold text-blue-700 mb-1">Farmers Meeting</div>
                            <div class="text-4xl font-black text-blue-950 mt-2" id="dga-count-fm">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-100 to-green-200 rounded-lg p-5 border-l-4 border-green-700 shadow-lg">
                            <div class="text-xs font-black text-green-800 uppercase tracking-wide">ODP</div>
                            <div class="text-xs font-semibold text-green-700 mb-1">One Day Promo</div>
                            <div class="text-4xl font-black text-green-950 mt-2" id="dga-count-odp">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-lg p-5 border-l-4 border-yellow-700 shadow-lg">
                            <div class="text-xs font-black text-yellow-900 uppercase tracking-wide">FT</div>
                            <div class="text-xs font-semibold text-yellow-800 mb-1">Field Trial/Study</div>
                            <div class="text-4xl font-black text-yellow-950 mt-2" id="dga-count-ft">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-100 to-purple-200 rounded-lg p-5 border-l-4 border-purple-700 shadow-lg">
                            <div class="text-xs font-black text-purple-800 uppercase tracking-wide">FFD</div>
                            <div class="text-xs font-semibold text-purple-700 mb-1">Farm Field Day</div>
                            <div class="text-4xl font-black text-purple-950 mt-2" id="dga-count-ffd">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-pink-100 to-pink-200 rounded-lg p-5 border-l-4 border-pink-700 shadow-lg">
                            <div class="text-xs font-black text-pink-800 uppercase tracking-wide">DISPLAY</div>
                            <div class="text-xs font-semibold text-pink-700 mb-1">Product Display</div>
                            <div class="text-4xl font-black text-pink-950 mt-2" id="dga-count-display">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-100 via-orange-200 to-amber-200 rounded-lg p-5 border-l-4 border-orange-700 shadow-xl ring-2 ring-orange-300">
                            <div class="flex items-center gap-2 mb-1">
                                <svg class="w-4 h-4 text-orange-700" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                </svg>
                                <div class="text-xs font-black text-orange-800 uppercase tracking-wide">Farmer Reach</div>
                            </div>
                            <div class="text-xs font-semibold text-orange-700 mb-1">Total Petani Terjangkau</div>
                            <div class="text-3xl font-black text-orange-950 mt-2" id="dga-farmer-reach">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Presentation Page -->
            <div id="presentation-page" class="page" style="display:none;">
                <div class="space-y-6">
                    <!-- Header with Period Selector -->
                    <div class="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 rounded-xl shadow-lg p-6 text-white" style="position: relative; z-index: 100; overflow: visible;">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4" style="position: relative; z-index: 101;">
                            <div>
                                <h3 class="text-3xl font-bold mb-2">📊 Presentation Dashboard</h3>
                                <p class="text-blue-100">Data untuk Meeting Mingguan & Bulanan</p>
                                <p id="pres-data-info" class="text-xs text-yellow-200 mt-1"></p>
                            </div>
                            <div class="flex flex-wrap gap-3 items-end" style="position: relative; z-index: 102;">
                                <div>
                                    <label class="text-xs text-white/80 block mb-1">Distributor</label>
                                    <select id="pres-distributor" onchange="if(window.refreshPresentation) window.refreshPresentation();" class="px-4 py-2 bg-white text-gray-800 rounded-lg font-medium shadow-md cursor-pointer hover:bg-gray-50 transition-colors min-w-[180px]">
                                        <option value="">Semua Distributor</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-white/80 block mb-1">Bulan</label>
                                    <select id="pres-month" onchange="if(window.refreshPresentation) window.refreshPresentation();" class="px-4 py-2 bg-white text-gray-800 rounded-lg font-medium shadow-md cursor-pointer hover:bg-gray-50 transition-colors">
                                        <option value="">Semua Bulan</option>
                                    <option value="01">Januari</option>
                                    <option value="02">Februari</option>
                                    <option value="03">Maret</option>
                                    <option value="04">April</option>
                                    <option value="05">Mei</option>
                                    <option value="06">Juni</option>
                                    <option value="07">Juli</option>
                                    <option value="08">Agustus</option>
                                    <option value="09">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                                </div>
                                <div>
                                    <label class="text-xs text-white/80 block mb-1">Tahun Fiskal</label>
                                    <select id="pres-year" onchange="if(window.refreshPresentation) window.refreshPresentation();" class="px-4 py-2 bg-white text-gray-800 rounded-lg font-medium shadow-md cursor-pointer hover:bg-gray-50 transition-colors">
                                        <option value="">Semua FY</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-white/80 block mb-1">Periode</label>
                                    <select id="pres-period" onchange="if(window.refreshPresentation) window.refreshPresentation();" class="px-4 py-2 bg-white text-gray-800 rounded-lg font-medium shadow-md cursor-pointer hover:bg-gray-50 transition-colors">
                                        <option value="all" selected>Semua Data</option>
                                        <option value="week">Minggu Ini</option>
                                        <option value="month">Bulan Ini</option>
                                        <option value="quarter">Quarter Ini</option>
                                        <option value="year">Tahun Ini</option>
                                    </select>
                                </div>
                                <div class="flex items-end gap-2">
                                    <button onclick="startSlideshow()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium shadow-md hover:from-purple-600 hover:to-pink-600 transition flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Slideshow
                                    </button>
                                    <button onclick="toggleFYComparison()" id="fy-compare-btn" class="px-4 py-2 bg-white/20 backdrop-blur-sm text-white rounded-lg font-medium shadow-md hover:bg-white/30 transition border border-white/30">
                                        📊 Compare
                                    </button>
                                    <button onclick="window.print()" class="px-4 py-2 bg-white text-purple-600 rounded-lg font-medium shadow-md hover:bg-gray-50 transition">
                                        🖨️ Print
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- FY Comparison Panel (Hidden by default) -->
                        <div id="fy-compare-panel" class="hidden mt-4 p-4 bg-white/10 backdrop-blur-sm rounded-lg border border-white/20">
                            <div class="flex items-center gap-4 flex-wrap">
                                <span class="text-sm font-semibold text-white">Bandingkan:</span>
                                <select id="fy-compare-1" onchange="window.refreshFYComparison()" class="px-3 py-2 bg-white text-gray-800 rounded-lg text-sm font-medium shadow-md">
                                    <option value="">Pilih FY 1</option>
                                </select>
                                <span class="text-white font-bold">vs</span>
                                <select id="fy-compare-2" onchange="window.refreshFYComparison()" class="px-3 py-2 bg-white text-gray-800 rounded-lg text-sm font-medium shadow-md">
                                    <option value="">Pilih FY 2</option>
                                </select>
                                <button onclick="clearFYComparison()" class="px-3 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg text-sm font-medium shadow-md transition">
                                    ✕ Clear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div onclick="showMetricDetail('po')" class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-lg cursor-pointer hover:scale-105 transform transition-all duration-200 hover:shadow-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Total PO</span>
                                <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <div class="text-lg font-bold break-words leading-tight" id="pres-total-po">0</div>
                            <div class="text-xs opacity-75 mt-1">Purchase Orders</div>
                        </div>
                        <div onclick="showMetricDetail('sales')" class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 text-white shadow-lg cursor-pointer hover:scale-105 transform transition-all duration-200 hover:shadow-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Total Sales</span>
                                <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div class="text-base font-bold break-words leading-tight" id="pres-total-sales">Rp 0</div>
                            <div class="text-xs opacity-75 mt-1">Revenue Generated</div>
                        </div>
                        <div onclick="showMetricDetail('qty')" class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl p-5 text-white shadow-lg cursor-pointer hover:scale-105 transform transition-all duration-200 hover:shadow-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Total Qty</span>
                                <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                            </div>
                            <div class="text-lg font-bold break-words leading-tight" id="pres-total-qty">0</div>
                            <div class="text-xs opacity-75 mt-1">Units Sold</div>
                        </div>
                        <div onclick="showMetricDetail('dga')" class="bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl p-5 text-white shadow-lg cursor-pointer hover:scale-105 transform transition-all duration-200 hover:shadow-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Aktivitas DGA</span>
                                <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            </div>
                            <div class="text-lg font-bold break-words leading-tight" id="pres-total-dga">0</div>
                            <div class="text-xs opacity-75 mt-1">Team Activities</div>
                        </div>
                        <div onclick="showMetricDetail('distributors')" class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-5 text-white shadow-lg cursor-pointer hover:scale-105 transform transition-all duration-200 hover:shadow-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Distributors</span>
                                <svg class="w-8 h-8 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                            </div>
                            <div class="text-lg font-bold break-words leading-tight" id="pres-total-distributors">0</div>
                            <div class="text-xs opacity-75 mt-1">Active Partners</div>
                        </div>
                    </div>

                    <!-- DGA Summary -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-4">
                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                Ringkasan Aktivitas DGA
                            </h4>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="pres-dga-summary">
                            </div>
                        </div>
                    </div>

                    <!-- DGA Activities Detail per BS -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-4">
                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                Detail Kegiatan per BS
                            </h4>
                        </div>
                        <div class="p-6">
                            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                <table class="w-full text-sm" id="dga-bs-detail-table">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Business Solution</th>
                                            <th class="px-3 py-3 text-center font-semibold text-blue-700">FM</th>
                                            <th class="px-3 py-3 text-center font-semibold text-green-700">ODP</th>
                                            <th class="px-3 py-3 text-center font-semibold text-yellow-700">FT</th>
                                            <th class="px-3 py-3 text-center font-semibold text-purple-700">FFD</th>
                                            <th class="px-3 py-3 text-center font-semibold text-pink-700">Display</th>
                                            <th class="px-3 py-3 text-center font-semibold text-gray-700 bg-gray-100">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dga-bs-detail-body" class="divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Plan PO Section -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-cyan-500 via-blue-500 to-indigo-600 px-6 py-4">
                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                                Planning PO - Rencana Pembelian
                            </h4>
                        </div>
                        <div class="p-6">
                            <!-- Summary Cards -->
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-2 border-blue-200">
                                    <div class="text-xs font-semibold text-blue-600 uppercase mb-1">Total Plans</div>
                                    <div class="text-2xl font-black text-blue-900" id="pres-plan-count">0</div>
                                </div>
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-2 border-green-200">
                                    <div class="text-xs font-semibold text-green-600 uppercase mb-1">Total Qty (KG)</div>
                                    <div class="text-2xl font-black text-green-900" id="pres-plan-total">0</div>
                                </div>
                                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-2 border-purple-200">
                                    <div class="text-xs font-semibold text-purple-600 uppercase mb-1">Distributors</div>
                                    <div class="text-2xl font-black text-purple-900" id="pres-plan-dist">0</div>
                                </div>
                                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border-2 border-orange-200">
                                    <div class="text-xs font-semibold text-orange-600 uppercase mb-1">Varieties</div>
                                    <div class="text-2xl font-black text-orange-900" id="pres-plan-var">0</div>
                                </div>
                                <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-4 border-2 border-pink-200">
                                    <div class="text-xs font-semibold text-pink-600 uppercase mb-1">Total Value</div>
                                    <div class="text-lg font-black text-pink-900" id="pres-plan-value">Rp 0</div>
                                </div>
                            </div>

                            <!-- Plan Cards Grid -->
                            <div id="pres-plan-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Cards will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- FY Comparison Results (Hidden by default) -->
                    <div id="fy-comparison-results" class="hidden space-y-6">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 rounded-2xl shadow-2xl p-8 text-white border-2 border-white/20">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div>
                                    <h4 class="text-3xl font-extrabold mb-2 flex items-center gap-3">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                        Analisis Perbandingan Fiscal Year
                                    </h4>
                                    <p id="fy-comparison-title" class="text-lg opacity-95 font-medium"></p>
                                </div>
                                <div class="flex gap-2">
                                    <div id="fy-growth-badge" class="px-4 py-2 bg-white/20 backdrop-blur-sm rounded-lg border border-white/30">
                                        <span class="text-xs font-semibold opacity-90">Growth Rate</span>
                                        <div id="fy-growth-value" class="text-2xl font-bold"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main Comparison Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- FY 1 Column -->
                            <div class="bg-white rounded-2xl shadow-xl border-2 border-blue-200 overflow-hidden">
                                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 px-6 py-4">
                                    <h5 id="fy1-header" class="text-lg font-bold text-white flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        FY 1
                                    </h5>
                                </div>
                                <div class="p-5 space-y-3">
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Total PO</span>
                                        <span id="fy1-po" class="text-xl font-bold text-blue-600">0</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Total Sales</span>
                                        <span id="fy1-sales" class="text-sm font-bold text-green-600">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Total Qty</span>
                                        <span id="fy1-qty" class="text-xl font-bold text-yellow-600">0</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Aktivitas DGA</span>
                                        <span id="fy1-dga" class="text-xl font-bold text-purple-600">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Comparison/Difference Column -->
                            <div class="bg-white rounded-2xl shadow-2xl border-4 border-orange-400 overflow-hidden relative">
                                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-200/20 rounded-full -mr-16 -mt-16"></div>
                                <div class="absolute bottom-0 left-0 w-24 h-24 bg-pink-200/20 rounded-full -ml-12 -mb-12"></div>
                                <div class="bg-gradient-to-br from-orange-500 via-red-500 to-pink-500 px-6 py-4 relative z-10">
                                    <h5 class="text-lg font-bold text-white flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                        Selisih & Growth
                                    </h5>
                                </div>
                                <div class="p-5 space-y-3 relative z-10">
                                    <div class="flex flex-col py-3 border-b border-white/20 bg-white/10 backdrop-blur-sm rounded-lg px-3">
                                        <span class="text-xs font-bold text-white mb-2 uppercase tracking-wide">PO Change</span>
                                        <div class="flex items-center justify-between gap-2">
                                            <span id="diff-po" class="text-xl font-extrabold text-white"></span>
                                            <span id="diff-po-pct" class="text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap"></span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col py-3 border-b border-white/20 bg-white/10 backdrop-blur-sm rounded-lg px-3">
                                        <span class="text-xs font-bold text-white mb-2 uppercase tracking-wide">Sales Change</span>
                                        <div class="flex items-center justify-between gap-2">
                                            <span id="diff-sales" class="text-sm font-extrabold text-white"></span>
                                            <span id="diff-sales-pct" class="text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap"></span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col py-3 border-b border-white/20 bg-white/10 backdrop-blur-sm rounded-lg px-3">
                                        <span class="text-xs font-bold text-white mb-2 uppercase tracking-wide">Qty Change</span>
                                        <div class="flex items-center justify-between gap-2">
                                            <span id="diff-qty" class="text-xl font-extrabold text-white"></span>
                                            <span id="diff-qty-pct" class="text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap"></span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col py-3 bg-white/10 backdrop-blur-sm rounded-lg px-3">
                                        <span class="text-xs font-bold text-white mb-2 uppercase tracking-wide">DGA Change</span>
                                        <div class="flex items-center justify-between gap-2">
                                            <span id="diff-dga" class="text-xl font-extrabold text-white"></span>
                                            <span id="diff-dga-pct" class="text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- FY 2 Column -->
                            <div class="bg-white rounded-2xl shadow-xl border-2 border-green-200 overflow-hidden">
                                <div class="bg-gradient-to-br from-green-500 to-emerald-600 px-6 py-4">
                                    <h5 id="fy2-header" class="text-lg font-bold text-white flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        FY 2
                                    </h5>
                                </div>
                                <div class="p-5 space-y-3">
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Total PO</span>
                                        <span id="fy2-po" class="text-xl font-bold text-blue-600">0</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Total Sales</span>
                                        <span id="fy2-sales" class="text-sm font-bold text-green-600">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Total Qty</span>
                                        <span id="fy2-qty" class="text-xl font-bold text-yellow-600">0</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3">
                                        <span class="text-xs font-semibold text-gray-600 uppercase">Aktivitas DGA</span>
                                        <span id="fy2-dga" class="text-xl font-bold text-purple-600">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comparison Chart -->
                        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-4">
                                <h5 class="text-lg font-bold text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                                    Grafik Perbandingan Penjualan Bulanan
                                </h5>
                            </div>
                            <div class="p-6">
                                <div style="height: 400px;">
                                    <canvas id="fy-comparison-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Key Insights -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-5 border-l-4 border-blue-500 shadow-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span class="text-sm font-semibold text-blue-700">Best Month</span>
                                </div>
                                <div id="best-month" class="text-xl font-bold text-blue-900">-</div>
                                <div id="best-month-value" class="text-xs text-blue-600 mt-1">-</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 border-l-4 border-green-500 shadow-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                    <span class="text-sm font-semibold text-green-700">Avg Monthly Growth</span>
                                </div>
                                <div id="avg-growth" class="text-xl font-bold text-green-900">-</div>
                                <div class="text-xs text-green-600 mt-1">Month over Month</div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-5 border-l-4 border-purple-500 shadow-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    <span class="text-sm font-semibold text-purple-700">Total Comparison</span>
                                </div>
                                <div id="total-comparison" class="text-xl font-bold text-purple-900">-</div>
                                <div class="text-xs text-purple-600 mt-1">Performance Indicator</div>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Distributor Summary -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-cyan-500 to-blue-500 px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                                <h4 class="text-lg font-bold text-white">Stok Distributor</h4>
                            </div>
                            <div class="flex items-center gap-3">
                                <div onclick="toggleStockView()" class="flex items-center cursor-pointer bg-white/20 rounded-full p-0.5 hover:bg-white/30 transition-colors">
                                    <span id="stock-view-summary" class="px-3 py-1 rounded-full text-xs font-semibold transition-all bg-white text-cyan-700">Summary</span>
                                    <span id="stock-view-detail" class="px-3 py-1 rounded-full text-xs font-semibold transition-all text-white">Detail</span>
                                </div>
                                <span id="pres-stock-count" class="px-3 py-1 bg-white/20 rounded-full text-sm font-semibold text-white">0 item</span>
                            </div>
                        </div>
                        <div class="p-6">
                            <!-- Summary by Variety -->
                            <div id="pres-stock-summary"></div>

                            <!-- Detail Table -->
                            <div id="stock-detail-wrapper" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Tanggal</th>
                                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Distributor</th>
                                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Varietas</th>
                                                <th class="px-4 py-3 text-right font-semibold text-gray-700">Qty</th>
                                                <th class="px-4 py-3 text-center font-semibold text-gray-700">Lot Number</th>
                                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Catatan</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pres-stock-table" class="divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Growth Varietas -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-4">
                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                Growth Varietas
                            </h4>
                        </div>
                        <div class="p-6">
                            <div id="pres-variety-growth-content">
                                <!-- Content will be dynamically loaded -->
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Sales Trend Chart -->
                        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                Tren Penjualan
                            </h4>
                            <div style="height: 250px;"><canvas id="sales-trend-chart"></canvas></div>
                        </div>

                        <!-- Top Varieties Chart -->
                        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                Top 5 Varietas
                            </h4>
                            <div style="height: 250px;"><canvas id="top-varieties-chart"></canvas></div>
                        </div>

                        <!-- PO Status Chart -->
                        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                Status PO
                            </h4>
                            <div style="height: 250px;"><canvas id="po-status-chart"></canvas></div>
                        </div>

                        <!-- Top Customers -->
                        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-500 to-emerald-500 px-6 py-4">
                                <h4 class="text-lg font-bold text-white">Top Customers</h4>
                            </div>
                            <div class="p-6">
                                <div class="space-y-3" id="pres-top-customers">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metric Detail Modal -->
            <div id="metric-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" style="display: none; z-index: 9999;" onclick="if(event.target === this) closeMetricDetailModal()">
                <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden transform transition-all" onclick="event.stopPropagation()">
                    <!-- Modal Header -->
                    <div id="metric-detail-header" class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-5 flex items-center justify-between">
                        <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                            <span id="metric-detail-icon"></span>
                            <span id="metric-detail-title">Detail Metric</span>
                        </h3>
                        <button onclick="closeMetricDetailModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 100px);">
                        <div id="metric-detail-content" class="space-y-4">
                            <!-- Content will be dynamically loaded -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-page" class="page" style="display:none;">
                <div class="space-y-8">
                    <!-- Export/Import Excel Section -->
                    <div class="bg-white p-8 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-2">📊 Export/Import Excel</h3>
                        <p class="text-gray-600 mb-6">Download atau upload data dalam format Excel (.xlsx)</p>
                        
                        <!-- Export Options -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Export Data</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <button onclick="exportToExcel('po')" class="px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Export Purchase Orders
                                </button>
                                <button onclick="exportToExcel('distributors')" class="px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Export Distributors
                                </button>
                                <button onclick="exportToExcel('targets')" class="px-4 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Export Targets
                                </button>
                            </div>
                        </div>
                        
                        <!-- Import Options -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Import Data (Coming Soon)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button disabled class="px-4 py-3 bg-gray-300 text-gray-600 rounded-md cursor-not-allowed flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                    </svg>
                                    Import Distributors
                                </button>
                                <button disabled class="px-4 py-3 bg-gray-300 text-gray-600 rounded-md cursor-not-allowed flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                    </svg>
                                    Import Targets
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">* Import functionality will be available in future update</p>
                        </div>
                    </div>
                    
                    <!-- Backup & Recovery Section -->
                    <div class="bg-white p-8 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-2">💾 Backup & Recovery</h3>
                        <p class="text-gray-600 mb-6">Simpan atau pulihkan semua data aplikasi dalam format JSON</p>
                        <div class="flex gap-4">
                            <button onclick="backupData()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                📥 Backup Data
                            </button>
                            <input type="file" id="restore-file-input" class="hidden" accept=".json" onchange="handleRestoreFile(event)">
                            <label for="restore-file-input" class="cursor-pointer px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                📤 Restore Data
                            </label>
                        </div>
                    </div>
                    
                    <!-- Farmer Reach Configuration Section -->
                    <div class="bg-white p-8 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-2">👥 Konfigurasi Farmer Reach</h3>
                        <p class="text-gray-600 mb-6">Atur jumlah petani yang dijangkau untuk setiap tipe aktivitas</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    FM (Farmers Meeting)
                                </label>
                                <input 
                                    type="number" 
                                    id="multiplier-fm" 
                                    min="0" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Jumlah petani per FM"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ODP (On Demo Plot)
                                </label>
                                <input 
                                    type="number" 
                                    id="multiplier-odp" 
                                    min="0" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                    placeholder="Jumlah petani per ODP"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    FT (Field Trip)
                                </label>
                                <input 
                                    type="number" 
                                    id="multiplier-ft" 
                                    min="0" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    placeholder="Jumlah petani per FT"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    FFD (Farmer Field Day)
                                </label>
                                <input 
                                    type="number" 
                                    id="multiplier-ffd" 
                                    min="0" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="Jumlah petani per FFD"
                                >
                            </div>
                        </div>
                        
                        <div class="mt-6 flex gap-3">
                            <button onclick="saveFarmerReachConfig()" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Simpan Konfigurasi
                            </button>
                            <button onclick="resetFarmerReachConfig()" class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 font-medium">
                                Reset ke Default
                            </button>
                        </div>
                        
                        <div class="mt-4 p-4 bg-blue-50 rounded-md">
                            <p class="text-sm text-blue-800">
                                <strong>ℹ️ Info:</strong> Nilai ini digunakan untuk menghitung total petani yang dijangkau. 
                                Contoh: Jika FM = 25, maka setiap 1 aktivitas Farmers Meeting akan dihitung sebagai 25 petani terjangkau.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Reset Section -->
                    <div class="bg-white p-8 rounded-lg shadow-sm border-t-4 border-red-500">
                        <h3 class="text-xl font-bold mb-2 text-red-700">⚠️ Reset Aplikasi</h3>
                        <p class="text-gray-600 mb-6">Hapus semua data dan kembali ke awal. Tindakan ini tidak dapat dibatalkan.</p>
                        <button onclick="confirmReset()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            🗑️ Reset Data Aplikasi
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('add-distributor-form').addEventListener('submit', addDistributor);
        document.getElementById('edit-distributor-form').addEventListener('submit', saveDistributorChanges);
        document.getElementById('add-variety-form').addEventListener('submit', addVariety);
        document.getElementById('edit-variety-form').addEventListener('submit', saveVarietyChanges);
    }
    
    function renderEmptyState(containerId, message, iconSvg) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = `<div class="text-left py-10 px-4"><div class="mx-auto w-16 h-16 text-gray-400">${iconSvg}</div><p class="mt-4 text-gray-500">${message}</p></div>`;
        container.classList.remove('hidden');
    }
    
    function refreshUI() {
        renderDistributorCards();
        renderVarietyTable();
        renderDraftPOTable();
        renderPOReleaseTable();
        renderArsipPOTable();
        renderTargetPage();
        if (document.getElementById('dashboard-page') && document.getElementById('dashboard-page').style.display !== 'none') {
             createCharts();
        }
    }
    
    function renderDistributorCards() {
        const cardContainer = document.getElementById('distributor-card-container');
        const emptyContainer = document.getElementById('distributor-empty');
        const searchTerm = document.getElementById('search-distributor')?.value.toLowerCase() || '';
        if (!cardContainer || !emptyContainer) return;

        const filteredDistributors = appState.distributors.filter(d => 
            d.name.toLowerCase().includes(searchTerm) || 
            d.address.toLowerCase().includes(searchTerm) ||
            d.cp.toLowerCase().includes(searchTerm)
        );

        if (filteredDistributors.length === 0) {
            cardContainer.innerHTML = '';
            const icon = `<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>`;
            renderEmptyState('distributor-empty', 'Belum ada distributor. Silakan tambahkan.', icon);
            return;
        }

        emptyContainer.classList.add('hidden');
        const addressIcon = `<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM12 11a2 2 0 100-4 2 2 0 000 4z"></path></svg>`;
        const userIcon = `<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`;
        const dotsIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>`;
        
        cardContainer.innerHTML = filteredDistributors.map(d => `
            <div class="bg-white border rounded-lg p-4 relative">
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-4">
                        <img src="${d.logo || 'https://placehold.co/100x40/EFEFEF/333?text=Logo'}" alt="Logo" class="h-10 w-auto object-contain">
                        <h4 class="font-bold text-lg text-gray-800">${d.name}</h4>
                    </div>
                     <div class="relative">
                          <button onclick="toggleActionsMenu(${d.id})" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                            ${dotsIcon}
                          </button>
                          <div id="actions-menu-${d.id}" class="actions-menu hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg z-10 border">
                            <a href="#" onclick="event.preventDefault(); openEditModal('edit-distributor-modal', ${d.id}); toggleActionsMenu(${d.id});" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit</a>
                            <a href="#" onclick="event.preventDefault(); confirmDeleteDistributor(${d.id}); toggleActionsMenu(${d.id});" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Hapus</a>
                          </div>
                     </div>
                </div>
                <div class="space-y-2 text-gray-600 text-sm border-t pt-3 mt-3">
                    <div class="flex items-start gap-3"> ${addressIcon} <span class="flex-1">${d.address}</span> </div>
                    <div class="flex items-center gap-3"> ${userIcon} <span>${d.cp}</span> </div>
                </div>
            </div>
        `).join('');
        populateDistributorSelect();
    }
    
    function toggleActionsMenu(id) {
        document.querySelectorAll('.actions-menu').forEach(menu => {
            if (menu.id !== `actions-menu-${id}`) menu.classList.add('hidden');
        });
        document.getElementById(`actions-menu-${id}`)?.classList.toggle('hidden');
    }

    function renderVarietyTable() {
        const tableBody = document.getElementById('variety-table-body');
        const emptyContainer = document.getElementById('variety-empty');
        const searchTerm = document.getElementById('search-variety')?.value.toLowerCase() || '';
        if (!tableBody || !emptyContainer) return;
        
        const filteredVarieties = appState.varieties.filter(v => v.name.toLowerCase().includes(searchTerm));

        if(filteredVarieties.length === 0) {
            tableBody.innerHTML = '';
            const icon = `<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>`;
            renderEmptyState('variety-empty', 'Belum ada varietas. Silakan tambahkan.', icon);
            return;
        }
        
        emptyContainer.classList.add('hidden');
        tableBody.innerHTML = filteredVarieties.map(v => `
            <tr>
                <td class="py-2 px-4 border-b">${v.name}</td>
                <td class="py-2 px-4 border-b">${formatRupiah(v.price)}</td>
                 <td class="py-2 px-4 border-b">${v.weight} gr</td>
                <td class="py-2 px-4 border-b"><div class="flex gap-1">${renderActionIcons([{action: `openEditModal('edit-variety-modal', ${v.id})`, icon: 'pencil'},{action: `confirmDeleteVariety(${v.id})`, icon: 'trash'}])}</div></td>
            </tr>`).join('');
    }
    
    function renderDraftPOTable() {
        const tableBody = document.getElementById('draft-po-table-body');
        const cardContainer = document.getElementById('draft-po-card-container');
        const emptyContainer = document.getElementById('draft-po-empty');
        const searchTerm = document.getElementById('search-draft-po')?.value.toLowerCase() || '';
        if (!tableBody || !cardContainer || !emptyContainer) return;

        const filteredDraftPOs = appState.purchaseOrders.filter(p => {
            const distributor = appState.distributors.find(d => d.id == p.distributorId);
            return p.status === 'Draft' && (
                p.poNumber.toLowerCase().includes(searchTerm) ||
                (distributor && distributor.name.toLowerCase().includes(searchTerm))
            );
        });
        
        tableBody.innerHTML = '';
        cardContainer.innerHTML = '';
        if (filteredDraftPOs.length === 0) {
            const icon = `<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>`;
            renderEmptyState('draft-po-empty', 'Tidak ada PO draft.', icon);
            return;
        }
        emptyContainer.classList.add('hidden');
        [...filteredDraftPOs].reverse().forEach(po => {
            const distributor = appState.distributors.find(d => d.id == po.distributorId);
            const actions = [{action: `exportPOtoPDF(${po.id})`, icon: 'download', text: 'Export'}, {action: `editPO(${po.id})`, icon: 'pencil', text: 'Edit'}, {action: `confirmDeletePO(${po.id})`, icon: 'trash', text: 'Hapus'}];
            tableBody.innerHTML += `<tr><td class="py-2 px-4 border-b">${po.poNumber}</td><td class="py-2 px-4 border-b">${formatDate(po.poDate)}</td><td class="py-2 px-4 border-b">${distributor?.name || 'N/A'}</td><td class="py-2 px-4 border-b">${formatRupiah(po.totalAmount)}</td><td class="py-2 px-4 border-b text-left"><div class="flex gap-2 justify-center">${renderActionIcons(actions, true)}</div></td></tr>`;
            cardContainer.innerHTML += renderPOCard(po, distributor, actions.map(a => ({...a, text: null})));
        });
    }

    function renderPOReleaseTable() {
        const tableBody = document.getElementById('po-release-table-body');
        const cardContainer = document.getElementById('po-release-card-container');
        const emptyContainer = document.getElementById('po-release-empty');
        const searchTerm = document.getElementById('search-release-po')?.value.toLowerCase() || '';
        if (!tableBody || !cardContainer || !emptyContainer) return;

        tableBody.innerHTML = '';
        cardContainer.innerHTML = '';

        const poToRelease = appState.purchaseOrders.filter(p => {
            const distributor = appState.distributors.find(d => d.id == p.distributorId);
            const cleanStatus = p.status ? p.status.trim() : '';
            return ['Draft', 'Partially Released'].includes(cleanStatus) && (
                p.poNumber.toLowerCase().includes(searchTerm) ||
                (distributor && distributor.name.toLowerCase().includes(searchTerm))
            );
        });

        if (poToRelease.length === 0) {
            const icon = `<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            renderEmptyState('po-release-empty', 'Tidak ada PO aktif yang perlu dirilis.', icon);
            return;
        }
        emptyContainer.classList.add('hidden');

        [...poToRelease].reverse().forEach(po => {
            const distributor = appState.distributors.find(d => d.id == po.distributorId);
            const totalReleasedQty = po.items.reduce((sum, item) => sum + getReleasedQty(item), 0);
            const releasedValue = po.items.reduce((sum, item) => sum + (getReleasedQty(item) * (item.price || 0)), 0);
            const totalOrderedQty = po.items.reduce((sum, item) => sum + item.qty, 0);

            const cleanStatus = po.status ? po.status.trim() : 'Draft';
            
            const actions = [
                { action: `exportPOtoPDF(${po.id})`, icon: 'download', text: 'Export' },
                { action: `openReleaseModal(${po.id})`, icon: 'pencil', text: cleanStatus === 'Draft' ? 'Release' : 'Manage' },
                cleanStatus === 'Draft'
                    ? { action: `confirmDeletePO(${po.id})`, icon: 'trash', text: 'Hapus' }
                    : { icon: 'trash', disabled: true, title: 'PO yang sudah dirilis tidak bisa dihapus' }
            ];

            const detailContent = `<div class="p-4 bg-gray-50 space-y-3">${po.items.map(item => {
                    const released = getReleasedQty(item);
                    const remaining = item.qty - released;
                    const percentage = item.qty > 0 ? (released / item.qty) * 100 : 0;
                    return `<div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-medium text-gray-700">${item.name}</span>
                            <span class="text-gray-600">Dirilis: ${released} / ${item.qty}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        ${remaining > 0 ? `<p class="text-right text-xs text-yellow-700 mt-1">${remaining} pcs belum dirilis</p>` : `<p class="text-right text-xs text-green-700 mt-1">Semua telah dirilis</p>`}
                    </div>`;
                }).join('')}</div>`;

            const mainRow = `
                <tr class="cursor-pointer hover:bg-gray-50" onclick="toggleTableRow('details-row-release-${po.id}')">
                    <td class="py-2 px-4 border-b">${po.poNumber}</td>
                    <td class="py-2 px-4 border-b">${distributor?.name || 'N/A'}</td>
                    <td class="py-2 px-4 border-b">${totalReleasedQty} / ${totalOrderedQty} pcs</td>
                    <td class="py-2 px-4 border-b">
                        <div class="text-sm">
                            <span class="font-semibold text-green-600">${formatRupiah(releasedValue)}</span>
                            <span class="text-xs text-gray-500">/ ${formatRupiah(po.totalAmount)}</span>
                        </div>
                    </td>
                    <td class="py-2 px-4 border-b text-left"><div class="flex gap-2 justify-center">${renderActionIcons(actions)}</div></td>
                </tr>
                <tr id="details-row-release-${po.id}" class="hidden"><td colspan="5" class="p-0">${detailContent}</td></tr>`;
            
            tableBody.innerHTML += mainRow;
            cardContainer.innerHTML += renderReleaseCard(po, distributor, releasedValue, actions);
        });
    }

    function renderArsipPOTable() {
        const tableBody = document.getElementById('arsip-po-table-body');
        const cardContainer = document.getElementById('arsip-po-card-container');
        const emptyContainer = document.getElementById('arsip-po-empty');
        const searchInput = document.getElementById('search-arsip-po');

        if (!tableBody || !cardContainer || !emptyContainer || !searchInput) return;

        // Pastikan filter Fiscal Year ada di header Arsip PO
        let fySelect = document.getElementById('arsip-fiscal-year-filter');
        if (!fySelect) {
            const parent = searchInput.parentElement;
            if (parent) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-wrap items-center gap-2';

                const label = document.createElement('label');
                label.htmlFor = 'arsip-fiscal-year-filter';
                label.textContent = 'Fiscal Year';
                label.className = 'text-sm text-gray-600';

                fySelect = document.createElement('select');
                fySelect.id = 'arsip-fiscal-year-filter';
                fySelect.className = 'border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500';
                fySelect.innerHTML = '<option value="all">Semua</option>';

                // ganti posisi input search lama dengan wrapper baru (label + select + search)
                parent.replaceChild(wrapper, searchInput);
                wrapper.appendChild(label);
                wrapper.appendChild(fySelect);
                wrapper.appendChild(searchInput);
            }
        }

        const searchTerm = searchInput.value.toLowerCase();

        // Ambil semua PO yang Fully Released + cocok dengan pencarian
        const archivedPOsRaw = appState.purchaseOrders.filter(p => {
            if (p.status !== 'Fully Released') return false;

            const poNumber = (p.poNumber || '').toLowerCase();
            const distributor = appState.distributors.find(d => d.id == p.distributorId);
            const distName = distributor ? (distributor.name || '').toLowerCase() : '';

            if (!searchTerm) return true;
            return poNumber.includes(searchTerm) || distName.includes(searchTerm);
        });

        // Tentukan fiscal year per PO, pakai tanggal rilis terakhir (fallback ke tanggal PO)
        const fyMap = new Map();
        const fySet = new Set();

        archivedPOsRaw.forEach(po => {
            let latest = null;

            (po.items || []).forEach(item => {
                (item.releases || []).forEach(rel => {
                    if (!rel.date) return;
                    const d = new Date(rel.date);
                    if (!isNaN(d)) {
                        if (!latest || d > latest) latest = d;
                    }
                });
            });

            if (!latest && po.poDate) {
                const d = new Date(po.poDate);
                if (!isNaN(d)) latest = d;
            }

            if (latest) {
                const fy = getFiscalYear(latest);
                fyMap.set(po.id, fy);
                fySet.add(fy);
            }
        });

        // Isi dropdown Fiscal Year
        let selectedFiscalYear = null;
        if (fySelect) {
            const years = Array.from(fySet).sort((a, b) => b - a);
            const previous = fySelect.value || 'all';

            fySelect.innerHTML = '<option value="all">Semua</option>' +
                years.map(y => `<option value="${y}">${y}/${y + 1}</option>`).join('');

            if (previous && (previous === 'all' || years.includes(parseInt(previous, 10)))) {
                fySelect.value = previous;
            }

            const val = fySelect.value;
            if (val && val !== 'all') {
                selectedFiscalYear = parseInt(val, 10);
            }

            if (!fySelect._listenerAttached) {
                fySelect.addEventListener('change', renderArsipPOTable);
                fySelect._listenerAttached = true;
            }
        }

        // Filter PO berdasarkan fiscal year yang dipilih
        const archivedPOs = archivedPOsRaw.filter(po => {
            if (selectedFiscalYear == null) return true;
            const fy = fyMap.get(po.id);
            return fy === selectedFiscalYear;
        });

        tableBody.innerHTML = '';
        cardContainer.innerHTML = '';

        // Kalau tidak ada data, tampilkan empty state
        if (!archivedPOs.length) {
            const icon = `<svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M3 7h18M5 7v11a2 2 0 002 2h10a2 2 0 002-2V7M9 11h6" />
            </svg>`;
            renderEmptyState('arsip-po-empty', 'Belum ada PO yang diarsip.', icon);
            return;
        }

        emptyContainer.classList.add('hidden');

        // Render tabel + card view (mobile)
        [...archivedPOs].reverse().forEach(po => {
            const distributor = appState.distributors.find(d => d.id == po.distributorId);

            const actions = [
                { action: `openEditReleaseDateModal(${po.id})`, icon: 'pencil', text: 'Edit' },
                { action: `exportPOtoPDF(${po.id})`, icon: 'download', text: 'Export' },
                { action: `confirmDeleteArchivedPO(${po.id})`, icon: 'trash', text: 'Hapus' }
            ];

            tableBody.innerHTML += `
                <tr class="cursor-pointer hover:bg-blue-50"
                    onclick="openPODetail('${po.poNumber}')">
                    <td class="py-2 px-4 border-b">${po.poNumber}</td>
                    <td class="py-2 px-4 border-b">${formatDate(po.poDate)}</td>
                    <td class="py-2 px-4 border-b">${distributor ? distributor.name : '-'}</td>
                    <td class="py-2 px-4 border-b">${formatRupiah(po.totalAmount || 0)}</td>
                    <td class="py-2 px-4 border-b" onclick="event.stopPropagation()">
                        <div class="flex justify-center">
                            ${renderActionIcons(actions, true)}
                        </div>
                    </td>
                </tr>
            `;

            cardContainer.innerHTML += renderPOCard(
                po,
                distributor,
                actions.map(a => ({ ...a, text: null }))
            );
        });
    }
    
    function renderActionIcons(actions, isText) {
        const icons = {
            pencil: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>`,
            trash: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`,
            download: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`,
        };
        const textLabels = {pencil: 'Manage', trash: 'Hapus', download: 'Export'};
        return actions.map(act => {
             if (act.disabled) {
                 return `<button disabled class="p-2 rounded-full text-gray-300 cursor-not-allowed" title="${act.title || ''}">${icons[act.icon]}</button>`;
            }
             const baseClass = isText ? `px-3 py-1 text-xs rounded-md flex items-center gap-1` : `p-2 rounded-full`;
             const colorClass = {pencil: 'bg-yellow-100 hover:bg-yellow-200 text-yellow-800', trash: 'bg-red-100 hover:bg-red-200 text-red-800', download: 'bg-blue-100 hover:bg-blue-200 text-blue-800'}[act.icon];
             const iconColorClass = {pencil: 'text-yellow-600 hover:bg-yellow-100', trash: 'text-red-600 hover:bg-red-100', download: 'text-blue-600 hover:bg-blue-100'}[act.icon];
            
            return `<button onclick="event.stopPropagation(); ${act.action}" class="${isText ? `${baseClass} ${colorClass}` : `${baseClass} ${iconColorClass}`} transition-colors" title="${act.text || textLabels[act.icon]}">${icons[act.icon]} ${isText ? `<span>${act.text}</span>` : ''}</button>`
        }).join('');
    }
    
    function renderPOCard(po, distributor, actions) {
        let itemsHtml = po.items.map(item => `<div class="flex justify-between text-xs text-gray-600"><span class="truncate pr-2">- ${item.name} (x${item.qty})</span><span class="flex-shrink-0">${formatRupiah(item.amount)}</span></div>`).join('');
        let varietySummary = po.items.map(item => `${item.name} (x${item.qty})`).join(', ');
        if (varietySummary.length > 40) varietySummary = varietySummary.substring(0, 40) + '...';
        return `<div class="bg-white border rounded-lg p-3 cursor-pointer" onclick="toggleDetails('details-draft-${po.id}')"><div class="flex justify-between items-start text-xs"><div><p class="font-bold text-gray-800 text-sm">PO #${po.poNumber}</p><p class="text-gray-500">${distributor?.name || 'N/A'}</p></div></div><div class="mt-2 text-xs text-gray-600 truncate">${varietySummary}</div><div id="details-draft-${po.id}" class="details-container mt-2 pt-2 border-t"><p class="text-xs font-semibold mb-1">Detail Item:</p><div class="space-y-1">${itemsHtml}</div></div><div class="mt-3 pt-3 border-t flex justify-between items-center"><p class="font-bold text-md text-blue-600">${formatRupiah(po.totalAmount)}</p><div class="flex gap-2">${renderActionIcons(actions)}</div></div></div>`;
    }

    function renderReleaseCard(po, distributor, releasedValue, actions) {
        const totalOrderedQty = po.items.reduce((sum, item) => sum + item.qty, 0);
        const totalReleasedQty = po.items.reduce((sum, item) => sum + getReleasedQty(item), 0);
        
        const detailContent = `<div class="p-4 bg-gray-50 space-y-3">${po.items.map(item => {
                const released = getReleasedQty(item);
                const remaining = item.qty - released;
                const percentage = item.qty > 0 ? (released / item.qty) * 100 : 0;
                return `<div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-medium text-gray-700">${item.name}</span>
                        <span class="text-gray-600">Dirilis: ${released} / ${item.qty}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div class="bg-green-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    ${remaining > 0 ? `<p class="text-right text-xs text-yellow-700 mt-1">${remaining} pcs belum dirilis</p>` : `<p class="text-right text-xs text-green-700 mt-1">Semua telah dirilis</p>`}
                </div>`;
            }).join('')}</div>`;

        return `<div class="bg-white border rounded-lg overflow-hidden">
                <div class="p-3 cursor-pointer" onclick="toggleDetails('details-release-${po.id}')">
                    <div class="flex justify-between items-start text-xs">
                        <div>
                            <p class="font-bold text-gray-800 text-sm">PO #${po.poNumber}</p>
                            <p class="text-gray-500">${distributor?.name || 'N/A'}</p>
                        </div>
                        ${getStatusBadge(po.status)}
                    </div>
                    <div class="mt-3 pt-3 border-t grid grid-cols-2 gap-2">
                        <div>
                            <div class="text-xs text-gray-500">Qty Dirilis</div>
                            <div class="font-semibold">${totalReleasedQty} / ${totalOrderedQty}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">Nilai Dirilis</div>
                            <div class="font-bold text-green-600">${formatRupiah(releasedValue)}</div>
                        </div>
                    </div>
                </div>
                <div id="details-release-${po.id}" class="details-container">${detailContent}</div>
                <div class="p-3 border-t flex justify-end"> <div class="flex gap-2">${renderActionIcons(actions)}</div> </div>
            </div>`;
    }
</script>
<script>
    // --- Continuation of the script block for all functions ---
    function getStatusBadge(status) {
        const cleanStatus = status ? status.trim() : '';
        if (cleanStatus === 'Fully Released') return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Dirilis Penuh</span>`;
        if (cleanStatus === 'Partially Released') return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Parsial</span>`;
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Draft</span>`;
    }

    function toggleDetails(divId) {
        const details = document.getElementById(divId);
        if(details) { details.style.maxHeight = details.style.maxHeight ? null : details.scrollHeight + "px"; }
    }
    function toggleTableRow(rowId) {
        const row = document.getElementById(rowId);
        if (row) row.classList.toggle('hidden');
    }

    function addPOItem() {
        poCounter++;
        const container = document.getElementById('po-items-container');
        if (!container) return;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'p-4 border rounded-md relative';
        itemDiv.id = `po-item-${poCounter}`;
        itemDiv.innerHTML = `<button type="button" onclick="removePOItem(${poCounter})" class="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded-full" title="Remove Item"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button><div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end"><div class="md:col-span-5"><label class="text-sm">Varietas</label><select class="mt-1 w-full p-2 border rounded-md item-variety" onchange="updateItemPrice(${poCounter})"></select></div><div class="md:col-span-2"><label class="text-sm">Kuantitas</label><input type="number" min="1" class="mt-1 w-full p-2 border rounded-md item-qty" oninput="calculateItemAmount(${poCounter})"></div><div class="md:col-span-2"><label class="text-sm">Harga</label><input type="text" class="mt-1 w-full p-2 bg-gray-100 border rounded-md item-price" readonly></div><div class="md:col-span-3"><label class="text-sm">Jumlah</label><input type="text" class="mt-1 w-full p-2 bg-gray-100 border rounded-md item-amount" readonly></div></div>`;
        container.appendChild(itemDiv);
        populateVarietySelect(itemDiv.querySelector('.item-variety'));
    }
    
    function removePOItem(id) { document.getElementById(`po-item-${id}`)?.remove(); }

    function updateItemPrice(id) {
        const row = document.getElementById(`po-item-${id}`);
        const varietySelect = row.querySelector('.item-variety');
        const priceInput = row.querySelector('.item-price');
        const selected = varietySelect.options[varietySelect.selectedIndex];
        const price = selected?.getAttribute('data-price') || 0;
        priceInput.value = formatRupiah(price);
        calculateItemAmount(id);
    }

    function calculateItemAmount(id) {
        const row = document.getElementById(`po-item-${id}`);
        const qty = parseInt(row.querySelector('.item-qty').value || 0);
        const price = parseInt((row.querySelector('.item-variety').selectedOptions[0]?.dataset.price) || 0);
        const amount = qty * price;
        row.querySelector('.item-amount').value = formatRupiah(amount);
    }
    
    function updatePONotes() {
        const isCod = document.getElementById('payment-cod').checked;
        const isBg = document.getElementById('payment-bg').checked;
        let notes = [];
        if (isCod) notes.push('Payment COD/CBD', 'Cash Discount 4,5 %', 'Retailer Program 2 %');
        if (isBg) { if(notes.length > 0) notes.push(''); notes.push('Payment Cover BG / Cek', 'Retailer Program 2%'); }
        document.getElementById('po-notes').value = notes.join('\n');
    }

    function resetPOForm() {
        document.getElementById('po-form-fields').reset();
        document.getElementById('editing-po-id').value = '';
        document.getElementById('po-items-container').innerHTML = '';
        document.getElementById('save-po-button').textContent = 'Simpan PO';
        document.getElementById('po-number').value = generatePONumber();
        document.getElementById('po-date').valueAsDate = new Date();
        poCounter = 0;
        addPOItem();
        updateShipmentAddress();
    }
    
    async function savePO() {
        const editingId = parseInt(document.getElementById('editing-po-id').value);
        const distributorId = document.getElementById('distributor-select').value;
        const poNumber = document.getElementById('po-number').value.trim();
        const poDate = document.getElementById('po-date').value;
        const notes = document.getElementById('po-notes').value.trim();

        if (!distributorId || !poNumber || !poDate) { showToast("Harap isi Distributor, No PO, dan Tanggal.", "error"); return; }
        if (!editingId && appState.purchaseOrders.some(p => p.poNumber === poNumber)) {
            showToast(`No PO "${poNumber}" sudah ada. Silakan gunakan nomor lain.`, "error");
            return;
        }
        if (editingId && appState.purchaseOrders.some(p => p.id !== editingId && p.poNumber === poNumber)) {
            showToast(`No PO "${poNumber}" sudah digunakan oleh PO lain.`, "error");
            return;
        }

        const items = [];
        let totalAmount = 0;
        document.querySelectorAll('#po-items-container > div').forEach(row => {
            const varietyId = row.querySelector('.item-variety').value;
            const qty = parseInt(row.querySelector('.item-qty').value || 0);
            if (varietyId && qty > 0) {
                const variety = appState.varieties.find(v => v.id == parseInt(varietyId));
                if (variety) {
                    const amount = qty * variety.price;
                    items.push({ 
                        varietyId: parseInt(varietyId), name: variety.name, qty, 
                        price: variety.price, weight: variety.weight || 0,
                        amount, releases: [] // Initialize releases array
                    });
                    totalAmount += amount;
                }
            }
        });
        
        if (items.length === 0) { showToast("Harap tambahkan minimal satu item pesanan.", "error"); return; }
        
        const poData = { distributorId: parseInt(distributorId), poNumber, poDate, notes, items, totalAmount, status: 'Draft' };
        if (editingId) {
            const poIndex = appState.purchaseOrders.findIndex(p => p.id === editingId);
            if (poIndex > -1) {
                const oldPO = appState.purchaseOrders[poIndex];
                // Preserve existing releases when editing
                poData.items.forEach(newItem => {
                    const oldItem = oldPO.items.find(old => old.varietyId === newItem.varietyId);
                    if(oldItem) newItem.releases = oldItem.releases || [];
                });
                appState.purchaseOrders[poIndex] = { ...oldPO, ...poData, id: editingId };
                showToast("PO berhasil diupdate!", "success");
            }
        } else {
            appState.purchaseOrders.push({ id: Date.now(), ...poData });
            showToast("PO berhasil disimpan sebagai draft!", "success");
        }

        await saveData();
        resetPOForm();
        showPage('draft-po');
        refreshUI();
    }

    function editPO(id) {
        const po = appState.purchaseOrders.find(p => p.id === id);
        if (!po) return;
        if (po.status.trim() !== 'Draft') {
            showToast('Hanya PO dengan status Draft yang bisa diedit.', 'info');
            return;
        }
        document.getElementById('editing-po-id').value = po.id;
        document.getElementById('distributor-select').value = po.distributorId;
        updateShipmentAddress();
        document.getElementById('po-number').value = po.poNumber;
        document.getElementById('po-date').value = po.poDate;
        document.getElementById('po-notes').value = po.notes;
        const notesLower = po.notes.toLowerCase();
        document.getElementById('payment-cod').checked = notesLower.includes('cod/cbd');
        document.getElementById('payment-bg').checked = notesLower.includes('bg / cek');
        const container = document.getElementById('po-items-container');
        container.innerHTML = '';
        poCounter = 0;
        po.items.forEach(item => {
            addPOItem();
            const itemRow = document.getElementById(`po-item-${poCounter}`);
            itemRow.querySelector('.item-variety').value = item.varietyId;
            updateItemPrice(poCounter);
            itemRow.querySelector('.item-qty').value = item.qty;
            calculateItemAmount(poCounter);
        });
        document.getElementById('save-po-button').textContent = 'Update PO';
        showPage('new-po', {editing: true});
    }

    function confirmDeletePO(id) {
        const po = appState.purchaseOrders.find(p => p.id === id);
        if (!po || po.status.trim() !== 'Draft') {
            showToast('Hanya PO dengan status Draft yang bisa dihapus.', 'info');
            return;
        }
        showConfirmation('Konfirmasi Hapus', `Yakin ingin menghapus PO #${po.poNumber}?`, () => { deletePO(id); hideConfirmation(); }); 
    }
    async function deletePO(id) { appState.purchaseOrders = appState.purchaseOrders.filter(p => p.id !== id); await saveData(); refreshUI(); showToast("PO berhasil dihapus.", "success"); }

    function confirmDeleteArchivedPO(id) {
        const po = appState.purchaseOrders.find(p => p.id === id);
        showConfirmation(
            'Konfirmasi Hapus Permanen', 
            `Yakin ingin menghapus PO arsip #${po.poNumber}? Tindakan ini akan menghapus data penjualan secara permanen dari dasbor dan laporan.`, 
            () => { deleteArchivedPO(id); hideConfirmation(); }
        ); 
    }
    async function deleteArchivedPO(id) {
        appState.purchaseOrders = appState.purchaseOrders.filter(p => p.id !== id);
        await saveData();
        refreshUI();
        showToast("PO arsip berhasil dihapus secara permanen.", "success");
    }

    let currentReleaseEditPOId = null;

    function openEditReleaseDateModal(poId) {
        const po = appState.purchaseOrders.find(p => p.id === poId);
        if (!po) return;

        currentReleaseEditPOId = poId;

        const distributor = appState.distributors.find(d => d.id == po.distributorId);
        const infoEl = document.getElementById('edit-release-po-info');
        if (infoEl) {
            const distName = distributor ? distributor.name : 'Tanpa distributor';
            infoEl.textContent = `PO ${po.poNumber} - ${distName}`;
        }

        let existingDate = null;
        if (po.items && po.items.length) {
            for (const item of po.items) {
                if (item.releases && item.releases.length) {
                    const r = item.releases[0];
                    if (r.date) {
                        const d = new Date(r.date);
                        if (!isNaN(d)) {
                            existingDate = d;
                            break;
                        }
                    }
                }
            }
        }

        const input = document.getElementById('edit-release-date-input');
        if (input) {
            if (existingDate && !isNaN(existingDate)) {
                const y = existingDate.getFullYear();
                const m = String(existingDate.getMonth() + 1).padStart(2, '0');
                const d = String(existingDate.getDate()).padStart(2, '0');
                input.value = `${y}-${m}-${d}`;
            } else {
                input.value = '';
            }
        }

        openEditModal('edit-release-modal');
    }

    function saveEditedReleaseDate() {
        if (currentReleaseEditPOId == null) {
            closeEditModal('edit-release-modal');
            return;
        }

        const input = document.getElementById('edit-release-date-input');
        if (!input || !input.value) {
            alert('Tanggal rilis harus diisi.');
            return;
        }

        const parts = input.value.split('-');
        if (parts.length !== 3) {
            alert('Format tanggal tidak valid.');
            return;
        }

        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const day = parseInt(parts[2], 10);
        const newDate = new Date(year, month, day);
        if (isNaN(newDate.getTime())) {
            alert('Tanggal rilis tidak valid.');
            return;
        }
        newDate.setHours(0, 0, 0, 0);
        const iso = newDate.toISOString();

        const po = appState.purchaseOrders.find(p => p.id === currentReleaseEditPOId);
        if (po && Array.isArray(po.items)) {
            po.items.forEach(item => {
                if (Array.isArray(item.releases)) {
                    item.releases.forEach(rel => {
                        rel.date = iso;
                    });
                }
            });
        }

        if (typeof saveData === 'function') {
            saveData();
        }
        if (typeof refreshUI === 'function') {
            refreshUI();
        }

        if (typeof showToast === 'function') {
            showToast('Tanggal rilis PO berhasil diperbarui.', 'success');
        }

        currentReleaseEditPOId = null;
        closeEditModal('edit-release-modal');
    }


    function openReleaseModal(poId) {
        const po = appState.purchaseOrders.find(p => p.id === poId);
        if (!po) return;
        
        document.getElementById('release-modal-title').textContent = `Release PO #${po.poNumber}`;
        
        // Add a date input field
        const today = new Date().toISOString().split('T')[0];
        const dateInputHtml = `
            <div class="mb-4">
                <label for="release-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Rilis</label>
                <input type="date" id="release-date" value="${today}" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <hr class="mb-4">
        `;

        let itemsHtml = po.items.map((item, index) => {
            const releasedQty = getReleasedQty(item);      // total sudah dirilis
            const cancelledQty = getCancelledQty(item);    // total dibatalkan sebelum rilis
            const remainingQty = item.qty - releasedQty - cancelledQty; // sisa yang masih bisa dirilis / dibatalkan
            const maxCancelable = remainingQty; // cancel hanya boleh untuk bagian yang BELUM dirilis
            return `
                <div class="grid grid-cols-4 gap-4 items-center border-b py-3">
                    <div class="col-span-2 flex flex-col gap-1">
                        <span class="text-sm">${item.name}</span>
                        <button type="button"
                                class="self-start text-[11px] text-blue-600 hover:underline"
                                onclick="openReleaseHistory(${po.id}, ${index})">
                            Histori
                        </button>
                    </div>
                    <span class="text-xs text-left text-gray-500">
                        Dipesan: ${item.qty}<br>
                        Dirilis: ${releasedQty}${cancelledQty > 0 ? `<br>Cancel total: ${cancelledQty}` : ''}
                    </span>
                    <div class="space-y-2">
                        <input type="number"
                               id="release-qty-${index}"
                               min="0"
                               max="${Math.max(0, remainingQty)}"
                               placeholder="Release"
                               class="p-2 border rounded-md w-full text-left text-xs"
                               ${remainingQty <= 0 ? 'disabled' : ''}>
                        <input type="number"
                               id="cancel-qty-${index}"
                               min="0"
                               max="${Math.max(0, maxCancelable)}"
                               placeholder="Cancel"
                               class="p-2 border rounded-md w-full text-left text-xs bg-red-50 border-red-200"
                               ${maxCancelable <= 0 ? 'disabled' : ''}>
                    </div>
                </div>`;
        }).join('');
        
        // Prepend the date input to the itemsHtml
        document.getElementById('release-modal-body').innerHTML = `<form id="release-form">${dateInputHtml}${itemsHtml}</form>`;
        
        document.getElementById('release-modal-confirm-button').onclick = () => submitPartialRelease(poId);
        openEditModal('release-po-modal');
    }

    // **UPDATED FUNCTION**: Records releases with a user-selected timestamp.
    async function submitPartialRelease(poId) {
        const poIndex = appState.purchaseOrders.findIndex(p => p.id === poId);
        if (poIndex === -1) return;

        let releasedSomething = false;

        // Read the date from the new input field
        const releaseDateInput = document.getElementById('release-date').value;
        if (!releaseDateInput) {
            showToast("Harap pilih tanggal rilis.", "error");
            return;
        }
        // Convert YYYY-MM-DD to a full ISO string. Using setHours(0,0,0,0) ensures it's at the start of that day in local time.
        const releaseDate = new Date(releaseDateInput);
        releaseDate.setHours(0, 0, 0, 0);
        const releaseDateISO = releaseDate.toISOString();

        appState.purchaseOrders[poIndex].items.forEach((item, index) => {
            const releaseInput = document.getElementById(`release-qty-${index}`);
            const cancelInput = document.getElementById(`cancel-qty-${index}`);

            const qtyToRelease = parseInt(releaseInput?.value) || 0;
            const qtyToCancel = parseInt(cancelInput?.value) || 0;
            
            if (!Array.isArray(item.releases)) item.releases = []; // Ensure releases array exists.
            const currentlyReleased = getReleasedQty(item); // total yang sudah dirilis (qty positif)
            const cancelledQty = getCancelledQty(item);    // total yang sudah dibatalkan sebelumnya
            const remainingBefore = item.qty - currentlyReleased - cancelledQty; // sisa yang masih "hidup"

            // Pastikan tidak melebihi sisa
            let validRelease = qtyToRelease;
            let validCancel = qtyToCancel;
            if (validRelease < 0) validRelease = 0;
            if (validCancel < 0) validCancel = 0;
            if (validRelease + validCancel > remainingBefore) {
                // Kalau berlebih, prioritaskan release dulu
                if (validRelease > remainingBefore) {
                    validRelease = remainingBefore;
                    validCancel = 0;
                } else {
                    validCancel = remainingBefore - validRelease;
                }
            }

            // Tambah release baru (benar-benar keluar barang)
            if (validRelease > 0) {
                item.releases.push({ qty: validRelease, date: releaseDateISO });
                releasedSomething = true;
            }

            // Tambah cancel (mengurangi porsi yang belum dirilis, tidak muncul minus di laporan)
            if (validCancel > 0) {
                item.cancelledQty = Number(item.cancelledQty || 0) + validCancel;
                releasedSomething = true;
            }
        });

        // Update the overall PO status based on Ordered, Released & Cancelled.
        updatePOStatusFromItems(poIndex);

        if (releasedSomething) {
            showToast("Release PO berhasil disimpan.", "success");
        } else {
            showToast("Tidak ada kuantitas baru yang dirilis.", "info");
        }

        await saveData();
        refreshUI();
        closeEditModal('release-po-modal');
    }

    

    // === Histori Release: lihat, edit, hapus ===
    function openReleaseHistory(poId, itemIndex) {
        const po = appState.purchaseOrders.find(p => p.id === poId);
        if (!po) return;
        const item = po.items[itemIndex];
        if (!item) return;

        const modal = document.getElementById('release-history-modal');
        const body = document.getElementById('release-history-body');
        const subtitle = document.getElementById('release-history-subtitle');
        if (!modal || !body || !subtitle) return;

        subtitle.textContent = `PO ${po.poNumber} • Varietas: ${item.name}`;
        const releases = Array.isArray(item.releases) ? item.releases : [];

        if (!releases.length) {
            body.innerHTML = '<p class="text-gray-500 text-xs">Belum ada histori release untuk varietas ini.</p>';
        } else {
            let rows = '';
            releases.forEach((r, idx) => {
                const date = r.date ? formatDate(r.date) : '-';
                const qty = r.qty || 0;
                rows += `
                    <tr>
                        <td class="py-1 px-2 border-b text-[11px]">${idx + 1}</td>
                        <td class="py-1 px-2 border-b text-[11px]">${date}</td>
                        <td class="py-1 px-2 border-b text-right text-[11px]">${qty.toLocaleString('id-ID')}</td>
                        <td class="py-1 px-2 border-b text-right text-[11px]">
                            <button type="button"
                                    class="px-2 py-0.5 rounded border border-blue-200 text-blue-700 hover:bg-blue-50 mr-1"
                                    onclick="editReleaseEntry(${po.id}, ${itemIndex}, ${idx})">
                                Edit
                            </button>
                            <button type="button"
                                    class="px-2 py-0.5 rounded border border-red-200 text-red-700 hover:bg-red-50"
                                    onclick="deleteReleaseEntry(${po.id}, ${itemIndex}, ${idx})">
                                Hapus
                            </button>
                        </td>
                    </tr>`;
            });

            body.innerHTML = `
                <div class="overflow-x-auto -mx-1">
                    <table class="min-w-full text-xs">
                        <thead>
                            <tr class="text-[11px] text-gray-500 border-b">
                                <th class="py-1 px-2 text-left">No</th>
                                <th class="py-1 px-2 text-left">Tanggal</th>
                                <th class="py-1 px-2 text-right">Qty</th>
                                <th class="py-1 px-2 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        }

        openEditModal('release-history-modal');
    }

    function editReleaseEntry(poId, itemIndex, releaseIndex) {
        const poIndex = appState.purchaseOrders.findIndex(p => p.id === poId);
        if (poIndex === -1) return;
        const item = appState.purchaseOrders[poIndex].items[itemIndex];
        if (!item || !Array.isArray(item.releases) || !item.releases[releaseIndex]) return;

        const current = Number(item.releases[releaseIndex].qty || 0);
        const input = prompt('Masukkan qty baru untuk release ini:', current);
        if (input === null) return;
        const newQty = parseInt(input, 10);
        if (isNaN(newQty) || newQty <= 0) {
            alert('Qty harus lebih besar dari 0.');
            return;
        }

        const cancelledQty = getCancelledQty(item);
        const otherReleasesTotal = item.releases.reduce((sum, r, idx) => idx === releaseIndex ? sum : sum + (Number(r.qty) || 0), 0);
        if (otherReleasesTotal + newQty + cancelledQty > item.qty) {
            alert('Qty baru melebihi total yang di-PO-kan (dikurangi cancel).');
            return;
        }

        item.releases[releaseIndex].qty = newQty;

        updatePOStatusFromItems(poIndex);
        window.saveData && window.saveData();
        renderPOReleaseTable();
        renderArsipPOTable && renderArsipPOTable();
        showToast('Histori release berhasil diupdate.', 'success');
        openReleaseHistory(poId, itemIndex);
    }

    function deleteReleaseEntry(poId, itemIndex, releaseIndex) {
        if (!confirm('Yakin ingin menghapus release ini?')) return;
        const poIndex = appState.purchaseOrders.findIndex(p => p.id === poId);
        if (poIndex === -1) return;
        const item = appState.purchaseOrders[poIndex].items[itemIndex];
        if (!item || !Array.isArray(item.releases) || !item.releases[releaseIndex]) return;

        item.releases.splice(releaseIndex, 1);

        updatePOStatusFromItems(poIndex);
        window.saveData && window.saveData();
        renderPOReleaseTable();
        renderArsipPOTable && renderArsipPOTable();
        showToast('Release berhasil dihapus.', 'success');
        openReleaseHistory(poId, itemIndex);
    }
function addDistributor(event) {
        event.preventDefault();
        const name = document.getElementById('new-distributor-name').value.trim();
        const address = document.getElementById('new-distributor-address').value.trim();
        const cp = document.getElementById('new-distributor-cp').value.trim();
        const logoFile = document.getElementById('new-distributor-logo').files[0];

        const save = async (logoDataUrl = null) => {
            appState.distributors.push({
                id: Date.now(),
                name,
                address,
                cp,
                logo: logoDataUrl,
                mergeToDistributorId: null
            });
            await saveData();
            refreshUI();
            document.getElementById('add-distributor-form').reset();
            showToast("Distributor baru berhasil ditambahkan.", "success");
        };

        if (logoFile) {
            const reader = new FileReader();
            reader.onload = (e) => save(e.target.result);
            reader.readAsDataURL(logoFile);
        } else {
            save();
        }
    }

    function confirmDeleteDistributor(id) { showConfirmation('Konfirmasi Hapus', 'Yakin ingin menghapus distributor ini?', () => { deleteDistributor(id); hideConfirmation(); }); }
    async function deleteDistributor(id) { appState.distributors = appState.distributors.filter(d => d.id !== id); await saveData(); refreshUI(); showToast("Distributor berhasil dihapus.", "success"); }

    
    function populateMergeTargetSelect(currentDistributorId, selectedMergeToId) {
        const sel = document.getElementById('edit-distributor-merge-target');
        if (!sel) return;

        sel.innerHTML =
            '<option value="">Pilih Distributor Induk</option>' +
            appState.distributors
                .filter(d => d.id !== currentDistributorId)
                .map(d => `<option value="${d.id}">${d.name}</option>`)
                .join('');

        sel.value = selectedMergeToId ? String(selectedMergeToId) : '';
    }

function openEditModal(modalId, id = null) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        if (id !== null) {
            if (modalId === 'edit-distributor-modal') {
                const d = appState.distributors.find(d => d.id === id);
                if (!d) return;
                document.getElementById('edit-distributor-id').value = d.id;
                document.getElementById('edit-distributor-name').value = d.name;
                document.getElementById('edit-distributor-address').value = d.address;
                document.getElementById('edit-distributor-cp').value = d.cp;
                document.getElementById('edit-logo-preview').src = d.logo || 'https://placehold.co/100x40/EFEFEF/333?text=Logo';
                document.getElementById('edit-distributor-logo').value = ''; 

                const mergeCheckbox = document.getElementById('edit-distributor-merge-checkbox');
                const mergeSelect = document.getElementById('edit-distributor-merge-target');

                if (mergeCheckbox && mergeSelect) {
                    const mergeToId = d.mergeToDistributorId || null;
                    populateMergeTargetSelect(d.id, mergeToId);

                    const hasMerge = !!mergeToId;
                    mergeCheckbox.checked = hasMerge;
                    mergeSelect.disabled = !hasMerge;

                    mergeCheckbox.onchange = () => {
                        const active = mergeCheckbox.checked;
                        mergeSelect.disabled = !active;
                        if (!active) {
                            mergeSelect.value = '';
                        }
                    };
                }
            } else if (modalId === 'edit-variety-modal') {
                const v = appState.varieties.find(v => v.id === id);
                if (!v) return;
                document.getElementById('edit-variety-id').value = v.id;
                document.getElementById('edit-variety-name').value = v.name;
                document.getElementById('edit-variety-price').value = v.price;
                document.getElementById('edit-variety-weight').value = v.weight;
            }
        }
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.querySelector('.transform').classList.remove('scale-95', 'opacity-0'), 10);
    }
    
    function closeEditModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    
function saveDistributorChanges(event) {
        event.preventDefault();
        const id = parseInt(document.getElementById('edit-distributor-id').value);
        const dIndex = appState.distributors.findIndex(d => d.id === id);
        if (dIndex === -1) return;

        const name = document.getElementById('edit-distributor-name').value.trim();
        const address = document.getElementById('edit-distributor-address').value.trim();
        const cp = document.getElementById('edit-distributor-cp').value.trim();
        const logoFile = document.getElementById('edit-distributor-logo').files[0];

        const mergeCheckbox = document.getElementById('edit-distributor-merge-checkbox');
        const mergeSelect = document.getElementById('edit-distributor-merge-target');

        let mergeToDistributorId = null;
        if (mergeCheckbox && mergeCheckbox.checked && mergeSelect && mergeSelect.value) {
            const parsed = parseInt(mergeSelect.value, 10);
            if (!Number.isNaN(parsed) && parsed !== id) {
                mergeToDistributorId = parsed;
            }
        }

        const update = async (logoDataUrl) => {
            appState.distributors[dIndex] = {
                ...appState.distributors[dIndex],
                name,
                address,
                cp,
                logo: logoDataUrl,
                mergeToDistributorId
            };
            await saveData();
            refreshUI();
            closeEditModal('edit-distributor-modal');
            showToast("Data distributor berhasil diupdate.", "success");
        };

        if (logoFile) {
            const reader = new FileReader();
            reader.onload = (e) => update(e.target.result);
            reader.readAsDataURL(logoFile);
        } else {
            update(appState.distributors[dIndex].logo);
        }
    }



    async function addVariety(event) {
        event.preventDefault();
        const name = document.getElementById('new-variety-name').value.trim();
        const price = document.getElementById('new-variety-price').value;
        const weight = document.getElementById('new-variety-weight').value;
        if (name && price && weight) {
            appState.varieties.push({ id: Date.now(), name, price: parseInt(price), unit: 'pcs', weight: parseInt(weight) });
            await saveData(); renderVarietyTable();
            document.getElementById('add-variety-form').reset();
            showToast("Varietas baru berhasil ditambahkan.", "success");
        }
    }

    function confirmDeleteVariety(id) { showConfirmation('Konfirmasi Hapus', 'Yakin ingin menghapus varietas ini?', () => { deleteVariety(id); hideConfirmation(); }); }
    async function deleteVariety(id) { appState.varieties = appState.varieties.filter(v => v.id !== id); await saveData(); refreshUI(); showToast("Varietas berhasil dihapus.", "success"); }

    async function saveVarietyChanges(event) {
        event.preventDefault();
        const id = parseInt(document.getElementById('edit-variety-id').value);
        const v = appState.varieties.find(v => v.id === id);
        if (!v) return;
        v.name = document.getElementById('edit-variety-name').value.trim();
        v.price = parseInt(document.getElementById('edit-variety-price').value);
        v.weight = parseInt(document.getElementById('edit-variety-weight').value);
        await saveData(); refreshUI(); closeEditModal('edit-variety-modal');
        showToast("Data varietas berhasil diupdate.", "success");
    }
    
    // === STOK DISTRIBUTOR FUNCTIONS ===
    function generateStockLink() {
        const selectDist = document.getElementById('select-dist-for-link');
        const distId = selectDist.value;
        
        if (!distId) {
            showToast("Pilih distributor terlebih dahulu", "error");
            return;
        }
        
        const distributor = appState.distributors.find(d => d.id == distId);
        if (!distributor) return;
        
        // Generate unique token
        const token = 'ST-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // Save link data
        if (!appState.stockLinks) appState.stockLinks = [];
        appState.stockLinks.push({
            token: token,
            distributorId: distId,
            distributorName: distributor.name,
            createdAt: new Date().toISOString(),
            active: true
        });
        
        saveData();
        
        // Generate URL
        const baseUrl = window.location.origin + window.location.pathname;
        const linkUrl = `${baseUrl}?stock-input=${token}`;
        
        // Display link
        document.getElementById('generated-link-input').value = linkUrl;
        document.getElementById('generated-link-container').classList.remove('hidden');
        
        showToast("Link berhasil di-generate!", "success");
    }
    
    function copyStockLink() {
        const input = document.getElementById('generated-link-input');
        input.select();
        document.execCommand('copy');
        showToast("Link berhasil dicopy!", "success");
    }
    
    function shareViaWhatsApp() {
        const link = document.getElementById('generated-link-input').value;
        const selectDist = document.getElementById('select-dist-for-link');
        const distId = selectDist.value;
        const distributor = appState.distributors.find(d => d.id == distId);
        const distName = distributor ? distributor.name : 'Distributor';
        
        // Create WhatsApp message
        const message = `Halo ${distName},\n\nSilakan gunakan link berikut untuk mengupdate stok produk Anda:\n\n${link}\n\nTerima kasih!`;
        
        // Encode message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Open WhatsApp with message
        const waUrl = `https://wa.me/?text=${encodedMessage}`;
        window.open(waUrl, '_blank');
    }
    
    function openStockLink() {
        const link = document.getElementById('generated-link-input').value;
        window.open(link, '_blank');
    }
    
    function renderStockTable() {
        console.log('🔄 renderStockTable() called');
        console.log('  - stockDistributor data:', appState.stockDistributor);
        console.log('  - stockDistributor count:', (appState.stockDistributor || []).length);
        
        const tbody = document.getElementById('stock-table-body');
        const emptyState = document.getElementById('stock-empty-state');
        
        if (!tbody) {
            console.error('❌ stock-table-body element not found!');
            return;
        }
        
        if (!appState.stockDistributor || appState.stockDistributor.length === 0) {
            console.log('ℹ️ No stock data to display');
            tbody.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        
        // Get filter values
        const filterDist = document.getElementById('stock-filter-dist')?.value || '';
        const filterVariety = document.getElementById('stock-filter-variety')?.value || '';
        const filterMonth = document.getElementById('stock-filter-month')?.value || '';
        
        // Filter data
        let filtered = appState.stockDistributor;
        
        if (filterDist) {
            filtered = filtered.filter(s => s.distributorId == filterDist);
        }
        
        if (filterVariety) {
            filtered = filtered.filter(s => s.varietyId == filterVariety);
        }
        
        if (filterMonth) {
            filtered = filtered.filter(s => {
                if (!s.date) return false;
                const stockMonth = s.date.substring(0, 7); // YYYY-MM
                return stockMonth === filterMonth;
            });
        }
        
        // Sort by date descending
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">Tidak ada data sesuai filter</td></tr>';
            emptyState.classList.add('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        tbody.innerHTML = filtered.map(stock => {
            const variety = appState.varieties.find(v => v.id == stock.varietyId);
            const varietyName = variety ? variety.name : 'Unknown';
            const dateFormatted = new Date(stock.date).toLocaleDateString('id-ID', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
            
            // Calculate aging from release date (more accurate for seed quality)
            const today = new Date();
            let agingDays = 0;
            if (stock.releaseDate) {
                // Use releaseDate if available (actual seed production date)
                const releaseDate = new Date(stock.releaseDate);
                agingDays = Math.floor((today - releaseDate) / (1000 * 60 * 60 * 24));
            } else if (stock.date) {
                // Fallback to entry date if releaseDate not available
                const stockDate = new Date(stock.date);
                agingDays = Math.floor((today - stockDate) / (1000 * 60 * 60 * 24));
            }
            
            // Format expired date
            let expiredFormatted = '-';
            let expiredClass = 'text-gray-600';
            let timeToExpireFormatted = '-';
            let timeToExpireClass = 'text-gray-600';
            
            if (stock.expired) {
                const expDate = new Date(stock.expired);
                expiredFormatted = expDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                // Check if expired or near expiration (within 30 days)
                const daysToExpiry = Math.floor((expDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysToExpiry < 0) {
                    expiredClass = 'text-red-700 font-bold';
                    expiredFormatted += ' ⚠️';
                    timeToExpireFormatted = 'EXPIRED';
                    timeToExpireClass = 'text-red-700 font-bold';
                } else {
                    // Calculate months and days
                    const months = Math.floor(daysToExpiry / 30);
                    const days = daysToExpiry % 30;
                    
                    if (months > 0) {
                        timeToExpireFormatted = `${months} bulan ${days} hari`;
                    } else {
                        timeToExpireFormatted = `${days} hari`;
                    }
                    
                    // Color coding based on time remaining
                    if (daysToExpiry <= 30) {
                        expiredClass = 'text-orange-600 font-semibold';
                        timeToExpireClass = 'text-orange-600 font-semibold';
                    } else if (daysToExpiry <= 60) {
                        timeToExpireClass = 'text-yellow-700 font-medium';
                    } else {
                        timeToExpireClass = 'text-green-600';
                    }
                }
            } else {
                // No expired date set
                timeToExpireFormatted = 'Belum diisi';
                timeToExpireClass = 'text-gray-400 italic';
            }
            
            // Aging color coding
            let agingClass = 'text-gray-700';
            if (agingDays > 60) {
                agingClass = 'text-red-600 font-bold';
            } else if (agingDays > 30) {
                agingClass = 'text-orange-600 font-semibold';
            } else if (agingDays > 14) {
                agingClass = 'text-yellow-700';
            }
            
            // Aging indicator - show source of calculation
            const agingSource = stock.releaseDate ? '🏭' : '📅';
            const agingTooltip = stock.releaseDate 
                ? `Dihitung dari tanggal release (${new Date(stock.releaseDate).toLocaleDateString('id-ID')})` 
                : 'Dihitung dari tanggal entry (belum ada tanggal release)';
            
            return `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 text-sm font-bold text-gray-900 bg-gray-50">${dateFormatted}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${stock.distributorName}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${varietyName}</td>
                    <td class="px-4 py-3 text-sm font-semibold text-green-600">${stock.qty.toLocaleString('id-ID')} ${stock.unit || 'pcs'}</td>
                    <td class="px-4 py-3 text-sm font-mono text-gray-600">${stock.lotNumber || '-'}</td>
                    <td class="px-4 py-3 text-sm ${expiredClass}">${expiredFormatted}</td>
                    <td class="px-4 py-3 text-sm ${timeToExpireClass}">
                        <span class="font-medium">${timeToExpireFormatted}</span>
                    </td>
                    <td class="px-4 py-3 text-sm ${agingClass}" title="${agingTooltip}">
                        <span class="inline-flex items-center gap-1">
                            <span class="text-xs">${agingSource}</span>
                            <span class="font-medium">${agingDays} hari</span>
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${stock.notes || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex gap-2">
                            <button onclick="editStockDistributor(${stock.id})" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-xs font-medium flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Edit
                            </button>
                            <button onclick="deleteStockDistributor(${stock.id})" class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-xs font-medium flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                Hapus
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function populateStockFilters() {
        // Populate distributor filter
        const distFilter = document.getElementById('stock-filter-dist');
        if (distFilter && appState.distributors) {
            distFilter.innerHTML = '<option value="">Semua Distributor</option>' + 
                appState.distributors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        }
        
        // Populate variety filter
        const varietyFilter = document.getElementById('stock-filter-variety');
        if (varietyFilter && appState.varieties) {
            varietyFilter.innerHTML = '<option value="">Semua Varietas</option>' + 
                appState.varieties.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
        }
        
        // Populate distributor select for link generation
        const selectDistForLink = document.getElementById('select-dist-for-link');
        if (selectDistForLink && appState.distributors) {
            selectDistForLink.innerHTML = '<option value="">-- Pilih Distributor --</option>' + 
                appState.distributors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        }
    }
    
    window.editStockDistributor = async function(stockId) {
        const stock = appState.stockDistributor.find(s => s.id === stockId);
        if (!stock) {
            showToast('Data stok tidak ditemukan', 'error');
            return;
        }
        
        const variety = appState.varieties.find(v => v.id == stock.varietyId);
        const varietyName = variety ? variety.name : 'Unknown';
        
        // Set current editing stock ID
        window.currentAdminEditingStockId = stockId;
        
        // Populate modal fields
        document.getElementById('admin-modal-distributor').value = stock.distributorName;
        document.getElementById('admin-modal-variety').value = varietyName;
        
        const stockDate = stock.date ? new Date(stock.date).toISOString().split('T')[0] : '';
        document.getElementById('admin-modal-date').value = stockDate;
        
        const releaseDate = stock.releaseDate ? new Date(stock.releaseDate).toISOString().split('T')[0] : '';
        document.getElementById('admin-modal-release-date').value = releaseDate;
        
        document.getElementById('admin-modal-qty').value = stock.qty;
        document.getElementById('admin-modal-unit').value = stock.unit || 'pcs';
        document.getElementById('admin-modal-lot-number').value = stock.lotNumber || '';
        
        const expiredDate = stock.expired ? new Date(stock.expired).toISOString().split('T')[0] : '';
        document.getElementById('admin-modal-expired').value = expiredDate;
        
        document.getElementById('admin-modal-notes').value = stock.notes || '';
        
        // Show modal
        document.getElementById('admin-edit-stock-modal').classList.remove('hidden');
    };
    
    window.closeAdminEditStockModal = function() {
        document.getElementById('admin-edit-stock-modal').classList.add('hidden');
        window.currentAdminEditingStockId = null;
        // Clear all fields
        document.getElementById('admin-modal-date').value = '';
        document.getElementById('admin-modal-release-date').value = '';
        document.getElementById('admin-modal-qty').value = '';
        document.getElementById('admin-modal-unit').value = '';
        document.getElementById('admin-modal-lot-number').value = '';
        document.getElementById('admin-modal-expired').value = '';
        document.getElementById('admin-modal-notes').value = '';
    };
    
    window.submitAdminEditStock = async function() {
        if (!window.currentAdminEditingStockId) {
            showToast('Data tidak valid', 'error');
            return;
        }
        
        console.log('🔄 [Admin Edit] Starting stock update...');
        console.log('  - Stock ID:', window.currentAdminEditingStockId);
        console.log('  - Current User:', window.currentUser);
        
        // Get all field values
        const date = document.getElementById('admin-modal-date').value;
        const releaseDate = document.getElementById('admin-modal-release-date').value;
        const qty = parseInt(document.getElementById('admin-modal-qty').value);
        const unit = document.getElementById('admin-modal-unit').value || 'pcs';
        const lotNumber = document.getElementById('admin-modal-lot-number').value;
        const expired = document.getElementById('admin-modal-expired').value;
        const notes = document.getElementById('admin-modal-notes').value;
        
        console.log('  - Form Values:', { date, releaseDate, qty, unit, lotNumber, expired, notes });
        
        // Validation
        if (!date || !releaseDate) {
            showToast('Tanggal Entry dan Release harus diisi', 'error');
            return;
        }
        
        if (isNaN(qty) || qty < 0) {
            showToast('Quantity harus berupa angka positif', 'error');
            return;
        }
        
        // Find and update stock
        const stock = appState.stockDistributor.find(s => s.id === window.currentAdminEditingStockId);
        if (stock) {
            stock.date = date;
            stock.qty = qty;
            stock.unit = unit;
            stock.lotNumber = lotNumber;
            stock.expired = expired || null;
            stock.releaseDate = releaseDate || null;
            stock.notes = notes;
            stock.updatedAt = new Date().toISOString();
            
            console.log('  ✅ Stock object updated in memory');
            console.log('  - Updated stock:', stock);
            
            // Save to localStorage
            localStorage.setItem('advantaSalesData', JSON.stringify(appState));
            console.log('  ✅ Data saved to localStorage');
            
            // Save to Firestore if logged in
            if (window.currentUser && typeof window.saveData === 'function') {
                try {
                    console.log('  🔄 Saving to Firestore...');
                    await window.saveData();
                    console.log('  ✅ Data BERHASIL disimpan ke Firestore!');
                    showToast('✓ Data stok berhasil diupdate dan disimpan ke Firestore!', 'success');
                } catch (error) {
                    console.error('  ❌ Error saving to Firestore:', error);
                    showToast('⚠ Data tersimpan lokal, tapi gagal sync ke Firestore: ' + error.message, 'error');
                }
            } else {
                console.warn('  ⚠ User not logged in or saveData not available');
                showToast('⚠ Data hanya tersimpan lokal (tidak login)', 'error');
            }
            
            renderStockTable();
            closeAdminEditStockModal();
        } else {
            console.error('  ❌ Stock not found with ID:', window.currentAdminEditingStockId);
            showToast('Stock tidak ditemukan', 'error');
        }
    };
    
    window.deleteStockDistributor = async function(stockId) {
        if (!window.appState || !window.appState.stockDistributor) {
            showToast('Data stok tidak tersedia', 'error');
            return;
        }
        
        const stock = window.appState.stockDistributor.find(s => s.id === stockId);
        if (!stock) {
            showToast('Data stok tidak ditemukan', 'error');
            return;
        }
        
        const variety = window.appState.varieties.find(v => v.id == stock.varietyId);
        const varietyName = variety ? variety.name : 'Unknown';
        
        const confirmation = confirm(`Hapus data stok ini?\n\nDistributor: ${stock.distributorName}\nVarietas: ${varietyName}\nQty: ${stock.qty} ${stock.unit || 'pcs'}\nLot: ${stock.lotNumber || '-'}`);
        
        if (!confirmation) return;
        
        try {
            // Remove from array
            const index = window.appState.stockDistributor.findIndex(s => s.id === stockId);
            if (index > -1) {
                window.appState.stockDistributor.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('advantaSalesData', JSON.stringify(window.appState));
                
                // Save to Firestore if logged in
                if (window.currentUser && typeof window.saveData === 'function') {
                    await window.saveData();
                    console.log('✅ Stock deleted and synced to Firestore');
                }
                
                renderStockTable();
                showToast('Data stok berhasil dihapus', 'success');
            }
        } catch (error) {
            console.error('Error deleting stock:', error);
            showToast('Gagal menghapus data: ' + error.message, 'error');
        }
    };
    
    window.exportStockToPDF = function() {
        console.log('📄 Exporting stock distributor to PDF...');
        
        if (!appState.stockDistributor || appState.stockDistributor.length === 0) {
            showToast('Tidak ada data stok untuk diekspor', 'error');
            return;
        }
        
        // Get filter values
        const filterDist = document.getElementById('stock-filter-dist')?.value || '';
        const filterVariety = document.getElementById('stock-filter-variety')?.value || '';
        const filterMonth = document.getElementById('stock-filter-month')?.value || '';
        
        // Filter data (same logic as renderStockTable)
        let filtered = appState.stockDistributor;
        
        if (filterDist) {
            filtered = filtered.filter(s => s.distributorId == filterDist);
        }
        
        if (filterVariety) {
            filtered = filtered.filter(s => s.varietyId == filterVariety);
        }
        
        if (filterMonth) {
            filtered = filtered.filter(s => {
                if (!s.date) return false;
                const stockMonth = s.date.substring(0, 7);
                return stockMonth === filterMonth;
            });
        }
        
        // Sort by date descending
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (filtered.length === 0) {
            showToast('Tidak ada data sesuai filter untuk diekspor', 'error');
            return;
        }
        
        // Generate PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); // Landscape for more columns
        const today = new Date();
        
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Laporan Stok Distributor', 40, 40);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Diekspor: ${today.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`, 40, 60);
        doc.text(`Total Data: ${filtered.length} item`, 40, 75);
        
        // Filter info
        let filterInfo = [];
        if (filterDist) {
            const dist = appState.distributors?.find(d => d.id == filterDist);
            if (dist) filterInfo.push(`Distributor: ${dist.name}`);
        }
        if (filterVariety) {
            const variety = appState.varieties?.find(v => v.id == filterVariety);
            if (variety) filterInfo.push(`Varietas: ${variety.name}`);
        }
        if (filterMonth) {
            const monthDate = new Date(filterMonth + '-01');
            filterInfo.push(`Bulan: ${monthDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}`);
        }
        
        if (filterInfo.length > 0) {
            doc.text(`Filter: ${filterInfo.join(', ')}`, 40, 90);
        }
        
        // Prepare table data
        const head = [['Tanggal', 'Distributor', 'Varietas', 'Qty', 'No Lot', 'Expired', 'Sisa Waktu', 'Aging', 'Ket']];
        const body = filtered.map(stock => {
            const variety = appState.varieties?.find(v => v.id == stock.varietyId);
            const varietyName = variety ? variety.name : 'Unknown';
            
            const dateFormatted = new Date(stock.date).toLocaleDateString('id-ID', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
            
            // Calculate aging from release date (more accurate for seed quality)
            let agingDays = 0;
            let agingSource = '';
            if (stock.releaseDate) {
                // Use releaseDate if available (actual seed production date)
                const releaseDate = new Date(stock.releaseDate);
                agingDays = Math.floor((today - releaseDate) / (1000 * 60 * 60 * 24));
                agingSource = '*'; // Star indicates calculated from release date
            } else if (stock.date) {
                // Fallback to entry date if releaseDate not available
                const stockDate = new Date(stock.date);
                agingDays = Math.floor((today - stockDate) / (1000 * 60 * 60 * 24));
                agingSource = '†'; // Dagger indicates calculated from entry date
            }
            
            // Format expired
            let expiredStr = '-';
            let timeToExpireStr = '-';
            if (stock.expired) {
                const expDate = new Date(stock.expired);
                expiredStr = expDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                const daysToExpiry = Math.floor((expDate - today) / (1000 * 60 * 60 * 24));
                if (daysToExpiry < 0) {
                    expiredStr += ' (KADALUARSA)';
                    timeToExpireStr = 'EXPIRED';
                } else {
                    // Calculate months and days
                    const months = Math.floor(daysToExpiry / 30);
                    const days = daysToExpiry % 30;
                    
                    if (months > 0) {
                        timeToExpireStr = `${months}bln ${days}hr`;
                    } else {
                        timeToExpireStr = `${days} hari`;
                    }
                    
                    if (daysToExpiry <= 30) {
                        expiredStr += ' (< 30 hari)';
                    }
                }
            }
            
            return [
                dateFormatted,
                stock.distributorName || '-',
                varietyName,
                `${stock.qty.toLocaleString('id-ID')} ${stock.unit || 'pcs'}`,
                stock.lotNumber || '-',
                expiredStr,
                timeToExpireStr,
                `${agingDays} hari${agingSource}`,
                stock.notes || '-'
            ];
        });
        
        if (doc.autoTable) {
            doc.autoTable({
                head,
                body,
                startY: filterInfo.length > 0 ? 110 : 95,
                styles: {
                    fontSize: 8,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [34, 197, 94],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 60 },  // Tanggal
                    1: { cellWidth: 75 },  // Distributor
                    2: { cellWidth: 70 },  // Varietas
                    3: { cellWidth: 55 },  // Qty
                    4: { cellWidth: 70 },  // No Lot
                    5: { cellWidth: 75 },  // Expired
                    6: { cellWidth: 55 },  // Sisa Waktu
                    7: { cellWidth: 50 },  // Aging
                    8: { cellWidth: 'auto' }  // Keterangan
                },
                margin: { top: 110, left: 40, right: 40 }
            });
            
            // Add legend for aging calculation source
            const finalY = doc.lastAutoTable.finalY || 110;
            doc.setFontSize(8);
            doc.setTextColor(100);
            doc.text('Keterangan Aging:', 40, finalY + 15);
            doc.text('* = Dihitung dari tanggal release/turun PO (lebih akurat)', 40, finalY + 22);
            doc.text('† = Dihitung dari tanggal entry (data lama/belum ada tgl release)', 40, finalY + 29);
        }
        
        // Save PDF
        const filename = `Stok-Distributor-${today.toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        
        showToast('PDF berhasil diunduh!', 'success');
        console.log('✅ PDF exported:', filename);
    };
    
    function populateDistributorSelect() {
        const select = document.getElementById('distributor-select');
        if (!select) return;
        const currentVal = select.value;
        select.innerHTML = '<option value="">Pilih Distributor</option>' + appState.distributors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        select.value = currentVal;
    }

    function updateShipmentAddress() {
        const select = document.getElementById('distributor-select');
        const textarea = document.getElementById('shipment-address');
        const distributor = appState.distributors.find(d => d.id == select.value);
        if (textarea) textarea.value = distributor ? distributor.address : '';
    }

    function populateVarietySelect(selectElement) {
        if (!selectElement) return;
        selectElement.innerHTML = '<option value="">Pilih Varietas</option>' + appState.varieties.map(v => `<option value="${v.id}" data-price="${v.price}">${v.name}</option>`).join('');
    }

    // --- TARGETS MODULE ---
    function getTargetActuals(target) {
        // Total target = jumlah 12 bulan
        const totalTarget = Array.isArray(target.monthlyTargets)
            ? target.monthlyTargets.reduce((a, b) => a + (Number(b) || 0), 0)
            : Number(target.totalTarget || 0);

        const distributorIds = getDistributorIdsForActual(target);

        const actualSalesReleases = appState.purchaseOrders
            .filter(po =>
                distributorIds.includes(po.distributorId) &&
                ['Partially Released', 'Fully Released'].includes((po.status || '').trim())
            )
            .flatMap(po => po.items || [])
            .filter(item => item.varietyId === target.varietyId)
            .flatMap(item => item.releases || [])
            .filter(release => {
                const d = new Date(release.date);
                return getFiscalYear(d) === target.year;
            });

        let totalActual = 0;
        const variety = appState.varieties.find(v => v.id === target.varietyId);

        if (target.unit === 'pcs') {
            totalActual = actualSalesReleases.reduce(
                (sum, release) => sum + (Number(release.qty) || 0),
                0
            );
        } else if (target.unit === 'kg' && variety) {
            totalActual = actualSalesReleases.reduce(
                (sum, release) => sum + (Number(release.qty) || 0) * (Number(variety.weight) || 0),
                0
            ) / 1000;
        } else if (target.unit === 'nominal' && variety) {
            totalActual = actualSalesReleases.reduce(
                (sum, release) => sum + (Number(release.qty) || 0) * (Number(variety.price) || 0),
                0
            );
        }

        const achievementPercentage = totalTarget > 0 ? (totalActual / totalTarget) * 100 : 0;

        return { totalTarget, totalActual, achievementPercentage };
    }

    // Dapatkan index bulan fiskal (0=Apr, 11=Mar)
    function getFiscalMonthIndex(date, fiscalYear) {
        const fy = getFiscalYear(date);
        if (fy !== fiscalYear) return -1;

        const month = date.getMonth(); // 0-11
        const year = date.getFullYear();

        // April-Desember di tahun fiskal
        if (year === fiscalYear) {
            // Apr (3) -> 0, ... Des (11) -> 8
            if (month >= 3 && month <= 11) {
                return month - 3;
            }
        }
        // Januari-Maret di tahun fiskal berikutnya
        if (year === fiscalYear + 1) {
            // Jan (0) -> 9, Feb (1) -> 10, Mar (2) -> 11
            if (month >= 0 && month <= 2) {
                return 9 + month;
            }
        }
        return -1;
    }

    // Kelompok distributor yang digabung untuk perhitungan realisasi
    function getDistributorIdsForActual(target) {
        const dist = appState.distributors.find(d => d.id === target.distributorId);
        if (!dist) return [target.distributorId];

        const baseId = dist.id;

        // 1) Grup MANUAL: semua distributor yang mergeToDistributorId == baseId
        const manualMembers = appState.distributors.filter(d => {
            if (!d) return false;
            const mergedTo = Number(d.mergeToDistributorId || 0);
            return mergedTo === baseId;
        });

        if (manualMembers.length > 0) {
            const ids = [baseId, ...manualMembers.map(d => d.id)];
            return Array.from(new Set(ids));
        }

        // 2) Fallback lama: grup nama RACCOLTA / TANI GUNA
        const rawName = (dist.name || '');
        const name = rawName.toLowerCase();
        const normalized = name.replace(/\s+/g, '');

        const isRaccoltaGroup =
            normalized.includes('raccolta') ||
            normalized.includes('taniguna') ||
            (name.includes('tani') && name.includes('guna'));

        if (isRaccoltaGroup) {
            const group = appState.distributors.filter(d => {
                const nm = (d.name || '');
                const nmLower = nm.toLowerCase();
                const nmNorm = nmLower.replace(/\s+/g, '');
                return (
                    nmNorm.includes('raccolta') ||
                    nmNorm.includes('taniguna') ||
                    (nmLower.includes('tani') && nmLower.includes('guna'))
                );
            });
            const ids = group.map(d => d.id);
            return ids.length ? ids : [target.distributorId];
        }

        // default: hanya distributor itu sendiri
        return [target.distributorId];
    }

    // Hitung realisasi per bulan untuk satu target (sesuai satuan target)
    function getTargetMonthlyActuals(target) {
        const monthlyActuals = new Array(12).fill(0);

        const variety = appState.varieties.find(v => v.id === target.varietyId);

        const distributorIds = getDistributorIdsForActual(target);

        const actualSalesReleases = appState.purchaseOrders
            .filter(po =>
                distributorIds.includes(po.distributorId) &&
                ['Partially Released', 'Fully Released'].includes((po.status || '').trim())
            )
            .flatMap(po => po.items || [])
            .filter(item => item.varietyId === target.varietyId)
            .flatMap(item => item.releases || [])
            .filter(release => {
                const d = new Date(release.date);
                return getFiscalYear(d) === target.year;
            });

        actualSalesReleases.forEach(release => {
            const d = new Date(release.date);
            const idx = getFiscalMonthIndex(d, target.year);
            if (idx < 0 || idx > 11) return;

            let delta = 0;
            if (target.unit === 'pcs') {
                delta = Number(release.qty) || 0;
            } else if (target.unit === 'kg' && variety) {
                delta = (Number(release.qty) || 0) * (Number(variety.weight) || 0) / 1000;
            } else if (target.unit === 'nominal' && variety) {
                delta = (Number(release.qty) || 0) * (Number(variety.price) || 0);
            }

            monthlyActuals[idx] += delta;
        });

        return monthlyActuals;
    }


    function renderTargetPage() {
        const container = document.getElementById('target-list-container');
        if (!container) return;

        if (!appState.targets || appState.targets.length === 0) {
            const icon = `
                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                    </path>
                </svg>`;
            renderEmptyState(
                'target-list-container',
                'Belum ada target yang dibuat. Klik "Buat Target Baru" untuk memulai.',
                icon
            );
            return;
        }

        // Group per Distributor + Tahun
        const groupedTargets = appState.targets.reduce((acc, target) => {
            const key = `${target.year}-${target.distributorId}`;
            if (!acc[key]) {
                acc[key] = {
                    year: target.year,
                    distributor: appState.distributors.find(d => d.id === target.distributorId),
                    targets: []
                };
            }
            acc[key].targets.push(target);
            return acc;
        }, {});

        container.innerHTML = Object.values(groupedTargets)
            .sort((a, b) => b.year - a.year)
            .map(group => {
                const distName = group.distributor
                    ? group.distributor.name
                    : `Distributor Dihapus (ID: ${group.distributorId})`;

                return `
                    <div class="bg-white border rounded-lg mb-6">
                        <div class="p-4 border-b bg-gray-50 rounded-t-lg flex items-center justify-between">
                            <h4 class="font-bold text-lg">
                                ${distName} - Tahun Fiskal ${group.year}/${group.year + 1}
                            </h4>
                        </div>
                        <div class="p-4 space-y-4">
                            ${group.targets.map(t => {
                                const { totalTarget, totalActual, achievementPercentage } = getTargetActuals(t);
                                const variety = appState.varieties.find(v => v.id === t.varietyId);

                                const unitLabel =
                                    t.unit === 'kg' ? 'Kg' :
                                    t.unit === 'pcs' ? 'Pcs' :
                                    t.unit === 'nominal' ? 'Rp' : t.unit;

                                const formattedTotalTarget = t.unit === 'nominal'
                                    ? formatRupiah(totalTarget)
                                    : `${totalTarget.toLocaleString('id-ID', {
                                          minimumFractionDigits: t.unit === 'kg' ? 2 : 0,
                                          maximumFractionDigits: t.unit === 'kg' ? 2 : 0
                                      })} ${unitLabel}`;

                                const formattedTotalActual = t.unit === 'nominal'
                                    ? formatRupiah(totalActual)
                                    : `${totalActual.toLocaleString('id-ID', {
                                          minimumFractionDigits: t.unit === 'kg' ? 2 : 0,
                                          maximumFractionDigits: t.unit === 'kg' ? 2 : 0
                                      })} ${unitLabel}`;

                                return `
                                    <div class="p-4 border rounded-md">
                                        <div class="flex justify-between items-start gap-3">
                                            <div class="space-y-1">
                                                <p class="font-semibold text-gray-800">
                                                    ${variety?.name || 'Varietas Dihapus'}
                                                </p>
                                                <p class="text-sm text-gray-500">
                                                    Total Target:
                                                    <button
                                                        type="button"
                                                        onclick="openTargetBreakdownModal('${t.id}')"
                                                        class="font-semibold text-blue-600 underline decoration-dashed underline-offset-2 hover:text-blue-800 focus:outline-none"
                                                        title="Klik untuk lihat breakdown per bulan"
                                                    >
                                                        ${formattedTotalTarget}
                                                    </button>
                                                </p>
                                            </div>
                                            <div class="flex gap-2 shrink-0">
                                                ${renderActionIcons([
                                                    { action: `openTargetModal('${t.id}')`, icon: 'pencil', text: 'Edit' },
                                                    { action: `confirmDeleteTarget('${t.id}')`, icon: 'trash', text: 'Hapus' }
                                                ], true)}
                                            </div>
                                        </div>

                                        <div class="mt-3 pt-3 border-t">
                                            <h5 class="text-sm font-medium text-gray-700 mb-1">
                                                Progres Pencapaian (${t.unit === 'nominal' ? 'Nominal (Rp)' : unitLabel})
                                            </h5>
                                            <div class="flex justify-between items-center text-sm mb-1">
                                                <span class="font-bold text-green-600">
                                                    ${formattedTotalActual}
                                                </span>
                                                <span class="text-gray-500">
                                                    ${achievementPercentage.toFixed(1)}%
                                                </span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                                <div
                                                    class="bg-green-500 h-2.5 rounded-full"
                                                    style="width: ${Math.min(achievementPercentage, 100)}%;"
                                                ></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
    }

    

function openTargetBreakdownModal(targetId) {
        if (!appState.targets || appState.targets.length === 0) return;

        const modal = document.getElementById('target-breakdown-modal');
        const body = document.getElementById('target-breakdown-body');
        const subtitleEl = document.getElementById('target-breakdown-subtitle');
        if (!modal || !body || !subtitleEl) return;

        const target = appState.targets.find(t => String(t.id) === String(targetId));
        if (!target) {
            showToast('Target tidak ditemukan.', 'error');
            return;
        }

        const distributor = appState.distributors.find(d => d.id === target.distributorId);
        const variety = appState.varieties.find(v => v.id === target.varietyId);

        const fiscalYearText = `${target.year}/${target.year + 1}`;
        subtitleEl.textContent = `Periode: April ${target.year} - Maret ${target.year + 1}`;

        const unitLabel =
            target.unit === 'kg' ? 'Kg' :
            target.unit === 'pcs' ? 'Pcs' :
            target.unit === 'nominal' ? 'Nominal (Rp)' : target.unit;

        const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

        // --- HITUNG REALISASI BULANAN: GRUP & DISTRIBUTOR UTAMA ---

        // helper: hitung realisasi bulanan untuk list distributor tertentu
        const getMonthlyActualsForDistributorIds = (distributorIds) => {
            const monthly = new Array(12).fill(0);
            const varietyObj = variety;

            const actualSalesReleases = appState.purchaseOrders
                .filter(po =>
                    distributorIds.includes(po.distributorId) &&
                    ['Partially Released', 'Fully Released'].includes((po.status || '').trim())
                )
                .flatMap(po => po.items || [])
                .filter(item => item.varietyId === target.varietyId)
                .flatMap(item => item.releases || [])
                .filter(release => {
                    const d = new Date(release.date);
                    return getFiscalYear(d) === target.year;
                });

            actualSalesReleases.forEach(release => {
                const d = new Date(release.date);
                const idx = getFiscalMonthIndex(d, target.year);
                if (idx < 0 || idx > 11) return;

                let delta = 0;
                if (target.unit === 'pcs') {
                    delta = Number(release.qty) || 0;
                } else if (target.unit === 'kg' && varietyObj) {
                    delta = (Number(release.qty) || 0) * (Number(varietyObj.weight) || 0) / 1000;
                } else if (target.unit === 'nominal' && varietyObj) {
                    delta = (Number(release.qty) || 0) * (Number(varietyObj.price) || 0);
                }
                monthly[idx] += delta;
            });

            return monthly;
        };

        const distributorIdsForActual = getDistributorIdsForActual(target);
        const monthlyActualGroup = getMonthlyActualsForDistributorIds(distributorIdsForActual);
        const monthlyActualBase = getMonthlyActualsForDistributorIds([target.distributorId]);

        const monthlyTambahan = monthlyActualGroup.map((val, idx) => {
            const base = monthlyActualBase[idx] || 0;
            const extra = val - base;
            return extra > 0 ? extra : 0;
        });

        const hasAnyAdditional = monthlyTambahan.some(v => v > 0);

        const monthInputs = fiscalMonths.map((monthLabel, idx) => {
            const rawTarget = Array.isArray(target.monthlyTargets)
                ? Number(target.monthlyTargets[idx] || 0)
                : 0;

            const rawActual = Array.isArray(monthlyActualGroup)
                ? Number(monthlyActualGroup[idx] || 0)
                : 0;

            const tambahanBulan = monthlyTambahan[idx] || 0;

            let displayTarget;
            let displayActual;
            let displayTambahan = '';

            if (target.unit === 'nominal') {
                displayTarget = formatRupiah(rawTarget, false);
                displayActual = formatRupiah(rawActual, false);
                if (tambahanBulan > 0) {
                    displayTambahan = formatRupiah(tambahanBulan);
                }
            } else if (target.unit === 'kg') {
                displayTarget = rawTarget.toLocaleString('id-ID', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                displayActual = rawActual.toLocaleString('id-ID', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                if (tambahanBulan > 0) {
                    displayTambahan = tambahanBulan.toLocaleString('id-ID', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }) + ' Kg';
                }
            } else {
                displayTarget = rawTarget.toLocaleString('id-ID');
                displayActual = rawActual.toLocaleString('id-ID');
                if (tambahanBulan > 0) {
                    displayTambahan = tambahanBulan.toLocaleString('id-ID') + ' Pcs';
                }
            }

            const achievement = rawTarget > 0 ? ((rawActual / rawTarget) * 100) : null;
            const actualClass = rawActual > 0 ? 'text-green-700' : 'text-gray-400';

            const tambahanHtml = tambahanBulan > 0
                ? `<div class="mt-1 text-[11px] text-blue-600 italic">
                        Tambahan distributor grup: <span class="font-semibold">${displayTambahan}</span>
                   </div>`
                : '';

            return `
                <div class="border rounded-md p-2 bg-gray-50">
                    <div class="text-xs font-semibold text-gray-700 mb-1">${monthLabel}</div>
                    <div class="text-[11px] text-gray-500">Target</div>
                    <div class="text-sm font-medium text-gray-800">${displayTarget}</div>
                    <div class="mt-1 text-[11px] text-gray-500">Realisasi</div>
                    <div class="text-sm font-medium ${actualClass}">${displayActual}</div>
                    <div class="mt-1 text-[11px] text-gray-500">
                        Pencapaian: ${achievement === null ? '-' : achievement.toFixed(1) + '%'}
                    </div>
                    ${tambahanHtml}
                </div>
            `;
        }).join('');

        const distributorName = distributor ? distributor.name : 'Distributor tidak ditemukan';
        const varietyName = variety ? variety.name : 'Varietas tidak ditemukan';

        const globalNote = hasAnyAdditional
            ? `<p class="mt-2 text-xs text-gray-500 italic">
                    * Bulan yang memiliki keterangan "Tambahan distributor grup" sudah termasuk penambahan realisasi dari Tani Guna.
               </p>`
            : '';

        body.innerHTML = `
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Distributor</label>
                        <div class="mt-1 w-full p-2 border rounded-md bg-gray-50 text-sm text-gray-700">
                            ${distributorName}
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Fiskal</label>
                        <div class="mt-1 w-full p-2 border rounded-md bg-gray-50 text-sm text-gray-700">
                            ${fiscalYearText}
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Satuan</label>
                        <div class="mt-1 w-full p-2 border rounded-md bg-gray-50 text-sm text-gray-700">
                            ${unitLabel}
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg p-4">
                    <div class="flex flex-wrap justify-between items-center gap-2 mb-4">
                        <p class="font-semibold text-gray-800">
                            ${varietyName}
                        </p>
                        <div class="flex gap-2">
                            <button
                                type="button"
                                onclick="exportSingleTargetBreakdownToPDF('${target.id}')"
                                class="px-3 py-1 text-xs rounded-md border border-red-500 text-red-600 hover:bg-red-50"
                            >
                                Export PDF
                            </button>
                            <button
                                type="button"
                                onclick="exportSingleTargetBreakdownToCSV('${target.id}')"
                                class="px-3 py-1 text-xs rounded-md border border-green-500 text-green-600 hover:bg-green-50"
                            >
                                Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                        ${monthInputs}
                    </div>
                    ${globalNote}
                </div>
            </div>
        `;

        modal.classList.remove('hidden');
        const card = modal.querySelector('.transform');
        if (card) {
            card.classList.remove('scale-95', 'opacity-0');
        }
    }



    // Export breakdown satu target (per bulan) ke PDF
    

function exportSingleTargetBreakdownToPDF(targetId) {
        if (!appState.targets || appState.targets.length === 0) {
            showToast('Tidak ada data target untuk diekspor.', 'info');
            return;
        }

        const target = appState.targets.find(t => String(t.id) === String(targetId));
        if (!target) {
            showToast('Target tidak ditemukan.', 'error');
            return;
        }

        const distributor = appState.distributors.find(d => d.id === target.distributorId)?.name || 'N/A';
        const variety = appState.varieties.find(v => v.id === target.varietyId)?.name || 'N/A';
        const varietyObj = appState.varieties.find(v => v.id === target.varietyId) || null;

        const unitLabel =
            target.unit === 'kg' ? 'Kg' :
            target.unit === 'pcs' ? 'Pcs' :
            target.unit === 'nominal' ? 'Nominal (Rp)' : target.unit;

        const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

        const getTargetValue = (idx) => {
            if (Array.isArray(target.monthlyTargets) && typeof target.monthlyTargets[idx] === 'number') {
                return target.monthlyTargets[idx];
            }
            return 0;
        };

        // --- HITUNG REALISASI BULANAN: GRUP & DISTRIBUTOR UTAMA ---
        const getMonthlyActualsForDistributorIds = (distributorIds) => {
            const monthly = new Array(12).fill(0);

            const actualSalesReleases = appState.purchaseOrders
                .filter(po =>
                    distributorIds.includes(po.distributorId) &&
                    ['Partially Released', 'Fully Released'].includes((po.status || '').trim())
                )
                .flatMap(po => po.items || [])
                .filter(item => item.varietyId === target.varietyId)
                .flatMap(item => item.releases || [])
                .filter(release => {
                    const d = new Date(release.date);
                    return getFiscalYear(d) === target.year;
                });

            actualSalesReleases.forEach(release => {
                const d = new Date(release.date);
                const idx = getFiscalMonthIndex(d, target.year);
                if (idx < 0 || idx > 11) return;

                let delta = 0;
                if (target.unit === 'pcs') {
                    delta = Number(release.qty) || 0;
                } else if (target.unit === 'kg' && varietyObj) {
                    delta = (Number(release.qty) || 0) * (Number(varietyObj.weight) || 0) / 1000;
                } else if (target.unit === 'nominal' && varietyObj) {
                    delta = (Number(release.qty) || 0) * (Number(varietyObj.price) || 0);
                }
                monthly[idx] += delta;
            });

            return monthly;
        };

        const distributorIdsForActual = getDistributorIdsForActual(target);
        const monthlyActualGroup = getMonthlyActualsForDistributorIds(distributorIdsForActual);
        const monthlyActualBase = getMonthlyActualsForDistributorIds([target.distributorId]);

        const monthlyTambahan = monthlyActualGroup.map((val, idx) => {
            const base = monthlyActualBase[idx] || 0;
            const extra = val - base;
            return extra > 0 ? extra : 0;
        });

        const hasAnyAdditional = monthlyTambahan.some(v => v > 0);

        // --- GENERATE PDF ---
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        const today = new Date();

        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Breakdown Target Penjualan per Bulan', 40, 40);

        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Distributor : ${distributor}`, 40, 60);
        doc.text(`Varietas    : ${variety}`, 40, 75);
        doc.text(`Tahun Fiskal: ${target.year}/${target.year + 1}`, 40, 90);
        doc.text(`Satuan      : ${unitLabel}`, 40, 105);
        doc.text(`Diekspor    : ${formatDate(today.toISOString())}`, 40, 120);

        const head = [['Bulan', 'Target', 'Realisasi', 'Tambahan distributor grup', 'Pencapaian (%)']];
        const body = fiscalMonths.map((monthLabel, idx) => {
            const rawTarget = getTargetValue(idx);
            const rawActual = Array.isArray(monthlyActualGroup) ? Number(monthlyActualGroup[idx] || 0) : 0;
            const tambahanBulan = monthlyTambahan[idx] || 0;

            const formatVal = (val, withUnit = false) => {
                if (target.unit === 'nominal') {
                    return formatRupiah(val);
                } else if (target.unit === 'kg') {
                    const base = val.toLocaleString('id-ID', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    return withUnit ? base + ' Kg' : base;
                } else if (target.unit === 'pcs') {
                    const base = val.toLocaleString('id-ID');
                    return withUnit ? base + ' Pcs' : base;
                } else {
                    return String(val);
                }
            };

            const achievement = rawTarget > 0 ? (rawActual / rawTarget) * 100 : null;

            return [
                monthLabel,
                formatVal(rawTarget, true),
                formatVal(rawActual, true),
                tambahanBulan > 0 ? formatVal(tambahanBulan, true) : '-',
                achievement === null ? '-' : achievement.toFixed(1) + ' %'
            ];
        });

        if (doc.autoTable) {
            doc.autoTable({
                head,
                body,
                startY: 140,
                styles: {
                    fontSize: 9,
                    cellPadding: 4
                },
                headStyles: {
                    fillColor: [40, 120, 200],
                    textColor: 255,
                    halign: 'center'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                columnStyles: {
                    0: { halign: 'left', cellWidth: 60 },
                    1: { halign: 'right', cellWidth: 90 },
                    2: { halign: 'right', cellWidth: 90 },
                    3: { halign: 'right', cellWidth: 90 },
                    4: { halign: 'right', cellWidth: 80 }
                }
            });
        }

        if (hasAnyAdditional && doc.lastAutoTable) {
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.text(`* Kolom "Tambahan distributor grup" hanya terisi pada bulan yang memiliki tambahan realisasi dari Tani Guna.`, 40, finalY);
        }

        const safeDistributor = distributor.replace(/[^a-z0-9]+/gi, '_');
        const safeVariety = variety.replace(/[^a-z0-9]+/gi, '_');

        doc.save(`Breakdown_Target_${safeDistributor}_${safeVariety}_${target.year}.pdf`);
        showToast('PDF breakdown target berhasil di-generate!', 'success');
    }



    // Export breakdown satu target (per bulan) ke CSV
    

function exportSingleTargetBreakdownToCSV(targetId) {
        if (!appState.targets || appState.targets.length === 0) {
            showToast('Tidak ada data target untuk diekspor.', 'info');
            return;
        }

        const target = appState.targets.find(t => String(t.id) === String(targetId));
        if (!target) {
            showToast('Target tidak ditemukan.', 'error');
            return;
        }

        const distributor = appState.distributors.find(d => d.id === target.distributorId)?.name || 'N/A';
        const variety = appState.varieties.find(v => v.id === target.varietyId)?.name || 'N/A';
        const varietyObj = appState.varieties.find(v => v.id === target.varietyId) || null;

        const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

        const getTargetValue = (idx) => {
            if (Array.isArray(target.monthlyTargets) && typeof target.monthlyTargets[idx] === 'number') {
                return target.monthlyTargets[idx];
            }
            return 0;
        };

        // --- HITUNG REALISASI BULANAN: GRUP & DISTRIBUTOR UTAMA ---
        const getMonthlyActualsForDistributorIds = (distributorIds) => {
            const monthly = new Array(12).fill(0);

            const actualSalesReleases = appState.purchaseOrders
                .filter(po =>
                    distributorIds.includes(po.distributorId) &&
                    ['Partially Released', 'Fully Released'].includes((po.status || '').trim())
                )
                .flatMap(po => po.items || [])
                .filter(item => item.varietyId === target.varietyId)
                .flatMap(item => item.releases || [])
                .filter(release => {
                    const d = new Date(release.date);
                    return getFiscalYear(d) === target.year;
                });

            actualSalesReleases.forEach(release => {
                const d = new Date(release.date);
                const idx = getFiscalMonthIndex(d, target.year);
                if (idx < 0 || idx > 11) return;

                let delta = 0;
                if (target.unit === 'pcs') {
                    delta = Number(release.qty) || 0;
                } else if (target.unit === 'kg' && varietyObj) {
                    delta = (Number(release.qty) || 0) * (Number(varietyObj.weight) || 0) / 1000;
                } else if (target.unit === 'nominal' && varietyObj) {
                    delta = (Number(release.qty) || 0) * (Number(varietyObj.price) || 0);
                }
                monthly[idx] += delta;
            });

            return monthly;
        };

        const distributorIdsForActual = getDistributorIdsForActual(target);
        const monthlyActualGroup = getMonthlyActualsForDistributorIds(distributorIdsForActual);
        const monthlyActualBase = getMonthlyActualsForDistributorIds([target.distributorId]);

        const monthlyTambahan = monthlyActualGroup.map((val, idx) => {
            const base = monthlyActualBase[idx] || 0;
            const extra = val - base;
            return extra > 0 ? extra : 0;
        });

        const hasAnyAdditional = monthlyTambahan.some(v => v > 0);

        // --- BUILD CSV ---
        let csvContent = 'data:text/csv;charset=utf-8,';
        csvContent += `Distributor,Varietas,Tahun Fiskal,Satuan,Bulan,Target,Realisasi, Tambahan distributor grup, Pencapaian (%)\\n`;

        fiscalMonths.forEach((monthLabel, idx) => {
            const rawTarget = getTargetValue(idx);
            const rawActual = Array.isArray(monthlyActualGroup) ? Number(monthlyActualGroup[idx] || 0) : 0;
            const tambahanBulan = monthlyTambahan[idx] || 0;
            const achievement = rawTarget > 0 ? (rawActual / rawTarget) * 100 : null;

            let tambahanDisplay = '';
            if (tambahanBulan > 0) {
                if (target.unit === 'nominal') {
                    tambahanDisplay = formatRupiah(tambahanBulan);
                } else if (target.unit === 'kg') {
                    tambahanDisplay = tambahanBulan.toLocaleString('id-ID', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }) + ' Kg';
                } else {
                    tambahanDisplay = tambahanBulan.toLocaleString('id-ID') + ' Pcs';
                }
            }

            const row = [
                `\"${distributor}\"`,
                `\"${variety}\"`,
                `\"${target.year}/${target.year + 1}\"`,
                `\"${target.unit.toUpperCase()}\"`,
                `\"${monthLabel}\"`,
                rawTarget,
                rawActual,
                tambahanDisplay ? `\"${tambahanDisplay}\"` : '',
                achievement === null ? '' : achievement.toFixed(2)
            ].join(',');
            csvContent += row + '\\n';
        });

        if (hasAnyAdditional) {
            const noteText = `Kolom \"Tambahan distributor grup\" hanya terisi pada bulan yang memiliki tambahan realisasi dari Tani Guna.`;
            const noteRow = [
                `\"${distributor}\"`,
                `\"${variety}\"`,
                `\"${target.year}/${target.year + 1}\"`,
                `\"${target.unit.toUpperCase()}\"`,
                `\"Keterangan\"`,
                `\"${noteText.replace(/\"/g, '\"\"')}\"`,
                '',
                '',
                ''
            ].join(',');
            csvContent += noteRow + '\\n';
        }

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        const safeDistributor = distributor.replace(/[^a-z0-9]+/gi, '_');
        const safeVariety = variety.replace(/[^a-z0-9]+/gi, '_');

        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `Breakdown_Target_${safeDistributor}_${safeVariety}_${target.year}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('CSV breakdown target berhasil di-generate!', 'success');
    }



    // Export SEMUA target + breakdown bulanan ke PDF
    

function exportAllTargetBreakdownToPDF() {
        if (!appState.targets || appState.targets.length === 0) {
            showToast('Tidak ada data target untuk diekspor.', 'info');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); // Landscape A4
        const today = new Date();

        const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

        // --- Tentukan fiscal year yang aktif dari filter ---
        let activeYear = null;
        const fySelect = document.getElementById('target-year-filter');
        if (fySelect && fySelect.value) {
            const parsed = parseInt(fySelect.value, 10);
            if (!Number.isNaN(parsed)) {
                activeYear = parsed;
            }
        }
        // Jika belum ada (misal filter belum dipilih), fallback ke fiscal year dari target terbaru
        if (activeYear === null) {
            const years = [...new Set(appState.targets.map(t => t.year))].sort((a, b) => b - a);
            if (years.length === 0) {
                showToast('Tidak ada data target untuk diekspor.', 'info');
                return;
            }
            activeYear = years[0];
        }

        // Kelompokkan target per Distributor untuk fiscal year terpilih saja
        const groups = {};
        appState.targets
            .filter(t => t.year === activeYear)
            .forEach(target => {
                const dist = appState.distributors.find(d => d.id === target.distributorId);
                const key = `${target.distributorId}-${target.year}`;
                if (!groups[key]) {
                    groups[key] = {
                        year: target.year,
                        distributorName: dist ? dist.name : 'N/A',
                        targets: []
                    };
                }
                groups[key].targets.push(target);
            });

        const groupList = Object.values(groups).sort((a, b) => {
            return a.distributorName.localeCompare(b.distributorName);
        });

        if (!groupList.length) {
            showToast(`Tidak ada target untuk tahun fiskal ${activeYear}/${activeYear + 1}.`, 'info');
            return;
        }

        const formatVal = (val, unit) => {
            const n = Number(val || 0);
            if (unit === 'nominal') {
                return formatRupiah(n);
            } else if (unit === 'kg') {
                return n.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else if (unit === 'pcs') {
                return n.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return String(n);
        };

        groupList.forEach((group, index) => {
            const { year, distributorName, targets } = group;

            if (index > 0) {
                doc.addPage('l', 'a4');
            }

            // --- Header halaman dengan blok warna ---
            doc.setFillColor(37, 99, 235); // biru
            doc.rect(30, 24, 782, 40, 'F'); // bar warna atas

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Sales Budget', 40, 40);

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Fiscal Year ${year}/${year + 1}`, 40, 56);

            // Info distributor di bawah header warna
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Distributor : ${distributorName}`, 40, 78);
            doc.text(`Diekspor pada : ${formatDate(today.toISOString())}`, 40, 92);

            // Siapkan header tabel: PRODUCT + 12 bulan + TOTAL
            const head = [[
                'Product',
                ...fiscalMonths,
                'TOTAL'
            ]];

            // Body: tiap baris = 1 target varietas di distributor & tahun ini
            const body = [];

            targets.forEach(target => {
                const variety = appState.varieties.find(v => v.id === target.varietyId);
                const name = variety ? variety.name : 'Varietas';

                const monthly = fiscalMonths.map((_, idx) => {
                    if (Array.isArray(target.monthlyTargets) && typeof target.monthlyTargets[idx] === 'number') {
                        return Number(target.monthlyTargets[idx] || 0);
                    }
                    return 0;
                });
                const total = monthly.reduce((sum, v) => sum + v, 0);

                body.push([
                    name,
                    ...monthly.map(v => formatVal(v, target.unit)),
                    formatVal(total, target.unit)
                ]);
            });

            if (doc.autoTable) {
                doc.autoTable({
                    head,
                    body,
                    startY: 106,
                    theme: 'grid',
                    styles: {
                        fontSize: 8,
                        cellPadding: 3,
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [251, 191, 36], // amber-400
                        textColor: 0,
                        halign: 'center',
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        textColor: 33
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252] // slate-50
                    },
                    columnStyles: {
                        0: { cellWidth: 120 }, // product
                        13: { halign: 'right' } // TOTAL
                    }
                });
            }
        });

        doc.save(`Sales_Budget_FY_${activeYear}_${formatDate(today.toISOString())}.pdf`);
        showToast('PDF semua breakdown target (tahun terpilih) berhasil di-generate!', 'success');
    }
// Export SEMUA target + breakdown bulanan ke CSV
    function exportAllTargetBreakdownToCSV() {
        if (!appState.targets || appState.targets.length === 0) {
            showToast('Tidak ada data target untuk diekspor.', 'info');
            return;
        }

        const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

        let csvContent = 'data:text/csv;charset=utf-8,';
        csvContent += 'Distributor,Tahun Fiskal,Varietas,Satuan,Bulan,Target,Realisasi,Pencapaian (%)\n';

        appState.targets.forEach(target => {
            const distributor = appState.distributors.find(d => d.id === target.distributorId)?.name || 'N/A';
            const variety = appState.varieties.find(v => v.id === target.varietyId)?.name || 'N/A';

            const monthlyActuals = getTargetMonthlyActuals(target);

            fiscalMonths.forEach((monthLabel, idx) => {
                let rawTarget = 0;
                if (Array.isArray(target.monthlyTargets) && typeof target.monthlyTargets[idx] === 'number') {
                    rawTarget = target.monthlyTargets[idx];
                }

                const rawActual = Array.isArray(monthlyActuals) ? Number(monthlyActuals[idx] || 0) : 0;
                const achievement = rawTarget > 0 ? (rawActual / rawTarget) * 100 : null;

                const row = [
                    `"${distributor}"`,
                    `"${target.year}/${target.year + 1}"`,
                    `"${variety}"`,
                    `"${target.unit.toUpperCase()}"`,
                    `"${monthLabel}"`,
                    rawTarget,
                    rawActual,
                    achievement === null ? '' : achievement.toFixed(2)
                ].join(',');

                csvContent += row + '\n';
            });
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        const today = new Date();
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `Laporan_Breakdown_Target_Semua_${formatDate(today.toISOString())}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('CSV semua breakdown target berhasil di-generate!', 'success');
    }

function openTargetModal(targetId = null) {
        const form = document.getElementById('target-form');
        form.reset();
        document.getElementById('editing-target-id').value = targetId || '';
        document.getElementById('target-items-container').innerHTML = '';
        
        const distSelect = document.getElementById('target-distributor');
        const yearSelect = document.getElementById('target-year');
        distSelect.innerHTML = appState.distributors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        
        const currentFiscalYear = getFiscalYear(new Date());
        yearSelect.innerHTML = Array.from({length: 5}, (_, i) => {
            const year = currentFiscalYear - i;
            return `<option value="${year}">${year}/${year + 1}</option>`;
        }).join('');

        const updateSubtitle = () => { document.getElementById('target-modal-subtitle').textContent = `Periode: April ${yearSelect.value} - Maret ${parseInt(yearSelect.value) + 1}`; };
        yearSelect.onchange = updateSubtitle;
        
        if (targetId) {
            const target = (appState.targets || []).find(t => String(t.id) === String(targetId));
            if (target) {
                document.getElementById('target-modal-title').textContent = 'Edit Target Penjualan';
                distSelect.value = target.distributorId;
                yearSelect.value = target.year;
                document.getElementById('target-unit').value = target.unit;
                distSelect.disabled = true;
                yearSelect.disabled = true;
                addTargetItem(target.varietyId, target.monthlyTargets);
            }
        } else {
            document.getElementById('target-modal-title').textContent = 'Set Target Penjualan Baru';
            distSelect.disabled = false;
            yearSelect.disabled = false;
            addTargetItem();
        }
        updateSubtitle();
        openEditModal('target-modal');
    }

    function addTargetItem(selectedVarietyId = null, monthlyTargets = null) {
        const container = document.getElementById('target-items-container');
        const itemIndex = container.children.length;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'p-4 border rounded-md';

        const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

        const varieties = Array.isArray(appState.varieties) ? appState.varieties : [];
        const varietyOptions = varieties.map(function(v) {
            const selected = selectedVarietyId && String(v.id) === String(selectedVarietyId) ? 'selected' : '';
            return '<option value="' + v.id + '" ' + selected + '>' + v.name + '</option>';
        }).join('');

        const monthValues = fiscalMonths.map(function(_, i) {
            if (Array.isArray(monthlyTargets) && monthlyTargets.length > i) {
                var val = monthlyTargets[i];
                return typeof val === 'number' ? val : (parseFloat(val) || 0);
            }
            return 0;
        });

        itemDiv.innerHTML = ''
            + '<div class="flex justify-between items-center mb-4">'
            + '  <select class="p-2 border rounded-md target-variety-select">' + varietyOptions + '</select>'
            + (itemIndex > 0
                ? '  <button type="button" onclick="this.closest(\'div.p-4\').remove()"'
                  + ' class="text-red-500 text-xl leading-none px-2 hover:bg-red-50 rounded-full"'
                  + ' title="Hapus Varietas">&times;</button>'
                : '')
            + '</div>'
            + '<div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-2">'
            + fiscalMonths.map(function(m, i) {
                return ''
                    + '<div>'
                    + '  <label class="text-xs">' + m + '</label>'
                    + '  <input type="number" min="0" value="' + monthValues[i] + '"'
                    + ' class="w-full p-1 border rounded-md text-sm monthly-target-input">'
                    + '</div>';
            }).join('')
            + '</div>';

        container.appendChild(itemDiv);
    }

async function saveTarget() {
        const editingId = document.getElementById('editing-target-id').value;
        const distributorId = parseInt(document.getElementById('target-distributor').value);
        const year = parseInt(document.getElementById('target-year').value);
        const unit = document.getElementById('target-unit').value;

        const targetItems = [];
        let hasError = false;

        document.querySelectorAll('#target-items-container > div').forEach(row => {
            const varietyId = parseInt(row.querySelector('.target-variety-select').value);
            const monthlyTargets = Array.from(row.querySelectorAll('.monthly-target-input')).map(input => parseFloat(input.value) || 0);

            if (targetItems.some(item => item.varietyId === varietyId)) {
                showToast(`Varietas duplikat ditemukan. Harap pilih varietas yang berbeda.`, 'error');
                hasError = true;
            }
            if (!editingId && appState.targets.some(t => t.distributorId === distributorId && t.year === year && t.varietyId === varietyId && t.unit === unit)) {
                showToast(`Target (${unit}) untuk "${appState.varieties.find(v=>v.id===varietyId)?.name}" pada tahun ${year} sudah ada.`, 'error');
                hasError = true;
            }
            targetItems.push({ varietyId, monthlyTargets, unit });
        });
        
        if (hasError) return;

        if (editingId) {
            const targetIndex = appState.targets.findIndex(t => t.id === editingId);
            if (targetIndex > -1) appState.targets[targetIndex] = { ...appState.targets[targetIndex], ...targetItems[0] };
        } else {
            targetItems.forEach(item => {
                appState.targets.push({ id: `target-${Date.now()}-${Math.random()}`, distributorId, year, ...item });
            });
        }
        
        await saveData(); refreshUI(); closeEditModal('target-modal');
        showToast('Target berhasil disimpan!', 'success');
    }
    
    function confirmDeleteTarget(targetId) {
        showConfirmation('Hapus Target', 'Yakin ingin menghapus target ini?', async () => {
            var idStr = String(targetId);
            appState.targets = (appState.targets || []).filter(function(t) {
                return String(t.id) !== idStr;
            });
            await saveData(); 
            refreshUI(); 
            hideConfirmation();
            showToast('Target berhasil dihapus.', 'success');
        });
    }
</script>
<script>
    // --- Continuation for Dashboard, Reports, PDF Export ---
    // **UPDATED**: All functions in this block now use the release date for calculations.
    function createCharts() {
        // **UPDATED**: Collects each individual release event, not just PO items.
        // This ensures sales are attributed to the correct date.
        const allReleasedItems = appState.purchaseOrders.flatMap(po => {
            if (!['Partially Released', 'Fully Released'].includes(po.status.trim())) return [];
            return po.items.flatMap(item =>
                (item.releases || []).map(release => ({
                    ...item, // includes name, price, weight
                    distributorId: po.distributorId,
                    releaseQty: release.qty, // Use the quantity from this specific release
                    releaseDate: release.date // Use the date of this specific release
                }))
            );
        });

        
        const fiscalSelect = document.getElementById('dashboard-fiscal-year-select');
        const distributorSelect = document.getElementById('dashboard-distributor-filter');
        const varietySelect = document.getElementById('dashboard-variety-filter');
        let compareVarietySelect = document.getElementById('compare-variety-filter');

        let selectedFiscalYear = null;
        let selectedDistributorId = null;
        let selectedVarietyId = null;

        const yearsSet = new Set();

        if (fiscalSelect) {
            allReleasedItems.forEach(item => {
                const d = new Date(item.releaseDate);
                if (!isNaN(d)) {
                    yearsSet.add(getFiscalYear(d));
                }
            });

            const years = Array.from(yearsSet).sort((a, b) => b - a);
            const previousValue = fiscalSelect.value || 'all';

            fiscalSelect.innerHTML = '<option value="all">Semua</option>' +
                years.map(y => '<option value="' + y + '">' + y + '/' + (y + 1) + '</option>').join('');

            if (previousValue && (previousValue === 'all' || years.includes(parseInt(previousValue, 10)))) {
                fiscalSelect.value = previousValue;
            }

            const value = fiscalSelect.value;
            if (value && value !== 'all') {
                selectedFiscalYear = parseInt(value, 10);
            }

            if (!fiscalSelect._listenerAttached) {
                fiscalSelect.addEventListener('change', () => {
                    createCharts();
                });
                fiscalSelect._listenerAttached = true;
            }
        }

        if (distributorSelect) {
            const previousDist = distributorSelect.value || 'all';

            const sortedDistributors = [...(appState.distributors || [])].sort((a, b) =>
                String(a.name || '').localeCompare(String(b.name || ''))
            );

            distributorSelect.innerHTML = '<option value="all">Semua</option>' +
                sortedDistributors.map(d => '<option value="' + d.id + '">' + d.name + '</option>').join('');

            if (previousDist && (previousDist === 'all' || sortedDistributors.some(d => String(d.id) === previousDist))) {
                distributorSelect.value = previousDist;
            }

            const distVal = distributorSelect.value;
            if (distVal && distVal !== 'all') {
                selectedDistributorId = parseInt(distVal, 10);
            }

            if (!distributorSelect._listenerAttached) {
                distributorSelect.addEventListener('change', () => {
                    createCharts();
                });
                distributorSelect._listenerAttached = true;
            }
        }

        if (varietySelect) {
            const previousVar = varietySelect.value || 'all';

            const sortedVarieties = [...(appState.varieties || [])].sort((a, b) =>
                String(a.name || '').localeCompare(String(b.name || ''))
            );

            const optionsHtml = '<option value="all">Semua</option>' +
                sortedVarieties.map(v => '<option value="' + v.id + '">' + v.name + '</option>').join('');

            varietySelect.innerHTML = optionsHtml;

            if (previousVar && (previousVar === 'all' || sortedVarieties.some(v => String(v.id) === previousVar))) {
                varietySelect.value = previousVar;
            }

            const varVal = varietySelect.value;
            if (varVal && varVal !== 'all') {
                selectedVarietyId = parseInt(varVal, 10);
            }

            // Sinkronkan dropdown varietas di kartu compare
            const fy1SelectEl = document.getElementById('compare-fiscal-year-1');
            if (!compareVarietySelect && fy1SelectEl && fy1SelectEl.parentElement) {
                const container = fy1SelectEl.parentElement;
                const label = document.createElement('label');
                label.htmlFor = 'compare-variety-filter';
                label.className = 'text-gray-600';
                label.textContent = 'Varietas';
                compareVarietySelect = document.createElement('select');
                compareVarietySelect.id = 'compare-variety-filter';
                compareVarietySelect.className = 'border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500';
                container.appendChild(label);
                container.appendChild(compareVarietySelect);
            }

            if (compareVarietySelect) {
                compareVarietySelect.innerHTML = optionsHtml;
                compareVarietySelect.value = varietySelect.value;

                if (!compareVarietySelect._listenerAttached) {
                    compareVarietySelect.addEventListener('change', () => {
                        varietySelect.value = compareVarietySelect.value;
                        createCharts();
                    });
                    compareVarietySelect._listenerAttached = true;
                }
            }

            if (!varietySelect._listenerAttached) {
                varietySelect.addEventListener('change', () => {
                    if (compareVarietySelect) {
                        compareVarietySelect.value = varietySelect.value;
                    }
                    createCharts();
                });
                varietySelect._listenerAttached = true;
            }
        }


        let filteredReleasedItems = allReleasedItems;

        if (selectedFiscalYear !== null) {
            filteredReleasedItems = filteredReleasedItems.filter(item => {
                const d = new Date(item.releaseDate);
                return !isNaN(d) && getFiscalYear(d) === selectedFiscalYear;
            });
        }

        if (selectedDistributorId !== null) {
            filteredReleasedItems = filteredReleasedItems.filter(item => item.distributorId == selectedDistributorId);
        }

        if (selectedVarietyId !== null) {
            filteredReleasedItems = filteredReleasedItems.filter(item => item.varietyId == selectedVarietyId);
        }
        
        let totalSales = 0, totalPcs = 0, totalKg = 0;
        filteredReleasedItems.forEach(item => {
            totalSales += item.releaseQty * (item.price || 0);
            totalPcs += item.releaseQty;
            totalKg += (item.releaseQty * (item.weight || 0)) / 1000;
        });

        document.getElementById('dashboard-stats').innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-sm"><h4 class="text-gray-500">Total Penjualan (Dirilis)</h4><p class="text-3xl font-bold text-blue-600">${formatRupiah(totalSales)}</p></div>
            <div class="bg-white p-6 rounded-lg shadow-sm"><h4 class="text-gray-500">Total Qty (Pcs)</h4><p class="text-3xl font-bold text-gray-800">${totalPcs.toLocaleString('id-ID')}</p></div>
            <div class="bg-white p-6 rounded-lg shadow-sm"><h4 class="text-gray-500">Total Qty (Kg)</h4><p class="text-3xl font-bold text-gray-800">${totalKg.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
            <div class="bg-white p-6 rounded-lg shadow-sm"><h4 class="text-gray-500">PO Draft</h4><p class="text-3xl font-bold text-gray-800">${appState.purchaseOrders.filter(p => p.status.trim() === 'Draft').length}</p></div>
        `;

        const now = new Date();
        const currentFiscalYear = getFiscalYear(now);
        const currentMonthIndex = now.getMonth();
        const fiscalMonthIndex = currentMonthIndex >= 3 ? currentMonthIndex - 3 : currentMonthIndex + 9;

        const totalTargetThisMonth = appState.targets.filter(t => t.year === currentFiscalYear && t.unit === 'nominal').reduce((sum, t) => sum + t.monthlyTargets[fiscalMonthIndex], 0);
        
        // **UPDATED**: Calculates sales for the current month based on release dates.
        const actualSalesThisMonth = filteredReleasedItems.filter(item => {
            const releaseDate = new Date(item.releaseDate);
            return releaseDate.getFullYear() === now.getFullYear() && releaseDate.getMonth() === currentMonthIndex;
        }).reduce((sum, item) => sum + (item.releaseQty * (item.price || 0)), 0);

        const achievementPercentage = totalTargetThisMonth > 0 ? (actualSalesThisMonth / totalTargetThisMonth) * 100 : 0;
        document.getElementById('dashboard-target-summary').innerHTML = `
            <h3 class="font-bold text-lg mb-4">Pencapaian Target Bulan Ini (Nominal)</h3>
            <div class="space-y-2">
                <div class="flex justify-between text-sm font-medium">
                    <span>${formatRupiah(actualSalesThisMonth)}</span>
                    <span class="text-gray-500">Target: ${formatRupiah(totalTargetThisMonth)}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="bg-blue-600 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${Math.min(achievementPercentage, 100)}%">${achievementPercentage.toFixed(0)}%</div>
                </div>
            </div>`;

        // **UPDATED**: Groups monthly sales by release date.
        const monthlySales = {};
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
        filteredReleasedItems.forEach(item => {
            const releaseDate = new Date(item.releaseDate);
            const monthKey = `${releaseDate.getFullYear()}-${String(releaseDate.getMonth()).padStart(2, '0')}`;
            monthlySales[monthKey] = (monthlySales[monthKey] || 0) + (item.releaseQty * (item.price || 0));
        });

        const sortedMonths = Object.keys(monthlySales).sort();
        const chartLabels = sortedMonths.map(key => `${monthNames[parseInt(key.split('-')[1])]} ${key.split('-')[0]}`);
        const chartData = sortedMonths.map(key => monthlySales[key] / 1000000);

        let salesChart = Chart.getChart("salesChart");
        if (salesChart) salesChart.destroy();
        const salesCanvas = document.getElementById('salesChart');
        if (salesCanvas) {
            const salesCtx = salesCanvas.getContext('2d');

            // Gradient for sales bars
            const gradient = salesCtx.createLinearGradient(0, 0, 0, salesCanvas.height || 300);
            gradient.addColorStop(0, 'rgba(37, 99, 235, 0.95)');
            gradient.addColorStop(0.5, 'rgba(59, 130, 246, 0.85)');
            gradient.addColorStop(1, 'rgba(191, 219, 254, 0.9)');

            new Chart(salesCtx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Penjualan (Juta Rupiah)',
                        data: chartData,
                        backgroundColor: gradient,
                        borderColor: '#1D4ED8',
                        borderWidth: 1.5,
                        borderRadius: 6,
                        maxBarThickness: 40,
                        categoryPercentage: 0.6,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            right: 16,
                            left: 8,
                            bottom: 8
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 11 },
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 10,
                            cornerRadius: 6,
                            displayColors: false,
                            callbacks: {
                                label: function(ctx) {
                                    const value = ctx.parsed.y || 0;
                                    return ' ' + value.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Juta';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 10 },
                                maxRotation: 0,
                                minRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.25)',
                                drawBorder: false
                            },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return value.toLocaleString('id-ID') + ' Jt';
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutCubic'
                    }
                }
            });
        }

        let distChart = Chart.getChart("distributorChart");
        if (distChart) distChart.destroy();
        const distCanvas = document.getElementById('distributorChart');
        if (distCanvas) {
            const distCtx = distCanvas.getContext('2d');
            const salesByDistributor = filteredReleasedItems.reduce((acc, item) => {
                const distName = appState.distributors.find(d => d.id == item.distributorId)?.name || 'Unknown';
                acc[distName] = (acc[distName] || 0) + (item.releaseQty * (item.price || 0));
                return acc;
            }, {});

            const distLabels = Object.keys(salesByDistributor);
            const distValues = Object.values(salesByDistributor).map(v => v / 1000000);

            new Chart(distCtx, {
                type: 'doughnut',
                data: {
                    labels: distLabels,
                    datasets: [{
                        data: distValues,
                        backgroundColor: [
                            '#1D4ED8',
                            '#0EA5E9',
                            '#22C55E',
                            '#F97316',
                            '#E11D48',
                            '#8B5CF6',
                            '#A855F7'
                        ],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 10 },
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 8,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(ctx) {
                                    const label = ctx.label || '';
                                    const value = ctx.parsed || 0;
                                    return ' ' + label + ': ' + value.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Jt';
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 700,
                        easing: 'easeOutCubic'
                    }
                }
            });
        }


        const salesByVarietyKg = filteredReleasedItems.reduce((acc, item) => {
            acc[item.name] = (acc[item.name] || 0) + ((item.releaseQty * (item.weight || 0)) / 1000);
            return acc;
        }, {});
        
        const varietyKgContainer = document.getElementById('variety-kg-summary');
        if (varietyKgContainer) {
            let content = '<h3 class="font-bold text-lg mb-4">Total Penjualan per Varietas (Kg)</h3>';
            const sortedVarieties = Object.entries(salesByVarietyKg).sort(([,a],[,b]) => b-a);
            if (sortedVarieties.length === 0) content += '<p class="text-gray-500 text-sm">Tidak ada data penjualan.</p>';
            else {
                content += '<div class="space-y-3 max-h-48 overflow-y-auto pr-2">';
                sortedVarieties.forEach(([name, kg]) => {
                    content += `<div class="flex justify-between items-center text-sm"><span class="text-gray-700 truncate pr-2">${name}</span><span class="font-semibold text-gray-800 flex-shrink-0">${kg.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2})} Kg</span></div>`;
                });
                content += '</div>';
            }
            varietyKgContainer.innerHTML = content;
        }


                // Compare penjualan antar Fiscal Year per bulan (April-Maret) untuk distributor yang sama
        const compareCanvas = document.getElementById('compareSalesChart');
        const fyCompare1 = document.getElementById('compare-fiscal-year-1');
        const fyCompare2 = document.getElementById('compare-fiscal-year-2');
        const compareDistLabel = document.getElementById('compare-distributor-label');

        if (compareDistLabel) {
            if (selectedDistributorId !== null) {
                const dist = (appState.distributors || []).find(d => String(d.id) === String(selectedDistributorId));
                compareDistLabel.textContent = dist ? `Distributor: ${dist.name}` : 'Distributor: -';
            } else {
                compareDistLabel.textContent = 'Distributor: Semua';
            }
        }

        if (compareCanvas && fyCompare1 && fyCompare2 && yearsSet.size > 0) {
            const allYears = Array.from(yearsSet).sort((a, b) => a - b);
            const prev1 = fyCompare1.value || '';
            const prev2 = fyCompare2.value || '';

            fyCompare1.innerHTML = allYears.map(y => '<option value="' + y + '">' + y + '/' + (y + 1) + '</option>').join('');
            fyCompare2.innerHTML = allYears.map(y => '<option value="' + y + '">' + y + '/' + (y + 1) + '</option>').join('');

            if (prev1 && allYears.includes(parseInt(prev1, 10))) fyCompare1.value = prev1;
            if (prev2 && allYears.includes(parseInt(prev2, 10))) fyCompare2.value = prev2;

            if (!fyCompare1.value && allYears.length) fyCompare1.value = String(allYears[Math.max(0, allYears.length - 2)]);
            if (!fyCompare2.value && allYears.length) fyCompare2.value = String(allYears[allYears.length - 1]);

            const fy1 = parseInt(fyCompare1.value || '0', 10);
            const fy2 = parseInt(fyCompare2.value || '0', 10);

            const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

            const monthlyKg1 = new Array(12).fill(0);
            const monthlyKg2 = new Array(12).fill(0);

            function monthlyTotalsForFiscalYear(fy, targetKgArray) {
                const result = new Array(12).fill(0);
                if (!fy || isNaN(fy)) return result;

                allReleasedItems.forEach(item => {
                    const d = new Date(item.releaseDate);
                    if (isNaN(d)) return;
                    if (getFiscalYear(d) !== fy) return;
                    if (selectedDistributorId !== null && item.distributorId != selectedDistributorId) return;
                    if (selectedVarietyId !== null && item.varietyId != selectedVarietyId) return;

                    const month = d.getMonth(); // 0=Jan
                    let idx = month >= 3 ? month - 3 : month + 9; // April-Maret => 0-11

                    result[idx] += item.releaseQty * (item.price || 0);
                    if (targetKgArray) {
                        targetKgArray[idx] += (item.releaseQty * (item.weight || 0)) / 1000;
                    }
                });

                return result.map(v => v / 1000000); // ke Juta Rupiah
            }

            const data1 = monthlyTotalsForFiscalYear(fy1, monthlyKg1);
            const data2 = monthlyTotalsForFiscalYear(fy2, monthlyKg2);

            let compareChart = Chart.getChart('compareSalesChart');
            if (compareChart) compareChart.destroy();

            const ctx = compareCanvas.getContext('2d');
            const gradient1 = ctx.createLinearGradient(0, 0, 0, compareCanvas.height || 300);
            gradient1.addColorStop(0, 'rgba(37, 99, 235, 0.95)');
            gradient1.addColorStop(1, 'rgba(191, 219, 254, 0.9)');

            const gradient2 = ctx.createLinearGradient(0, 0, 0, compareCanvas.height || 300);
            gradient2.addColorStop(0, 'rgba(16, 185, 129, 0.95)');
            gradient2.addColorStop(1, 'rgba(167, 243, 208, 0.9)');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fiscalMonths,
                    datasets: [
                        {
                            label: fy1 ? ('FY ' + fy1 + '/' + (fy1 + 1)) : 'FY 1',
                            data: data1,
                            backgroundColor: gradient1,
                            borderWidth: 0,
                            borderRadius: 6
                        },
                        {
                            label: fy2 ? ('FY ' + fy2 + '/' + (fy2 + 1)) : 'FY 2',
                            data: data2,
                            backgroundColor: gradient2,
                            borderWidth: 0,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 11 } }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('id-ID') + ' Jt';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const value = ctx.parsed.y;
                                    const lines = [];
                                    const idx = ctx.dataIndex;

                                    // Nilai penjualan (Juta Rupiah)
                                    lines.push(
                                        ctx.dataset.label + ': ' +
                                        value.toLocaleString('id-ID', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        }) + ' Juta'
                                    );

                                    // Qty dalam Kg
                                    if (typeof monthlyKg1 !== 'undefined' && typeof monthlyKg2 !== 'undefined') {
                                        let kg = 0;
                                        if (ctx.datasetIndex === 0) {
                                            kg = monthlyKg1[idx] || 0;
                                        } else if (ctx.datasetIndex === 1) {
                                            kg = monthlyKg2[idx] || 0;
                                        }
                                        if (kg && kg > 0) {
                                            lines.push(
                                                'Qty: ' + kg.toLocaleString('id-ID', {
                                                    minimumFractionDigits: 1,
                                                    maximumFractionDigits: 1
                                                }) + ' Kg'
                                            );
                                        }
                                    }

                                    // Growth % per bulan (hanya ditampilkan untuk FY 2)
                                    const chart = ctx.chart;
                                    const datasets = chart.data.datasets || [];

                                    if (datasets.length >= 2 && ctx.datasetIndex === 1) {
                                        const base = datasets[0].data[idx] || 0;
                                        const compare = datasets[1].data[idx] || 0;

                                        if (base === 0 && compare === 0) {
                                            // tidak ada growth
                                        } else if (base === 0 && compare > 0) {
                                            lines.push('Growth: tahun pertama (tidak bisa dihitung %)');
                                        } else if (base !== 0) {
                                            const pct = ((compare - base) / base) * 100;
                                            const rounded = pct.toLocaleString('id-ID', {
                                                minimumFractionDigits: 1,
                                                maximumFractionDigits: 1
                                            });
                                            lines.push('Growth vs FY 1: ' + rounded + ' %');
                                        }
                                    }

                                    return lines;
                                }
                            }
                        }
                    }
                }
            });

            if (!fyCompare1._listenerAttached) {
                const handler = () => createCharts();
                fyCompare1.addEventListener('change', handler);
                fyCompare2.addEventListener('change', handler);
                fyCompare1._listenerAttached = true;
                fyCompare2._listenerAttached = true;
            }
        }

    }
    
    function showConfirmation(title, body, onConfirm) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = body;
        document.getElementById('modal-confirm-button').onclick = onConfirm;
        openEditModal('confirmation-modal');
    }
    function hideConfirmation() { closeEditModal('confirmation-modal'); }
    
    function confirmReset() { showConfirmation('Reset Aplikasi', 'Yakin ingin menghapus semua data? Data yang sudah ada di cloud akan terhapus permanen.', async () => { 
        appState = JSON.parse(JSON.stringify(window.defaultData));
        await saveData();
        refreshUI();
        resetPOForm();
        showPage('dashboard');
        hideConfirmation();
        showToast("Aplikasi berhasil direset.", "success"); 
    }); }
    
    // === FARMER REACH CONFIGURATION ===
    function loadFarmerReachConfig() {
        const multipliers = appState.farmerReachMultipliers || {
            FM: 25, ODP: 25, FT: 20, FFD: 60, DISPLAY: 0
        };
        
        document.getElementById('multiplier-fm').value = multipliers.FM;
        document.getElementById('multiplier-odp').value = multipliers.ODP;
        document.getElementById('multiplier-ft').value = multipliers.FT;
        document.getElementById('multiplier-ffd').value = multipliers.FFD;
    }
    
    async function saveFarmerReachConfig() {
        const fm = parseInt(document.getElementById('multiplier-fm').value) || 25;
        const odp = parseInt(document.getElementById('multiplier-odp').value) || 25;
        const ft = parseInt(document.getElementById('multiplier-ft').value) || 20;
        const ffd = parseInt(document.getElementById('multiplier-ffd').value) || 60;
        
        appState.farmerReachMultipliers = {
            FM: fm,
            ODP: odp,
            FT: ft,
            FFD: ffd,
            DISPLAY: 0
        };
        
        await saveData();
        
        // Refresh DGA and Presentation summaries to reflect new calculations
        if (document.getElementById('dga-page').style.display !== 'none') {
            updateDGASummary();
        }
        
        showToast("Konfigurasi Farmer Reach berhasil disimpan!", "success");
    }
    
    function resetFarmerReachConfig() {
        appState.farmerReachMultipliers = {
            FM: 25, ODP: 25, FT: 20, FFD: 60, DISPLAY: 0
        };
        loadFarmerReachConfig();
        showToast("Konfigurasi direset ke nilai default", "success");
    }
    
    // === EXPORT TO EXCEL (CSV FORMAT) ===
    function exportToExcel(type) {
        let data = [];
        let filename = '';
        let headers = [];
        
        switch(type) {
            case 'po':
                headers = ['No PO', 'Tanggal', 'Distributor', 'Alamat', 'Total', 'Status'];
                data = (appState.purchaseOrders || []).map(po => [
                    po.poNumber || '',
                    po.poDate || '',
                    po.distributor || '',
                    po.shipmentAddress || '',
                    po.total || 0,
                    po.status || 'Draft'
                ]);
                filename = 'purchase-orders';
                break;
                
            case 'distributors':
                headers = ['Nama', 'Alamat', 'Kontak', 'Kabupaten', 'Provinsi'];
                data = (appState.distributors || []).map(dist => [
                    dist.name || '',
                    dist.address || '',
                    dist.contact || '',
                    dist.kabupaten || '',
                    dist.provinsi || ''
                ]);
                filename = 'distributors';
                break;
                
            case 'targets':
                headers = ['Tahun', 'Distributor', 'Varietas', 'Unit', 'Target Qty', 'Realisasi'];
                data = (appState.targets || []).map(target => {
                    const distributor = appState.distributors?.find(d => d.id == target.distributorId);
                    const variety = appState.varieties?.find(v => v.id == target.varietyId);
                    return [
                        target.year || '',
                        distributor?.name || 'N/A',
                        variety?.name || 'N/A',
                        target.unit || '',
                        target.targetQty || 0,
                        target.achievedQty || 0
                    ];
                });
                filename = 'targets';
                break;
        }
        
        if (data.length === 0) {
            showToast('Tidak ada data untuk di-export', 'error');
            return;
        }
        
        // Convert to CSV
        const csvContent = [
            headers.join(','),
            ...data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
        ].join('\n');
        
        // Create and download file
        const BOM = '\uFEFF'; // UTF-8 BOM for Excel compatibility
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `advanta-${filename}-${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast(`Export ${filename} berhasil! File: CSV`, 'success');
    }
    
    function backupData() {
        const dataStr = JSON.stringify(appState, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `advanta-backup-${new Date().toISOString().slice(0, 10)}.json`; a.click();
        URL.revokeObjectURL(url);
        showToast("Backup data berhasil diunduh.", "success");
    }
    async function handleRestoreFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.distributors && data.varieties) {
                    appState = data;
                    await saveData(); 
                    refreshUI(); resetPOForm(); showPage('dashboard');
                    showToast('Data berhasil dipulihkan!', "success");
                } else { showToast('File backup tidak valid.', "error"); }
            } catch (error) { showToast('Gagal membaca file backup.', "error"); }
        };
        reader.readAsText(file); event.target.value = '';
    }

    
    
    
    // ==========================
    //  HALAMAN INSENTIF
    // ==========================

    function ensureInsentifPage() {
        const container = document.getElementById('page-container');
        if (!container) return;
        if (document.getElementById('insentif-page')) return;

        const div = document.createElement('div');
        div.id = 'insentif-page';
        div.className = 'page';
        div.style.display = 'none';
        div.innerHTML = `
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-100">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                    <div>
                        <h3 class="text-xl font-bold mb-1">Insentif Distributor</h3>
                        <p class="text-sm text-gray-500">
                            Perhitungan insentif berdasarkan pencapaian target nominal per tahun fiskal.
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-3 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Distributor</label>
                            <select id="insentif-distributor-filter" class="mt-1 p-2 border rounded-md min-w-[180px]"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tahun Fiskal</label>
                            <select id="insentif-year-filter" class="mt-1 p-2 border rounded-md min-w-[140px]"></select>
                        </div>
                        <div class="flex gap-2">
                            <button type="button"
                                    onclick="exportInsentifToCSV()"
                                    class="px-3 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 flex items-center text-xs md:text-sm shadow-sm">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M12 12v9m0 0l-3-3m3 3l3-3"/>
                                </svg>
                                Export CSV
                            </button>
                            <button type="button"
                                    onclick="exportInsentifToPDF()"
                                    class="px-3 py-2 bg-rose-600 text-white rounded-md hover:bg-rose-700 flex items-center text-xs md:text-sm shadow-sm">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M19 11H5m7-7v14M5 19h14" />
                                </svg>
                                Export PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div id="insentif-content" class="space-y-4"></div>
            </div>
        `;
        container.appendChild(div);
    }

    // Tahun fiskal diambil dari semua target yang sudah ada.
    function getInsentifFiscalYears() {
        if (!window.appState || !Array.isArray(appState.targets)) return [];
        const years = [...new Set(
            appState.targets
                .map(t => t.year)
                .filter(y => typeof y === 'number' && !isNaN(y))
        )];
        return years.sort((a, b) => b - a);
    }

    
function getInsentifSummary(year, distributorIdFilter = null) {
        if (!window.appState || !Array.isArray(appState.targets)) {
            return { rows: [], totalIncentive: 0, totalActual: 0 };
        }

        // Ambil semua target di tahun fiskal tersebut (simulasi insentif berdasarkan target + realisasi PO)
        let relevantTargets = appState.targets.filter(t => t.year === year);
        if (distributorIdFilter) {
            relevantTargets = relevantTargets.filter(t => t.distributorId === distributorIdFilter);
        }

        if (!relevantTargets.length) {
            return { rows: [], totalIncentive: 0, totalActual: 0 };
        }

        const groups = {};
        relevantTargets.forEach(t => {
            const stats = typeof getTargetActuals === 'function'
                ? getTargetActuals(t)
                : { totalTarget: 0, totalActual: 0, achievementPercentage: 0 };

            const variety = Array.isArray(appState.varieties)
                ? appState.varieties.find(v => v.id === t.varietyId)
                : null;
            const price = variety ? Number(variety.price || 0) : 0;

            // Kuantitas (pcs/kg) untuk simulasi ambang 80/90/101%
            let qtyTarget = 0;
            let qtyActual = 0;
            // Nilai nominal (Rp) untuk perhitungan insentif
            let nominalTarget = 0;
            let nominalActual = 0;

            if (t.unit === 'nominal') {
                nominalTarget = stats.totalTarget || 0;
                nominalActual = stats.totalActual || 0;
            } else {
                qtyTarget = stats.totalTarget || 0;
                qtyActual = stats.totalActual || 0;
                if (price > 0) {
                    nominalTarget = qtyTarget * price;
                    nominalActual = qtyActual * price;
                }
            }

            const key = t.distributorId;
            if (!groups[key]) {
                const dist = Array.isArray(appState.distributors)
                    ? appState.distributors.find(d => d.id === t.distributorId)
                    : null;
                groups[key] = {
                    distributor: dist,
                    totalNominalTarget: 0,
                    totalNominalActual: 0,
                    totalQtyTarget: 0,
                    totalQtyActual: 0
                };
            }
            groups[key].totalNominalTarget += nominalTarget;
            groups[key].totalNominalActual += nominalActual;
            groups[key].totalQtyTarget += qtyTarget;
            groups[key].totalQtyActual += qtyActual;
        });

        const rows = Object.values(groups).map(g => {
            const achievement = g.totalNominalTarget > 0
                ? (g.totalNominalActual / g.totalNominalTarget) * 100
                : 0;

            // Skema insentif simulasi (baru):
            // 80–89%  → 1%
            // 90–100% → 2%
            // >100%   → 4%
            let rate = 0;
            if (achievement > 100) {
                rate = 0.04;
            } else if (achievement >= 90) {
                rate = 0.02;
            } else if (achievement >= 80) {
                rate = 0.01;
            }

            const incentive = g.totalNominalActual * rate;

            // Hitung qty ambang 80%, 90%, 101% dari total target kuantitas
            const qty80 = g.totalQtyTarget * 0.80;
            const qty90 = g.totalQtyTarget * 0.90;
            const qty101 = g.totalQtyTarget * 1.01;

            return {
                distributorName: g.distributor ? g.distributor.name : 'Distributor dihapus',
                distributorId: g.distributor ? g.distributor.id : null,
                totalTargetNominal: g.totalNominalTarget,
                totalActualNominal: g.totalNominalActual,
                totalTargetQty: g.totalQtyTarget,
                totalActualQty: g.totalQtyActual,
                achievement,
                rate,
                incentive,
                qty80,
                qty90,
                qty101
            };
        }).sort((a, b) => (b.incentive || 0) - (a.incentive || 0));

        const totalIncentive = rows.reduce((s, r) => s + (r.incentive || 0), 0);
        const totalActualNominal = rows.reduce((s, r) => s + (r.totalActualNominal || 0), 0);

        return { rows, totalIncentive, totalActual: totalActualNominal };
    }







function getInsentifVarietyRows(year, distributorIdFilter = null) {
        if (!window.appState || !Array.isArray(appState.targets)) {
            return [];
        }

        // Ambil semua target di tahun fiskal tsb
        let relevantTargets = appState.targets.filter(t => t.year === year);
        if (distributorIdFilter) {
            relevantTargets = relevantTargets.filter(t => t.distributorId === distributorIdFilter);
        }
        if (!relevantTargets.length) return [];

        const groups = {};

        const toKg = (unit, totalVal, variety, price) => {
            if (!variety) return 0;
            const weight = Number(variety.weight || 0); // gram per pack
            const vUnit = variety.unit || 'pcs';
            const val = Number(totalVal || 0);

            // Jika target diset dalam KG langsung
            if (unit === 'kg') {
                return val;
            }

            // Jika target diset dalam PCS → konversi ke KG pakai bobot varietas
            if (unit === 'pcs') {
                if (!weight) return 0;
                return (val * weight) / 1000;
            }

            // Jika target diset dalam NOMINAL → balik ke qty dulu, baru ke KG
            if (unit === 'nominal' && price > 0) {
                const qtyUnit = val / price; // qty dalam "unit" varietas
                if (vUnit === 'kg') {
                    return qtyUnit; // sudah kg
                }
                if (vUnit === 'pcs' && weight) {
                    return (qtyUnit * weight) / 1000;
                }
            }

            return 0;
        };

        relevantTargets.forEach(t => {
            const stats = typeof getTargetActuals === 'function'
                ? getTargetActuals(t)
                : { totalTarget: 0, totalActual: 0, achievementPercentage: 0 };

            const variety = Array.isArray(appState.varieties)
                ? appState.varieties.find(v => v.id === t.varietyId)
                : null;
            const price = variety ? Number(variety.price || 0) : 0;

            // Harga per kg (berdasarkan harga di master varietas)
            const pricePerKg = (() => {
                if (!variety) return 0;
                const unit = variety.unit || 'pcs';
                const weight = Number(variety.weight || 0); // gram per pack
                if (unit === 'kg') {
                    return price;
                }
                if (unit === 'pcs' && weight > 0) {
                    const kgPerPack = weight / 1000;
                    return kgPerPack > 0 ? price / kgPerPack : 0;
                }
                return 0;
            })();

            let qtyTargetKg = toKg(t.unit, stats.totalTarget, variety, price);
            let qtyActualKg = toKg(t.unit, stats.totalActual, variety, price);

            // Nominal target & actual
            let nominalTarget = 0;
            let nominalActual = 0;

            if (t.unit === 'nominal') {
                nominalTarget = stats.totalTarget || 0;
                nominalActual = stats.totalActual || 0;
            } else if (pricePerKg > 0) {
                // Semua dikonversi ke kg, lalu kali harga per kg
                nominalTarget = qtyTargetKg * pricePerKg;
                nominalActual = qtyActualKg * pricePerKg;
            }

            const key = `${t.distributorId}__${t.varietyId}`;
            if (!groups[key]) {
                const dist = Array.isArray(appState.distributors)
                    ? appState.distributors.find(d => d.id === t.distributorId)
                    : null;
                groups[key] = {
                    distributor: dist,
                    variety,
                    totalNominalTarget: 0,
                    totalNominalActual: 0,
                    totalQtyKgTarget: 0,
                    totalQtyKgActual: 0,
                };
            }

            groups[key].totalNominalTarget += nominalTarget;
            groups[key].totalNominalActual += nominalActual;
            groups[key].totalQtyKgTarget += qtyTargetKg;
            groups[key].totalQtyKgActual += qtyActualKg;
        });

        const rows = Object.values(groups).map(g => {
            const achievement = g.totalNominalTarget > 0
                ? (g.totalNominalActual / g.totalNominalTarget) * 100
                : 0;

            // Skema baru:
            // 80–89%  → 1%
            // 90–100% → 2%
            // >100%   → 4%
            let rate = 0;
            if (achievement > 100) {
                rate = 0.04;
            } else if (achievement >= 90) {
                rate = 0.02;
            } else if (achievement >= 80) {
                rate = 0.01;
            }

            const incentive = g.totalNominalActual * rate;

            // Ambang qty dalam Kg untuk masing-masing level
            const qty80Kg = g.totalQtyKgTarget * 0.80;
            const qty90Kg = g.totalQtyKgTarget * 0.90;
            const qty101Kg = g.totalQtyKgTarget * 1.01; // minimal >100%

            // Simulasi nominal insentif pada masing-masing level
            const lvl80Nominal = g.totalNominalTarget * 0.80 * 0.01; // 1% dari 80% target nominal
            const lvl90Nominal = g.totalNominalTarget * 0.90 * 0.02; // 2% dari 90% target nominal
            const lvl101Nominal = g.totalNominalTarget * 1.01 * 0.04; // 4% dari 101% target nominal

            return {
                distributorName: g.distributor ? g.distributor.name : 'Distributor dihapus',
                distributorId: g.distributor ? g.distributor.id : null,
                varietyName: g.variety ? g.variety.name : 'Varietas dihapus',
                varietyId: g.variety ? g.variety.id : null,

                totalTargetNominal: g.totalNominalTarget,
                totalActualNominal: g.totalNominalActual,

                totalTargetKg: g.totalQtyKgTarget,
                totalActualKg: g.totalQtyKgActual,

                achievement,
                rate,
                incentive,
                qty80Kg,
                qty90Kg,
                qty101Kg,
                lvl80Nominal,
                lvl90Nominal,
                lvl101Nominal
            };
        }).sort((a, b) => (b.incentive || 0) - (a.incentive || 0));

        return rows;
    }






function renderInsentifTable(year) {
        const container = document.getElementById('insentif-content');
        if (!container) return;

        const distSelect = document.getElementById('insentif-distributor-filter');
        const distributorId = distSelect && distSelect.value ? parseInt(distSelect.value, 10) : null;

        const varietyRows = getInsentifVarietyRows(year, distributorId);

        if (!varietyRows.length) {
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-sm text-left text-gray-500">
                    Belum ada data insentif per varietas untuk kombinasi filter ini.
                    Pastikan sudah ada target dan (jika ingin realisasi) data release PO.
                </div>
            `;
            return;
        }

        const varietyTableHtml = `
            <div class="bg-white p-4 md:p-5 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-gray-800">Detail Insentif per Varietas (Kg)</h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs md:text-sm">
                        <thead>
                            <tr class="bg-gray-50 text-left">
                                <th class="px-3 py-2">Distributor</th>
                                <th class="px-3 py-2">Varietas</th>
                                <th class="px-3 py-2 text-right">Target Qty (Kg)</th>
                                <th class="px-3 py-2 text-right">Realisasi Qty (Kg)</th>
                                <th class="px-3 py-2 text-right">% Pencapaian</th>
                                <th class="px-3 py-2 text-right">Qty 80% (Kg, 1%)</th>
                                <th class="px-3 py-2 text-right">Qty 90% (Kg, 2%)</th>
                                <th class="px-3 py-2 text-right">Qty 101% (Kg, 4%)</th>
                                <th class="px-3 py-2 text-right">% Insentif</th>
                                <th class="px-3 py-2 text-right">Nilai Insentif (Rp)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${varietyRows.map((r, idx) => `
                                <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="px-3 py-2">${r.distributorName}</td>
                                    <td class="px-3 py-2">${r.varietyName}</td>
                                    <td class="px-3 py-2 text-right">
                                        ${(r.totalTargetKg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 })}
                                    </td>
                                    <td class="px-3 py-2 text-right">
                                        ${(r.totalActualKg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 })}
                                    </td>
                                    <td class="px-3 py-2 text-right">
                                        ${r.achievement.toFixed(2)} %
                                    </td>
                                    <td class="px-3 py-2 text-right">
                                        ${(r.qty80Kg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 })}
                                        <span class="block text-[10px] text-emerald-700 font-semibold italic">
                                            ≈ ${typeof formatRupiah === 'function'
                                                ? formatRupiah(r.lvl80Nominal || 0)
                                                : (r.lvl80Nominal || 0).toLocaleString('id-ID')}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-right">
                                        ${(r.qty90Kg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 })}
                                        <span class="block text-[10px] text-emerald-700 font-semibold italic">
                                            ≈ ${typeof formatRupiah === 'function'
                                                ? formatRupiah(r.lvl90Nominal || 0)
                                                : (r.lvl90Nominal || 0).toLocaleString('id-ID')}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-right">
                                        ${(r.qty101Kg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 })}
                                        <span class="block text-[10px] text-emerald-700 font-semibold italic">
                                            ≈ ${typeof formatRupiah === 'function'
                                                ? formatRupiah(r.lvl101Nominal || 0)
                                                : (r.lvl101Nominal || 0).toLocaleString('id-ID')}
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-right">
                                        ${(r.rate * 100).toFixed(2)} %
                                    </td>
                                    <td class="px-3 py-2 text-right font-semibold">
                                        ${typeof formatRupiah === 'function'
                                            ? formatRupiah(r.incentive || 0)
                                            : (r.incentive || 0).toLocaleString('id-ID')}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <p class="mt-4 text-xs text-gray-500">
                    Skema simulasi insentif per varietas:
                    80–89% pencapaian → insentif 1% (kolom Qty 80%);
                    90–100% → insentif 2% (kolom Qty 90%);
                    >100% → insentif 4% (kolom Qty 101%).
                    Angka kecil di bawah Qty adalah simulasi nilai insentif (Rp) jika level tersebut tercapai.
                </p>
            </div>
        `;

        container.innerHTML = varietyTableHtml;
    }




function initInsentifPage() {
        ensureInsentifPage();

        const yearSelect = document.getElementById('insentif-year-filter');
        const distSelect = document.getElementById('insentif-distributor-filter');
        const content = document.getElementById('insentif-content');
        if (!yearSelect || !distSelect || !content) return;

        const years = getInsentifFiscalYears();
        const distributors = Array.isArray(appState.distributors) ? appState.distributors.slice() : [];

        const now = new Date();
        const defaultFiscalYear = typeof getFiscalYear === 'function'
            ? getFiscalYear(now)
            : now.getFullYear();

        // Isi dropdown tahun fiskal (kalau belum ada target sama sekali, pakai tahun berjalan)
        const yearOptions = years.length ? years : [defaultFiscalYear];
        yearSelect.innerHTML = yearOptions
            .map(y => `<option value="${y}" ${y === defaultFiscalYear ? 'selected' : ''}>${y}/${y + 1}</option>`)
            .join('');

        // Isi dropdown distributor (kalau belum ada distributor, tampilkan 1 opsi info)
        if (distributors.length) {
            distSelect.innerHTML = [
                `<option value="">Semua Distributor</option>`,
                ...distributors
                    .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
                    .map(d => `<option value="${d.id}">${d.name}</option>`)
            ].join('');
        } else {
            distSelect.innerHTML = `<option value="">Belum ada distributor</option>`;
        }

        if (!yearSelect.dataset.bound) {
            yearSelect.addEventListener('change', () => {
                const selectedYear = parseInt(yearSelect.value, 10);
                renderInsentifTable(selectedYear);
            });
            yearSelect.dataset.bound = '1';
        }

        if (!distSelect.dataset.bound) {
            distSelect.addEventListener('change', () => {
                const selectedYear = parseInt(yearSelect.value, 10);
                renderInsentifTable(selectedYear);
            });
            distSelect.dataset.bound = '1';
        }

        const initialYear = parseInt(yearSelect.value || defaultFiscalYear, 10);
        renderInsentifTable(initialYear);
    }

    
function exportInsentifToCSV() {
        const yearSelect = document.getElementById('insentif-year-filter');
        const distSelect = document.getElementById('insentif-distributor-filter');

        if (!yearSelect || !yearSelect.value) {
            if (typeof showToast === 'function') showToast('Pilih tahun fiskal terlebih dahulu.', 'info');
            return;
        }

        const year = parseInt(yearSelect.value, 10);
        const distributorId = distSelect && distSelect.value && distSelect.value !== '' ? parseInt(distSelect.value, 10) : null;

        const { rows, totalIncentive, totalActual } = getInsentifSummary(year, distributorId);
        if (!rows.length) {
            if (typeof showToast === 'function') showToast('Tidak ada data insentif untuk filter ini.', 'info');
            return;
        }

        let csv = "data:text/csv;charset=utf-8,";
        csv += "Distributor,Tahun Fiskal,Target Nominal,Realisasi Nominal,Pencapaian (%),Qty 80% (1%),Qty 90% (2%),Qty 101% (4%),Persentase Insentif (%),Nilai Insentif\n";

        rows.forEach(r => {
            csv += [
                `"${r.distributorName}"`,
                `"${year}/${year + 1}"`,
                Math.round(r.totalTargetNominal || 0),
                Math.round(r.totalActualNominal || 0),
                r.achievement.toFixed(2),
                r.totalTargetQty ? Math.round(r.qty80 || 0) : 0,
                r.totalTargetQty ? Math.round(r.qty90 || 0) : 0,
                r.totalTargetQty ? Math.round(r.qty101 || 0) : 0,
                (r.rate * 100).toFixed(2),
                (r.incentive || 0).toFixed(0)
            ].join(',') + "\n";
        });

        const avgRate = totalActual > 0 ? (totalIncentive / totalActual) * 100 : 0;
        csv += `,"TOTAL",,,${avgRate.toFixed(2)},,,,${(totalIncentive || 0).toFixed(0)}\n`;

        const uri = encodeURI(csv);
        const link = document.createElement('a');
        link.setAttribute('href', uri);
        link.setAttribute('download', `Insentif_Distributor_${year}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        if (typeof showToast === 'function') showToast('CSV Insentif berhasil di-generate!', 'success');
    }

// --- LAPORAN ---
    function setupLaporanPage() {
        document.getElementById('laporan-type').innerHTML = `<option value="monthly">Laporan Rincian Bulanan</option><option value="pivot_yearly">Laporan Pivot Tahunan</option>`;
        document.getElementById('laporan-unit').innerHTML = `<option value="pcs">Qty (Pcs)</option><option value="kg">Qty (Kg)</option><option value="nominal">Nominal (Rp)</option>`;
        document.getElementById('laporan-month').innerHTML = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'].map((name, i) => `<option value="${i}">${name}</option>`).join('');
        document.getElementById('laporan-month').value = new Date().getMonth();
        const currentFiscalYear = getFiscalYear(new Date());
        document.getElementById('laporan-year').innerHTML = Array.from({length: 5}, (_, i) => `<option value="${currentFiscalYear - i}">${currentFiscalYear - i}/${currentFiscalYear - i + 1}</option>`).join('');
        const monthSelector = document.getElementById('laporan-month-selector-div');
        const typeSelector = document.getElementById('laporan-type');
        const toggleMonth = () => { monthSelector.style.display = typeSelector.value === 'monthly' ? 'block' : 'none'; };
        typeSelector.addEventListener('change', toggleMonth);
        toggleMonth();

        document.getElementById('laporan-content').innerHTML = `<p class="text-gray-500">Pilih jenis laporan dan periode, lalu klik "Tampilkan Laporan". Laporan didasarkan pada tanggal rilis.</p>`;
        laporanData = null;
    }
    
    function generateLaporan() {
        if (document.getElementById('laporan-type').value === 'monthly') generateMonthlyDetailReport();
        else generateYearlyPivotReport();
    }

    // **UPDATED**: Generates report based on release dates within the selected month.
    function generateMonthlyDetailReport() {
        const fiscalYearStart = parseInt(document.getElementById('laporan-year').value);
        const month = parseInt(document.getElementById('laporan-month').value);
        const calendarYear = month >= 3 ? fiscalYearStart : fiscalYearStart + 1;
        const unit = document.getElementById('laporan-unit').value;
        const container = document.getElementById('laporan-content');
        container.innerHTML = ''; laporanData = null;

        const periodItems = appState.purchaseOrders.flatMap(po => {
            const distributorName = appState.distributors.find(d => d.id == po.distributorId)?.name || 'N/A';
            return po.items.flatMap(item =>
                (item.releases || []).filter(release => {
                    const releaseDate = new Date(release.date);
                    return releaseDate.getFullYear() === calendarYear && releaseDate.getMonth() === month;
                }).map(release => {
                    let displayQty = (unit === 'kg') ? (release.qty * (item.weight || 0)) / 1000 : ((unit === 'pcs') ? release.qty : release.qty * (item.price || 0));
                    return {
                        ...item,
                        distributorName,
                        releaseDate: new Date(release.date),
                        releasedQty: release.qty, // Note: this is the qty of a single release event
                        displayQty
                    };
                })
            );
        });
        
        if (periodItems.length === 0) { container.innerHTML = `<div class="p-4 border rounded-md text-left text-gray-500">Tidak ada data penjualan pada periode yang dipilih.</div>`; return; }
        
        const fiscalMonthIndex = month >= 3 ? month - 3 : month + 9;
        const totalValue = periodItems.reduce((sum, item) => sum + (item.releasedQty * (item.price || 0)), 0);
        const totalTarget = appState.targets.filter(t => t.year === fiscalYearStart && t.unit === 'nominal').reduce((sum, t) => sum + t.monthlyTargets[fiscalMonthIndex], 0);
        const unitLabel = unit === 'kg' ? 'Kg' : (unit === 'pcs' ? 'Pcs' : 'Nominal');
        const totalQty = periodItems.reduce((sum, item) => sum + item.displayQty, 0);
        const title = `Laporan Rincian Penjualan - ${document.getElementById('laporan-month').options[month].text} ${calendarYear}`;
        
        const summaryHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg"><h4 class="text-sm font-semibold text-blue-800">Total Penjualan Aktual</h4><p class="text-2xl font-bold text-blue-900">${formatRupiah(totalValue)}</p></div>
                 <div class="bg-gray-50 p-4 rounded-lg"><h4 class="text-sm font-semibold text-gray-800">Total Target Penjualan</h4><p class="text-2xl font-bold text-gray-900">${formatRupiah(totalTarget)}</p></div>
                <div class="bg-green-50 p-4 rounded-lg"><h4 class="text-sm font-semibold text-green-800">Total Kuantitas (${unitLabel})</h4><p class="text-2xl font-bold text-green-900">${unit === 'nominal' ? formatRupiah(totalQty) : totalQty.toLocaleString('id-ID', {minimumFractionDigits: unit === 'kg' ? 2 : 0})}</p></div>
            </div>`;

        const qtyHeader = unit === 'nominal' ? `Nilai (Rp)` : `Qty (${unitLabel})`;
        container.innerHTML = `<div class="mb-6 flex justify-between items-start"><h4 class="text-lg font-bold">${title}</h4><div class="flex gap-2"><button onclick="exportLaporanToPDF()" class="px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">Export PDF</button><button onclick="exportLaporanToCSV()" class="px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">Export CSV</button></div></div>${summaryHtml}<div class="overflow-x-auto"><table class="min-w-full bg-white text-sm"><thead><tr class="bg-gray-50"><th class="py-2 px-3 text-left">Tgl Rilis</th><th class="py-2 px-3 text-left">Distributor</th><th class="py-2 px-3 text-left">Varietas</th><th class="py-2 px-3 text-right">${qtyHeader}</th><th class="py-2 px-3 text-right">Harga Satuan</th><th class="py-2 px-3 text-right">Total</th></tr></thead><tbody>${periodItems.map(item => `<tr><td class="py-2 px-3 border-b">${formatDate(item.releaseDate)}</td><td class="py-2 px-3 border-b">${item.distributorName}</td><td class="py-2 px-3 border-b">${item.name}</td><td class="py-2 px-3 border-b text-right">${unit === 'nominal' ? formatRupiah(item.displayQty) : item.displayQty.toLocaleString('id-ID', {minimumFractionDigits: unit === 'kg' ? 2 : 0})}</td><td class="py-2 px-3 border-b text-right">${formatRupiah(item.price)}</td><td class="py-2 px-3 border-b text-right">${formatRupiah(item.releasedQty * (item.price || 0))}</td></tr>`).join('')}</tbody><tfoot class="bg-gray-100 font-bold"><tr><td colspan="5" class="py-2 px-3 text-right">Grand Total</td><td class="py-2 px-3 text-right">${formatRupiah(totalValue)}</td></tr></tfoot></table></div>`;
        laporanData = { type: 'monthly', title, periodItems, unit, summary: {totalValue, totalTarget, totalQty} };
    }

    // **UPDATED**: Pivots data based on release dates and shows all varieties.
    function generateYearlyPivotReport() {
        const year = parseInt(document.getElementById('laporan-year').value);
        const unit = document.getElementById('laporan-unit').value;
        const container = document.getElementById('laporan-content');
        container.innerHTML = ''; laporanData = null;
        
        const pivotData = { actual: {}, target: {} };
        const monthTotals = { actual: Array(12).fill(0), target: Array(12).fill(0) };
        let totalActualValue = 0;

        // Loop through each release event to build the actual sales data.
        appState.purchaseOrders.forEach(po => {
            const distName = appState.distributors.find(d => d.id == po.distributorId)?.name || 'N/A';
            po.items.forEach(item => {
                (item.releases || []).forEach(release => {
                    const releaseDate = new Date(release.date);
                    if (getFiscalYear(releaseDate) !== year) return;

                    if (!pivotData.actual[distName]) pivotData.actual[distName] = { varieties: {} };
                    totalActualValue += release.qty * (item.price || 0);
                    let qty = (unit === 'kg') ? (release.qty * (item.weight || 0)) / 1000 : ((unit === 'pcs') ? release.qty : release.qty * (item.price || 0));
                    
                    if (!pivotData.actual[distName].varieties[item.name]) pivotData.actual[distName].varieties[item.name] = { monthly: Array(12).fill(0), total: 0 };
                    
                    const fiscalMonthIndex = releaseDate.getMonth() >= 3 ? releaseDate.getMonth() - 3 : releaseDate.getMonth() + 9;
                    pivotData.actual[distName].varieties[item.name].monthly[fiscalMonthIndex] += qty;
                    pivotData.actual[distName].varieties[item.name].total += qty;
                    monthTotals.actual[fiscalMonthIndex] += qty;
                });
            });
        });
        
        const totalTargetValue = appState.targets.filter(t => t.year === year && t.unit === 'nominal').reduce((sum, t) => sum + t.monthlyTargets.reduce((a, b) => a + b, 0), 0);
        appState.targets.forEach(t => {
            if (t.year !== year || t.unit !== unit) return;
            const distName = appState.distributors.find(d => d.id === t.distributorId)?.name || 'N/A';
            const varName = appState.varieties.find(v => v.id === t.varietyId)?.name || 'N/A';
            if (!pivotData.target[distName]) pivotData.target[distName] = { varieties: {} };
            pivotData.target[distName].varieties[varName] = { monthly: t.monthlyTargets, total: t.monthlyTargets.reduce((a,b) => a+b, 0) };
            t.monthlyTargets.forEach((val, i) => monthTotals.target[i] += val);
        });

        if (Object.keys(pivotData.actual).length === 0 && Object.keys(pivotData.target).length === 0) { container.innerHTML = `<div class="p-4 border rounded-md text-left text-gray-500">Tidak ada data penjualan atau target pada tahun fiskal ${year}/${year+1}.</div>`; return; }
        
        const unitLabel = unit === 'kg' ? 'Kg' : (unit === 'pcs' ? 'Pcs' : 'Rp');
        const monthHeaders = [`Apr '${String(year).slice(2)}'`, `Mei '${String(year).slice(2)}'`, `Jun '${String(year).slice(2)}'`, `Jul '${String(year).slice(2)}'`, `Agu '${String(year).slice(2)}'`, `Sep '${String(year).slice(2)}'`, `Okt '${String(year).slice(2)}'`, `Nov '${String(year).slice(2)}'`, `Des '${String(year).slice(2)}'`, `Jan '${String(year+1).slice(2)}'`, `Feb '${String(year+1).slice(2)}'`, `Mar '${String(year+1).slice(2)}'`];
        const summaryHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div class="bg-blue-50 p-4 rounded-lg"><h4 class="text-sm font-semibold text-blue-800">Total Penjualan Aktual (Nominal)</h4><p class="text-2xl font-bold text-blue-900">${formatRupiah(totalActualValue)}</p></div><div class="bg-gray-50 p-4 rounded-lg"><h4 class="text-sm font-semibold text-gray-800">Total Target Penjualan (Nominal)</h4><p class="text-2xl font-bold text-gray-900">${formatRupiah(totalTargetValue)}</p></div></div>`;

        let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full bg-white text-xs border"><thead class="bg-gray-100"><tr><th class="py-2 px-2 border text-left">Distributor / Varietas</th><th class="py-2 px-2 border text-left">Data</th>${monthHeaders.map(h => `<th class="py-2 px-2 border">${h}</th>`).join('')}<th class="py-2 px-2 border bg-gray-200">Grand Total</th></tr></thead><tbody>`;
        const formatCell = val => (val === null || val === undefined) ? '-' : (val === 0 ? '-' : (unit === 'nominal' ? formatRupiah(val, false) : val.toLocaleString('id-ID', {minimumFractionDigits: unit === 'kg' ? 2 : 0})));
        
        const allDistributors = [...new Set([...Object.keys(pivotData.actual), ...Object.keys(pivotData.target)])].sort();
        const allVarietyNamesFromState = appState.varieties.map(v => v.name);

        allDistributors.forEach(distName => {
            tableHtml += `<tr><td colspan="15" class="py-1 px-2 border bg-gray-50 font-bold">${distName}</td></tr>`;
            
            const varietiesForDistributor = [...new Set([
                ...allVarietyNamesFromState,
                ...Object.keys(pivotData.actual[distName]?.varieties || {}),
                ...Object.keys(pivotData.target[distName]?.varieties || {})
            ])].sort();

            varietiesForDistributor.forEach(varName => {
                const actualData = pivotData.actual[distName]?.varieties[varName];
                const targetData = pivotData.target[distName]?.varieties[varName];

                // Render Actual Row
                const actualRowContent = actualData
                    ? actualData.monthly.map(qty => `<td class="py-1 px-2 border text-right">${formatCell(qty)}</td>`).join('') + `<td class="py-1 px-2 border text-right font-bold bg-gray-50">${formatCell(actualData.total)}</td>`
                    : Array(12).fill('<td class="py-1 px-2 border text-right">-</td>').join('') + '<td class="py-1 px-2 border text-right font-bold bg-gray-50">-</td>';
                tableHtml += `<tr><td class="py-1 px-2 border pl-6" rowspan="2">${varName}</td><td class="py-1 px-2 border">Aktual</td>${actualRowContent}</tr>`;

                // Render Target Row
                const targetRowContent = targetData
                    ? targetData.monthly.map(qty => `<td class="py-1 px-2 border text-right bg-blue-50 text-blue-700">${formatCell(qty)}</td>`).join('') + `<td class="py-1 px-2 border text-right font-bold bg-blue-100 text-blue-800">${formatCell(targetData.total)}</td>`
                    : Array(12).fill('<td class="py-1 px-2 border text-right bg-blue-50 text-blue-700">-</td>').join('') + '<td class="py-1 px-2 border text-right font-bold bg-blue-100 text-blue-800">-</td>';
                tableHtml += `<tr><td class="py-1 px-2 border bg-blue-50 text-blue-700">Target</td>${targetRowContent}</tr>`;
            });
        });
        
        tableHtml += `<tr class="bg-gray-200 font-bold"><td class="py-2 px-2 border" rowspan="2">Grand Total</td><td class="py-2 px-2 border">Aktual</td>${monthTotals.actual.map(total => `<td class="py-2 px-2 border text-right">${formatCell(total)}</td>`).join('')}<td class="py-2 px-2 border text-right">${formatCell(monthTotals.actual.reduce((a, b) => a + b, 0))}</td></tr><tr class="bg-blue-200 font-bold text-blue-800"><td class="py-2 px-2 border">Target</td>${monthTotals.target.map(total => `<td class="py-2 px-2 border text-right">${formatCell(total)}</td>`).join('')}<td class="py-2 px-2 border text-right">${formatCell(monthTotals.target.reduce((a, b) => a + b, 0))}</td></tr></tbody></table></div>`;
        const title = `Laporan Pivot Penjualan (${unit === 'nominal' ? 'Nominal' : unitLabel}) - Tahun Fiskal ${year}/${year+1}`;
        container.innerHTML = `<div class="mb-6 flex justify-between items-start"><h4 class="text-lg font-bold">${title}</h4><div class="flex gap-2"><button onclick="exportLaporanToPDF()" class="px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">Export PDF</button><button onclick="exportLaporanToCSV()" class="px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">Export CSV</button></div></div>${summaryHtml}${tableHtml}`;
        laporanData = { type: 'pivot_yearly', title, pivotData, unit, monthTotals, summary: { totalActualValue, totalTargetValue } };
    }


    // --- PDF & CSV EXPORT ---
    function exportPOtoPDF(poId) {
        const po = appState.purchaseOrders.find(p => p.id === poId);
        if (!po) { showToast('PO tidak ditemukan.', 'error'); return; }
        const distributor = appState.distributors.find(d => d.id == po.distributorId);
        if (!distributor) { showToast('Distributor untuk PO ini tidak ditemukan.', 'error'); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 40;
        let y = 0;

        // --- Header ---
        if (distributor.logo) {
            try {
                const img = new Image();
                img.src = distributor.logo;
                const imgProps = doc.getImageProperties(img);
                const aspectRatio = imgProps.width / imgProps.height;
                const logoHeight = 40;
                const logoWidth = logoHeight * aspectRatio;
                doc.addImage(distributor.logo, 'PNG', margin, margin, logoWidth, logoHeight);
            } catch (e) {
                console.error("Gagal memuat logo untuk PDF:", e);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(distributor.name, margin, margin + 15);
            }
        } else {
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(distributor.name, margin, margin + 15);
        }
        
        doc.setFontSize(22);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(40, 58, 128);
        doc.text('PURCHASE ORDER', pageWidth - margin, margin + 20, { align: 'right' });
        doc.setTextColor(0, 0, 0);
        y = margin + 60;
        doc.setLineWidth(1.5);
        doc.line(margin, y, pageWidth - margin, y);
        y += 25;

        // --- Recipient Info ---
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.text('KEPADA (TO)', margin, y);
        doc.text('KIRIM KE (SHIP TO)', pageWidth / 2, y);
        
        y += 12;
        doc.setFont('helvetica', 'normal');
        doc.text('PT. ADVANTA SEEDS INDONESIA', margin, y);
        doc.text(distributor.name, pageWidth / 2, y);

        const addressLines = doc.splitTextToSize(distributor.address, (pageWidth / 2) - margin - 5);
        y += 12;
        doc.text(addressLines, pageWidth / 2, y);
        
        y = Math.max(y + (addressLines.length * 10), 170);

        // --- PO Details Table ---
        doc.autoTable({
            startY: y,
            body: [
                [{content: 'NO. PO', styles: {fontStyle: 'bold'}}, po.poNumber],
                [{content: 'TANGGAL', styles: {fontStyle: 'bold'}}, formatDate(po.poDate)],
            ],
            theme: 'plain',
            styles: { fontSize: 9 },
            columnStyles: { 0: { cellWidth: 80 } },
            tableWidth: (pageWidth / 2) - margin,
        });
        
        y = doc.autoTable.previous.finalY + 20;

        // --- Items Table ---
        const tableBody = po.items.map((item, index) => [
            index + 1,
            item.name,
            item.qty.toLocaleString('id-ID'),
            formatRupiah(item.price, false),
            formatRupiah(item.amount, false)
        ]);

        const grandTotal = "Rp " + formatRupiah(po.totalAmount, false);

        doc.autoTable({
            startY: y,
            head: [['NO', 'ITEM DESCRIPTION', 'QTY', 'UNIT PRICE', 'TOTAL']],
            body: tableBody,
            foot: [[
                { 
                    content: 'GRAND TOTAL', 
                    colSpan: 4, 
                    styles: { halign: 'right', fontStyle: 'bold', textColor: [40, 58, 128] } 
                }, 
                { 
                    content: grandTotal, 
                    styles: { halign: 'right', fontStyle: 'bold', textColor: [40, 58, 128] } 
                }
            ]],
            theme: 'striped',
            headStyles: { 
                fillColor: [40, 58, 128],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            footStyles: {
                fillColor: [220, 220, 220]
            },
            styles: { fontSize: 9, cellPadding: 6 },
            columnStyles: {
                0: { halign: 'center', cellWidth: 30 },
                2: { halign: 'right', cellWidth: 50 },
                3: { halign: 'right', cellWidth: 80 },
                4: { halign: 'right', cellWidth: 90 },
            }
        });

        y = doc.autoTable.previous.finalY + 15;

        // --- Notes & Signature ---
        let contentEndY = y;
        if (po.notes) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Catatan:', margin, contentEndY);
            contentEndY += 12;
            doc.setFont('helvetica', 'normal');
            const noteLines = doc.splitTextToSize(po.notes, (pageWidth / 2) - margin);
            doc.text(noteLines, margin, contentEndY);
            contentEndY += (noteLines.length * 10);
        }

        let signatureY = contentEndY + 40; // Increased space after notes for signature

        if (signatureY > pageHeight - 100) {
             doc.addPage();
             signatureY = margin;
        }

        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text('Hormat kami,', margin, signatureY);
        signatureY += 60; 
        doc.setLineWidth(0.5);
        doc.line(margin, signatureY, margin + 180, signatureY);
        doc.text(distributor.name, margin, signatureY - 5);
        
        // --- Footer ---
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.text(`Halaman ${i}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
        }


        doc.save(`PO_${po.poNumber}_${distributor.name}.pdf`);
        showToast("PDF berhasil di-generate!", "success");
    }

    function exportLaporanToPDF() {
        if (!laporanData) { showToast('Silakan generate laporan terlebih dahulu.', 'info'); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); // Landscape for reports
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text(laporanData.title, 40, 40);

        if (laporanData.type === 'monthly') {
            const head = [['Tgl Rilis', 'Distributor', 'Varietas', `Qty (${laporanData.unit})`, 'Harga', 'Total']];
            const body = laporanData.periodItems.map(item => [
                formatDate(item.releaseDate),
                item.distributorName,
                item.name,
                laporanData.unit === 'nominal' ? formatRupiah(item.displayQty) : item.displayQty.toLocaleString('id-ID', {minimumFractionDigits: laporanData.unit === 'kg' ? 2 : 0}),
                formatRupiah(item.price),
                formatRupiah(item.releasedQty * (item.price || 0))
            ]);
            body.push([{ content: 'Grand Total', colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatRupiah(laporanData.summary.totalValue), styles: { fontStyle: 'bold' } }]);
            doc.autoTable({ head, body, startY: 60 });
        } else if (laporanData.type === 'pivot_yearly') {
            const year = parseInt(laporanData.title.match(/(\d{4})\/\d{4}/)[1]);
            const monthHeaders = [`Apr '${String(year).slice(2)}'`, 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', `Jan '${String(year+1).slice(2)}'`, 'Feb', 'Mar'];
            const head = [['Distributor/Varietas', 'Data', ...monthHeaders, 'Grand Total']];
            const body = [];
            const formatCell = val => (val === 0 || !val) ? '-' : (laporanData.unit === 'nominal' ? formatRupiah(val) : val.toLocaleString('id-ID', {minimumFractionDigits: laporanData.unit === 'kg' ? 2 : 0}));

            const allDistributors = [...new Set([...Object.keys(laporanData.pivotData.actual), ...Object.keys(laporanData.pivotData.target)])].sort();
            allDistributors.forEach(distName => {
                body.push([{ content: distName, colSpan: 15, styles: { fontStyle: 'bold', fillColor: [230, 230, 230] } }]);
                const allVarieties = [...new Set([...Object.keys(laporanData.pivotData.actual[distName]?.varieties || {}), ...Object.keys(laporanData.pivotData.target[distName]?.varieties || {})])].sort();
                allVarieties.forEach(varName => {
                    const actual = laporanData.pivotData.actual[distName]?.varieties[varName];
                    const target = laporanData.pivotData.target[distName]?.varieties[varName];
                    if (actual) body.push([`  ${varName}`, 'Aktual', ...actual.monthly.map(formatCell), formatCell(actual.total)]);
                    if (target) body.push([!actual ? `  ${varName}` : '', 'Target', ...target.monthly.map(formatCell), formatCell(target.total)]);
                });
            });
            body.push([{ content: 'Grand Total', colSpan: 15, styles: { fontStyle: 'bold', fillColor: [200, 200, 200] } }]);
            body.push(['', 'Aktual', ...laporanData.monthTotals.actual.map(formatCell), formatCell(laporanData.monthTotals.actual.reduce((a,b)=>a+b,0))]);
            body.push(['', 'Target', ...laporanData.monthTotals.target.map(formatCell), formatCell(laporanData.monthTotals.target.reduce((a,b)=>a+b,0))]);

            doc.autoTable({ head, body, startY: 60, theme: 'grid' });
        }

        doc.save(`Laporan_${laporanData.title.replace(/ /g, '_')}.pdf`);
        showToast("PDF Laporan berhasil di-generate!", "success");
    }

    function exportLaporanToCSV() {
        if (!laporanData) { showToast('Silakan generate laporan terlebih dahulu.', 'info'); return; }
        let csvContent = "data:text/csv;charset=utf-8,";
        
        if (laporanData.type === 'monthly') {
            csvContent += `Tgl Rilis,Distributor,Varietas,Qty (${laporanData.unit}),Harga,Total\n`;
            laporanData.periodItems.forEach(item => {
                const row = [
                    formatDate(item.releaseDate),
                    `"${item.distributorName}"`,
                    `"${item.name}"`,
                    item.displayQty,
                    item.price,
                    item.releasedQty * (item.price || 0)
                ].join(',');
                csvContent += row + "\n";
            });
        } else if (laporanData.type === 'pivot_yearly') {
            const year = parseInt(laporanData.title.match(/(\d{4})\/\d{4}/)[1]);
            const monthHeaders = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];
            csvContent += `Distributor,Varietas,Data Type,${monthHeaders.join(',')},Total\n`;
            const allDistributors = [...new Set([...Object.keys(laporanData.pivotData.actual), ...Object.keys(laporanData.target)])].sort();
            allDistributors.forEach(distName => {
                const allVarieties = [...new Set([...Object.keys(laporanData.pivotData.actual[distName]?.varieties || {}), ...Object.keys(laporanData.pivotData.target[distName]?.varieties || {})])].sort();
                allVarieties.forEach(varName => {
                    const actual = laporanData.pivotData.actual[distName]?.varieties[varName];
                    const target = laporanData.pivotData.target[distName]?.varieties[varName];
                    if (actual) csvContent += [`"${distName}"`, `"${varName}"`, 'Aktual', ...actual.monthly, actual.total].join(',') + '\n';
                    if (target) csvContent += [`"${distName}"`, `"${varName}"`, 'Target', ...target.monthly, target.total].join(',') + '\n';
                });
            });
        }
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        const today = new Date();
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Laporan_${laporanData.title.replace(/ /g, '_')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("CSV Laporan berhasil di-generate!", "success");
    }

    
function exportTargetToPDF() {
        if (!appState.targets || appState.targets.length === 0) {
            showToast('Tidak ada data target untuk diekspor.', 'info');
            return;
        }

        // Baca filter yang sedang aktif di halaman Target
        const yearFilterEl = document.getElementById('target-year-filter');
        const distFilterEl = document.getElementById('target-distributor-filter');

        const selectedYear = yearFilterEl && yearFilterEl.value && yearFilterEl.value !== 'all'
            ? parseInt(yearFilterEl.value, 10)
            : null;

        const selectedDistributor = distFilterEl && distFilterEl.value && distFilterEl.value !== 'all'
            ? distFilterEl.value
            : null;

        // Filter data target sesuai filter UI
        let filteredTargets = Array.isArray(appState.targets) ? [...appState.targets] : [];

        if (selectedYear !== null && !Number.isNaN(selectedYear)) {
            filteredTargets = filteredTargets.filter(t => t.year === selectedYear);
        }

        if (selectedDistributor) {
            filteredTargets = filteredTargets.filter(t => String(t.distributorId) === String(selectedDistributor));
        }

        if (!filteredTargets.length) {
            showToast('Tidak ada data target sesuai filter untuk diekspor.', 'info');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); // Landscape
        const today = new Date();

        // Kelompokkan per Tahun Fiskal
        const groupedByYear = filteredTargets.reduce((acc, t) => {
            const key = t.year;
            if (!acc[key]) acc[key] = [];
            acc[key].push(t);
            return acc;
        }, {});

        const fiscalYears = Object.keys(groupedByYear)
            .map(y => parseInt(y, 10))
            .sort((a, b) => b - a); // terbaru di awal

        let isFirstPage = true;

        fiscalYears.forEach((fy) => {
            const targetsOfYear = groupedByYear[fy];

            // Tambah halaman baru untuk fiscal berikutnya
            if (!isFirstPage) {
                doc.addPage();
            }
            isFirstPage = false;

            // Header halaman
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Laporan Progres Target Penjualan', 40, 40);

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(`Tahun Fiskal: ${fy}/${fy + 1}`, 40, 58);

            doc.setFontSize(10);
            doc.text(`Diekspor pada: ${formatDate(today.toISOString())}`, 40, 74);

            const head = [['Distributor', 'Varietas', 'Satuan', 'Total Target', 'Total Realisasi', 'Pencapaian (%)']];

            const body = targetsOfYear.map(target => {
                const distributor =
                    appState.distributors.find(d => d.id === target.distributorId)?.name || 'N/A';
                const variety =
                    appState.varieties.find(v => v.id === target.varietyId)?.name || 'N/A';

                const { totalTarget, totalActual, achievementPercentage } = getTargetActuals(target);

                const formatValue = (value, unit) => {
                    if (unit === 'nominal') return formatRupiah(value);
                    if (unit === 'kg')
                        return value.toLocaleString('id-ID', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    return value.toLocaleString('id-ID');
                };

                return [
                    distributor,
                    variety,
                    (target.unit || '').toUpperCase(),
                    formatValue(totalTarget, target.unit),
                    formatValue(totalActual, target.unit),
                    `${(achievementPercentage || 0).toFixed(1)} %`
                ];
            });

            doc.autoTable({
                head,
                body,
                startY: 90,
                theme: 'grid',
                headStyles: { fillColor: [40, 58, 128] },
                styles: { fontSize: 8 },
                columnStyles: {
                    3: { halign: 'right' },
                    4: { halign: 'right' },
                    5: { halign: 'right' },
                }
            });
        });

        doc.save(`Laporan_Target_Penjualan_${formatDate(today.toISOString())}.pdf`);
        showToast("PDF Laporan Target (per fiscal) berhasil di-generate!", "success");
    }


function exportTargetToCSV() {
        if (!appState.targets || appState.targets.length === 0) {
            showToast('Tidak ada data target untuk diekspor.', 'info');
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Distributor,Tahun Fiskal,Varietas,Satuan,Total Target,Total Realisasi,Pencapaian (%)\n";

        appState.targets.forEach(target => {
            const distributor = appState.distributors.find(d => d.id === target.distributorId)?.name || 'N/A';
            const variety = appState.varieties.find(v => v.id === target.varietyId)?.name || 'N/A';
            const { totalTarget, totalActual, achievementPercentage } = getTargetActuals(target);

            const row = [
                `"${distributor}"`,
                `"${target.year}/${target.year + 1}"`,
                `"${variety}"`,
                target.unit.toUpperCase(),
                totalTarget,
                totalActual,
                achievementPercentage.toFixed(2)
            ].join(',');
            csvContent += row + "\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        const today = new Date();
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Laporan_Target_Penjualan_${formatDate(today.toISOString())}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("CSV Laporan Target berhasil di-generate!", "success");
    }

</script>

<!-- Auto-fit numeric stat values: scale font-size down until fits one line, with debounced resize -->
<style>
/* Ensure elements measured behave predictably */
#dashboard-stats .stat-value,
#dashboard-stats p,
#dashboard-stats .value,
#dashboard-stats .stat-number {
  white-space: nowrap !important;
  overflow: visible !important;
  display: inline-block !important;
  line-height: 1 !important;
  transition: font-size 120ms linear;
}
</style>
<script>
(function(){
  const selectors = ['#dashboard-stats .stat-value', '#dashboard-stats p', '#dashboard-stats .value', '#dashboard-stats .stat-number'];
  function elementsList() {
    return Array.from(document.querySelectorAll(selectors.join(',')));
  }

  function fitElement(el, minPx = 10) {
    // Reset to computed base size
    const style = window.getComputedStyle(el);
    let fontSize = parseFloat(style.fontSize) || 18;
    // start from current size but cap to reasonable max
    fontSize = Math.min(fontSize, 40);
    el.style.fontSize = fontSize + 'px';
    // If it already fits, done
    const fits = () => el.scrollWidth <= el.clientWidth + 1; // small tolerance
    if (fits()) return;
    // Reduce in a loop until it fits or reaches minPx
    // Reduce by 1px steps (fast enough for small number of elements)
    let safety = 200;
    while (!fits() && fontSize > minPx && safety-- > 0) {
      fontSize -= 1;
      el.style.fontSize = fontSize + 'px';
    }
  }

  function fitAll() {
    const els = elementsList();
    els.forEach(el => {
      // Only fit for tablet widths (match user's environment needs). Broader upper bound to include large tablets.
      if (window.innerWidth >= 641 && window.innerWidth <= 1400) {
        fitElement(el, 10);
      } else {
        // restore to default computed size by removing inline style
        el.style.fontSize = '';
      }
    });
  }

  // Debounced resize handler
  let t = null;
  window.addEventListener('resize', () => {
    clearTimeout(t);
    t = setTimeout(fitAll, 150);
  });

  // Run after fonts/images/charts settled
  window.addEventListener('load', () => setTimeout(fitAll, 120));
  document.addEventListener('DOMContentLoaded', () => setTimeout(fitAll, 120));
})();
</script>


<script>
(function(){
  function parseNumberFromText(text){
    if(!text) return NaN;
    let s = text.replace(/[^0-9\.,\-]/g, '').trim();
    if(s === '') return NaN;
    if(s.indexOf('.') !== -1 && s.indexOf(',') !== -1){
      s = s.replace(/\./g, '').replace(/,/g, '.');
    } else if(s.indexOf('.') !== -1 && s.indexOf(',') === -1){
      /* treat '.' as thousands separator -> remove all dots */
      s = s.replace(/\./g, '');
    } else if(s.indexOf(',') !== -1 && s.indexOf('.') === -1){
      s = s.replace(/,/g, '.');
    }
    var n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }

  function formatRupiahShort(n){
    if(!isFinite(n)) return '';
    var abs = Math.abs(n);
    if(abs >= 1e9){
      return 'Rp ' + (n/1e9).toFixed(2).replace('.',',') + ' B';
    }
    if(abs >= 1e6){
      return 'Rp ' + (n/1e6).toFixed(2).replace('.',',') + ' M';
    }
    if(abs >= 1e3){
      return 'Rp ' + (n/1e3).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,".") + ' K';
    }
    return 'Rp ' + n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,".");
  }

  function formatRupiahFull(n){
    if(!isFinite(n)) return '';
    return 'Rp ' + n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,".");
  }

  var selectors = [
    '#dashboard-stats .stat-value',
    '#dashboard-stats .stat-number',
    '#dashboard-stats .value',
    '#dashboard-stats p',
    '.stat-card .value',
    '.stat-card .stat-number'
  ];

  function tryFormatElement(el){
    if(!el || el.__formatted_done) return;
    var text = el.innerText || el.textContent || '';
    var n = parseNumberFromText(text);
    if(isNaN(n)) return;
    if(!el.getAttribute('data-original')) el.setAttribute('data-original', text.trim());
    el.setAttribute('title', formatRupiahFull(n));
    var short = formatRupiahShort(n);
    el.innerText = short;
    el.__formatted_done = true;
  }

  function scanAndFormat(root){
    try {
      selectors.forEach(function(sel){
        var nodes = (root || document).querySelectorAll(sel);
        nodes.forEach(function(n){ tryFormatElement(n); });
      });
    } catch(e){ console.error('format scan error', e); }
  }

  document.addEventListener('DOMContentLoaded', function(){ scanAndFormat(document); });
  scanAndFormat(document);

  var obs = new MutationObserver(function(mutations){
    mutations.forEach(function(m){
      if(m.type === 'childList'){
        m.addedNodes.forEach(function(node){ if(node.querySelectorAll) scanAndFormat(node); });
      } else if(m.type === 'characterData' && m.target && m.target.parentNode){
        scanAndFormat(m.target.parentNode);
      }
    });
  });
  obs.observe(document.body, { childList: true, subtree: true, characterData: true });

  window.__advantaFormat = {
    refresh: function(){ scanAndFormat(document); },
    restore: function(){
      selectors.forEach(function(sel){
        document.querySelectorAll(sel).forEach(function(el){
          var orig = el.getAttribute('data-original');
          if(orig) el.innerText = orig;
          el.removeAttribute('data-original');
          el.removeAttribute('title');
          el.__formatted_done = false;
        });
      });
    }
  };
})();
</script>


<script>
(function(){
  var selectors = [
    '#dashboard-stats .stat-value',
    '#dashboard-stats .stat-number',
    '#dashboard-stats .value',
    '#dashboard-stats p',
    '.stat-card .value',
    '.stat-card .stat-number'
  ];

  function getTextElement(el){
    // prefer direct text-holding element; if element already has .__autoscaleInner, use it
    if(!el) return null;
    var inner = el.querySelector('.__autoscaleInner');
    if(inner) return inner;
    // create wrapper span and move text nodes into it
    inner = document.createElement('span');
    inner.className = '__autoscaleInner';
    // preserve original whitespace
    inner.style.display = 'inline-block';
    inner.style.whiteSpace = 'nowrap';
    inner.style.transformOrigin = 'left center';
    // move child nodes that are text or inline into inner
    while(el.firstChild){
      inner.appendChild(el.firstChild);
    }
    el.appendChild(inner);
    return inner;
  }

  function restoreOriginal(el){
    var data = el.getAttribute && el.getAttribute('data-original');
    if(data){
      // set original text inside inner wrapper
      var inner = getTextElement(el);
      inner.textContent = data;
    }
  }

  function applyScaleTo(el){
    if(!el) return;
    var inner = getTextElement(el);
    // ensure original text present if available
    if(el.getAttribute && el.getAttribute('data-original')){
      inner.textContent = el.getAttribute('data-original');
    }
    // reset transform
    inner.style.transform = 'scale(1)';
    inner.style.fontSize = ''; // keep CSS font-size
    // measure and compute scale
    // allow small padding
    var parent = el;
    var avail = parent.clientWidth - 6;
    if(avail <= 0) return;
    // measure natural width
    var natural = inner.scrollWidth;
    if(natural <= avail){
      inner.style.transform = 'scale(1)';
      inner.style.display = 'inline-block';
      inner.style.lineHeight = '1';
      parent.style.overflow = 'visible';
      return;
    }
    var scale = Math.max(0.5, Math.min(1, avail / natural));
    inner.style.transform = 'scale(' + scale + ')';
    inner.style.display = 'inline-block';
    inner.style.lineHeight = '1';
    // To prevent visual overflow due to scaling (which doesn't change layout), set parent overflow hidden
    parent.style.overflow = 'hidden';
    // adjust transform origin
    inner.style.transformOrigin = 'left center';
  }

  function scanAndScale(root){
    try{
      // Validate root is a valid element with querySelectorAll
      if (!root || !root.querySelectorAll || typeof root.querySelectorAll !== 'function') {
        root = document;
      }
      
      selectors.forEach(function(sel){
        var nodes = root.querySelectorAll(sel);
        nodes.forEach(function(n){
          // make sure node is visible and has text
          var txt = (n.innerText || n.textContent || '').trim();
          if(!txt) return;
          // restore original if any
          restoreOriginal(n);
          applyScaleTo(n);
        });
      });
    }catch(e){ 
      // Silently handle autoscale errors to avoid console spam
      // console.error('autoscale error', e); 
    }
  }

  // run on load
  function onReady(){
    scanAndScale(document);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', onReady);
  } else{
    onReady();
  }

  // handle resize
  var resizeTimer = null;
  window.addEventListener('resize', function(){
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function(){ scanAndScale(document); }, 120);
  });

  // Observe DOM changes and reapply
  var mo = new MutationObserver(function(muts){
    muts.forEach(function(m){
      if(m.type === 'childList'){
        m.addedNodes.forEach(function(node){
          // Only process element nodes (nodeType 1)
          if (node && node.nodeType === 1 && node.querySelectorAll) {
            try{ scanAndScale(node); }catch(e){}
          }
        });
      } else if(m.type === 'characterData' && m.target && m.target.parentNode){
        // For text changes, scan parent node if it's an element
        var parent = m.target.parentNode;
        if (parent && parent.nodeType === 1 && parent.querySelectorAll) {
          try{ scanAndScale(parent); }catch(e){}
        }
      }
    });
  });
  mo.observe(document.body, { childList:true, subtree:true, characterData:true });

  // expose control
  window.__advantaAutoscale = {
    refresh: function(){ scanAndScale(document); },
    applyToAll: function(){ scanAndScale(document); }
  };
})();
</script>


<script>
(function(){
  // target selectors for numeric values
  var selectors = [
    '#dashboard-stats .stat-value',
    '#dashboard-stats .stat-number',
    '#dashboard-stats .value',
    '.stat-card .value',
    '.stat-card .stat-number'
  ];

  // ensure each target has an inner span __autosizeText that holds the visible text
  function ensureInner(el){
    if(!el) return null;
    var inner = el.querySelector('.__autosizeText');
    if(!inner){
      var span = document.createElement('span');
      span.className = '__autosizeText';
      // move child nodes (text) into span
      while(el.firstChild){
        span.appendChild(el.firstChild);
      }
      el.appendChild(span);
      inner = span;
    }
    return inner;
  }

  function numericText(el){
    // return the original numeric text (stored in data-original) or current text
    var orig = el.getAttribute && el.getAttribute('data-original');
    if(orig) return orig;
    return (el.innerText || el.textContent || '').trim();
  }

  function setText(el, txt){
    var inner = ensureInner(el);
    if(!inner) return;
    inner.textContent = txt;
  }

  function autosizeElement(el){
    try{
      var inner = ensureInner(el);
      if(!inner) return;
      // restore original if stored
      var orig = el.getAttribute('data-original');
      if(orig) inner.textContent = orig;
      // base font size (px)
      var base = parseFloat(window.getComputedStyle(inner).getPropertyValue('font-size')) || 20;
      // available width within parent
      var parent = el;
      var avail = parent.clientWidth - 8; // some padding allowance
      if(avail <= 0) return;
      // reset font-size to base for measurement
      inner.style.fontSize = base + 'px';
      // if fits, done. Use scrollWidth for natural width.
      var natural = inner.scrollWidth;
      if(natural <= avail){
        inner.style.fontSize = base + 'px';
        parent.style.overflow = 'hidden';
        return;
      }
      // decrease font-size until fits or reach minimum (10px)
      var newSize = base;
      while(newSize > 10 && inner.scrollWidth > avail){
        newSize = Math.max(10, newSize - 1);
        inner.style.fontSize = newSize + 'px';
      }
      // if still not fit, allow wrapping to two lines by toggling white-space
      if(inner.scrollWidth > avail){
        inner.style.whiteSpace = 'normal';
        inner.style.display = 'inline-block';
      } else {
        inner.style.whiteSpace = 'nowrap';
      }
      parent.style.overflow = 'hidden';
    }catch(e){ console.error('autosizeElement error', e); }
  }

  function scanAndAutosize(root){
    selectors.forEach(function(sel){
      var nodes = (root || document).querySelectorAll(sel);
      nodes.forEach(function(n){
        // only operate on visible text nodes
        var txt = (n.innerText || n.textContent || '').trim();
        if(!txt) return;
        // if original not stored, store it
        if(!n.getAttribute('data-original')) n.setAttribute('data-original', txt);
        autosizeElement(n);
      });
    });
  }

  function onReady(){
    scanAndAutosize(document);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', onReady);
  } else {
    onReady();
  }

  var resizeTimer = null;
  window.addEventListener('resize', function(){
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function(){ scanAndAutosize(document); }, 120);
  });

  var mo = new MutationObserver(function(muts){
    muts.forEach(function(m){
      if(m.type === 'childList'){
        m.addedNodes.forEach(function(node){
          if(node.querySelectorAll) scanAndAutosize(node);
        });
      } else if(m.type === 'characterData' && m.target && m.target.parentNode){
        scanAndAutosize(m.target.parentNode);
      }
    });
  });
  mo.observe(document.body, { childList:true, subtree:true, characterData:true });

  // expose control
  window.__advantaAutosize = { refresh: function(){ scanAndAutosize(document); } };
})();
</script>


<script>
(function(){
  function ensureStructure(){
    var cards = document.querySelectorAll('#dashboard-stats .stat-card, #dashboard-stats .card, .stat-card, .card');
    cards.forEach(function(card){
      // find possible label elements (small, h4, .title, .stat-label)
      var label = card.querySelector('.stat-label') || card.querySelector('small') || card.querySelector('h4') || card.querySelector('.title');
      var value = card.querySelector('.stat-value') || card.querySelector('.value') || card.querySelector('.stat-number') || card.querySelector('p');
      if(!label){
        // create a label placeholder if missing
        var el = document.createElement('div');
        el.className = 'stat-label';
        el.textContent = card.getAttribute('data-label') || '';
        card.insertBefore(el, card.firstChild);
      } else {
        label.classList.add('stat-label');
      }
      if(!value){
        // try to find any text node and wrap it
        var foundText = null;
        card.childNodes.forEach(function(n){ if(n.nodeType===3 && n.textContent.trim()) foundText = n; });
        var v = document.createElement('div');
        v.className = 'stat-value';
        if(foundText){ v.textContent = foundText.textContent.trim(); foundText.remove(); }
        else v.textContent = '';
        card.appendChild(v);
      } else {
        value.classList.add('stat-value');
      }
      // ensure inner autosize span
      var val = card.querySelector('.stat-value');
      if(val && !val.querySelector('.__autosizeText')){
        var span = document.createElement('span');
        span.className = '__autosizeText';
        span.style.whiteSpace = 'nowrap';
        // move existing children into span
        while(val.firstChild){ span.appendChild(val.firstChild); }
        val.appendChild(span);
      }
    });
  }

  function runNow(){
    ensureStructure();
    if(window.__advantaAutosize && window.__advantaAutosize.refresh){
      window.__advantaAutosize.refresh();
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', runNow);
  } else runNow();

  // watch for dynamic changes
  var mo = new MutationObserver(function(muts){
    muts.forEach(function(m){
      if(m.type === 'childList'){
        runNow();
      } else if(m.type === 'characterData'){
        runNow();
      }
    });
  });
  mo.observe(document.body, { childList:true, subtree:true, characterData:true });
  window.__advantaNormalize = { run: runNow };
})();
</script>


<!-- FINAL AUTOSIZE: adjust font-size until the value fits the available width -->
<script>
(function(){
  var selectors = [
    '#dashboard-stats .stat-value',
    '#dashboard-stats .stat-number',
    '#dashboard-stats .value',
    '.stat-card .value',
    '.card .stat-value'
  ];

  function ensureInner(el){
    if(!el) return null;
    var inner = el.querySelector('.__autosizeText');
    if(inner) return inner;
    inner = document.createElement('span');
    inner.className = '__autosizeText';
    // move children into inner
    while(el.firstChild){
      inner.appendChild(el.firstChild);
    }
    el.appendChild(inner);
    return inner;
  }

  function autosizeOne(el){
    try{
      var inner = ensureInner(el);
      if(!inner) return;
      // restore original if stored
      var orig = el.getAttribute && el.getAttribute('data-original');
      if(orig) inner.textContent = orig;
      // base font size
      var cs = window.getComputedStyle(inner);
      var base = parseFloat(cs.fontSize) || 20;
      // available width in parent
      var parent = el;
      var avail = parent.clientWidth - 8;
      if(avail <= 0) return;
      inner.style.fontSize = base + 'px';
      inner.style.whiteSpace = 'nowrap';
      var natural = inner.scrollWidth;
      if(natural <= avail){ inner.style.fontSize = base + 'px'; return; }
      // decrease font-size stepwise
      var newSize = base;
      var minSize = Math.max(10, base * 0.5);
      while(newSize > minSize && inner.scrollWidth > avail){
        newSize = Math.max(minSize, newSize - 1);
        inner.style.fontSize = newSize + 'px';
      }
      if(inner.scrollWidth > avail){
        inner.style.whiteSpace = 'normal';
        inner.style.display = 'inline-block';
      } else {
        inner.style.whiteSpace = 'nowrap';
      }
    }catch(e){ console.error('autosizeOne', e); }
  }

  function scan(){
    selectors.forEach(function(sel){
      var nodes = document.querySelectorAll(sel);
      nodes.forEach(function(n){
        var txt = (n.innerText || n.textContent || '').trim();
        if(!txt) return;
        if(!n.getAttribute('data-original')) n.setAttribute('data-original', txt);
        autosizeOne(n);
      });
    });
  }

  function onReady(){
    scan();
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', onReady);
  } else onReady();

  var resizeTimer = null;
  window.addEventListener('resize', function(){ clearTimeout(resizeTimer); resizeTimer = setTimeout(scan, 120); });

  var mo = new MutationObserver(function(muts){
    muts.forEach(function(m){
      if(m.type === 'childList'){
        m.addedNodes.forEach(function(node){
          if(node.querySelectorAll) scan();
        });
      } else if(m.type === 'characterData' && m.target && m.target.parentNode){
        scan();
      }
    });
  });
  mo.observe(document.body, { childList:true, subtree:true, characterData:true });

  window.__advantaFinal = { refresh: scan, stop: function(){ mo.disconnect(); window.removeEventListener('resize', scan); } };
  console.log('Advanta final autosize installed.');
})();
</script>


<!-- Patch: Dashboard Target Bulanan per Varietas (dari menu Target) -->
<script>
(function () {
    const fiscalMonths = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

    function getDistinctFiscalYears() {
        if (!window.appState || !Array.isArray(appState.targets)) return [];
        const years = [...new Set(appState.targets.map(t => t.year))];
        return years.sort((a, b) => b - a);
    }

    function getAvailableUnitsForYear(year) {
        if (!window.appState || !Array.isArray(appState.targets)) return [];
        const units = [...new Set(appState.targets.filter(t => t.year === year).map(t => t.unit))];
        const order = ['kg', 'pcs', 'nominal'];
        return units.sort((a, b) => order.indexOf(a) - order.indexOf(b));
    }

    function getDefaultFilters() {
        const years = getDistinctFiscalYears();
        if (!years.length) return null;
        const today = new Date();
        const currentFY = (typeof getFiscalYear === 'function') ? getFiscalYear(today) : years[0];
        const year = years.includes(currentFY) ? currentFY : years[0];

        const units = getAvailableUnitsForYear(year);
        const unit = units[0] || 'pcs';

        let monthIndex = 0;
        if (typeof getFiscalMonthIndex === 'function') {
            const idx = getFiscalMonthIndex(today, year);
            monthIndex = (idx >= 0 && idx < 12) ? idx : 0;
        }

        return { year, unit, monthIndex };
    }

    function aggregateTargetPerVarietas(year, unit, monthIndex) {
        const result = {};
        if (!window.appState || !Array.isArray(appState.targets)) return result;

        const relevantTargets = appState.targets.filter(t => t.year === year && t.unit === unit);
        relevantTargets.forEach(t => {
            const variety = appState.varieties.find(v => v.id === t.varietyId);
            const varietyName = variety ? variety.name : 'Varietas';
            const monthlyTargets = Array.isArray(t.monthlyTargets) ? t.monthlyTargets : [];
            const targetVal = Number(monthlyTargets[monthIndex] || 0);

            let actualMonthly = [];
            if (typeof getTargetMonthlyActuals === 'function') {
                actualMonthly = getTargetMonthlyActuals(t) || [];
            }
            const actualVal = Number(actualMonthly[monthIndex] || 0);

            if (!result[varietyName]) {
                result[varietyName] = { target: 0, actual: 0 };
            }
            result[varietyName].target += targetVal;
            result[varietyName].actual += actualVal;
        });

        return result;
    }

    function formatDashboardTargetValue(val, unit) {
        const num = Number(val || 0);
        if (unit === 'nominal') {
            if (typeof formatRupiah === 'function') {
                return formatRupiah(num, false);
            }
            return 'Rp ' + num.toLocaleString('id-ID');
        }
        if (unit === 'kg') {
            return num.toLocaleString('id-ID', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' Kg';
        }
        if (unit === 'pcs') {
            return num.toLocaleString('id-ID') + ' Pcs';
        }
        return num.toLocaleString('id-ID');
    }

    function renderDashboardTargetCard() {
        const container = document.getElementById('dashboard-target-summary');
        if (!container) return;

        if (!window.appState || !Array.isArray(appState.targets) || appState.targets.length === 0) {
            container.innerHTML = `
                <h3 class="font-bold text-lg mb-2">Target Bulanan</h3>
                <p class="text-gray-500 text-sm">Belum ada target yang dibuat di menu Target.</p>
            `;
            return;
        }

        const filters = getDefaultFilters();
        if (!filters) {
            container.innerHTML = `
                <h3 class="font-bold text-lg mb-2">Target Bulanan</h3>
                <p class="text-gray-500 text-sm">Belum ada data target.</p>
            `;
            return;
        }

        const years = getDistinctFiscalYears();
        const units = getAvailableUnitsForYear(filters.year);

        container.innerHTML = `
            <div class="flex items-start justify-between mb-3 gap-3">
                <div>
                    <h3 class="font-bold text-lg">Target Bulanan per Varietas</h3>
                    <p class="text-xs text-gray-500" id="dashboard-target-subtitle"></p>
                </div>
                <div class="flex flex-col items-end gap-1 text-xs">
                    <div class="flex flex-wrap gap-2">
                        <div>
                            <label class="block text-[11px] text-gray-500 mb-0.5">Tahun Fiskal</label>
                            <select id="dashboard-target-year" class="border rounded-md px-2 py-1">
                                ${years.map(y => `<option value="${y}" ${y === filters.year ? 'selected' : ''}>${y}/${y+1}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-[11px] text-gray-500 mb-0.5">Bulan</label>
                            <select id="dashboard-target-month" class="border rounded-md px-2 py-1">
                                ${fiscalMonths.map((m, idx) => `<option value="${idx}" ${idx === filters.monthIndex ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-[11px] text-gray-500 mb-0.5">Satuan</label>
                            <select id="dashboard-target-unit" class="border rounded-md px-2 py-1">
                                ${(units.length ? units : ['kg','pcs','nominal']).map(u => `<option value="${u}" ${u === filters.unit ? 'selected' : ''}>${u === 'kg' ? 'Kg' : (u === 'pcs' ? 'Pcs' : 'Nominal (Rp)')}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1 justify-end mt-1">
                        <button type="button"
                                class="px-2 py-1 rounded-md border border-red-200 bg-red-50 text-[11px] text-red-700 hover:bg-red-100"
                                onclick="window.exportDashboardTargetToPDF && window.exportDashboardTargetToPDF()">
                            Export PDF
                        </button>
                        <button type="button"
                                class="px-2 py-1 rounded-md border border-green-200 bg-green-50 text-[11px] text-green-700 hover:bg-green-100"
                                onclick="window.exportDashboardTargetToCSV && window.exportDashboardTargetToCSV()">
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
            <div id="dashboard-target-table-wrapper" class="mt-2 text-xs"></div>
        `;

        function updateSubtitle(year, monthIndex, unit) {
            const subEl = document.getElementById('dashboard-target-subtitle');
            if (!subEl) return;
            const unitLabel = unit === 'kg' ? 'Kg' : (unit === 'pcs' ? 'Pcs' : 'Nominal (Rp)');
            subEl.textContent = `Sumber data: menu Target (sudah di-breakdown bulanan). Tahun fiskal ${year}/${year+1}, bulan ${fiscalMonths[monthIndex]}, satuan ${unitLabel}.`;
        }

        function renderTable(year, monthIndex, unit) {
            const wrapper = document.getElementById('dashboard-target-table-wrapper');
            if (!wrapper) return;

            const aggregated = aggregateTargetPerVarietas(year, unit, monthIndex);
            const varietyNames = Object.keys(aggregated).sort();

            if (!varietyNames.length) {
                wrapper.innerHTML = `<p class="text-gray-500 text-xs">Tidak ada target untuk kombinasi filter ini.</p>`;
                updateSubtitle(year, monthIndex, unit);
                return;
            }

            let rows = '';
            let totalTarget = 0;
            let totalActual = 0;

            varietyNames.forEach(name => {
                const data = aggregated[name];
                totalTarget += data.target;
                totalActual += data.actual;
                const ach = data.target > 0 ? (data.actual / data.target) * 100 : null;

                rows += `
                    <tr>
                        <td class="py-1 px-2 border-b text-[11px]">${name}</td>
                        <td class="py-1 px-2 border-b text-right font-medium">${formatDashboardTargetValue(data.target, unit)}</td>
                        <td class="py-1 px-2 border-b text-right text-green-700">${formatDashboardTargetValue(data.actual, unit)}</td>
                        <td class="py-1 px-2 border-b text-right">${ach === null ? '-' : ach.toFixed(1) + '%'}</td>
                    </tr>
                `;
            });

            const totalAch = totalTarget > 0 ? (totalActual / totalTarget) * 100 : null;

            wrapper.innerHTML = `
                <div class="overflow-x-auto -mx-1">
                    <table class="min-w-full text-xs">
                        <thead>
                            <tr class="text-[11px] text-gray-500 border-b">
                                <th class="py-1 px-2 text-left">Varietas</th>
                                <th class="py-1 px-2 text-right">Target</th>
                                <th class="py-1 px-2 text-right">Realisasi</th>
                                <th class="py-1 px-2 text-right">% Capai</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-50 font-semibold text-[11px]">
                                <td class="py-1 px-2 text-left">Total</td>
                                <td class="py-1 px-2 text-right">${formatDashboardTargetValue(totalTarget, unit)}</td>
                                <td class="py-1 px-2 text-right">${formatDashboardTargetValue(totalActual, unit)}</td>
                                <td class="py-1 px-2 text-right">${totalAch === null ? '-' : totalAch.toFixed(1) + '%'}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            updateSubtitle(year, monthIndex, unit);
        }

        const yearSelect = document.getElementById('dashboard-target-year');
        const monthSelect = document.getElementById('dashboard-target-month');
        const unitSelect = document.getElementById('dashboard-target-unit');

        function onFilterChange() {
            const year = parseInt(yearSelect.value, 10);
            const monthIndex = parseInt(monthSelect.value, 10);
            const unit = unitSelect.value;

            const availableUnits = getAvailableUnitsForYear(year);
            if (availableUnits.length && !availableUnits.includes(unit)) {
                unitSelect.value = availableUnits[0];
            }

            renderTable(year, monthIndex, unitSelect.value);
        }

        yearSelect.addEventListener('change', onFilterChange);
        monthSelect.addEventListener('change', onFilterChange);
        unitSelect.addEventListener('change', onFilterChange);

        renderTable(filters.year, filters.monthIndex, filters.unit);
    }

    // === Export fungsi untuk dashboard target bulanan ===
    function getCurrentDashboardTargetFilters() {
        const yearEl = document.getElementById('dashboard-target-year');
        const monthEl = document.getElementById('dashboard-target-month');
        const unitEl = document.getElementById('dashboard-target-unit');
        if (!yearEl || !monthEl || !unitEl) return null;
        return {
            year: parseInt(yearEl.value, 10),
            monthIndex: parseInt(monthEl.value, 10),
            unit: unitEl.value
        };
    }

    window.exportDashboardTargetToCSV = function () {
        const filters = getCurrentDashboardTargetFilters();
        if (!filters) {
            alert('Target bulanan belum siap ditampilkan.');
            return;
        }
        const { year, monthIndex, unit } = filters;
        const aggregated = aggregateTargetPerVarietas(year, unit, monthIndex);
        const names = Object.keys(aggregated).sort();
        if (!names.length) {
            alert('Tidak ada data untuk kombinasi filter ini.');
            return;
        }

        let csv = 'Varietas,Target,Realisasi,Persentase Capai\\n';
        let totalTarget = 0;
        let totalActual = 0;
        names.forEach(name => {
            const d = aggregated[name];
            totalTarget += d.target;
            totalActual += d.actual;
            const ach = d.target > 0 ? (d.actual / d.target) * 100 : null;
            csv += `"${name.replace('"','""')}",${d.target},${d.actual},${ach === null ? '' : ach.toFixed(1)}\\n`;
        });
        const totalAch = totalTarget > 0 ? (totalActual / totalTarget) * 100 : null;
        csv += `"TOTAL",${totalTarget},${totalActual},${totalAch === null ? '' : totalAch.toFixed(1)}\\n`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const monthLabel = fiscalMonths[monthIndex] || 'Bulan';
        a.href = url;
        a.download = `target-dashboard-${year}-${monthLabel}-${unit}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    window.exportDashboardTargetToPDF = function () {
        const filters = getCurrentDashboardTargetFilters();
        if (!filters) {
            alert('Target bulanan belum siap ditampilkan.');
            return;
        }
        const { year, monthIndex, unit } = filters;
        const aggregated = aggregateTargetPerVarietas(year, unit, monthIndex);
        const names = Object.keys(aggregated).sort();
        if (!names.length) {
            alert('Tidak ada data untuk kombinasi filter ini.');
            return;
        }

        if (!window.jspdf || !window.jspdf.jsPDF) {
            alert('jsPDF belum tersedia.');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        const monthLabel = fiscalMonths[monthIndex] || 'Bulan';
        const unitLabel = unit === 'kg' ? 'Kg' : (unit === 'pcs' ? 'Pcs' : 'Nominal (Rp)');

        doc.setFontSize(14);
        doc.text('Target Bulanan per Varietas (Dashboard)', 14, 15);
        doc.setFontSize(10);
        doc.text(`Tahun fiskal ${year}/${year+1} - Bulan ${monthLabel} - Satuan ${unitLabel}`, 14, 22);

        let totalTarget = 0;
        let totalActual = 0;
        const body = names.map(name => {
            const d = aggregated[name];
            totalTarget += d.target;
            totalActual += d.actual;
            const ach = d.target > 0 ? (d.actual / d.target) * 100 : null;
            return [
                name,
                formatDashboardTargetValue(d.target, unit),
                formatDashboardTargetValue(d.actual, unit),
                ach === null ? '-' : ach.toFixed(1) + '%'
            ];
        });
        const totalAch = totalTarget > 0 ? (totalActual / totalTarget) * 100 : null;
        body.push([
            'TOTAL',
            formatDashboardTargetValue(totalTarget, unit),
            formatDashboardTargetValue(totalActual, unit),
            totalAch === null ? '-' : totalAch.toFixed(1) + '%'
        ]);

        if (doc.autoTable) {
            doc.autoTable({
                startY: 28,
                head: [['Varietas', 'Target', 'Realisasi', '% Capai']],
                body
            });
        }

        doc.save(`target-dashboard-${year}-${monthLabel}-${unit}.pdf`);
    };

    // Patch createCharts supaya selalu memanggil renderDashboardTargetCard() dan renderVarietyGrowth()
    const originalCreateCharts = window.createCharts;
    window.createCharts = function () {
        try {
            if (typeof originalCreateCharts === 'function') {
                originalCreateCharts();
            }
        } catch (e) {
            console.error('Error in original createCharts:', e);
        }
        try {
            renderDashboardTargetCard();
        } catch (e) {
            console.error('Error renderDashboardTargetCard:', e);
        }
        try {
            renderVarietyGrowth();
        } catch (e) {
            console.error('Error renderVarietyGrowth:', e);
        }
    };

    // Fungsi untuk render Growth Varietas
    function renderVarietyGrowth() {
        const container = document.getElementById('variety-growth-summary');
        if (!container) return;

        // Get all released items
        const allReleasedItems = appState.purchaseOrders.flatMap(po => {
            if (!['Partially Released', 'Fully Released'].includes(po.status.trim())) return [];
            return po.items.flatMap(item =>
                (item.releases || []).map(release => ({
                    ...item,
                    distributorId: po.distributorId,
                    releaseQty: release.qty,
                    releaseDate: release.date,
                    varietyId: item.varietyId
                }))
            );
        });

        // Get fiscal year filter
        const fiscalSelect = document.getElementById('dashboard-fiscal-year-select');
        const currentYear = new Date().getFullYear();
        let selectedFiscalYear = fiscalSelect && fiscalSelect.value !== 'all' ? parseInt(fiscalSelect.value) : null;
        
        // If no filter, use current fiscal year
        if (!selectedFiscalYear) {
            const now = new Date();
            selectedFiscalYear = now.getMonth() >= 3 ? now.getFullYear() : now.getFullYear() - 1;
        }

        const previousYear = selectedFiscalYear - 1;

        // Calculate sales per variety for current and previous year
        const currentYearSales = {};
        const previousYearSales = {};

        allReleasedItems.forEach(item => {
            const d = new Date(item.releaseDate);
            if (isNaN(d)) return;
            
            const fy = getFiscalYear(d);
            const varietyId = item.varietyId;
            const qty = item.releaseQty * (item.weight || 0) / 1000; // Convert to KG

            if (fy === selectedFiscalYear) {
                currentYearSales[varietyId] = (currentYearSales[varietyId] || 0) + qty;
            } else if (fy === previousYear) {
                previousYearSales[varietyId] = (previousYearSales[varietyId] || 0) + qty;
            }
        });

        // Calculate growth for each variety
        const growthData = [];
        const allVarietyIds = new Set([...Object.keys(currentYearSales), ...Object.keys(previousYearSales)]);

        allVarietyIds.forEach(varietyId => {
            const variety = appState.varieties.find(v => v.id == varietyId);
            if (!variety) return;

            const currentQty = currentYearSales[varietyId] || 0;
            const previousQty = previousYearSales[varietyId] || 0;

            let growthPercent = 0;
            if (previousQty > 0) {
                growthPercent = ((currentQty - previousQty) / previousQty) * 100;
            } else if (currentQty > 0) {
                growthPercent = 100; // New product
            }

            growthData.push({
                name: variety.name,
                currentQty,
                previousQty,
                growthPercent,
                isPositive: growthPercent >= 0
            });
        });

        // Sort by absolute growth percentage
        growthData.sort((a, b) => Math.abs(b.growthPercent) - Math.abs(a.growthPercent));

        // Render HTML
        container.innerHTML = `
            <h3 class="font-bold text-base mb-3">Growth Varietas</h3>
            <p class="text-xs text-gray-500 mb-4">Perbandingan FY ${selectedFiscalYear}/${selectedFiscalYear+1} vs FY ${previousYear}/${previousYear+1}</p>
            <div class="space-y-2 max-h-96 overflow-y-auto">
                ${growthData.length === 0 ? '<p class="text-sm text-gray-500">Belum ada data penjualan</p>' : 
                    growthData.map(data => `
                        <div class="border-b border-gray-100 pb-2">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-medium text-sm">${data.name}</span>
                                <span class="text-sm font-bold ${data.isPositive ? 'text-green-600' : 'text-red-600'}">
                                    ${data.isPositive ? '↑' : '↓'} ${Math.abs(data.growthPercent).toFixed(1)}%
                                </span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>FY ${previousYear}: ${data.previousQty.toLocaleString('id-ID', { maximumFractionDigits: 0 })} Kg</span>
                                <span>FY ${selectedFiscalYear}: ${data.currentQty.toLocaleString('id-ID', { maximumFractionDigits: 0 })} Kg</span>
                            </div>
                            <div class="mt-1 bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                <div class="h-full ${data.isPositive ? 'bg-green-500' : 'bg-red-500'}" 
                                     style="width: ${Math.min(Math.abs(data.growthPercent), 100)}%"></div>
                            </div>
                        </div>
                    `).join('')
                }
            </div>
        `;
    }
})();
</script>

<script>
// OVERRIDE: openTargetModal dengan Tahun Fiskal lebih fleksibel (bisa beberapa tahun ke depan)
function openTargetModal(targetId = null) {
    const form = document.getElementById('target-form');
    form.reset();
    document.getElementById('editing-target-id').value = targetId || '';
    document.getElementById('target-items-container').innerHTML = '';
    
    const distSelect = document.getElementById('target-distributor');
    const yearSelect = document.getElementById('target-year');

    // Isi dropdown distributor
    distSelect.innerHTML = appState.distributors
        .map(d => `<option value="${d.id}">${d.name}</option>`)
        .join('');

    // Tahun fiskal: dari 1 tahun sebelum tahun fiskal sekarang sampai 10 tahun ke depan
    const currentFiscalYear = getFiscalYear(new Date());
    const startYear = currentFiscalYear - 1;
    const endYear   = currentFiscalYear + 10;

    let yearOptions = '';
    for (let y = startYear; y <= endYear; y++) {
        yearOptions += `<option value="${y}">${y}/${y + 1}</option>`;
    }
    yearSelect.innerHTML = yearOptions;

    const updateSubtitle = () => {
        const tahun = parseInt(yearSelect.value, 10);
        document.getElementById('target-modal-subtitle').textContent =
            `Periode: April ${tahun} - Maret ${tahun + 1}`;
    };
    yearSelect.onchange = updateSubtitle;
    
    if (targetId) {
        const target = appState.targets.find(t => t.id === targetId);
        if (target) {
            document.getElementById('target-modal-title').textContent = 'Edit Target Penjualan';
            distSelect.value = target.distributorId;

            // Jika tahun target di luar range dropdown, tambahkan option khusus
            const exists = Array.from(yearSelect.options)
                .some(opt => Number(opt.value) === Number(target.year));
            if (!exists) {
                const opt = document.createElement('option');
                opt.value = target.year;
                opt.textContent = `${target.year}/${target.year + 1}`;
                yearSelect.appendChild(opt);
            }

            yearSelect.value = target.year;
            document.getElementById('target-unit').value = target.unit;
            distSelect.disabled = true;
            yearSelect.disabled = true;
            addTargetItem(target.varietyId, target.monthlyTargets);
        }
    } else {
        document.getElementById('target-modal-title').textContent = 'Set Target Penjualan Baru';
        distSelect.disabled = false;
        yearSelect.disabled = false;
        addTargetItem();
    }
    updateSubtitle();
    openEditModal('target-modal');
}
</script>


<script>
// OVERRIDE: Target Page dengan filter Tahun Fiskal (menggunakan dropdown statis #target-year-filter)
(function () {
    function getDistinctFiscalYears() {
        if (!window.appState || !Array.isArray(appState.targets)) return [];
        const years = [...new Set(appState.targets.map(t => t.year))];
        return years.sort((a, b) => b - a); // terbaru di atas
    }

    window.renderTargetPage = function(selectedYear = null) {
        const container = document.getElementById('target-list-container');
        if (!container) return;

        if (!appState.targets || appState.targets.length === 0) {
            const icon = `
                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                    </path>
                </svg>`;
            renderEmptyState(
                'target-list-container',
                'Belum ada target yang dibuat. Klik "Buat Target Baru" untuk memulai.',
                icon
            );
            // kosongkan juga filter jika tidak ada data
            const filterSelect = document.getElementById('target-year-filter');
            if (filterSelect) filterSelect.innerHTML = '';
            return;
        }

        const years = getDistinctFiscalYears();
        const filterSelect = document.getElementById('target-year-filter');

        if (filterSelect) {
            filterSelect.innerHTML = years
                .map(y => `<option value="${y}">${y}/${y + 1}</option>`)
                .join('');
        }

        // Tentukan tahun aktif
        let activeYear = selectedYear;
        const selectedFromUI = filterSelect ? parseInt(filterSelect.value, 10) : NaN;
        if (activeYear == null) {
            if (!Number.isNaN(selectedFromUI) && years.includes(selectedFromUI)) {
                activeYear = selectedFromUI;
            } else {
                const today = new Date();
                const currentFY = (typeof getFiscalYear === 'function') ? getFiscalYear(today) : years[0];
                activeYear = years.includes(currentFY) ? currentFY : years[0];
            }
        }
        if (filterSelect) {
            filterSelect.value = activeYear;
        }

        // Bind event change sekali saja
        if (filterSelect && !filterSelect.dataset.bound) {
            filterSelect.addEventListener('change', function () {
                const v = parseInt(this.value, 10);
                window.renderTargetPage(Number.isNaN(v) ? null : v);
            });
            filterSelect.dataset.bound = '1';
        }

        const filteredTargets = appState.targets.filter(t => t.year === activeYear);
        if (!filteredTargets.length) {
            container.innerHTML = `<div class="p-4 border rounded-md text-left text-gray-500">
                Tidak ada target pada tahun fiskal ${activeYear}/${activeYear + 1}.
            </div>`;
            return;
        }

        // Group per Distributor + Tahun (hanya tahun aktif)
        const groupedTargets = filteredTargets.reduce((acc, target) => {
            const key = `${target.year}-${target.distributorId}`;
            if (!acc[key]) {
                acc[key] = {
                    year: target.year,
                    distributor: appState.distributors.find(d => d.id === target.distributorId),
                    targets: []
                };
            }
            acc[key].targets.push(target);
            return acc;
        }, {});

        container.innerHTML = Object.values(groupedTargets)
            .sort((a, b) => {
                // urutkan distributor alfabet tapi tahun semua sama
                const an = (a.distributor?.name || '').toLowerCase();
                const bn = (b.distributor?.name || '').toLowerCase();
                return an.localeCompare(bn);
            })
            .map(group => {
                const distName = group.distributor
                    ? group.distributor.name
                    : `Distributor Dihapus (ID: ${group.distributorId})`;

                return `
                    <div class="bg-white border rounded-lg mb-6">
                        <div class="p-4 border-b bg-gray-50 rounded-t-lg flex items-center justify-between">
                            <h4 class="font-bold text-lg">
                                ${distName} - Tahun Fiskal ${group.year}/${group.year + 1}
                            </h4>
                        </div>
                        <div class="p-4 space-y-4">
                            ${group.targets.map(t => {
                                const { totalTarget, totalActual, achievementPercentage } = getTargetActuals(t);
                                const variety = appState.varieties.find(v => v.id === t.varietyId);

                                const unitLabel =
                                    t.unit === 'kg' ? 'Kg' :
                                    t.unit === 'pcs' ? 'Pcs' :
                                    t.unit === 'nominal' ? 'Rp' : t.unit;

                                const formattedTotalTarget = t.unit === 'nominal'
                                    ? formatRupiah(totalTarget)
                                    : `${totalTarget.toLocaleString('id-ID', {
                                          minimumFractionDigits: t.unit === 'kg' ? 2 : 0,
                                          maximumFractionDigits: t.unit === 'kg' ? 2 : 0
                                      })} ${unitLabel}`;

                                const formattedTotalActual = t.unit === 'nominal'
                                    ? formatRupiah(totalActual)
                                    : `${totalActual.toLocaleString('id-ID', {
                                          minimumFractionDigits: t.unit === 'kg' ? 2 : 0,
                                          maximumFractionDigits: t.unit === 'kg' ? 2 : 0
                                      })} ${unitLabel}`;

                                return `
                                    <div class="border rounded-md p-4">
                                        <div class="flex flex-col sm:flex-row justify-between gap-3 sm:gap-4">
                                            <div>
                                                <p class="font-semibold text-gray-800">
                                                    ${variety ? variety.name : 'Varietas Dihapus'}
                                                </p>
                                                <p class="text-sm text-gray-500">
                                                    Total Target:
                                                    <button
                                                        type="button"
                                                        onclick="openTargetBreakdownModal('${t.id}')"
                                                        class="font-semibold text-blue-600 underline decoration-dashed underline-offset-2 hover:text-blue-800 focus:outline-none"
                                                        title="Klik untuk lihat breakdown per bulan"
                                                    >
                                                        ${formattedTotalTarget}
                                                    </button>
                                                </p>
                                            </div>
                                            <div class="flex gap-2 shrink-0">
                                                ${renderActionIcons([
                                                    { action: \`openTargetModal('${t.id}')\`, icon: 'pencil', text: 'Edit' },
                                                    { action: \`confirmDeleteTarget('${t.id}')\`, icon: 'trash', text: 'Hapus' }
                                                ], true)}
                                            </div>
                                        </div>

                                        <div class="mt-3 pt-3 border-t">
                                            <h5 class="text-sm font-medium text-gray-700 mb-1">
                                                Progres Pencapaian (${t.unit === 'nominal' ? 'Nominal (Rp)' : unitLabel})
                                            </h5>
                                            <div class="flex justify-between items-center text-sm mb-1">
                                                <span class="font-bold text-green-600">
                                                    ${formattedTotalActual}
                                                </span>
                                                <span class="text-gray-500">
                                                    ${achievementPercentage.toFixed(1)}%
                                                </span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                                <div
                                                    class="bg-green-500 h-2.5 rounded-full"
                                                    style="width: ${Math.min(achievementPercentage, 100)}%;"
                                                ></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
    };
})();
</script>


<script>
// FINAL OVERRIDE: renderTargetPage dengan filter Tahun Fiskal yang berfungsi
function renderTargetPage(selectedYear = null) {
    const container = document.getElementById('target-list-container');
    if (!container) return;

    if (!appState.targets || appState.targets.length === 0) {
        const icon = `
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                </path>
            </svg>`;
        if (typeof renderEmptyState === 'function') {
            renderEmptyState(
                'target-list-container',
                'Belum ada target yang dibuat. Klik "Buat Target Baru" untuk memulai.',
                icon
            );
        } else {
            container.innerHTML = '<div class="py-8 text-left text-gray-500">Belum ada target yang dibuat.</div>';
        }
        const filterSelect = document.getElementById('target-year-filter');
        if (filterSelect) filterSelect.innerHTML = '';
        return;
    }

    const years = [...new Set(appState.targets.map(t => t.year))].sort((a, b) => b - a);

    const filterSelect = document.getElementById('target-year-filter');
    if (filterSelect) {
        filterSelect.innerHTML = years
            .map(y => `<option value="${y}">${y}/${y + 1}</option>`)
            .join('');
    }

    // Tentukan tahun aktif
    let activeYear = selectedYear;
    const selectedFromUI = filterSelect ? parseInt(filterSelect.value, 10) : NaN;
    if (activeYear == null) {
        if (!Number.isNaN(selectedFromUI) && years.includes(selectedFromUI)) {
            activeYear = selectedFromUI;
        } else {
            const today = new Date();
            const currentFY = (typeof getFiscalYear === 'function') ? getFiscalYear(today) : years[0];
            activeYear = years.includes(currentFY) ? currentFY : years[0];
        }
    }
    if (filterSelect) {
        filterSelect.value = activeYear;
    }

    // Bind event change sekali saja ke fungsi ini
    if (filterSelect && !filterSelect.dataset.bound) {
        filterSelect.addEventListener('change', function () {
            const v = parseInt(this.value, 10);
            renderTargetPage(Number.isNaN(v) ? null : v);
        });
        filterSelect.dataset.bound = '1';
    }

    const filteredTargets = appState.targets.filter(t => t.year === activeYear);
    if (!filteredTargets.length) {
        container.innerHTML = `<div class="p-4 border rounded-md text-left text-gray-500">
            Tidak ada target pada tahun fiskal ${activeYear}/${activeYear + 1}.
        </div>`;
        return;
    }

    const groupedTargets = filteredTargets.reduce((acc, target) => {
        const key = `${target.year}-${target.distributorId}`;
        if (!acc[key]) {
            acc[key] = {
                year: target.year,
                distributor: appState.distributors.find(d => d.id === target.distributorId),
                targets: []
            };
        }
        acc[key].targets.push(target);
        return acc;
    }, {});

    container.innerHTML = Object.values(groupedTargets)
        .sort((a, b) => {
            const an = (a.distributor?.name || '').toLowerCase();
            const bn = (b.distributor?.name || '').toLowerCase();
            return an.localeCompare(bn);
        })
        .map(group => {
            const distName = group.distributor
                ? group.distributor.name
                : `Distributor Dihapus (ID: ${group.distributorId})`;

            return `
                <div class="bg-white border rounded-lg mb-6">
                    <div class="p-4 border-b bg-gray-50 rounded-t-lg flex items-center justify-between">
                        <h4 class="font-bold text-lg">
                            ${distName} - Tahun Fiskal ${group.year}/${group.year + 1}
                        </h4>
                    </div>
                    <div class="p-4 space-y-4">
                        ${group.targets.map(t => {
                            const stats = typeof getTargetActuals === 'function'
                                ? getTargetActuals(t)
                                : { totalTarget: 0, totalActual: 0, achievementPercentage: 0 };
                            const { totalTarget, totalActual, achievementPercentage } = stats;
                            const variety = appState.varieties.find(v => v.id === t.varietyId);

                            const unitLabel =
                                t.unit === 'kg' ? 'Kg' :
                                t.unit === 'pcs' ? 'Pcs' :
                                t.unit === 'nominal' ? 'Rp' : t.unit;

                            const formattedTotalTarget = t.unit === 'nominal'
                                ? formatRupiah(totalTarget)
                                : `${totalTarget.toLocaleString('id-ID', {
                                      minimumFractionDigits: t.unit === 'kg' ? 2 : 0,
                                      maximumFractionDigits: t.unit === 'kg' ? 2 : 0
                                  })} ${unitLabel}`;

                            const formattedTotalActual = t.unit === 'nominal'
                                ? formatRupiah(totalActual)
                                : `${totalActual.toLocaleString('id-ID', {
                                      minimumFractionDigits: t.unit === 'kg' ? 2 : 0,
                                      maximumFractionDigits: t.unit === 'kg' ? 2 : 0
                                  })} ${unitLabel}`;

                            const actions = typeof renderActionIcons === 'function'
                                ? renderActionIcons([
                                      { action: \`openTargetModal('${t.id}')\`, icon: 'pencil', text: 'Edit' },
                                      { action: \`confirmDeleteTarget('${t.id}')\`, icon: 'trash', text: 'Hapus' }
                                  ], true)
                                : '';

                            return `
                                <div class="border rounded-md p-4">
                                    <div class="flex flex-col sm:flex-row justify-between gap-3 sm:gap-4">
                                        <div>
                                            <p class="font-semibold text-gray-800">
                                                ${variety ? variety.name : 'Varietas Dihapus'}
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                Total Target:
                                                <button
                                                    type="button"
                                                    onclick="openTargetBreakdownModal('${t.id}')"
                                                    class="font-semibold text-blue-600 underline decoration-dashed underline-offset-2 hover:text-blue-800 focus:outline-none"
                                                    title="Klik untuk lihat breakdown per bulan"
                                                >
                                                    ${formattedTotalTarget}
                                                </button>
                                            </p>
                                        </div>
                                        <div class="flex gap-2 shrink-0">
                                            ${actions}
                                        </div>
                                    </div>

                                    <div class="mt-3 pt-3 border-t">
                                        <h5 class="text-sm font-medium text-gray-700 mb-1">
                                            Progres Pencapaian (${t.unit === 'nominal' ? 'Nominal (Rp)' : unitLabel})
                                        </h5>
                                        <div class="flex justify-between items-center text-sm mb-1">
                                            <span class="font-bold text-green-600">
                                                ${formattedTotalActual}
                                            </span>
                                            <span class="text-gray-500">
                                                ${achievementPercentage.toFixed(1)}%
                                            </span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                            <div
                                                class="bg-green-500 h-2.5 rounded-full"
                                                style="width: ${Math.min(achievementPercentage, 100)}%;"
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');
}
</script>


<script>
// DEBUG + FILTER: Fiscal Year filter based on rendered DOM, with console logging
(function () {
    console.log('[TargetFilterDebug] Script loaded');

    function rebuildFiscalFilter() {
        try {
            const container = document.getElementById('target-list-container');
            const select = document.getElementById('target-year-filter');
            console.log('[TargetFilterDebug] rebuildFiscalFilter called', {
                hasContainer: !!container,
                hasSelect: !!select
            });
            if (!container || !select) return;

            // Find all group cards inside target-list-container
            const groups = Array.from(container.querySelectorAll(':scope > div'));
            console.log('[TargetFilterDebug] group cards found:', groups.length);

            const yearsSet = new Set();

            groups.forEach(group => {
                const titleEl = group.querySelector('h4');
                if (!titleEl) return;
                const text = titleEl.textContent || '';
                const match = text.match(/Tahun\s+Fiskal\s+(\d{4})\s*\/\s*(\d{4})/i);
                if (match) {
                    const year = parseInt(match[1], 10);
                    group.dataset.fiscalYear = String(year);
                    yearsSet.add(year);
                    console.log('[TargetFilterDebug] parsed year for group:', { text, year });
                } else {
                    console.warn('[TargetFilterDebug] unable to parse fiscal year from title:', text);
                }
            });

            const years = Array.from(yearsSet).sort((a, b) => b - a);
            console.log('[TargetFilterDebug] distinct years:', years);

            // Populate select options
            const previousValue = select.value;
            select.innerHTML = '';
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = String(y);
                opt.textContent = `${y}/${y + 1}`;
                select.appendChild(opt);
            });

            if (!years.length) {
                console.warn('[TargetFilterDebug] no years detected from DOM, leaving select empty');
                return;
            }

            let activeYear = previousValue && years.includes(parseInt(previousValue, 10))
                ? parseInt(previousValue, 10)
                : years[0];
            select.value = String(activeYear);

            console.log('[TargetFilterDebug] activeYear set to:', activeYear);

            // Apply filtering
            groups.forEach(group => {
                const gy = parseInt(group.dataset.fiscalYear || '0', 10);
                const show = gy === activeYear;
                group.style.display = show ? '' : 'none';
            });
        } catch (e) {
            console.error('[TargetFilterDebug] Error in rebuildFiscalFilter:', e);
        }
    }

    function bindSelectIfNeeded() {
        const select = document.getElementById('target-year-filter');
        if (!select) {
            console.log('[TargetFilterDebug] #target-year-filter not found when binding');
            return;
        }
        if (select.dataset._bound === '1') return;
        select.addEventListener('change', function () {
            try {
                const selectedYear = parseInt(this.value, 10);
                console.log('[TargetFilterDebug] select changed:', selectedYear);
                const container = document.getElementById('target-list-container');
                if (!container) return;
                const groups = Array.from(container.querySelectorAll(':scope > div'));
                groups.forEach(group => {
                    const gy = parseInt(group.dataset.fiscalYear || '0', 10);
                    const show = gy === selectedYear;
                    group.style.display = show ? '' : 'none';
                });
            } catch (e) {
                console.error('[TargetFilterDebug] Error in select change handler:', e);
            }
        });
        select.dataset._bound = '1';
        console.log('[TargetFilterDebug] change handler bound to #target-year-filter');
    }

    // Wrap existing renderTargetPage so every render refreshes the filter
    const originalRenderTargetPage = window.renderTargetPage;
    window.renderTargetPage = function () {
        console.log('[TargetFilterDebug] renderTargetPage called with args:', arguments);
        let result;
        try {
            if (typeof originalRenderTargetPage === 'function') {
                result = originalRenderTargetPage.apply(this, arguments);
            }
        } catch (e) {
            console.error('[TargetFilterDebug] Error inside original renderTargetPage:', e);
        }
        // After original render, rebuild filter
        rebuildFiscalFilter();
        bindSelectIfNeeded();
        return result;
    };

    document.addEventListener('DOMContentLoaded', function () {
        console.log('[TargetFilterDebug] DOMContentLoaded');
        try {
            rebuildFiscalFilter();
            bindSelectIfNeeded();
        } catch (e) {
            console.error('[TargetFilterDebug] Error during DOMContentLoaded init:', e);
        }
    });

    // As extra safety, observe DOM changes inside target-list-container
    const mo = new MutationObserver(() => {
        console.log('[TargetFilterDebug] MutationObserver detected change, rebuilding filter');
        rebuildFiscalFilter();
        bindSelectIfNeeded();
    });
    window.addEventListener('load', function () {
        const container = document.getElementById('target-list-container');
        if (container) {
            mo.observe(container, { childList: true, subtree: true });
            console.log('[TargetFilterDebug] MutationObserver attached to #target-list-container');
        } else {
            console.log('[TargetFilterDebug] container not found on load, observer not attached');
        }
    });
})();

    // === Export Insentif per Varietas ke PDF ===
    function exportInsentifToPDF() {
        const yearSelect = document.getElementById('insentif-year-filter');
        const distSelect = document.getElementById('insentif-distributor-filter');

        if (!yearSelect || !yearSelect.value) {
            if (typeof showToast === 'function') showToast('Pilih tahun fiskal terlebih dahulu.', 'info');
            return;
        }

        const year = parseInt(yearSelect.value, 10);
        const distributorId = distSelect && distSelect.value && distSelect.value !== '' ? parseInt(distSelect.value, 10) : null;

        const varietyRows = typeof getInsentifVarietyRows === 'function'
            ? getInsentifVarietyRows(year, distributorId)
            : [];

        if (!varietyRows.length) {
            if (typeof showToast === 'function') showToast('Tidak ada data insentif untuk filter ini.', 'info');
            return;
        }

        if (!window.jspdf || !window.jspdf.jsPDF) {
            if (typeof showToast === 'function') showToast('jsPDF belum tersedia di halaman.', 'error');
            return;
        }

        var jsPDF = window.jspdf.jsPDF;
        var doc = new jsPDF('l', 'pt', 'a4');

        var title = distributorId
            ? 'Insentif per Varietas - ' + year + '/' + (year + 1)
            : 'Insentif per Varietas - Semua Distributor - ' + year + '/' + (year + 1);

        doc.setFontSize(14);
        doc.text(title, 40, 40);

        var head = [[
            'Distributor',
            'Varietas',
            'Target Kg',
            'Realisasi Kg',
            '% Pencapaian',
            'Qty 80%',
            'Nominal 80% (Rp)',
            'Qty 90%',
            'Nominal 90% (Rp)',
            'Qty 101%',
            'Nominal 101% (Rp)',
            '% Insentif',
            'Nilai Insentif (Rp)'
        ]];

        var body = varietyRows.map(function(r) {
            return [
                r.distributorName,
                r.varietyName,
                (r.totalTargetKg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 }),
                (r.totalActualKg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 }),
                r.achievement.toFixed(2) + ' %',
                (r.qty80Kg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 }),
                (r.lvl80Nominal || 0).toLocaleString('id-ID'),
                (r.qty90Kg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 }),
                (r.lvl90Nominal || 0).toLocaleString('id-ID'),
                (r.qty101Kg || 0).toLocaleString('id-ID', { maximumFractionDigits: 2 }),
                (r.lvl101Nominal || 0).toLocaleString('id-ID'),
                (r.rate * 100).toFixed(2) + ' %',
                (r.incentive || 0).toLocaleString('id-ID')
            ];
        });

        if (doc.autoTable) {
            doc.autoTable({
                startY: 60,
                head: head,
                body: body,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [37, 99, 235] },
                alternateRowStyles: { fillColor: [248, 250, 252] }
            });
        }

        doc.save('Insentif_Varietas_' + year + '.pdf');
    }

</script>

<script>
        try {
            if (typeof XLSX === 'undefined') {
                alert('Library Excel (XLSX) belum dimuat.');
                return;
            }

            var wb = XLSX.utils.book_new();
            var header = ['Distributor', 'Tahun Fiskal', 'Varietas', 'Satuan', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

            var sampleRows = [];
            try {
                if (window.appState && Array.isArray(appState.distributors) && appState.distributors.length && Array.isArray(appState.varieties) && appState.varieties.length) {
                    var dist = appState.distributors[0].name;
                    var year = (typeof getFiscalYear === 'function') ? getFiscalYear(new Date()) : (new Date()).getFullYear();
                    var variety = appState.varieties[0].name;
                    sampleRows.push([dist, year, variety, 'nominal', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                } else {
                    sampleRows.push(['Contoh Distributor', '2024', 'Contoh Varietas', 'nominal', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                }
            } catch (e) {
                sampleRows.push(['Contoh Distributor', '2024', 'Contoh Varietas', 'nominal', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
            }

            var wsData = [header].concat(sampleRows);
            var ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Target');

            var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            var blob = new Blob([wbout], { type: 'application/octet-stream' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'template-target-penjualan.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (typeof showToast === 'function') {
                showToast('Template Excel target berhasil di-download.', 'success');
            }
        } catch (error) {
            console.error('Gagal membuat template target:', error);
            if (typeof showToast === 'function') {
                showToast('Gagal membuat template Excel target.', 'error');
            } else {
                alert('Gagal membuat template Excel target.');
            }
        }
    }

    function importTargetsFromSheet(workbook) {
        if (!window.appState) {
            console.error('appState belum siap');
            return;
        }

        var sheetName = workbook.SheetNames[0];
        var ws = workbook.Sheets[sheetName];
        var rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

        if (!rows || rows.length < 2) {
            if (typeof showToast === 'function') {
                showToast('File Excel tidak berisi data.', 'error');
            }
            return;
        }

        var header = rows[0].map(function (h) { return String(h || '').trim().toLowerCase(); });

        function findIdx(keyword) {
            return header.findIndex(function (h) { return h.indexOf(keyword) !== -1; });
        }

        var idxDist = findIdx('distributor');
        var idxYear = findIdx('tahun');
        if (idxYear === -1) idxYear = findIdx('fiskal');
        var idxVar = findIdx('varietas');
        if (idxVar === -1) idxVar = findIdx('crop');
        if (idxVar === -1) idxVar = findIdx('produk');
        var idxUnit = findIdx('satuan');
        if (idxUnit === -1) idxUnit = findIdx('unit');

        var monthKeys = ['apr', 'mei', 'jun', 'jul', 'agu', 'sep', 'okt', 'nov', 'des', 'jan', 'feb', 'mar'];
        var monthIdx = monthKeys.map(function (key) {
            return header.findIndex(function (h) { return h.indexOf(key) !== -1; });
        });

        if (idxDist === -1 || idxYear === -1 || idxVar === -1 || idxUnit === -1 || monthIdx.some(function (i) { return i === -1; })) {
            if (typeof showToast === 'function') {
                showToast('Header kolom tidak lengkap. Minimal harus ada: Distributor, Tahun Fiskal, Varietas, Satuan, Apr s/d Mar.', 'error');
            }
            return;
        }

        var imported = [];
        var skipped = 0;

        for (var i = 1; i < rows.length; i++) {
            var row = rows[i];
            if (!row || row.length === 0) continue;

            var distName = String(row[idxDist] || '').trim();
            var yearCell = row[idxYear];
            var varName = String(row[idxVar] || '').trim();
            var unitRaw = String(row[idxUnit] || '').trim().toLowerCase();

            if (!distName || !yearCell || !varName) continue;

            var distributor = (appState.distributors || []).find(function (d) {
                return String(d.name || '').trim().toLowerCase() === distName.toLowerCase();
            });

            var variety = (appState.varieties || []).find(function (v) {
                return String(v.name || '').trim().toLowerCase() === varName.toLowerCase();
            });

            var yearMatch = String(yearCell).match(/(\d{4})/);
            var year = yearMatch ? parseInt(yearMatch[1], 10) : parseInt(yearCell, 10);

            var unit = 'nominal';
            if (unitRaw.indexOf('kg') !== -1) unit = 'kg';
            else if (unitRaw.indexOf('pc') !== -1) unit = 'pcs';
            else if (unitRaw.indexOf('nom') !== -1 || unitRaw.indexOf('rp') !== -1) unit = 'nominal';

            if (!distributor || !variety || !year || isNaN(year)) {
                skipped++;
                continue;
            }

            var monthlyTargets = monthIdx.map(function (idx) {
                var val = row[idx];
                if (typeof val === 'number') return val;
                if (val == null) return 0;
                var cleaned = String(val).replace(/[^0-9,.-]/g, '').replace(',', '.');
                var num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            });

            if (!Array.isArray(appState.targets)) appState.targets = [];
            var exists = appState.targets.some(function (t) {
                return t.distributorId === distributor.id &&
                       t.year === year &&
                       t.varietyId === variety.id &&
                       t.unit === unit;
            });

            if (exists) {
                skipped++;
                continue;
            }

            imported.push({
                id: Date.now() + Math.random(),
                distributorId: distributor.id,
                year: year,
                varietyId: variety.id,
                unit: unit,
                monthlyTargets: monthlyTargets
            });
        }

        if (!imported.length) {
            if (typeof showToast === 'function') {
                showToast('Tidak ada baris target baru yang bisa diimport.', 'info');
            }
            return;
        }

        if (!Array.isArray(appState.targets)) appState.targets = [];
        appState.targets = appState.targets.concat(imported);

        if (typeof saveData === 'function') {
            saveData();
        }
        if (typeof renderTargetPage === 'function') {
            renderTargetPage();
        }

        if (typeof showToast === 'function') {
            var extra = skipped ? ' (' + skipped + ' baris dilewati)' : '';
            showToast('Berhasil import ' + imported.length + ' target.' + extra, 'success');
        }
    }

    function setupTargetImportButtons() {

        if (importBtn && importInput && !importBtn._listenerAttached) {
            importBtn.onclick = function () {
                importInput.click();
            };

            importInput.onchange = function (e) {
                var file = e.target.files && e.target.files[0];
                if (!file) return;

                var reader = new FileReader();
                reader.onload = function (evt) {
                    try {
                        var data = new Uint8Array(evt.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        importTargetsFromSheet(wb);
                    } catch (err) {
                        console.error('Error baca Excel target:', err);
                        if (typeof showToast === 'function') {
                            showToast('Gagal membaca file Excel target.', 'error');
                        } else {
                            alert('Gagal membaca file Excel target.');
                        }
                    } finally {
                        importInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            importBtn._listenerAttached = true;
        }
    }

    document.addEventListener('DOMContentLoaded', setupTargetImportButtons);
</script>
<script>
    function downloadTargetTemplateCurrentSelection() {
        try {
            if (typeof XLSX === 'undefined') {
                alert('Library Excel (XLSX) belum dimuat.');
                return;
            }

            var distSelect = document.getElementById('target-distributor');
            var yearSelect = document.getElementById('target-year');
            var unitSelect = document.getElementById('target-unit');

            if (!distSelect || !yearSelect || !unitSelect) {
                alert('Form target belum siap.');
                return;
            }

            var distName = distSelect.options[distSelect.selectedIndex]?.text || 'Distributor';
            var yearVal = yearSelect.value || '';
            var unitVal = unitSelect.value || 'nominal';

            var wb = XLSX.utils.book_new();
            var header = ['Varietas', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];

            var rows = [];
            try {
                if (window.appState && Array.isArray(appState.varieties) && appState.varieties.length) {
                    appState.varieties.forEach(function (v) {
                        rows.push([v.name, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                    });
                } else {
                    rows.push(['Contoh Varietas', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                }
            } catch (e) {
                rows.push(['Contoh Varietas', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
            }

            var wsData = [header].concat(rows);
            var ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Target');

            var safeDist = String(distName).replace(/[^a-z0-9]+/gi, '_');
            var safeYear = String(yearVal).replace(/[^0-9]+/g, '');
            var safeUnit = String(unitVal).replace(/[^a-z0-9]+/gi, '_');

            var fileName = 'template-target-' + safeDist + '-' + (safeYear || 'tahun') + '-' + safeUnit + '.xlsx';

            var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            var blob = new Blob([wbout], { type: 'application/octet-stream' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (typeof showToast === 'function') {
                showToast('Template Excel target (berdasarkan distributor & tahun terpilih) berhasil di-download.', 'success');
            }
        } catch (error) {
            console.error('Gagal membuat template target (modal):', error);
            if (typeof showToast === 'function') {
                showToast('Gagal membuat template Excel target (modal).', 'error');
            } else {
                alert('Gagal membuat template Excel target (modal).');
            }
        }
    }

    function importTargetsFromModalSheet(workbook) {
        if (!window.appState) {
            console.error('appState belum siap');
            return;
        }

        var distSelect = document.getElementById('target-distributor');
        var yearSelect = document.getElementById('target-year');
        var unitSelect = document.getElementById('target-unit');

        if (!distSelect || !yearSelect || !unitSelect) {
            if (typeof showToast === 'function') {
                showToast('Form target belum siap.', 'error');
            } else {
                alert('Form target belum siap.');
            }
            return;
        }

        var sheetName = workbook.SheetNames[0];
        var ws = workbook.Sheets[sheetName];
        var rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

        if (!rows || rows.length < 2) {
            if (typeof showToast === 'function') {
                showToast('File Excel tidak berisi data.', 'error');
            } else {
                alert('File Excel tidak berisi data.');
            }
            return;
        }

        var header = rows[0].map(function (h) { return String(h || '').trim().toLowerCase(); });

        function findIdx(keyword) {
            return header.findIndex(function (h) { return h.indexOf(keyword) !== -1; });
        }

        var idxVar = findIdx('varietas');
        if (idxVar === -1) idxVar = findIdx('crop');
        if (idxVar === -1) idxVar = findIdx('produk');

        var monthKeys = ['apr', 'mei', 'jun', 'jul', 'agu', 'sep', 'okt', 'nov', 'des', 'jan', 'feb', 'mar'];
        var monthIdx = monthKeys.map(function (key) {
            return header.findIndex(function (h) { return h.indexOf(key) !== -1; });
        });

        if (idxVar === -1 || monthIdx.some(function (i) { return i === -1; })) {
            if (typeof showToast === 'function') {
                showToast('Header kolom tidak lengkap. Minimal harus ada: Varietas, Apr s/d Mar.', 'error');
            } else {
                alert('Header kolom tidak lengkap. Minimal harus ada: Varietas, Apr s/d Mar.');
            }
            return;
        }

        var itemsForForm = [];
        var usedVarietyIds = {};

        for (var i = 1; i < rows.length; i++) {
            var row = rows[i];
            if (!row || row.length === 0) continue;

            var varName = String(row[idxVar] || '').trim();
            if (!varName) continue;

            var variety = (appState.varieties || []).find(function (v) {
                return String(v.name || '').trim().toLowerCase() === varName.toLowerCase();
            });

            if (!variety) {
                continue; // varietas di Excel tidak ditemukan di master, dilewati
            }

            if (usedVarietyIds[variety.id]) {
                continue; // duplikat varietas dalam file, pakai baris pertama saja
            }

            var monthlyTargets = monthIdx.map(function (idx) {
                var val = row[idx];
                if (typeof val === 'number') return val;
                if (val == null) return 0;
                var cleaned = String(val).replace(/[^0-9,.-]/g, '').replace(',', '.');
                var num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            });

            usedVarietyIds[variety.id] = true;
            itemsForForm.push({
                varietyId: variety.id,
                monthlyTargets: monthlyTargets
            });
        }

        if (!itemsForForm.length) {
            if (typeof showToast === 'function') {
                showToast('Tidak ada data varietas yang valid di file Excel.', 'info');
            } else {
                alert('Tidak ada data varietas yang valid di file Excel.');
            }
            return;
        }

        var container = document.getElementById('target-items-container');
        if (!container) {
            console.error('Container target-items-container tidak ditemukan.');
            return;
        }

        container.innerHTML = '';
        itemsForForm.forEach(function (item) {
            addTargetItem(item.varietyId, item.monthlyTargets);
        });

        if (typeof showToast === 'function') {
            showToast('Data Excel berhasil dimuat ke formulir. Silakan periksa dan klik "Simpan Target".', 'success');
        }
}
function setupTargetModalImportButtons() {
        var importBtn = document.getElementById('target-modal-import-button');
        var importInput = document.getElementById('target-modal-import-input');

        if (importBtn && importInput && !importBtn._listenerAttached) {
            importBtn.onclick = function () {
                importInput.click();
            };

            importInput.onchange = function (e) {
                var file = e.target.files && e.target.files[0];
                if (!file) return;

                var reader = new FileReader();
                reader.onload = function (evt) {
                    try {
                        var data = new Uint8Array(evt.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        importTargetsFromModalSheet(wb);
                    } catch (err) {
                        console.error('Error baca Excel target (modal):', err);
                        if (typeof showToast === 'function') {
                            showToast('Gagal membaca file Excel target (modal).', 'error');
                        } else {
                            alert('Gagal membaca file Excel target (modal).');
                        }
                    } finally {
                        importInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            importBtn._listenerAttached = true;
        }
    }

    document.addEventListener('DOMContentLoaded', setupTargetModalImportButtons);
</script>


<script>
    function parseExcelDateCell(val) {
        if (!val) return null;
        if (val instanceof Date) return val;

        if (typeof val === 'number') {
            var utcDays = Math.floor(val - 25569);
            var utcValue = utcDays * 86400;
            return new Date(utcValue * 1000);
        }

        if (typeof val === 'string') {
            var s = val.trim();
            if (!s) return null;

            var m1 = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (m1) {
                return new Date(parseInt(m1[1], 10), parseInt(m1[2], 10) - 1, parseInt(m1[3], 10));
            }

            var m2 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
            if (m2) {
                return new Date(parseInt(m2[3], 10), parseInt(m2[2], 10) - 1, parseInt(m2[1], 10));
            }
        }

        return null;
    }

    function parseNumericCell(val) {
        if (typeof val === 'number') return val;
        if (val == null) return 0;
        var cleaned = String(val).replace(/[^0-9,.-]/g, '').replace(',', '.');
        var num = parseFloat(cleaned);
        return isNaN(num) ? 0 : num;
    }

    function importPOReleaseFromSheet(workbook) {
        if (!window.appState) {
            console.error('appState belum siap');
            return;
        }

        var sheetName = workbook.SheetNames[0];
        var ws = workbook.Sheets[sheetName];
        var rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

        if (!rows || rows.length < 2) {
            if (typeof showToast === 'function') {
                showToast('File Excel tidak berisi data.', 'error');
            } else {
                alert('File Excel tidak berisi data.');
            }
            return;
        }

        var header = rows[0].map(function (h) { return String(h || '').trim().toLowerCase(); });

        function findIdx(keyword) {
            return header.findIndex(function (h) { return h.indexOf(keyword) !== -1; });
        }

        var idxDist       = findIdx('distributor');
        var idxNoPO       = findIdx('no po');
        var idxTglPO      = findIdx('tanggal po');
        var idxTglRelease = (function () {
            var i = findIdx('tgl release');
            if (i === -1) i = findIdx('tanggal release');
            return i;
        })();
        var idxVar        = (function () {
            var i = findIdx('varietas');
            if (i === -1) i = findIdx('crop');
            if (i === -1) i = findIdx('produk');
            return i;
        })();
        var idxQty        = findIdx('qty');
        var idxHarga      = findIdx('harga');

        if (idxDist === -1 || idxTglRelease === -1 || idxVar === -1 || idxQty === -1) {
            if (typeof showToast === 'function') {
                showToast('Header kolom minimal: Distributor, Tanggal Release, Varietas, Qty.', 'error');
            } else {
                alert('Header kolom minimal: Distributor, Tanggal Release, Varietas, Qty.');
            }
            return;
        }

        var imported = 0;
        var skipped = 0;

        for (var i = 1; i < rows.length; i++) {
            var row = rows[i];
            if (!row || row.length === 0) continue;

            var distName = String(row[idxDist] || '').trim();
            var varName  = String(row[idxVar] || '').trim();
            if (!distName || !varName) {
                skipped++;
                continue;
            }

            var distributor = (appState.distributors || []).find(function (d) {
                return String(d.name || '').trim().toLowerCase() === distName.toLowerCase();
            });
            var variety = (appState.varieties || []).find(function (v) {
                return String(v.name || '').trim().toLowerCase() === varName.toLowerCase();
            });

            if (!distributor || !variety) {
                skipped++;
                continue;
            }

            var qtyVal = parseNumericCell(row[idxQty]);
            if (!qtyVal || qtyVal <= 0) {
                skipped++;
                continue;
            }

            var priceVal = idxHarga >= 0 ? parseNumericCell(row[idxHarga]) : (variety.price || 0);
            if (!priceVal || priceVal < 0) priceVal = variety.price || 0;

            var releaseDateCell = row[idxTglRelease];
            var releaseDateObj = parseExcelDateCell(releaseDateCell);
            if (!releaseDateObj) {
                skipped++;
                continue;
            }
            releaseDateObj.setHours(0, 0, 0, 0);
            var releaseDateISO = releaseDateObj.toISOString();

            var poDateStr = releaseDateISO.split('T')[0];

            var poNumberRaw = idxNoPO >= 0 ? String(row[idxNoPO] || '').trim() : '';
            var poDateCell  = idxTglPO >= 0 ? row[idxTglPO] : null;
            var poDateObj   = parseExcelDateCell(poDateCell) || releaseDateObj;
            poDateStr = poDateObj.toISOString().split('T')[0];

            var existingPO = null;
            if (poNumberRaw) {
                existingPO = (appState.purchaseOrders || []).find(function (p) {
                    return p.distributorId === distributor.id &&
                           String(p.poNumber || '').trim().toLowerCase() === poNumberRaw.toLowerCase();
                });
            }

            if (!existingPO) {
                var newId = Date.now() + Math.random();
                var newPONumber = poNumberRaw || generatePONumber();

                existingPO = {
                    id: newId,
                    distributorId: distributor.id,
                    poNumber: newPONumber,
                    poDate: poDateStr,
                    notes: 'Import Excel Release',
                    items: [],
                    totalAmount: 0,
                    status: 'Draft',
                    _importedFromExcel: true
                };

                if (!Array.isArray(appState.purchaseOrders)) {
                    appState.purchaseOrders = [];
                }
                appState.purchaseOrders.push(existingPO);
            }

            var item = existingPO.items.find(function (it) { return it.varietyId === variety.id; });
            if (!item) {
                item = {
                    varietyId: variety.id,
                    name: variety.name,
                    qty: 0,
                    price: priceVal,
                    weight: variety.weight || 0,
                    amount: 0,
                    releases: []
                };
                existingPO.items.push(item);
            }

            if (!Array.isArray(item.releases)) item.releases = [];

            if (existingPO._importedFromExcel) {
                item.qty = (item.qty || 0) + qtyVal;
            }

            item.releases.push({ qty: qtyVal, date: releaseDateISO });

            imported++;
        }

        if (Array.isArray(appState.purchaseOrders)) {
            appState.purchaseOrders.forEach(function (po, idx) {
                po.totalAmount = (po.items || []).reduce(function (sum, it) {
                    return sum + (Number(it.qty || 0) * Number(it.price || 0));
                }, 0);

                if (typeof updatePOStatusFromItems === 'function') {
                    updatePOStatusFromItems(idx);
                }
            });
        }

        if (typeof saveData === 'function') {
            saveData();
        }
        if (typeof refreshUI === 'function') {
            refreshUI();
        }

        if (typeof showToast === 'function') {
            var extra = skipped ? ' (' + skipped + ' baris dilewati)' : '';
            showToast('Berhasil import ' + imported + ' baris release PO.' + extra, 'success');
        }
    }

    function setupPOReleaseImportButtons() {
        var importBtn = document.getElementById('po-release-import-button');
        var importInput = document.getElementById('po-release-import-input');

        if (importBtn && importInput && !importBtn._listenerAttached) {
            importBtn.onclick = function () {
                importInput.click();
            };

            importInput.onchange = function (e) {
                var file = e.target.files && e.target.files[0];
                if (!file) return;

                var reader = new FileReader();
                reader.onload = function (evt) {
                    try {
                        var data = new Uint8Array(evt.target.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        importPOReleaseFromSheet(wb);
                    } catch (err) {
                        console.error('Error baca Excel release PO:', err);
                        if (typeof showToast === 'function') {
                            showToast('Gagal membaca file Excel release PO.', 'error');
                        } else {
                            alert('Gagal membaca file Excel release PO.');
                        }
                    } finally {
                        importInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            importBtn._listenerAttached = true;
        }
    }

    function downloadPOReleaseTemplate() {
        try {
            if (typeof XLSX === 'undefined') {
                alert('Library Excel (XLSX) belum dimuat.');
                return;
            }

            var wb = XLSX.utils.book_new();
            var header = [
                'Distributor',
                'No PO (Opsional)',
                'Tanggal PO',
                'Tanggal Release',
                'Varietas',
                'Qty',
                'Harga Satuan (Rp)'
            ];

            var sampleRows = [];

            try {
                if (window.appState &&
                    Array.isArray(appState.distributors) && appState.distributors.length &&
                    Array.isArray(appState.varieties) && appState.varieties.length) {

                    var dist = appState.distributors[0].name;
                    var variety = appState.varieties[0].name;
                    var today = new Date();
                    var y = today.getFullYear();
                    var m = String(today.getMonth() + 1).padStart(2, '0');
                    var d = String(today.getDate()).padStart(2, '0');
                    var dateStr = y + '-' + m + '-' + d;

                    sampleRows.push([
                        dist,
                        'PO-EXAMPLE-001',
                        dateStr,
                        dateStr,
                        variety,
                        100,
                        appState.varieties[0].price || 0
                    ]);
                } else {
                    sampleRows.push([
                        'Contoh Distributor',
                        'PO-EXAMPLE-001',
                        '2024-04-01',
                        '2024-04-15',
                        'Contoh Varietas',
                        100,
                        100000
                    ]);
                }
            } catch (e) {
                sampleRows.push([
                    'Contoh Distributor',
                    'PO-EXAMPLE-001',
                    '2024-04-01',
                    '2024-04-15',
                    'Contoh Varietas',
                    100,
                    100000
                ]);
            }

            var wsData = [header].concat(sampleRows);
            var ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Release');

            var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            var blob = new Blob([wbout], { type: 'application/octet-stream' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'template-release-po.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (typeof showToast === 'function') {
                showToast('Template Excel release PO berhasil di-download.', 'success');
            }
        } catch (error) {
            console.error('Gagal membuat template release PO:', error);
            if (typeof showToast === 'function') {
                showToast('Gagal membuat template release PO.', 'error');
            } else {
                alert('Gagal membuat template release PO.');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (typeof setupPOReleaseImportButtons === 'function') {
            setupPOReleaseImportButtons();
        }
        
        // Check if URL has ?page=public-dga parameter
        checkPublicDGARoute();
    });
</script>

<script>
// === PUBLIC DGA FORM FUNCTIONS ===
let publicActivityCounter = 0;

function checkPublicDGARoute() {
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page');
    
    if (page === 'public-dga') {
        // Show public DGA form only
        document.getElementById('public-dga-page').classList.remove('hidden');
        document.getElementById('loader').style.display = 'none';
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('app-container').classList.add('hidden');
        
        // Hide sidebar and overlay for public page
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        if (sidebar) sidebar.classList.add('hidden');
        if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
        
        // Initialize public form
        initPublicDGAForm();
    }
}

async function initPublicDGAForm() {
    // Get owner email from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const ownerEmail = urlParams.get('owner');
    
    if (!ownerEmail) {
        console.error('❌ No owner email in URL - cannot load BS');
        const bsSelect = document.getElementById('public-bs-select');
        if (bsSelect) bsSelect.innerHTML = '<option value="">-- Link tidak valid, hubungi admin --</option>';
        return;
    }
    
    console.log('📧 Public form owner:', ownerEmail);
    
    // Store owner email for later use
    window._publicFormOwnerEmail = ownerEmail;
    
    // Set default month to current month
    const monthInput = document.getElementById('public-month-input');
    if (monthInput) {
        const today = new Date();
        const currentMonth = today.toISOString().substr(0, 7);
        monthInput.value = currentMonth;
    }
    
    // Load BS list filtered by owner
    await loadPublicBSList(ownerEmail);
    
    // Setup realtime listener for BS updates filtered by owner
    setupPublicBSRealtimeListener(ownerEmail);
    
    // Add initial rows (W1-W5)
    for (let i = 1; i <= 5; i++) {
        addPublicBatchRow();
    }
    
    // Setup form submission
    const form = document.getElementById('public-dga-form');
    if (form) {
        form.addEventListener('submit', handlePublicBatchSubmit);
    }
}

let publicBSRealtimeUnsubscribe = null;

function setupPublicBSRealtimeListener(ownerEmail) {
    // Unsubscribe from previous listener if exists
    if (publicBSRealtimeUnsubscribe) {
        publicBSRealtimeUnsubscribe();
        console.log('🔌 Disconnected previous public BS listener');
    }
    
    if (!ownerEmail) {
        console.log('⚠️ No owner email, cannot setup public BS listener');
        return;
    }
    
    // Check if Firebase is available
    if (!window.db || !window.onSnapshot || !window.collection || !window.query || !window.where) {
        console.log('⚠️ Firestore not available for public form, realtime sync disabled');
        return;
    }
    
    try {
        const bsCollRef = window.collection(window.db, 'businessSolutions');
        const bsQuery = window.query(bsCollRef, window.where('ownerEmail', '==', ownerEmail));
        
        console.log('📡 Setting up realtime BS listener for public form, owner:', ownerEmail);
        
        publicBSRealtimeUnsubscribe = window.onSnapshot(bsQuery, (snapshot) => {
            const cloudBSList = [];
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                cloudBSList.push({
                    id: data.id || docSnap.id,
                    firestoreId: docSnap.id,
                    name: data.name,
                    ownerEmail: data.ownerEmail
                });
            });
            
            console.log('🔄 Public form: BS data updated:', cloudBSList.length, 'items for owner:', ownerEmail);
            
            // Update dropdown
            const bsSelect = document.getElementById('public-bs-select');
            if (bsSelect) {
                const sortedList = [...cloudBSList].sort((a, b) => a.name.localeCompare(b.name));
                const currentValue = bsSelect.value;
                
                bsSelect.innerHTML = '<option value="">-- Pilih Nama BS --</option>' +
                    sortedList.map(bs => `<option value="${bs.name}">${bs.name}</option>`).join('');
                
                // Restore selection if still valid
                if (currentValue && sortedList.some(bs => bs.name === currentValue)) {
                    bsSelect.value = currentValue;
                }
                
                console.log('✅ Public form dropdown updated with', cloudBSList.length, 'BS');
            }
            
            // Update status
            const statusIcon = document.getElementById('status-icon');
            const statusTitle = document.getElementById('status-title');
            const statusMessage = document.getElementById('status-message');
            
            if (statusIcon) statusIcon.innerHTML = '<svg class="w-8 h-8 text-green-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            if (statusTitle) {
                statusTitle.textContent = '🔄 Cloud Synced';
                statusTitle.className = 'text-sm font-bold text-green-700';
            }
            if (statusMessage) {
                statusMessage.textContent = `${cloudBSList.length} BS tersedia (realtime)`;
                statusMessage.className = 'text-xs text-green-600';
            }
            
        }, (error) => {
            console.error('❌ Public form realtime listener error:', error);
        });
        
        console.log('✅ Realtime BS listener activated for public form');
        
    } catch (error) {
        console.error('❌ Failed to setup realtime listener for public form:', error);
    }
}

async function loadPublicBSList(ownerEmail) {
    const bsSelect = document.getElementById('public-bs-select');
    if (!bsSelect) {
        console.error('public-bs-select element not found');
        return;
    }
    
    if (!ownerEmail) ownerEmail = window._publicFormOwnerEmail;
    
    // Update status UI
    const updateStatus = (icon, title, message, color = 'blue') => {
        const statusIcon = document.getElementById('status-icon');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        
        if (statusIcon) statusIcon.innerHTML = icon;
        if (statusTitle) {
            statusTitle.textContent = title;
            statusTitle.className = `text-sm font-bold text-${color}-700`;
        }
        if (statusMessage) statusMessage.textContent = message;
    };
    
    let bsList = [];
    
    console.log('Loading public BS list for owner:', ownerEmail, 'db available:', !!window.db);
    
    // Show loading
    updateStatus(
        '<div class="animate-spin rounded-full h-8 w-8 border-4 border-blue-200 border-t-blue-600"></div>',
        'Loading...',
        'Memuat daftar BS dari cloud...',
        'blue'
    );
    
    // Load from Firestore businessSolutions collection filtered by ownerEmail
    if (window.db && ownerEmail) {
        try {
            console.log('Attempting to load BS from Firestore collection for owner:', ownerEmail);
            const bsCollRef = window.collection(window.db, 'businessSolutions');
            const bsQuery = window.query(bsCollRef, window.where('ownerEmail', '==', ownerEmail));
            const snapshot = await window.getDocs(bsQuery);
            
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                bsList.push({
                    id: data.id || docSnap.id,
                    firestoreId: docSnap.id,
                    name: data.name,
                    ownerEmail: data.ownerEmail
                });
            });
            
            console.log('✅ Loaded BS list from Firestore:', bsList.length, 'items for owner:', ownerEmail);
            
            if (bsList.length > 0) {
                updateStatus(
                    '<svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                    '✅ Cloud Connected',
                    `Berhasil memuat ${bsList.length} BS`,
                    'green'
                );
            } else {
                updateStatus(
                    '<svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                    '⚠️ Tidak Ada Data',
                    'Belum ada BS terdaftar. Tambahkan BS dari aplikasi utama.',
                    'yellow'
                );
            }
        } catch (error) {
            console.error('❌ Error loading BS from Firestore:', error);
            updateStatus(
                '<svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                '❌ Firestore Error',
                `${error.code || 'Error'}: ${error.message}`,
                'red'
            );
        }
    } else {
        console.log('⚠️ Firestore not available or no owner email');
        updateStatus(
            '<svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            '⚠️ Error',
            ownerEmail ? 'Firestore tidak tersedia.' : 'Link tidak valid - tidak ada owner.',
            'orange'
        );
    }
    
    // Sort alphabetically
    bsList.sort((a, b) => a.name.localeCompare(b.name));
    
    // Populate dropdown
    if (bsList.length > 0) {
        bsSelect.innerHTML = '<option value="">-- Pilih Nama BS --</option>' +
            bsList.map(bs => `<option value="${bs.name}">${bs.name}</option>`).join('');
        console.log('BS dropdown populated with', bsList.length, 'entries');
    } else {
        bsSelect.innerHTML = '<option value="">-- Belum ada BS terdaftar --</option>';
        console.log('No BS available to populate');
    }
}

function addPublicBatchRow() {
    const tbody = document.getElementById('public-batch-tbody');
    if (!tbody) return;
    
    const rowCount = tbody.querySelectorAll('tr').length;
    const weekNum = (rowCount % 5) + 1;
    
    const weekColors = {
        1: 'bg-blue-50',
        2: 'bg-green-50',
        3: 'bg-yellow-50',
        4: 'bg-purple-50',
        5: 'bg-pink-50'
    };
    
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-100 transition-all';
    tr.innerHTML = `
        <td class="px-4 py-3 border-b ${weekColors[weekNum]}">
            <select class="week-select w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold text-sm min-w-[100px]">
                <option value="1" ${weekNum === 1 ? 'selected' : ''}>W1</option>
                <option value="2" ${weekNum === 2 ? 'selected' : ''}>W2</option>
                <option value="3" ${weekNum === 3 ? 'selected' : ''}>W3</option>
                <option value="4" ${weekNum === 4 ? 'selected' : ''}>W4</option>
                <option value="5" ${weekNum === 5 ? 'selected' : ''}>W5</option>
            </select>
        </td>
        <td class="px-3 py-3 border-b bg-blue-50">
            <input type="number" min="0" value="0" class="fm-input w-full px-2 py-2 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-center font-bold text-blue-900 bg-white text-sm">
        </td>
        <td class="px-3 py-3 border-b bg-green-50">
            <input type="number" min="0" value="0" class="odp-input w-full px-2 py-2 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 text-center font-bold text-green-900 bg-white text-sm">
        </td>
        <td class="px-3 py-3 border-b bg-yellow-50">
            <input type="number" min="0" value="0" class="ft-input w-full px-2 py-2 border-2 border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 text-center font-bold text-yellow-900 bg-white text-sm">
        </td>
        <td class="px-3 py-3 border-b bg-purple-50">
            <input type="number" min="0" value="0" class="ffd-input w-full px-2 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-center font-bold text-purple-900 bg-white text-sm">
        </td>
        <td class="px-3 py-3 border-b bg-pink-50">
            <input type="number" min="0" value="0" class="display-input w-full px-2 py-2 border-2 border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-500 text-center font-bold text-pink-900 bg-white text-sm">
        </td>
        <td class="px-4 py-3 border-b">
            <input type="text" class="desc-input w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 text-sm bg-white" placeholder="Keterangan">
        </td>
        <td class="px-3 py-3 border-b text-center">
            <button type="button" onclick="removePublicBatchRow(this)" class="p-2 text-red-500 hover:text-white hover:bg-red-500 rounded-lg transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </td>
    `;
    
    tbody.appendChild(tr);
}

function removePublicBatchRow(btn) {
    const tr = btn.closest('tr');
    if (tr) tr.remove();
}

function clearPublicBatchForm() {
    if (confirm('Yakin ingin mereset form? Semua data akan hilang.')) {
        document.getElementById('public-dga-form').reset();
        document.getElementById('public-batch-tbody').innerHTML = '';
        
        // Reset month to current
        const monthInput = document.getElementById('public-month-input');
        const today = new Date();
        monthInput.value = today.toISOString().substr(0, 7);
        
        // Re-add initial rows
        for (let i = 1; i <= 5; i++) {
            addPublicBatchRow();
        }
    }
}

function showPublicToast(message, type = 'success') {
    const container = document.getElementById('toast-container-public');
    
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    
    const icons = {
        success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
        error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
        info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
    };
    
    const toast = document.createElement('div');
    toast.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 mb-3`;
    toast.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${icons[type]}
        </svg>
        <span class="font-semibold">${message}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100px)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

async function handlePublicBatchSubmit(e) {
    e.preventDefault();
    
    showPublicToast('⏳ Memproses data...', 'info');
    
    const bsName = document.getElementById('public-bs-select').value;
    const month = document.getElementById('public-month-input').value;
    
    if (!bsName) {
        showPublicToast('Mohon pilih nama BS terlebih dahulu!', 'error');
        return;
    }
    
    if (!month) {
        showPublicToast('Mohon pilih bulan terlebih dahulu!', 'error');
        return;
    }
    
    const tbody = document.getElementById('public-batch-tbody');
    const rows = tbody.querySelectorAll('tr');
    
    if (rows.length === 0) {
        showPublicToast('Mohon tambahkan minimal 1 baris data!', 'error');
        return;
    }
    
    // Get BS ID and owner email from URL param and Firestore collection
    let bsId = null;
    const ownerEmail = window._publicFormOwnerEmail || null;
    
    if (!ownerEmail) {
        showPublicToast('❌ Link tidak valid - tidak ada informasi pemilik BS.', 'error');
        console.error('❌ Cannot save: ownerEmail not found in URL');
        return;
    }
    
    try {
        if (window.db && window.collection && window.query && window.where && window.getDocs) {
            const bsCollRef = window.collection(window.db, 'businessSolutions');
            const bsQuery = window.query(bsCollRef, window.where('ownerEmail', '==', ownerEmail), window.where('name', '==', bsName));
            const snapshot = await window.getDocs(bsQuery);
            
            if (!snapshot.empty) {
                const bsDoc = snapshot.docs[0];
                bsId = bsDoc.data().id || bsDoc.id;
                console.log('📧 BS found, owner email:', ownerEmail, 'bsId:', bsId);
            } else {
                bsId = Date.now();
                console.log('⚠️ BS not found in collection, using temp ID');
            }
        }
    } catch (e) {
        console.error('Error finding BS ID:', e);
        bsId = Date.now();
    }
    
    const newActivities = [];
    const activityTypes = [
        { class: 'fm-input', type: 'FM' },
        { class: 'odp-input', type: 'ODP' },
        { class: 'ft-input', type: 'FT' },
        { class: 'ffd-input', type: 'FFD' },
        { class: 'display-input', type: 'DISPLAY' }
    ];
    
    rows.forEach(row => {
        const week = row.querySelector('.week-select').value;
        const description = row.querySelector('.desc-input').value.trim();
        
        activityTypes.forEach(({ class: className, type }) => {
            const input = row.querySelector('.' + className);
            const count = parseInt(input.value) || 0;
            
            if (count > 0) {
                // Create activity with proper structure - INCLUDE ownerEmail for data isolation
                const activity = {
                    id: Date.now() + Math.random(),
                    month: month,
                    week: parseInt(week),
                    bsId: bsId,
                    bsName: bsName,
                    type: type,
                    count: count,
                    description: description,
                    timestamp: new Date().toISOString(),
                    source: 'public-form',
                    ownerEmail: ownerEmail // Track who owns this BS for data security
                };
                
                newActivities.push(activity);
            }
        });
    });
    
    if (newActivities.length === 0) {
        showPublicToast('Mohon isi minimal 1 kegiatan dengan jumlah > 0!', 'error');
        return;
    }
    
    console.log('📤 Saving', newActivities.length, 'activities to Firestore...');
    
    // Save to Firestore for cross-device sync
    try {
        if (window.db && window.addDoc && window.collection) {
            const activitiesRef = window.collection(window.db, 'dgaActivities');
            
            // Save each activity
            for (const activity of newActivities) {
                await window.addDoc(activitiesRef, activity);
                console.log('✅ Activity saved:', activity.type, 'Week', activity.week);
            }
            
            showPublicToast(`✅ Berhasil menyimpan ${newActivities.length} kegiatan ke cloud!`, 'success');
            
            setTimeout(() => {
                clearPublicBatchForm();
                showPublicToast('Form direset, data sudah tersinkronisasi!', 'info');
            }, 1500);
            
        } else {
            // Fallback to localStorage if Firestore not available
            console.warn('⚠️ Firestore not available, saving to localStorage');
            
            let dgaData = [];
            try {
                const existingData = localStorage.getItem('advanta_dga_activities');
                if (existingData) dgaData = JSON.parse(existingData);
            } catch (e) {
                console.error('Error reading localStorage:', e);
            }
            
            dgaData.push(...newActivities);
            localStorage.setItem('advanta_dga_activities', JSON.stringify(dgaData));
            
            showPublicToast(`✅ Berhasil menyimpan ${newActivities.length} kegiatan (lokal)!`, 'success');
            
            setTimeout(() => {
                clearPublicBatchForm();
                refreshPublicDataDisplay();
                showPublicToast('Form direset!', 'info');
            }, 1500);
        }
    } catch (e) {
        console.error('❌ Error saving activities:', e);
        showPublicToast('❌ Gagal menyimpan data. Mohon coba lagi.', 'error');
    }
}

// Toggle instructions visibility
function togglePublicInstructions() {
    const content = document.getElementById('public-instructions-content');
    const icon = document.getElementById('instructions-toggle-icon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
    } else {
        content.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

// Refresh and display submitted data
async function refreshPublicDataDisplay() {
    console.log('🔄 Refreshing public data display...');
    
    const tbody = document.getElementById('public-data-display-tbody');
    if (!tbody) return;
    
    const summaryElements = {
        fm: document.getElementById('public-summary-fm'),
        odp: document.getElementById('public-summary-odp'),
        ft: document.getElementById('public-summary-ft'),
        ffd: document.getElementById('public-summary-ffd'),
        display: document.getElementById('public-summary-display')
    };
    
    // Show loading
    tbody.innerHTML = `<tr>
        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
            <div class="flex flex-col items-center gap-2">
                <div class="animate-spin rounded-full h-8 w-8 border-4 border-purple-200 border-t-purple-600"></div>
                <span>Memuat data...</span>
            </div>
        </td>
    </tr>`;
    
    let activities = [];
    
    // Try to load from Firestore
    if (window.db && window.getDocs && window.collection) {
        try {
            const activitiesRef = window.collection(window.db, 'dgaActivities');
            const snapshot = await window.getDocs(activitiesRef);
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.source === 'public-form') {
                    activities.push({
                        firestoreId: doc.id,
                        ...data
                    });
                }
            });
            
            console.log('✅ Loaded', activities.length, 'activities from Firestore');
        } catch (e) {
            console.error('❌ Error loading from Firestore:', e);
        }
    }
    
    // Fallback to localStorage
    if (activities.length === 0) {
        try {
            const localData = localStorage.getItem('advanta_dga_activities');
            if (localData) {
                const allData = JSON.parse(localData);
                activities = allData.filter(a => a.source === 'public-form');
            }
        } catch (e) {
            console.error('Error loading from localStorage:', e);
        }
    }
    
    // Calculate summary
    const summary = { FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0 };
    activities.forEach(act => {
        if (summary[act.type] !== undefined) {
            summary[act.type] += (act.count || 1);
        }
    });
    
    // Update summary cards
    if (summaryElements.fm) summaryElements.fm.textContent = summary.FM;
    if (summaryElements.odp) summaryElements.odp.textContent = summary.ODP;
    if (summaryElements.ft) summaryElements.ft.textContent = summary.FT;
    if (summaryElements.ffd) summaryElements.ffd.textContent = summary.FFD;
    if (summaryElements.display) summaryElements.display.textContent = summary.DISPLAY;
    
    // Group by BS Name (rekap format)
    const bsGroups = {};
    activities.forEach(act => {
        const bsName = act.bsName || 'Tidak Diketahui';
        if (!bsGroups[bsName]) {
            bsGroups[bsName] = { FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0, total: 0 };
        }
        const count = act.count || 1;
        if (bsGroups[bsName][act.type] !== undefined) {
            bsGroups[bsName][act.type] += count;
            bsGroups[bsName].total += count;
        }
    });
    
    // Render table
    if (Object.keys(bsGroups).length === 0) {
        tbody.innerHTML = `<tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center gap-2">
                    <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <span>Belum ada data yang diinput</span>
                </div>
            </td>
        </tr>`;
        
        // Clear footer
        const tfoot = document.getElementById('public-data-total-footer');
        if (tfoot) tfoot.innerHTML = '';
        
        return;
    }
    
    // Sort by total (descending)
    const sortedBS = Object.entries(bsGroups).sort((a, b) => b[1].total - a[1].total);
    
    // Render rows
    tbody.innerHTML = sortedBS.map(([bsName, counts], idx) => {
        const bgColor = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
        return `<tr class="hover:bg-purple-50 transition-colors ${bgColor}">
            <td class="px-4 py-4 font-bold text-gray-900 flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                ${bsName}
            </td>
            <td class="px-3 py-4 text-center">
                <span class="inline-block px-3 py-2 ${counts.FM > 0 ? 'bg-blue-100 text-blue-800 font-bold' : 'text-gray-400'} rounded-lg">${counts.FM}</span>
            </td>
            <td class="px-3 py-4 text-center">
                <span class="inline-block px-3 py-2 ${counts.ODP > 0 ? 'bg-green-100 text-green-800 font-bold' : 'text-gray-400'} rounded-lg">${counts.ODP}</span>
            </td>
            <td class="px-3 py-4 text-center">
                <span class="inline-block px-3 py-2 ${counts.FT > 0 ? 'bg-yellow-100 text-yellow-800 font-bold' : 'text-gray-400'} rounded-lg">${counts.FT}</span>
            </td>
            <td class="px-3 py-4 text-center">
                <span class="inline-block px-3 py-2 ${counts.FFD > 0 ? 'bg-purple-100 text-purple-800 font-bold' : 'text-gray-400'} rounded-lg">${counts.FFD}</span>
            </td>
            <td class="px-3 py-4 text-center">
                <span class="inline-block px-3 py-2 ${counts.DISPLAY > 0 ? 'bg-pink-100 text-pink-800 font-bold' : 'text-gray-400'} rounded-lg">${counts.DISPLAY}</span>
            </td>
            <td class="px-4 py-4 text-center">
                <span class="inline-block px-4 py-2 bg-orange-100 text-orange-900 font-black rounded-lg text-lg border-2 border-orange-300">${counts.total}</span>
            </td>
        </tr>`;
    }).join('');
    
    // Render footer with totals
    const tfoot = document.getElementById('public-data-total-footer');
    if (tfoot) {
        const grandTotal = summary.FM + summary.ODP + summary.FT + summary.FFD + summary.DISPLAY;
        tfoot.innerHTML = `
            <tr class="text-white font-bold">
                <td class="px-4 py-4 text-left flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    TOTAL KEGIATAN
                </td>
                <td class="px-3 py-4 text-center bg-blue-600">
                    <span class="inline-block px-3 py-2 bg-gray-900 rounded-lg text-xl font-black">${summary.FM}</span>
                </td>
                <td class="px-3 py-4 text-center bg-green-600">
                    <span class="inline-block px-3 py-2 bg-gray-900 rounded-lg text-xl font-black">${summary.ODP}</span>
                </td>
                <td class="px-3 py-4 text-center bg-yellow-600">
                    <span class="inline-block px-3 py-2 bg-gray-900 rounded-lg text-xl font-black">${summary.FT}</span>
                </td>
                <td class="px-3 py-4 text-center bg-purple-600">
                    <span class="inline-block px-3 py-2 bg-gray-900 rounded-lg text-xl font-black">${summary.FFD}</span>
                </td>
                <td class="px-3 py-4 text-center bg-pink-600">
                    <span class="inline-block px-3 py-2 bg-gray-900 rounded-lg text-xl font-black">${summary.DISPLAY}</span>
                </td>
                <td class="px-4 py-4 text-center bg-orange-600">
                    <span class="inline-block px-4 py-2 bg-gray-900 rounded-lg text-2xl font-black border-4 border-white">${grandTotal}</span>
                </td>
            </tr>
        `;
    }
    
    console.log('✅ Data display refreshed:', sortedBS.length, 'BS with', activities.length, 'total activities');
}

// Auto-refresh data display on page load
if (window.location.search.includes('page=public-dga')) {
    setTimeout(() => {
        refreshPublicDataDisplay();
    }, 2000);
}
</script>

<script>
// SUPER FINAL OVERRIDE: Target Page dengan filter Tahun Fiskal statis + Distributor
(function () {
    // Simpan fungsi asli
    const baseRenderTargetPage = window.renderTargetPage;

    window.renderTargetPage = function(selectedYear = null, selectedDistributorId = 'all') {
        const container = document.getElementById('target-list-container');

        // --- Setup dropdown Tahun & Distributor ---
        const years = [2023, 2024, 2025, 2026, 2027, 2028];

        const yearSelect = document.getElementById('target-year-filter');
        const distSelect = document.getElementById('target-distributor-filter');

        // Isi Tahun Fiskal
        if (yearSelect) {
            yearSelect.innerHTML = years
                .map(y => `<option value="${y}">${y}/${y + 1}</option>`)
                .join('');
        }

        // Tentukan Tahun aktif
        let activeYear = selectedYear;
        const selectedFromUI = yearSelect ? parseInt(yearSelect.value, 10) : NaN;
        if (activeYear == null || !years.includes(activeYear)) {
            if (!Number.isNaN(selectedFromUI) && years.includes(selectedFromUI)) {
                activeYear = selectedFromUI;
            } else {
                const today = new Date();
                const currentFY = (typeof getFiscalYear === 'function') ? getFiscalYear(today) : years[0];
                activeYear = years.includes(currentFY) ? currentFY : years[0];
            }
        }
        if (yearSelect) {
            yearSelect.value = activeYear;
        }

        // Isi Distributor
        let activeDistributorId = selectedDistributorId || 'all';
        const distList = (window.appState && Array.isArray(appState.distributors))
            ? appState.distributors.map(d => ({ id: d.id, name: d.name || 'Tanpa Nama' }))
            : [];

        if (distSelect) {
            const previous = distSelect.value || 'all';

            distSelect.innerHTML = [
                '<option value="all">Semua</option>',
                ...distList.map(d => `<option value="${d.id}">${d.name}</option>`)
            ].join('');

            if (activeDistributorId === 'all' && previous) {
                activeDistributorId = previous;
            }

            if (activeDistributorId !== 'all' &&
                !distList.some(d => String(d.id) === String(activeDistributorId))) {
                activeDistributorId = 'all';
            }

            distSelect.value = activeDistributorId;
        }

        // Bind event Tahun
        if (yearSelect && !yearSelect.dataset.superBound) {
            yearSelect.addEventListener('change', function () {
                const y = parseInt(this.value, 10);
                const distVal = distSelect ? distSelect.value : 'all';
                window.renderTargetPage(Number.isNaN(y) ? null : y, distVal || 'all');
            });
            yearSelect.dataset.superBound = '1';
        }

        // Bind event Distributor
        if (distSelect && !distSelect.dataset.superBound) {
            distSelect.addEventListener('change', function () {
                const y = yearSelect ? parseInt(yearSelect.value, 10) : null;
                const distVal = this.value || 'all';
                window.renderTargetPage(Number.isNaN(y) ? null : y, distVal);
            });
            distSelect.dataset.superBound = '1';
        }

        // --- Panggil renderer asli untuk Tahun aktif ---
        if (typeof baseRenderTargetPage === 'function') {
            baseRenderTargetPage(activeYear);
        }

        if (!container) return;

        // --- Filter tampilan kartu berdasarkan Distributor ---
        const groups = container.querySelectorAll('.bg-white.border.rounded-lg.mb-6');
        const distName = (window.appState && Array.isArray(appState.distributors) && activeDistributorId !== 'all')
            ? (appState.distributors.find(d => String(d.id) === String(activeDistributorId)) || {}).name
            : null;

        groups.forEach(group => {
            if (!distName || activeDistributorId === 'all') {
                group.style.display = '';
                return;
            }
            const h4 = group.querySelector('h4');
            const text = h4 ? (h4.textContent || '') : '';
            if (text.includes(distName)) {
                group.style.display = '';
            } else {
                group.style.display = 'none';
            }
        });
    };
})();
</script>


<!-- Patch: Stay on same fiscal year after saveTarget() -->
<script>
// --- FIX: After saving target, stay on same fiscal year page ---
(function(){
    // Wrap in IIFE to avoid polluting global scope
    const originalSaveTarget = window.saveTarget;
    if (!originalSaveTarget) {
        console.warn("saveTarget() not found on window; patch will attach a wrapper but original function is missing.");
    }

    window.saveTarget = async function() {
        try {
            const yearEl = document.getElementById('target-year');
            const distEl = document.getElementById('target-distributor');
            const selectedYear = yearEl ? yearEl.value : null;
            const selectedDistributor = distEl ? distEl.value : null;

            if (typeof originalSaveTarget === 'function') {
                await originalSaveTarget();
            } else {
                // If original missing, attempt to save appState directly as fallback
                if (window.saveData) await window.saveData();
            }

            // Re-open target page with same selection if possible
            if (selectedYear || selectedDistributor) {
                // small timeout to let UI state settle
                setTimeout(() => {
                    try {
                        // Try to show the target page - maybe function exists in app
                        if (typeof showPage === 'function') showPage('target');
                        // Restore selections
                        if (selectedYear && document.getElementById('target-year')) document.getElementById('target-year').value = selectedYear;
                        if (selectedDistributor && document.getElementById('target-distributor')) document.getElementById('target-distributor').value = selectedDistributor;
                        // Re-render target-specific UI if available
                        if (typeof renderTargetPage === 'function') renderTargetPage();
                        if (typeof renderTargets === 'function') renderTargets();
                    } catch (err) {
                        console.warn("Patch: failed to re-open or render target page", err);
                    }
                }, 120);
            }
        } catch (err) {
            console.error("Patch wrapper around saveTarget failed", err);
            if (typeof originalSaveTarget === 'function') {
                // Fall back to original behavior
                return originalSaveTarget.apply(this, arguments);
            }
        }
    };
})();
</script>


<!-- 
<!-- Autoscale guard: prevent repeated autoscale errors and allow temporary disable during save -->
<script>
(function(){
    // Wrap existing autoscale function (if any) to catch and suppress errors, and track calls.
    try {
        if (window.autoscale && typeof window.autoscale === 'function' && !window.__autoscale_wrapped) {
            const originalAutoscale = window.autoscale;
            window.__autoscale_wrapped = true;
            window.__autoscale_error_count = 0;
            window.autoscale = function() {
                try {
                    if (window.__autoscaleDisabled) return; // temporarily disabled
                    return originalAutoscale.apply(this, arguments);
                } catch (err) {
                    window.__autoscale_error_count = (window.__autoscale_error_count || 0) + 1;
                    if (window.__autoscale_error_count < 5) {
                        console.warn('Autoscale error suppressed', err);
                    } else if (window.__autoscale_error_count === 5) {
                        console.warn('Autoscale error suppressed (further errors will be silenced)');
                    }
                    // avoid throwing to console repeatedly
                    return null;
                }
            };
            console.info('Autoscale guard installed');
        } else {
            // if autoscale not present yet, define a safe placeholder and install later if present
            if (!window.autoscale) {
                window.autoscale = function(){ /* placeholder until real autoscale is loaded */ };
                window.__autoscale_wrapped = true;
            }
        }
    } catch(e){
        console.error('Failed to install autoscale guard', e);
    }

    // Expose helper to temporarily disable autoscale (used by save wrapper)
    window.__disableAutoscaleTemporarily = function(timeoutMs = 1000) {
        window.__autoscaleDisabled = true;
        setTimeout(() => { window.__autoscaleDisabled = false; }, timeoutMs);
    };
})();
</script>

<!-- Stronger Patch: Force stay on same fiscal year after saveTarget() and guard against auto-navigation -->
<script>
(function(){
    const originalSaveTarget = window.saveTarget;
    async function fallbackSave() {
        if (typeof window.saveData === 'function') return window.saveData();
        console.warn('No saveTarget or saveData found to perform save.');
    }

    window.saveTarget = async function() {
        const yearEl = document.getElementById('target-year');
        const distEl = document.getElementById('target-distributor');
        const selectedYear = yearEl ? yearEl.value : null;
        const selectedDistributor = distEl ? distEl.value : null;

        // If form has change handlers that auto-switch, disable them temporarily by cloning the select
        function disableSelectTemporarily(el) {
            if (!el) return null;
            const clone = el.cloneNode(true);
            clone.value = el.value;
            clone.style.pointerEvents = 'none';
            el.parentNode.replaceChild(clone, el);
            return {orig: el, clone: clone};
        }

        let yearSwap = disableSelectTemporarily(yearEl);
        let distSwap = disableSelectTemporarily(distEl);

        try {
            if (typeof originalSaveTarget === 'function') {
                await originalSaveTarget();
            } else {
                await fallbackSave();
            }
        } catch (err) {
            console.error('Error in original saveTarget:', err);
        } finally {
            // Restore selects (if they were swapped) and enforce chosen values repeatedly for a short time
            if (yearSwap) yearSwap.clone.parentNode.replaceChild(yearSwap.orig, yearSwap.clone);
            if (distSwap) distSwap.clone.parentNode.replaceChild(distSwap.orig, distSwap.clone);

            // enforce selections and re-open target page
            const enforce = () => {
                try {
                    if (selectedYear && document.getElementById('target-year')) document.getElementById('target-year').value = selectedYear;
                    if (selectedDistributor && document.getElementById('target-distributor')) document.getElementById('target-distributor').value = selectedDistributor;
                    if (typeof showPage === 'function') showPage('target');
                    if (typeof renderTargetPage === 'function') renderTargetPage();
                    if (typeof renderTargets === 'function') renderTargets();
                } catch(e){ /* ignore */ }
            };

            // run enforce immediately and several times to override any async auto-change
            enforce();
            let runs = 0;
            const maxRuns = 10;
            const iv = setInterval(() => {
                enforce();
                runs++;
                if (runs >= maxRuns) clearInterval(iv);
            }, 150);
        }
    };
})();
</script>


<!-- Lock Active Year Patch: prevent other code from switching the fiscal year for a short window -->
<script>
(function(){
    // Helper: set a short-lived lock that forces the target-year select to stay on chosen value
    window.__lockFiscalYear = function(year, ttlMs = 3000) {
        try {
            window.__lockedFiscal = { year: year, expires: Date.now() + ttlMs };
            // Immediately set the select value
            const yEl = document.getElementById('target-year');
            if (yEl) yEl.value = year;
            // Also set any internal activeYear variable if present
            try { if (window.activeYear !== undefined) window.activeYear = year; } catch(e){}
            try { if (window.appState && window.appState.activeYear !== undefined) window.appState.activeYear = year; } catch(e){}
            // Reapply repeatedly for ttl window
            const iv = setInterval(() => {
                if (!window.__lockedFiscal) return clearInterval(iv);
                if (Date.now() > window.__lockedFiscal.expires) { window.__lockedFiscal = null; return clearInterval(iv); }
                const el = document.getElementById('target-year');
                if (el && el.value != year) el.value = year;
                try { if (window.activeYear !== undefined && window.activeYear != year) window.activeYear = year; } catch(e){}
                try { if (window.appState && window.appState.activeYear !== undefined && window.appState.activeYear != year) window.appState.activeYear = year; } catch(e){}
            }, 120);
        } catch(e) { console.warn('lockFiscalYear failed', e); }
    };

    // MutationObserver to revert unwanted changes to the target-year select while locked
    const targetSelect = () => document.getElementById('target-year');
    let observer = null;
    function ensureObserver() {
        if (observer) return;
        const sel = targetSelect();
        if (!sel) return;
        observer = new MutationObserver(muts => {
            if (!window.__lockedFiscal) return;
            const desired = window.__lockedFiscal.year;
            const cur = sel.value;
            if (cur != desired) {
                // revert quickly
                sel.value = desired;
                // trigger change event in case app listens to it
                const ev = new Event('change', { bubbles: true });
                sel.dispatchEvent(ev);
            }
        });
        observer.observe(sel, { attributes: true, attributeFilter: ['value'] });
        // also listen to input events
        sel.addEventListener('input', () => {
            if (!window.__lockedFiscal) return;
            if (sel.value != window.__lockedFiscal.year) {
                sel.value = window.__lockedFiscal.year;
                sel.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    }

    // Try to attach observer periodically until the element appears
    const attachIv = setInterval(() => {
        ensureObserver();
        if (observer) { clearInterval(attachIv); }
    }, 200);

    // Wrap renderTargetPage / rebuildFiscalFilter / setActiveYear if present to reapply lock at end
    function wrapFn(name) {
        try {
            const fn = window[name];
            if (typeof fn === 'function' && !fn.__wrappedByLock) {
                const orig = fn;
                const wrapped = function() {
                    const res = orig.apply(this, arguments);
                    // Re-enforce locked year shortly after function runs
                    if (window.__lockedFiscal) {
                        setTimeout(() => {
                            try {
                                const y = window.__lockedFiscal.year;
                                const sel = document.getElementById('target-year');
                                if (sel) sel.value = y;
                                try { if (window.activeYear !== undefined) window.activeYear = y; } catch(e){}
                                try { if (window.appState && window.appState.activeYear !== undefined) window.appState.activeYear = y; } catch(e){}
                            } catch(e){}
                        }, 60);
                    }
                    return res;
                };
                wrapped.__wrappedByLock = true;
                window[name] = wrapped;
            }
        } catch(e){ /* ignore */ }
    }

    const names = ['renderTargetPage','rebuildFiscalFilter','setActiveYear','renderTargets','renderTargetSummary'];
    const wrapIv = setInterval(() => {
        names.forEach(wrapFn);
    }, 200);
    // stop wrapping after some time
    setTimeout(() => clearInterval(wrapIv), 6000);

    // Expose convenience: lock-and-save helper that calls original saveTarget and locks the year
    const origSave = window.saveTarget;
    window.saveTarget = async function() {
        // capture current selection
        const sel = document.getElementById('target-year');
        const selectedYear = sel ? sel.value : (window.appState && window.appState.activeYear ? window.appState.activeYear : null);
        // set lock BEFORE calling original save to prevent auto-navigation
        if (selectedYear) window.__lockFiscalYear(selectedYear, 4000);
        if (typeof origSave === 'function') {
            try { await origSave.apply(this, arguments); } catch(e){ console.error('original saveTarget error', e); }
        } else if (window.saveData) {
            try { await window.saveData(); } catch(e){ console.error('saveData fallback error', e); }
        }
        // ensure UI shows target page and selected year
        try {
            if (typeof showPage === 'function') showPage('target');
            const sel2 = document.getElementById('target-year');
            if (sel2 && selectedYear) sel2.value = selectedYear;
            if (typeof renderTargetPage === 'function') renderTargetPage();
        } catch(e){}
    };
})(); 
</script>


<!-- Patch v5: Force-stay flag and overrides for auto-activeYear setters -->
<script>
(function(){
    // Ensure global guard exists
    window.__forceStayFiscalYear = window.__forceStayFiscalYear || false;

    // Helper to wrap functions: if __forceStayFiscalYear true, skip their action
    function wrapNoopWhenForced(name) {
        try {
            const fn = window[name];
            if (typeof fn === 'function' && !fn.__v5Wrapped) {
                const orig = fn;
                const wrapped = function() {
                    if (window.__forceStayFiscalYear) {
                        // Provide debug hint without spamming
                        if (!wrapped.__warned) {
                            console.debug('[PatchV5] Skipping', name, 'because __forceStayFiscalYear is active');
                            wrapped.__warned = true;
                        }
                        return; // skip original behavior that may change active year
                    }
                    return orig.apply(this, arguments);
                };
                wrapped.__v5Wrapped = true;
                window[name] = wrapped;
                console.info('[PatchV5] Wrapped', name);
            }
        } catch(e){ console.warn('[PatchV5] wrap failed for', name, e); }
    }

    // Names to wrap - cover common functions that touch fiscal filters/active year rendering
    const names = ['rebuildFiscalFilter','setActiveYear','renderTargetPage','renderTargets','rebuildFilters','applyFiscalDefaults'];

    // Attempt to wrap periodically (in case functions are defined later)
    const wrapInterval = setInterval(() => {
        names.forEach(wrapNoopWhenForced);
    }, 200);

    // Stop trying after 8 seconds
    setTimeout(() => clearInterval(wrapInterval), 8000);

    // Also protect direct DOM changes: observe select and revert if forced and value differs
    const selId = 'target-year';
    function protectSelect() {
        const sel = document.getElementById(selId);
        if (!sel) return false;
        const obs = new MutationObserver(muts => {
            if (!window.__forceStayFiscalYear) return;
            const desired = window.__forcedFiscalYearValue;
            if (desired && sel.value != desired) {
                sel.value = desired;
                sel.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        try { obs.observe(sel, { attributes: true, attributeFilter: ['value'] }); } catch(e){}
        sel.addEventListener('input', () => {
            if (!window.__forceStayFiscalYear) return;
            const desired = window.__forcedFiscalYearValue;
            if (desired && sel.value != desired) {
                sel.value = desired;
                sel.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        return true;
    }
    const protectIv = setInterval(() => { if (protectSelect()) clearInterval(protectIv); }, 200);

    // Provide a helper to lock during save: set flag, remember desired year, clear flag after ttl
    window.__forceStayFiscalYearDuring = async function(year, ttlMs = 4000) {
        try {
            window.__forceStayFiscalYear = true;
            window.__forcedFiscalYearValue = year;
            // also set appState/activeYear if present
            try { if (window.activeYear !== undefined) window.activeYear = year; } catch(e){}
            try { if (window.appState && window.appState.activeYear !== undefined) window.appState.activeYear = year; } catch(e){}
            setTimeout(() => {
                window.__forceStayFiscalYear = false;
                window.__forcedFiscalYearValue = null;
                console.debug('[PatchV5] Cleared __forceStayFiscalYear');
            }, ttlMs);
        } catch(e){ console.warn('[PatchV5] forceDuring failed', e); }
    };

    // Wrap saveTarget to enable the flag before calling original and clear after completion
    (function wrapSave() {
        const orig = window.saveTarget;
        if (typeof orig === 'function' && !orig.__v5WrappedSave) {
            const wrappedSave = async function() {
                const sel = document.getElementById('target-year');
                const selectedYear = sel ? sel.value : (window.appState && window.appState.activeYear ? window.appState.activeYear : null);
                if (selectedYear) {
                    // lock for a slightly longer window to beat internal autosetters
                    await window.__forceStayFiscalYearDuring(selectedYear, 5000);
                } else {
                    window.__forceStayFiscalYear = true;
                    setTimeout(() => { window.__forceStayFiscalYear = false; }, 5000);
                }
                try {
                    const res = await orig.apply(this, arguments);
                    // Re-enforce UI
                    try { if (typeof showPage === 'function') showPage('target'); } catch(e){}
                    try { if (selectedYear && document.getElementById('target-year')) document.getElementById('target-year').value = selectedYear; } catch(e){}
                    try { if (typeof renderTargetPage === 'function') renderTargetPage(); } catch(e){}
                    return res;
                } catch(e) {
                    console.error('[PatchV5] original saveTarget error', e);
                    throw e;
                } finally {
                    // ensure flag cleared eventually (in case something threw)
                    setTimeout(() => { window.__forceStayFiscalYear = false; window.__forcedFiscalYearValue = null; }, 5200);
                }
            };
            wrappedSave.__v5WrappedSave = true;
            window.saveTarget = wrappedSave;
            console.info('[PatchV5] saveTarget wrapped to enforce fiscal-year lock during save');
        } else if (typeof window.saveTarget !== 'function') {
            // If saveTarget not yet defined, try to patch later
            const iv = setInterval(() => {
                if (typeof window.saveTarget === 'function') {
                    clearInterval(iv);
                    wrapSave();
                }
            }, 200);
            setTimeout(() => clearInterval(iv), 8000);
        }
    })();
})(); 
</script>





<script>
// === Arsip PO Row Click Hook (SAFE) ===
document.addEventListener('click', function(e){
  const row = e.target.closest('tr[data-po-id]');
  if(!row) return;
  // prevent when clicking action buttons
  if(e.target.closest('button')) return;
  const poId = row.getAttribute('data-po-id');
  if(poId && typeof openPODetail === 'function'){
    openPODetail(poId);
  }
});
</script>





<script>
</script>


<!-- ================== DETAIL PO MODAL (FINAL WORKING) ================== -->
<div id="po-detail-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:9999;">
  <div style="background:#fff; max-width:900px; margin:5% auto; padding:20px; border-radius:8px; max-height:85vh; overflow:auto">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3 style="font-size:18px; font-weight:600">Detail PO</h3>
      <button onclick="closePODetail()" style="font-size:18px">✕</button>
    </div>
    <div id="po-detail-content" style="margin-top:12px"></div>
    <div style="text-align:right; margin-top:16px">
      <button onclick="closePODetail()" style="padding:6px 12px">Tutup</button>
    </div>
  </div>
</div>

<script>
function normalizePO(str){
  return String(str || '')
    .toUpperCase()
    .replace(/\s+/g,'')
    .replace(/[^A-Z0-9-]/g,'');
}

function findPOByNumber(poNumber){
  if(!window.appState || !Array.isArray(appState.purchaseOrders)) return null;
  const key = normalizePO(poNumber);
  return appState.purchaseOrders.find(p => {
    const dataKey = normalizePO(p.poNumber);
    return dataKey.includes(key) || key.includes(dataKey);
  });
}

window.openPODetail = function(poNumber){
  const po = findPOByNumber(poNumber);
  if(!po){ console.warn('Detail PO tidak ditemukan'); return; }

  let html = '';
  html += `<p><b>No PO:</b> ${po.poNumber}</p>`;
  html += `<p><b>Tanggal:</b> ${po.poDate || '-'}</p>`;
  html += `<p><b>Total:</b> Rp ${(po.totalAmount||po.total||0).toLocaleString('id-ID')}</p>`;

  html += '<table border="1" width="100%" cellspacing="0" cellpadding="6" style="margin-top:10px">';
  html += '<tr><th align="left">Varietas</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr>';
  (po.items||[]).forEach(i=>{
    const sub = (i.qty||0)*(i.price||0);
    html += `<tr>
      <td>${i.name||'-'}</td>
      <td align="right">${i.qty||0}</td>
      <td align="right">Rp ${(i.price||0).toLocaleString('id-ID')}</td>
      <td align="right">Rp ${sub.toLocaleString('id-ID')}</td>
    </tr>`;
  });
  html += '</table>';

  document.getElementById('po-detail-content').innerHTML = html;
  document.getElementById('po-detail-modal').style.display = 'block';
}

window.closePODetail = function(){
  document.getElementById('po-detail-modal').style.display = 'none';
}

</script>
<!-- ================== END DETAIL PO ================== -->


<script>
(function(){
 const h=document.documentElement,t=document.getElementById('darkToggle'),
 i=document.getElementById('darkIcon'),l=document.getElementById('darkLabel');
 if(localStorage.getItem('advanta-theme')==='dark'){on()}
 t.addEventListener('click',()=>h.classList.contains('dark')?off():on());
 function on(){h.classList.add('dark');localStorage.setItem('advanta-theme','dark');i.textContent='☀️';l.textContent='Light'}
 function off(){h.classList.remove('dark');localStorage.setItem('advanta-theme','light');i.textContent='🌙';l.textContent='Dark'}
})();
</script>








<script>
/* === FORCE ADVANTA PALETTE (AUTO APPLY ALL CHARTS) === */
if (window.Chart) {
  Chart.defaults.color = "#E5EDFF";
  Chart.defaults.borderColor = "rgba(255,255,255,0.08)";
  Chart.defaults.font.family = "Inter, sans-serif";

  Chart.defaults.plugins.legend.labels.color = "#E5EDFF";
  Chart.defaults.plugins.tooltip.backgroundColor = "#0B1F36";
  Chart.defaults.plugins.tooltip.titleColor = "#FFFFFF";
  Chart.defaults.plugins.tooltip.bodyColor = "#E5EDFF";

  Chart.defaults.datasets.bar.backgroundColor = "#0E63B6";
  Chart.defaults.datasets.bar.borderRadius = 8;

  Chart.defaults.datasets.line.borderColor = "#39B54A";
  Chart.defaults.datasets.line.backgroundColor = "rgba(57,181,74,0.25)";
  Chart.defaults.datasets.line.tension = 0.4;
  Chart.defaults.datasets.line.fill = true;

  Chart.defaults.datasets.doughnut.backgroundColor = [
    "#0E63B6","#39B54A","#F5B301",
    "#0B3A6F","#1E7F3F","#C98A00"
  ];
}
</script>


<script>
/* =========================================================
   ADVANTA FORCE PLUGIN – APPLY TO ALL CHARTS (LEGACY SAFE)
   ========================================================= */
(function(){
  if (!window.Chart) return;

  const ADV_COLORS = [
    "#0E63B6","#39B54A","#F5B301",
    "#0B3A6F","#1E7F3F","#C98A00"
  ];

  Chart.register({
    id: 'advantaForcePalette',
    beforeUpdate(chart) {
      chart.data.datasets.forEach((ds, i) => {
        const c = ADV_COLORS[i % ADV_COLORS.length];

        if (chart.config.type === 'bar') {
          ds.backgroundColor = ds.backgroundColor || c;
          ds.borderRadius = ds.borderRadius ?? 8;
        }
        if (chart.config.type === 'line') {
          ds.borderColor = ds.borderColor || "#39B54A";
          ds.backgroundColor = ds.backgroundColor || "rgba(57,181,74,0.25)";
          ds.tension ??= 0.4;
          ds.fill ??= true;
        }
        if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
          ds.backgroundColor = ds.backgroundColor || ADV_COLORS;
          ds.borderWidth ??= 0;
        }
      });
    }
  });
})();
</script>


<script id="advanta-open-po-detail-v8">
/* Override openPODetail agar modal patuh Light/Dark mode */
window.openPODetail = function(poNumber){
  const po = (window.findPOByNumber && findPOByNumber(poNumber)) || null;
  if(!po){ console.warn('Detail PO tidak ditemukan'); return; }

  let html = '';
  html += `<p class="text-gray-800 dark:text-gray-200"><b>No PO:</b> ${po.poNumber}</p>`;
  html += `<p class="text-gray-800 dark:text-gray-200"><b>Tanggal:</b> ${po.poDate || '-'}</p>`;
  html += `<p class="text-gray-800 dark:text-gray-200"><b>Total:</b> Rp ${(po.totalAmount||po.total||0).toLocaleString('id-ID')}</p>`;

  html += '<div class="overflow-x-auto"><table class="w-full border-collapse border border-gray-300 dark:border-gray-600 mt-4 text-sm">';
  html += '<thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200"><tr><th class="p-2 border border-gray-300 dark:border-gray-600 text-left">Varietas</th><th class="p-2 border border-gray-300 dark:border-gray-600">Qty</th><th class="p-2 border border-gray-300 dark:border-gray-600">Harga</th><th class="p-2 border border-gray-300 dark:border-gray-600">Subtotal</th></tr></thead><tbody>';

  (po.items||[]).forEach(i=>{
    const sub = (i.qty||0)*(i.price||0);
    html += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-800 dark:text-gray-300">
      <td class="p-2 border border-gray-300 dark:border-gray-600">${i.name||'-'}</td>
      <td class="p-2 border border-gray-300 dark:border-gray-600 text-right">${i.qty||0}</td>
      <td class="p-2 border border-gray-300 dark:border-gray-600 text-right">Rp ${(i.price||0).toLocaleString('id-ID')}</td>
      <td class="p-2 border border-gray-300 dark:border-gray-600 text-right">Rp ${sub.toLocaleString('id-ID')}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';

  const content = document.getElementById('po-detail-content');
  if(content) content.innerHTML = html;

  const modalBox = document.querySelector('#po-detail-modal > div');
  if(modalBox){
    modalBox.style.background = '';
    modalBox.className = 'bg-white dark:bg-[#0B1F36] dark:text-white w-full max-w-[900px] mx-auto mt-[5%] p-6 rounded-xl shadow-2xl max-h-[85vh] overflow-y-auto border border-gray-200 dark:border-gray-700';
  }

  const modal = document.getElementById('po-detail-modal');
  if(modal) modal.style.display = 'block';
}
</script>
<!-- ================= END ADVANTA FINAL v8 ================= -->


<script>
/* ADVANTA Chart Light/Dark Sync */
function advantaChartColor() {
  return document.documentElement.classList.contains('dark')
    ? '#E5E7EB'
    : '#0F172A';
}
</script>


<script>
(function(){
  function applyPORelease(){
    const title = document.getElementById('page-title');
    if(title && title.textContent.trim() === 'PO Release'){
      document.body.classList.add('page-po-release');
    } else {
      document.body.classList.remove('page-po-release');
    }
  }
  applyPORelease();
  document.addEventListener('click', () => {
    setTimeout(applyPORelease, 50);
  });
})();
</script>

<style>
body.page-po-release .bg-white {
  background-color: transparent !important;
}
body.page-po-release [role="row"]:hover,
body.page-po-release .po-row:hover {
  background: rgba(46,125,50,.15) !important;
}
body.page-po-release [role="row"]:hover *,
body.page-po-release .po-row:hover * {
  color: #2e7d32 !important;
}
body.page-po-release .is-selected,
body.page-po-release .is-selected * {
  background: #C9A24D !important;
  color: #1f2937 !important;
  font-weight: 600;
}
</style>


<!-- FIX: Tombol Tutup hitam di Dark Mode -->
<style id="fix-modal-tutup-dark">
  html.dark .modal button,
  html.dark .modal .btn-close,
  html.dark .modal [data-action="close"] {
    color: #0F172A !important;
  }
  html.dark .modal button.bg-white,
  html.dark .modal button[class*="bg-white"] {
    color: #0F172A !important;
  }
  html.dark .modal button svg,
  html.dark .modal button svg * {
    fill: #0F172A !important;
    stroke: #0F172A !important;
  }
</style>


<!-- ================= PRODUCT PER AREA MODAL FIX (MERGED) ================= -->
<script>
(function () {
  function safePrevent(form) {
    if (!form) return;
    if (form._advantaBound) return;
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      e.stopPropagation();
    });
    form._advantaBound = true;
  }

  function ensureMarketModalReady() {
    const marketForm = document.getElementById('market-size-form');
    const indoForm = document.getElementById('indo-market-size-form');

    if (marketForm) safePrevent(marketForm);
    if (indoForm) safePrevent(indoForm);

    if (typeof window.initMarketSizePage === 'function' && marketForm && !marketForm._listenerAttached) {
      window.initMarketSizePage();
    }
    if (typeof window.initIndoMarketSizePage === 'function' && indoForm && !indoForm._listenerAttached) {
      window.initIndoMarketSizePage();
    }
  }

  const originalInitProductArea = window.initProductAreaPage;
  window.initProductAreaPage = function () {
    if (typeof originalInitProductArea === 'function') {
      originalInitProductArea();
    }
    ensureMarketModalReady();
  };

  const originalUpdateMarket = window.updateMarketSizeViews;
  window.updateMarketSizeViews = function () {
    if (typeof originalUpdateMarket === 'function') originalUpdateMarket();
    if (typeof window.updateProductAreaViews === 'function') {
      const kab = document.getElementById('product-area-kabupaten');
      window.updateProductAreaViews(kab ? kab.value : 'all');
    }
  };

  const originalUpdateIndo = window.updateIndoMarketSizeViews;
  window.updateIndoMarketSizeViews = function () {
    if (typeof originalUpdateIndo === 'function') originalUpdateIndo();
    if (typeof window.updateProductAreaViews === 'function') {
      const kab = document.getElementById('product-area-kabupaten');
      window.updateProductAreaViews(kab ? kab.value : 'all');
    }
  };
})();
</script>
<!-- ================= END PRODUCT PER AREA MODAL FIX ================= -->


<!-- ===== PATCH: AUTO INIT MODAL DEPENDENCY & STAY ON PRODUCT PER AREA ===== -->
<script>
(function() {
  const originalInitProductArea = window.initProductAreaPage;

  window.initProductAreaPage = function() {
    if (typeof originalInitProductArea === 'function') {
      originalInitProductArea();
    }

    const marketForm = document.getElementById('market-size-form');
    if (marketForm && !marketForm._listenerAttached) {
      if (typeof window.initMarketSizePage === 'function') {
        window.initMarketSizePage();
      }
    }

    const indoForm = document.getElementById('indo-market-size-form');
    if (indoForm && !indoForm._listenerAttached) {
      if (typeof window.initIndoMarketSizePage === 'function') {
        window.initIndoMarketSizePage();
      }
    }
  };

  const originalUpdateMarket = window.updateMarketSizeViews;
  window.updateMarketSizeViews = function() {
    if (typeof originalUpdateMarket === 'function') originalUpdateMarket();
    if (document.getElementById('product-area-table-body')) {
      const kab = document.getElementById('product-area-kabupaten')?.value || 'all';
      window.updateProductAreaViews?.(kab);
    }
  };

  const originalUpdateIndo = window.updateIndoMarketSizeViews;
  window.updateIndoMarketSizeViews = function() {
    if (typeof originalUpdateIndo === 'function') originalUpdateIndo();
    if (document.getElementById('product-area-table-body')) {
      const kab = document.getElementById('product-area-kabupaten')?.value || 'all';
      window.updateProductAreaViews?.(kab);
    }
  };
})();
</script>

<script>
// === PUBLIC STOCK INPUT FUNCTIONS ===
let publicStockToken = null;
let publicDistributorData = null;
let publicUserStockData = null;
let currentEditingStockId = null;
let publicVarieties = [];
let publicStockRealtimeUnsubscribe = null;

async function initializePublicStockForm(token) {
    publicStockToken = token;
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('public-stock-date').value = today;
    
    // Access global Firebase instances
    const firestoreDB = window.db || db;
    
    if (!firestoreDB) {
        alert('Firebase tidak tersedia. Silakan coba lagi.');
        return;
    }
    
    try {
        // Import Firestore functions from global scope
        const { collection, getDocs, doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        // Get all users' data to find the link
        const usersSnapshot = await getDocs(collection(firestoreDB, 'advantaUserData'));
        
        let foundLink = false;
        let foundVarieties = [];
        
        for (const userDoc of usersSnapshot.docs) {
            const userData = userDoc.data();
            const stockLinks = userData.data?.stockLinks || [];
            const linkData = stockLinks.find(l => l.token === token && l.active);
            
            if (linkData) {
                foundLink = true;
                foundVarieties = userData.data?.varieties || [];
                publicUserStockData = userData.data?.stockDistributor || [];
                
                publicDistributorData = {
                    userId: userDoc.id,
                    distributorId: linkData.distributorId,
                    distributorName: linkData.distributorName
                };
                
                // Update UI
                document.getElementById('public-dist-name').textContent = linkData.distributorName;
                
                console.log('Found varieties:', foundVarieties); // Debug log
                
                // Setup realtime listener for stock changes
                if (publicStockRealtimeUnsubscribe) {
                    publicStockRealtimeUnsubscribe();
                }
                
                const userDocRef = doc(firestoreDB, 'advantaUserData', userDoc.id);
                publicStockRealtimeUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const updatedUserData = docSnap.data();
                        const updatedStockData = updatedUserData.data?.stockDistributor || [];
                        
                        console.log('🔄 Stock data updated realtime:', updatedStockData.length, 'items');
                        
                        // Update local data
                        publicUserStockData = updatedStockData;
                        
                        // Re-render stock list
                        renderPublicStockList(foundVarieties);
                    }
                }, (error) => {
                    console.error('❌ Realtime listener error:', error);
                });
                
                console.log('✅ Realtime stock listener activated for public page');
                
                break;
            }
        }
        
        if (!foundLink) {
            alert('Link tidak valid atau sudah expired');
            return;
        }
        
        // Save varieties to global variable
        publicVarieties = foundVarieties;
        
        // Load varieties to dropdown
        const varietySelect = document.getElementById('public-stock-variety');
        if (varietySelect && foundVarieties.length > 0) {
            varietySelect.innerHTML = '<option value="">-- Pilih Varietas --</option>' + 
                foundVarieties.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            console.log('Varieties loaded:', foundVarieties.length); // Debug log
        } else {
            console.warn('No varieties found or select element not found');
            varietySelect.innerHTML = '<option value="">Tidak ada varietas tersedia</option>';
        }
        
        // Render existing stock list for this distributor
        renderPublicStockList(foundVarieties);
        
    } catch (error) {
        console.error('Error loading public stock form:', error);
        alert('Gagal memuat data: ' + error.message);
    }
}

function renderPublicStockList(varieties) {
    const listContainer = document.getElementById('public-stock-list');
    const listSection = document.getElementById('public-stock-list-section');
    
    if (!listContainer || !publicDistributorData || !publicUserStockData) {
        if (listSection) listSection.style.display = 'none';
        return;
    }
    
    // Filter stock for current distributor only
    const distributorStock = publicUserStockData.filter(
        s => s.distributorId == publicDistributorData.distributorId
    );
    
    if (distributorStock.length === 0) {
        listSection.style.display = 'none';
        return;
    }
    
    // Sort by date descending
    distributorStock.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
    
    listSection.style.display = 'block';
    
    listContainer.innerHTML = distributorStock.map(stock => {
        const variety = varieties.find(v => v.id == stock.varietyId);
        const varietyName = variety ? variety.name : 'Unknown';
        const dateFormatted = new Date(stock.date).toLocaleDateString('id-ID', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric' 
        });
        
        // Calculate aging from release date (more accurate for seed quality)
        const today = new Date();
        let agingDays = 0;
        let agingSource = '';
        let agingTooltip = '';
        if (stock.releaseDate) {
            // Use releaseDate if available (actual seed production date)
            const releaseDate = new Date(stock.releaseDate);
            agingDays = Math.floor((today - releaseDate) / (1000 * 60 * 60 * 24));
            agingSource = '🏭';
            agingTooltip = `Dihitung dari tanggal release (${releaseDate.toLocaleDateString('id-ID')})`;
        } else if (stock.date) {
            // Fallback to entry date if releaseDate not available
            const stockDate = new Date(stock.date);
            agingDays = Math.floor((today - stockDate) / (1000 * 60 * 60 * 24));
            agingSource = '📅';
            agingTooltip = 'Dihitung dari tanggal entry (belum ada tanggal release)';
        }
        
        // Aging badge color
        let agingBadge = 'bg-green-100 text-green-700';
        if (agingDays > 60) {
            agingBadge = 'bg-red-100 text-red-700';
        } else if (agingDays > 30) {
            agingBadge = 'bg-orange-100 text-orange-700';
        } else if (agingDays > 14) {
            agingBadge = 'bg-yellow-100 text-yellow-700';
        }
        
        // Format expired date
        let expiredHTML = '';
        if (stock.expired) {
            const expDate = new Date(stock.expired);
            const expFormatted = expDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
            const daysToExpiry = Math.floor((expDate - today) / (1000 * 60 * 60 * 24));
            
            let expiredBadge = 'bg-blue-100 text-blue-700';
            let expiredIcon = '📅';
            if (daysToExpiry < 0) {
                expiredBadge = 'bg-red-100 text-red-700';
                expiredIcon = '⚠️';
            } else if (daysToExpiry <= 30) {
                expiredBadge = 'bg-orange-100 text-orange-700';
                expiredIcon = '⏰';
            }
            
            expiredHTML = `
                <div class="flex items-center gap-1.5">
                    <span class="text-sm">${expiredIcon}</span>
                    <span class="text-xs ${expiredBadge} px-2 py-0.5 rounded-full font-semibold">Exp: ${expFormatted}</span>
                </div>
            `;
        }
        
        // Format release date info
        let releaseDateHTML = '';
        if (stock.releaseDate) {
            const releaseDate = new Date(stock.releaseDate);
            const releaseDateFormatted = releaseDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
            releaseDateHTML = `
                <div class="flex items-center gap-1.5">
                    <span class="text-sm">🏭</span>
                    <span class="text-xs text-gray-500">Release: ${releaseDateFormatted}</span>
                </div>
            `;
        }
        
        return `
            <div class="border border-gray-200 rounded-lg p-3 hover:shadow-lg transition bg-gradient-to-br from-white to-gray-50">
                <div class="text-center mb-3">
                    <h4 class="font-extrabold text-black text-base truncate" title="${varietyName}">${varietyName}</h4>
                    <p class="text-3xl font-bold text-green-600 mt-2">${stock.qty.toLocaleString('id-ID')}</p>
                    <p class="text-xs text-gray-500 font-medium">${stock.unit || 'pcs'}</p>
                </div>
                <div class="space-y-1.5 text-xs text-gray-600 border-t pt-2">
                    <div class="flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="truncate">${dateFormatted}</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                        </svg>
                        <span class="font-mono truncate" title="${stock.lotNumber || '-'}">${stock.lotNumber || '-'}</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs ${agingBadge} px-2 py-0.5 rounded-full font-semibold inline-flex items-center gap-1" title="${agingTooltip}">
                            <span>${agingSource}</span>
                            <span>Aging: ${agingDays} hari</span>
                        </span>
                    </div>
                    ${releaseDateHTML}
                    ${expiredHTML}
                    ${stock.notes ? `<p class="italic text-gray-500 truncate mt-1" title="${stock.notes}">"${stock.notes}"</p>` : ''}
                </div>
                <div class="grid grid-cols-2 gap-2 mt-3">
                    <button onclick="editPublicStock(${stock.id})" 
                        class="px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white text-xs font-bold rounded-lg hover:from-blue-600 hover:to-indigo-600 transition shadow-sm">
                        🔄 Update
                    </button>
                    <button onclick="deletePublicStock(${stock.id})" 
                        class="px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs font-bold rounded-lg hover:from-red-600 hover:to-red-700 transition shadow-sm">
                        🗑️ Hapus
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function checkExistingStock() {
    // Fungsi ini tidak digunakan lagi karena sekarang support multiple lot per variety
    // Biarkan kosong untuk kompatibilitas
}

function clearStockForm() {
    // Clear form ketika ganti varietas
    document.getElementById('public-stock-qty').value = '';
    document.getElementById('public-stock-lot').value = '';
    document.getElementById('public-stock-expired').value = '';
    document.getElementById('public-stock-release').value = '';
    document.getElementById('public-stock-notes').value = '';
    document.getElementById('public-stock-edit-stockid').value = '';
    
    // Reset button ke mode Submit
    const submitBtn = document.getElementById('public-stock-submit-btn');
    submitBtn.innerHTML = '✓ Submit Stok';
    submitBtn.className = 'w-full mt-4 px-4 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg font-bold shadow-md hover:from-green-700 hover:to-teal-700 transition';
}

function editPublicStock(stockId) {
    // Find stock data
    const stock = publicUserStockData.find(s => s.id == stockId);
    if (!stock) {
        alert('Data stok tidak ditemukan');
        return;
    }
    
    // Find variety name from publicVarieties
    const variety = publicVarieties.find(v => v.id == stock.varietyId);
    const varietyName = variety ? variety.name : 'Unknown';
    
    // Set modal data for all fields
    currentEditingStockId = stockId;
    document.getElementById('modal-variety-name').value = varietyName;
    
    // Populate all fields
    const stockDate = stock.date ? new Date(stock.date).toISOString().split('T')[0] : '';
    document.getElementById('modal-date').value = stockDate;
    
    const releaseDate = stock.releaseDate ? new Date(stock.releaseDate).toISOString().split('T')[0] : '';
    document.getElementById('modal-release-date').value = releaseDate;
    
    document.getElementById('modal-qty').value = stock.qty;
    document.getElementById('modal-unit').value = stock.unit || 'pcs';
    document.getElementById('modal-lot-number').value = stock.lotNumber || '';
    
    const expiredDate = stock.expired ? new Date(stock.expired).toISOString().split('T')[0] : '';
    document.getElementById('modal-expired').value = expiredDate;
    
    document.getElementById('modal-notes').value = stock.notes || '';
    
    // Show modal
    document.getElementById('update-stock-modal').classList.remove('hidden');
}

function closeUpdateStockModal() {
    document.getElementById('update-stock-modal').classList.add('hidden');
    currentEditingStockId = null;
    // Clear all fields
    document.getElementById('modal-date').value = '';
    document.getElementById('modal-release-date').value = '';
    document.getElementById('modal-qty').value = '';
    document.getElementById('modal-unit').value = '';
    document.getElementById('modal-lot-number').value = '';
    document.getElementById('modal-expired').value = '';
    document.getElementById('modal-notes').value = '';
}

async function deletePublicStock(stockId) {
    if (!publicDistributorData || !publicUserStockData) {
        alert('Data tidak tersedia');
        return;
    }
    
    // Find stock data
    const stock = publicUserStockData.find(s => s.id == stockId);
    if (!stock) {
        alert('Data stok tidak ditemukan');
        return;
    }
    
    // Find variety name
    const variety = publicVarieties.find(v => v.id == stock.varietyId);
    const varietyName = variety ? variety.name : 'Unknown';
    
    const confirmation = confirm(`Hapus data stok ini?\n\nVarietas: ${varietyName}\nQty: ${stock.qty.toLocaleString('id-ID')} ${stock.unit || 'pcs'}\nLot: ${stock.lotNumber || '-'}`);
    
    if (!confirmation) return;
    
    try {
        const { doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const userDocRef = doc(db, 'advantaUserData', publicDistributorData.userId);
        const docSnap = await getDoc(userDocRef);
        
        if (docSnap.exists()) {
            const userData = docSnap.data();
            const currentData = userData.data || {};
            
            if (!currentData.stockDistributor) currentData.stockDistributor = [];
            
            // Remove stock from array
            const stockIndex = currentData.stockDistributor.findIndex(s => s.id == stockId);
            if (stockIndex >= 0) {
                currentData.stockDistributor.splice(stockIndex, 1);
                
                await setDoc(userDocRef, { data: currentData });
                
                // Update local data
                publicUserStockData = currentData.stockDistributor;
                
                // Reload varieties for rendering
                const varieties = userData.data?.varieties || [];
                
                // Refresh stock list
                renderPublicStockList(varieties);
                
                alert('✓ Stok berhasil dihapus!');
            }
        }
    } catch (error) {
        console.error('Error deleting stock:', error);
        alert('Gagal menghapus stok: ' + error.message);
    }
}

async function submitUpdateStock() {
    if (!currentEditingStockId || !publicDistributorData) {
        alert('Data tidak valid');
        return;
    }
    
    console.log('🔄 [Public Edit] Starting stock update...');
    console.log('  - Stock ID:', currentEditingStockId);
    console.log('  - Distributor:', publicDistributorData.distributorName);
    
    // Get all field values
    const date = document.getElementById('modal-date').value;
    const releaseDate = document.getElementById('modal-release-date').value;
    const qty = parseInt(document.getElementById('modal-qty').value);
    const unit = document.getElementById('modal-unit').value || 'pcs';
    const lotNumber = document.getElementById('modal-lot-number').value;
    const expired = document.getElementById('modal-expired').value;
    const notes = document.getElementById('modal-notes').value;
    
    console.log('  - Form Values:', { date, releaseDate, qty, unit, lotNumber, expired, notes });
    
    // Validation
    if (!date || !releaseDate) {
        alert('Tanggal Entry dan Release harus diisi');
        return;
    }
    
    if (isNaN(qty) || qty < 0) {
        alert('Masukkan jumlah yang valid');
        return;
    }
    
    try {
        const { doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const userDocRef = doc(db, 'advantaUserData', publicDistributorData.userId);
        console.log('  🔄 Loading from Firestore...');
        const docSnap = await getDoc(userDocRef);
        
        if (docSnap.exists()) {
            const userData = docSnap.data();
            const currentData = userData.data || {};
            
            if (!currentData.stockDistributor) currentData.stockDistributor = [];
            
            // Find and update stock
            const existingIndex = currentData.stockDistributor.findIndex(
                s => s.id == currentEditingStockId
            );
            
            if (existingIndex >= 0) {
                console.log('  - Updating stock at index:', existingIndex);
                currentData.stockDistributor[existingIndex] = {
                    ...currentData.stockDistributor[existingIndex],
                    date: date,
                    releaseDate: releaseDate || null,
                    qty: qty,
                    unit: unit,
                    lotNumber: lotNumber,
                    expired: expired || null,
                    notes: notes,
                    updatedAt: new Date().toISOString()
                };
                
                console.log('  - Updated stock data:', currentData.stockDistributor[existingIndex]);
                console.log('  🔄 Saving to Firestore...');
                
                await setDoc(userDocRef, { data: currentData });
                
                console.log('  ✅ Data BERHASIL disimpan ke Firestore!');
                
                // Update local data
                publicUserStockData = currentData.stockDistributor;
                
                // Reload varieties for rendering
                const varieties = userData.data?.varieties || [];
                
                // Refresh stock list
                renderPublicStockList(varieties);
                
                // Close modal
                closeUpdateStockModal();
                
                // Show success toast
                alert('✓ Stok berhasil diupdate dan disimpan ke Firestore!');
            } else {
                console.error('  ❌ Stock not found in Firestore');
                alert('Stock tidak ditemukan di database');
            }
        } else {
            console.error('  ❌ User document not found');
            alert('Data user tidak ditemukan');
        }
    } catch (error) {
        console.error('❌ Error updating stock:', error);
        alert('Gagal update stok: ' + error.message);
    }
}

document.getElementById('public-stock-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    console.log('📝 Public Stock Form Submit Started');
    console.log('  - publicDistributorData:', publicDistributorData);
    
    if (!publicDistributorData) {
        alert('Data distributor tidak ditemukan');
        return;
    }
    
    const varietyId = parseInt(document.getElementById('public-stock-variety').value);
    const qty = parseInt(document.getElementById('public-stock-qty').value);
    const lotNumber = document.getElementById('public-stock-lot').value.trim();
    const date = document.getElementById('public-stock-date').value;
    const expired = document.getElementById('public-stock-expired').value;
    const releaseDate = document.getElementById('public-stock-release').value;
    const notes = document.getElementById('public-stock-notes').value.trim();
    const editStockId = document.getElementById('public-stock-edit-stockid').value;
    
    console.log('  - Form Data:', { varietyId, qty, lotNumber, date, expired, releaseDate, notes, editStockId });
    
    // Save to Firestore
    try {
        const { doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
        
        const userDocRef = doc(db, 'advantaUserData', publicDistributorData.userId);
        console.log('  - Saving to userId:', publicDistributorData.userId);
        
        const docSnap = await getDoc(userDocRef);
        
        if (docSnap.exists()) {
            const userData = docSnap.data();
            const currentData = userData.data || {};
            
            if (!currentData.stockDistributor) currentData.stockDistributor = [];
            
            console.log('  - Current stockDistributor count:', currentData.stockDistributor.length);
            
            if (editStockId) {
                // UPDATE MODE - Edit existing stock by ID
                const existingIndex = currentData.stockDistributor.findIndex(
                    s => s.id == editStockId
                );
                
                if (existingIndex >= 0) {
                    console.log('  - UPDATE MODE: Updating existing stock at index', existingIndex);
                    currentData.stockDistributor[existingIndex] = {
                        ...currentData.stockDistributor[existingIndex],
                        varietyId: varietyId,
                        qty: qty,
                        lotNumber: lotNumber,
                        date: date,
                        expired: expired || null,
                        releaseDate: releaseDate || null,
                        notes: notes,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // CREATE MODE - Check if same variety + lot already exists
                const duplicateIndex = currentData.stockDistributor.findIndex(
                    s => s.distributorId == publicDistributorData.distributorId && 
                         s.varietyId == varietyId && 
                         s.lotNumber == lotNumber
                );
                
                if (duplicateIndex >= 0) {
                    console.log('  - CREATE MODE: Duplicate found, updating existing at index', duplicateIndex);
                    // Update existing stock with same variety + lot
                    currentData.stockDistributor[duplicateIndex] = {
                        ...currentData.stockDistributor[duplicateIndex],
                        qty: qty,
                        date: date,
                        expired: expired || null,
                        releaseDate: releaseDate || null,
                        notes: notes,
                        updatedAt: new Date().toISOString()
                    };
                } else {
                    console.log('  - CREATE MODE: Adding new stock entry');
                    // ADD new stock entry (different lot or new variety)
                    const stockData = {
                        id: Date.now(),
                        distributorId: publicDistributorData.distributorId,
                        distributorName: publicDistributorData.distributorName,
                        varietyId: varietyId,
                        qty: qty,
                        lotNumber: lotNumber,
                        date: date,
                        expired: expired || null,
                        releaseDate: releaseDate || null,
                        notes: notes,
                        unit: 'pcs',
                        createdAt: new Date().toISOString()
                    };
                    currentData.stockDistributor.push(stockData);
                    console.log('  - New stock data:', stockData);
                }
            }
            
            console.log('  - Final stockDistributor count before save:', currentData.stockDistributor.length);
            console.log('  - Saving to Firestore...');
            
            await setDoc(userDocRef, { data: currentData });
            
            console.log('✅ Data saved successfully to Firestore!');
            
            // Update local data
            publicUserStockData = currentData.stockDistributor;
            
            // Reload varieties for rendering
            const varieties = userData.data?.varieties || [];
            
            // Refresh stock list
            renderPublicStockList(varieties);
            
            // Show success message
            document.getElementById('public-stock-form').style.display = 'none';
            document.getElementById('public-stock-success').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error saving stock:', error);
        alert('Gagal menyimpan data: ' + error.message);
    }
});

function resetPublicStockForm() {
    document.getElementById('public-stock-form').reset();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('public-stock-date').value = today;
    document.getElementById('public-stock-edit-stockid').value = '';
    document.getElementById('public-stock-form').style.display = 'block';
    document.getElementById('public-stock-success').classList.add('hidden');
    
    // Reset button ke mode Submit
    const submitBtn = document.getElementById('public-stock-submit-btn');
    submitBtn.innerHTML = '✓ Submit Stok';
    submitBtn.className = 'w-full mt-4 px-4 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg font-bold shadow-md hover:from-green-700 hover:to-teal-700 transition';
}

// ============================================
// SLIDESHOW PRESENTATION FUNCTIONALITY
// ============================================

let currentSlideIndex = 0;
let totalSlides = 0;
let slideshowData = null;
let autoHideTimer = null;
let presentationTimer = null;
let startTime = null;
let autoPlayInterval = null;
let selectedSlides = [];
let allSlideDefinitions = [];

// Slide definitions
const slideTemplates = [
    {
        id: 'title',
        name: 'Cover - ADVANTA',
        description: 'Slide pembuka dengan branding ADVANTA',
        icon: '🏢',
        bg: 'slide-bg-advanta',
        generator: (data) => `
            <div class="slide-content text-center" style="justify-content:center; align-items:center;">
                <div style="margin-bottom:2rem;">
                    <div style="font-size:5rem; font-weight:900; color:white; letter-spacing:-2px; text-shadow:0 4px 20px rgba(0,0,0,0.5);">
                        <span style="color:#10b981">A</span>DVANTA
                    </div>
                    <div style="font-size:1.1rem; color:rgba(255,255,255,0.6); font-weight:500; letter-spacing:0.2em; text-transform:uppercase; margin-top:0.5rem;">
                        Modern Science - Traditional Values
                    </div>
                </div>
                <div style="width:120px; height:3px; background:linear-gradient(90deg, #10b981, #3b82f6, #10b981); margin:2rem auto; border-radius:2px;"></div>
                <h2 style="font-size:2rem; margin-bottom:1rem; font-weight:700;">📊 Sales Presentation Dashboard</h2>
                <p style="font-size:1.3rem; opacity:0.8; margin-bottom:0.5rem;">Data Penjualan & Aktivitas</p>
                <p style="font-size:1rem; opacity:0.6;">${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <div style="margin-top:2rem; display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;">
                    <div style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:0.5rem; padding:0.5rem 1rem;">
                        <span style="font-size:0.7rem; color:rgba(255,255,255,0.5);">Distributor</span>
                        <div style="color:white; font-weight:700; font-size:0.9rem;">${data.filters.distributor}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:0.5rem; padding:0.5rem 1rem;">
                        <span style="font-size:0.7rem; color:rgba(255,255,255,0.5);">Periode</span>
                        <div style="color:white; font-weight:700; font-size:0.9rem;">${data.filters.month} ${data.filters.year}</div>
                    </div>
                </div>
                <div class="slide-footer">
                    <span>ADVANTA Sales Team</span>
                    <span>Confidential</span>
                </div>
            </div>
        `
    },
    {
        id: 'sales-overview',
        name: 'Data Penjualan',
        description: 'Dashboard overview penjualan lengkap',
        icon: '💰',
        bg: 'slide-bg-sales-dashboard',
        generator: (data) => `
            <div class="slide-content" style="padding:0;">
                <div class="slide-dashboard-header">
                    <h2 style="font-size:1.6rem;">💰 Data Penjualan</h2>
                    <div class="slide-brand">
                        <span style="color:#10b981; font-weight:900;">A</span>DVANTA
                        <span style="margin-left:0.5rem; opacity:0.5;">|</span>
                        <span style="font-size:0.8rem; opacity:0.5; margin-left:0.5rem;">${data.filters.month} ${data.filters.year}</span>
                    </div>
                </div>
                
                <!-- KPI Cards Row -->
                <div class="slide-kpi-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom:1rem;">
                    <div class="slide-kpi-card" style="border-left:3px solid #3b82f6; animation: countUp 0.5s ease-out 0.1s both;">
                        <div class="kpi-label">Total PO</div>
                        <div class="kpi-value" style="color:#60a5fa;">${data.metrics.totalPO}</div>
                        <div class="kpi-sub">Purchase Orders</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #10b981; animation: countUp 0.5s ease-out 0.2s both;">
                        <div class="kpi-label">Total Sales</div>
                        <div class="kpi-value" style="color:#34d399; font-size:1.2rem;">${data.metrics.totalSales}</div>
                        <div class="kpi-sub">Revenue</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #f59e0b; animation: countUp 0.5s ease-out 0.3s both;">
                        <div class="kpi-label">Total Qty</div>
                        <div class="kpi-value" style="color:#fbbf24;">${data.metrics.totalQty}</div>
                        <div class="kpi-sub">Units Sold</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #a855f7; animation: countUp 0.5s ease-out 0.4s both;">
                        <div class="kpi-label">DGA Activity</div>
                        <div class="kpi-value" style="color:#c084fc;">${data.metrics.totalDGA}</div>
                        <div class="kpi-sub">Team Activities</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #ef4444; animation: countUp 0.5s ease-out 0.5s both;">
                        <div class="kpi-label">Distributors</div>
                        <div class="kpi-value" style="color:#f87171;">${data.metrics.totalDistributors}</div>
                        <div class="kpi-sub">Active Partners</div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div style="display:grid; grid-template-columns:1.5fr 1fr; gap:1rem; flex:1; min-height:0;">
                    <div class="slide-chart-panel">
                        <div style="font-size:0.8rem; font-weight:700; color:rgba(255,255,255,0.7); margin-bottom:0.5rem;">📈 Tren Penjualan</div>
                        <div style="height:100%; max-height:280px;"><canvas id="slide-sales-chart"></canvas></div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.75rem;">
                        <div class="slide-chart-panel" style="flex:1;">
                            <div style="font-size:0.8rem; font-weight:700; color:rgba(255,255,255,0.7); margin-bottom:0.5rem;">🏆 Top 5 Varietas</div>
                            <div style="height:100%; max-height:250px;"><canvas id="slide-varieties-chart"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Customers Bar -->
                <div style="margin-top:0.75rem;">
                    <div class="slide-table-container">
                        <div style="padding:0.5rem 0.75rem; font-size:0.75rem; font-weight:700; color:rgba(255,255,255,0.7); background:rgba(255,255,255,0.05);">🏅 Top Customers</div>
                        <div style="padding:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;" id="slide-top-customers">
                            ${data.topCustomers ? data.topCustomers.map((c, i) => `
                                <div style="flex:1; min-width:120px; background:rgba(255,255,255,0.05); border-radius:0.5rem; padding:0.4rem 0.6rem; border:1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size:0.65rem; color:rgba(255,255,255,0.5);">#${i+1}</div>
                                    <div style="font-size:0.75rem; font-weight:700; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.name}</div>
                                    <div style="font-size:0.7rem; color:#34d399; font-weight:600;">${c.sales}</div>
                                </div>
                            `).join('') : '<span style="color:rgba(255,255,255,0.4); font-size:0.75rem;">No data</span>'}
                        </div>
                    </div>
                </div>
                
                <div class="slide-footer">
                    <span>Data Penjualan ADVANTA</span>
                    <span>${data.filters.distributor} | ${data.filters.month} ${data.filters.year}</span>
                </div>
            </div>
        `
    },
    {
        id: 'dga-dashboard',
        name: 'Aktivitas DGA',
        description: 'Dashboard lengkap aktivitas DGA team',
        icon: '👥',
        bg: 'slide-bg-dga-dashboard',
        generator: (data) => `
            <div class="slide-content" style="padding:0;">
                <div class="slide-dashboard-header">
                    <h2 style="font-size:1.6rem;">👥 Aktivitas DGA</h2>
                    <div class="slide-brand">
                        <span style="color:#10b981; font-weight:900;">A</span>DVANTA
                    </div>
                </div>
                
                <!-- DGA KPI Cards -->
                <div class="slide-kpi-grid" style="grid-template-columns: repeat(6, 1fr); margin-bottom:1rem;">
                    ${data.dgaTypes ? Object.entries(data.dgaTypes).map(([type, count], i) => {
                        const colors = { FM: '#3b82f6', ODP: '#10b981', FT: '#f59e0b', FFD: '#a855f7', DISPLAY: '#ec4899' };
                        const lightColors = { FM: '#60a5fa', ODP: '#34d399', FT: '#fbbf24', FFD: '#c084fc', DISPLAY: '#f472b6' };
                        return `
                            <div class="slide-kpi-card" style="border-left:3px solid ${colors[type] || '#6b7280'}; text-align:center; animation: countUp 0.5s ease-out ${i * 0.1}s both;">
                                <div class="kpi-label">${type}</div>
                                <div class="kpi-value" style="color:${lightColors[type] || '#fff'}; font-size:2rem;">${count}</div>
                            </div>
                        `;
                    }).join('') : ''}
                    <div class="slide-kpi-card" style="border-left:3px solid #f97316; text-align:center; background:rgba(249,115,22,0.1); animation: countUp 0.5s ease-out 0.5s both;">
                        <div class="kpi-label" style="color:#fb923c;">FARMER REACH</div>
                        <div class="kpi-value" style="color:#fb923c; font-size:1.8rem;">${data.farmerReach || '0'}</div>
                    </div>
                </div>
                
                <!-- DGA Detail Table -->
                <div class="slide-table-container" style="flex:1; overflow:auto; max-height:calc(100vh - 320px);">
                    <table class="slide-table">
                        <thead>
                            <tr>
                                <th>Business Solution</th>
                                <th style="text-align:center; color:#60a5fa;">FM</th>
                                <th style="text-align:center; color:#34d399;">ODP</th>
                                <th style="text-align:center; color:#fbbf24;">FT</th>
                                <th style="text-align:center; color:#c084fc;">FFD</th>
                                <th style="text-align:center; color:#f472b6;">Display</th>
                                <th style="text-align:center; background:rgba(255,255,255,0.08);">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.dgaBSData ? data.dgaBSData.map((bs, i) => `
                                <tr style="animation: countUp 0.4s ease-out ${0.1 + i * 0.05}s both;">
                                    <td style="font-weight:600;">${bs.name}</td>
                                    <td style="text-align:center;"><span class="slide-badge slide-badge-blue">${bs.FM || 0}</span></td>
                                    <td style="text-align:center;"><span class="slide-badge slide-badge-green">${bs.ODP || 0}</span></td>
                                    <td style="text-align:center;"><span class="slide-badge slide-badge-yellow">${bs.FT || 0}</span></td>
                                    <td style="text-align:center;"><span class="slide-badge" style="background:rgba(168,85,247,0.2); color:#c084fc;">${bs.FFD || 0}</span></td>
                                    <td style="text-align:center;"><span class="slide-badge" style="background:rgba(236,72,153,0.2); color:#f472b6;">${bs.DISPLAY || 0}</span></td>
                                    <td style="text-align:center; background:rgba(255,255,255,0.05);"><span style="font-weight:800; color:white; background:rgba(255,255,255,0.15); padding:0.15rem 0.5rem; border-radius:0.25rem; font-size:0.8rem;">${bs.total || 0}</span></td>
                                </tr>
                            `).join('') : '<tr><td colspan="7" style="text-align:center; color:rgba(255,255,255,0.4);">Tidak ada data DGA</td></tr>'}
                        </tbody>
                        ${data.dgaTotals ? `
                        <tfoot>
                            <tr style="background:rgba(99,102,241,0.2); font-weight:800;">
                                <td style="font-weight:900; text-transform:uppercase; letter-spacing:0.05em;">TOTAL</td>
                                <td style="text-align:center; color:#60a5fa; font-size:1rem;">${data.dgaTotals.FM || 0}</td>
                                <td style="text-align:center; color:#34d399; font-size:1rem;">${data.dgaTotals.ODP || 0}</td>
                                <td style="text-align:center; color:#fbbf24; font-size:1rem;">${data.dgaTotals.FT || 0}</td>
                                <td style="text-align:center; color:#c084fc; font-size:1rem;">${data.dgaTotals.FFD || 0}</td>
                                <td style="text-align:center; color:#f472b6; font-size:1rem;">${data.dgaTotals.DISPLAY || 0}</td>
                                <td style="text-align:center; background:rgba(255,255,255,0.1); font-size:1.1rem; color:#fbbf24;">${data.dgaTotals.total || 0}</td>
                            </tr>
                        </tfoot>` : ''}
                    </table>
                </div>
                
                <div class="slide-footer">
                    <span>DGA Activities Report</span>
                    <span>ADVANTA Sales Team</span>
                </div>
            </div>
        `
    },
    {
        id: 'stock-distributor',
        name: 'Stok Distributor',
        description: 'Ringkasan stok per distributor & varietas',
        icon: '📦',
        bg: 'slide-bg-stock-dashboard',
        generator: (data) => `
            <div class="slide-content" style="padding:0;">
                <div class="slide-dashboard-header">
                    <h2 style="font-size:1.6rem;">📦 Stok Distributor</h2>
                    <div class="slide-brand">
                        <span style="color:#10b981; font-weight:900;">A</span>DVANTA
                        <span style="margin-left:0.5rem; opacity:0.5;">|</span>
                        <span style="font-size:0.8rem; opacity:0.5; margin-left:0.5rem;">${data.stockSummary ? data.stockSummary.totalItems + ' items' : '0 items'}</span>
                    </div>
                </div>
                
                <!-- Stock Summary KPIs -->
                <div class="slide-kpi-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:1rem;">
                    <div class="slide-kpi-card" style="border-left:3px solid #06b6d4; animation: countUp 0.5s ease-out 0.1s both;">
                        <div class="kpi-label">Total Stok</div>
                        <div class="kpi-value" style="color:#22d3ee;">${data.stockSummary ? data.stockSummary.totalKG.toLocaleString('id-ID', {maximumFractionDigits:1}) + ' KG' : '0 KG'}</div>
                        <div class="kpi-sub">${data.stockSummary ? data.stockSummary.totalItems + ' items' : '0 items'}</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #10b981; animation: countUp 0.5s ease-out 0.2s both;">
                        <div class="kpi-label">Varietas</div>
                        <div class="kpi-value" style="color:#34d399;">${data.stockSummary ? data.stockSummary.totalVarieties : '0'}</div>
                        <div class="kpi-sub">Jenis Produk</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #f59e0b; animation: countUp 0.5s ease-out 0.3s both;">
                        <div class="kpi-label">Distributors</div>
                        <div class="kpi-value" style="color:#fbbf24;">${data.stockSummary ? data.stockSummary.totalDistributors : '0'}</div>
                        <div class="kpi-sub">Active Partners</div>
                    </div>
                </div>
                
                <!-- Stock by Variety Cards -->
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:0.75rem; flex:1; overflow:auto; max-height:calc(100vh - 340px); align-content:start;">
                    ${data.stockByVariety ? data.stockByVariety.map((item, i) => {
                        const colors = ['#06b6d4','#10b981','#f59e0b','#a855f7','#ec4899','#3b82f6','#ef4444','#14b8a6'];
                        const color = colors[i % colors.length];
                        const pct = data.stockSummary.totalKG > 0 ? ((item.totalKG / data.stockSummary.totalKG) * 100).toFixed(1) : 0;
                        return `
                            <div class="slide-kpi-card" style="border-left:3px solid ${color}; animation: countUp 0.5s ease-out ${0.1 + i * 0.08}s both;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                    <div class="kpi-label" style="margin:0;">${item.name}</div>
                                    <span class="slide-badge" style="background:rgba(255,255,255,0.1); color:rgba(255,255,255,0.6);">${pct}%</span>
                                </div>
                                <div class="kpi-value" style="color:${color}; font-size:1.3rem;">${item.totalKG.toLocaleString('id-ID', {maximumFractionDigits:1})} KG</div>
                                <div class="kpi-sub">${item.totalPCS.toLocaleString('id-ID', {maximumFractionDigits:0})} PCS | ${item.lots.length} lot</div>
                                <div class="slide-progress-bar" style="margin-top:0.35rem;">
                                    <div class="slide-progress-fill" style="width:${pct}%; background:${color};"></div>
                                </div>
                            </div>
                        `;
                    }).join('') : '<div style="color:rgba(255,255,255,0.4); text-align:center; grid-column:1/-1; padding:2rem;">Belum ada data stok</div>'}
                </div>
                
                <div class="slide-footer">
                    <span>Stok Distributor Report</span>
                    <span>ADVANTA Sales Team</span>
                </div>
            </div>
        `
    },
    {
        id: 'plan-penjualan',
        name: 'Plan Penjualan',
        description: 'Rencana pembelian & pencapaian',
        icon: '📋',
        bg: 'slide-bg-plan-dashboard',
        generator: (data) => `
            <div class="slide-content" style="padding:0;">
                <div class="slide-dashboard-header">
                    <h2 style="font-size:1.6rem;">📋 Plan Penjualan</h2>
                    <div class="slide-brand">
                        <span style="color:#10b981; font-weight:900;">A</span>DVANTA
                    </div>
                </div>
                
                <!-- Plan KPIs -->
                <div class="slide-kpi-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom:1rem;">
                    <div class="slide-kpi-card" style="border-left:3px solid #3b82f6; animation: countUp 0.5s ease-out 0.1s both;">
                        <div class="kpi-label">Total Plans</div>
                        <div class="kpi-value" style="color:#60a5fa;">${data.planSummary ? data.planSummary.count : '0'}</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #10b981; animation: countUp 0.5s ease-out 0.2s both;">
                        <div class="kpi-label">Total Plan QTY</div>
                        <div class="kpi-value" style="color:#34d399; font-size:1.2rem;">${data.planSummary ? data.planSummary.totalQty.toLocaleString('id-ID', {minimumFractionDigits:1}) + ' KG' : '0 KG'}</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #a855f7; animation: countUp 0.5s ease-out 0.3s both;">
                        <div class="kpi-label">Distributors</div>
                        <div class="kpi-value" style="color:#c084fc;">${data.planSummary ? data.planSummary.distributors : '0'}</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #f59e0b; animation: countUp 0.5s ease-out 0.4s both;">
                        <div class="kpi-label">Varieties</div>
                        <div class="kpi-value" style="color:#fbbf24;">${data.planSummary ? data.planSummary.varieties : '0'}</div>
                    </div>
                    <div class="slide-kpi-card" style="border-left:3px solid #ec4899; animation: countUp 0.5s ease-out 0.5s both;">
                        <div class="kpi-label">Total Value</div>
                        <div class="kpi-value" style="color:#f472b6; font-size:1rem;">${data.planSummary ? data.planSummary.totalValue : 'Rp 0'}</div>
                    </div>
                </div>
                
                <!-- Plan Cards -->
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:0.75rem; flex:1; overflow:auto; max-height:calc(100vh - 320px); align-content:start;">
                    ${data.planCards ? data.planCards.slice(0, 9).map((plan, i) => {
                        const achievePct = plan.planTotal > 0 ? ((plan.realization / plan.planTotal) * 100) : 0;
                        const achieveColor = achievePct >= 100 ? '#10b981' : achievePct >= 80 ? '#f59e0b' : '#ef4444';
                        return `
                            <div class="slide-kpi-card" style="animation: countUp 0.4s ease-out ${0.1 + i * 0.06}s both;">
                                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.4rem;">
                                    <div>
                                        <div style="font-size:0.85rem; font-weight:800; color:white;">${plan.variety}</div>
                                        <div style="font-size:0.65rem; color:rgba(255,255,255,0.5);">${plan.distributor}</div>
                                    </div>
                                    <span class="slide-badge" style="background:rgba(255,255,255,0.1); color:${achieveColor}; font-size:0.7rem;">${achievePct.toFixed(1)}%</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; margin-bottom:0.3rem;">
                                    <div>
                                        <div style="font-size:0.6rem; color:rgba(255,255,255,0.5);">Plan</div>
                                        <div style="font-size:0.9rem; font-weight:800; color:#60a5fa;">${plan.planTotal.toLocaleString('id-ID', {minimumFractionDigits:1})} KG</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size:0.6rem; color:rgba(255,255,255,0.5);">Realisasi</div>
                                        <div style="font-size:0.9rem; font-weight:800; color:${achieveColor};">${plan.realization.toLocaleString('id-ID', {minimumFractionDigits:1})} KG</div>
                                    </div>
                                </div>
                                <div class="slide-progress-bar">
                                    <div class="slide-progress-fill" style="width:${Math.min(achievePct, 100)}%; background:${achieveColor};"></div>
                                </div>
                                <div style="font-size:0.6rem; color:rgba(255,255,255,0.4); margin-top:0.2rem;">${plan.month} ${plan.fiscalYear}</div>
                            </div>
                        `;
                    }).join('') : '<div style="color:rgba(255,255,255,0.4); text-align:center; grid-column:1/-1; padding:2rem;">Tidak ada plan PO</div>'}
                </div>
                
                <div class="slide-footer">
                    <span>Planning PO Report</span>
                    <span>ADVANTA Sales Team</span>
                </div>
            </div>
        `
    },
    {
        id: 'compare-fy',
        name: 'Compare FY',
        description: 'Perbandingan antar Fiscal Year',
        icon: '📊',
        bg: 'slide-bg-compare-fy',
        generator: (data) => `
            <div class="slide-content" style="padding:0;">
                <div class="slide-dashboard-header">
                    <h2 style="font-size:1.6rem;">📊 Compare Fiscal Year</h2>
                    <div class="slide-brand">
                        <span style="color:#10b981; font-weight:900;">A</span>DVANTA
                    </div>
                </div>
                
                ${data.fyComparison ? `
                    <!-- FY Comparison KPIs -->
                    <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:1rem; margin-bottom:1rem;">
                        <!-- FY 1 -->
                        <div class="slide-kpi-card" style="border-top:3px solid #3b82f6;">
                            <div style="font-size:0.85rem; font-weight:800; color:#60a5fa; margin-bottom:0.5rem;">FY ${data.fyComparison.fy1.label}</div>
                            <div style="display:grid; gap:0.4rem;">
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">PO</span><span style="color:white; font-weight:700;">${data.fyComparison.fy1.po.toLocaleString('id-ID')}</span></div>
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">Sales</span><span style="color:#34d399; font-weight:700; font-size:0.8rem;">Rp ${data.fyComparison.fy1.sales.toLocaleString('id-ID')}</span></div>
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">Qty</span><span style="color:white; font-weight:700;">${data.fyComparison.fy1.qty.toLocaleString('id-ID')}</span></div>
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">DGA</span><span style="color:white; font-weight:700;">${data.fyComparison.fy1.dga.toLocaleString('id-ID')}</span></div>
                            </div>
                        </div>
                        
                        <!-- Growth/Diff -->
                        <div class="slide-kpi-card" style="border-top:3px solid #f97316; background:rgba(249,115,22,0.08); display:flex; flex-direction:column; justify-content:center; align-items:center; min-width:140px;">
                            <div style="font-size:0.7rem; font-weight:700; color:#fb923c; text-transform:uppercase; margin-bottom:0.5rem;">Growth</div>
                            <div style="font-size:2rem; font-weight:900; color:${data.fyComparison.growth >= 0 ? '#34d399' : '#f87171'};">
                                ${data.fyComparison.growth >= 0 ? '↑' : '↓'} ${Math.abs(data.fyComparison.growth).toFixed(1)}%
                            </div>
                            <div style="font-size:0.65rem; color:rgba(255,255,255,0.5); margin-top:0.25rem;">Sales Growth</div>
                        </div>
                        
                        <!-- FY 2 -->
                        <div class="slide-kpi-card" style="border-top:3px solid #10b981;">
                            <div style="font-size:0.85rem; font-weight:800; color:#34d399; margin-bottom:0.5rem;">FY ${data.fyComparison.fy2.label}</div>
                            <div style="display:grid; gap:0.4rem;">
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">PO</span><span style="color:white; font-weight:700;">${data.fyComparison.fy2.po.toLocaleString('id-ID')}</span></div>
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">Sales</span><span style="color:#34d399; font-weight:700; font-size:0.8rem;">Rp ${data.fyComparison.fy2.sales.toLocaleString('id-ID')}</span></div>
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">Qty</span><span style="color:white; font-weight:700;">${data.fyComparison.fy2.qty.toLocaleString('id-ID')}</span></div>
                                <div style="display:flex; justify-content:space-between;"><span class="kpi-sub">DGA</span><span style="color:white; font-weight:700;">${data.fyComparison.fy2.dga.toLocaleString('id-ID')}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FY Comparison Chart -->
                    <div class="slide-chart-panel" style="flex:1; min-height:0;">
                        <div style="font-size:0.8rem; font-weight:700; color:rgba(255,255,255,0.7); margin-bottom:0.5rem;">📈 Grafik Perbandingan Penjualan Bulanan</div>
                        <div style="height:100%; max-height:300px;"><canvas id="slide-fy-comparison-chart"></canvas></div>
                    </div>
                ` : `
                    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; color:rgba(255,255,255,0.5);">
                        <div style="font-size:4rem; margin-bottom:1rem;">📊</div>
                        <p style="font-size:1.2rem; font-weight:600;">Pilih 2 Fiscal Year untuk Compare</p>
                        <p style="font-size:0.9rem; opacity:0.6;">Gunakan panel Compare di Presentation Dashboard</p>
                    </div>
                `}
                
                <div class="slide-footer">
                    <span>FY Comparison Report</span>
                    <span>ADVANTA Sales Team</span>
                </div>
            </div>
        `
    },
    {
        id: 'growth-sales',
        name: 'Growth Sales',
        description: 'Pertumbuhan penjualan per varietas',
        icon: '🚀',
        bg: 'slide-bg-growth-dashboard',
        generator: (data) => `
            <div class="slide-content" style="padding:0;">
                <div class="slide-dashboard-header">
                    <h2 style="font-size:1.6rem;">🚀 Growth Sales</h2>
                    <div class="slide-brand">
                        <span style="color:#10b981; font-weight:900;">A</span>DVANTA
                        <span style="margin-left:0.5rem; opacity:0.5;">|</span>
                        <span style="font-size:0.8rem; opacity:0.5; margin-left:0.5rem;">${data.growthInfo ? data.growthInfo.currentFY + ' vs ' + data.growthInfo.previousFY : ''}</span>
                    </div>
                </div>
                
                <!-- Growth Cards -->
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:0.75rem; flex:1; overflow:auto; max-height:calc(100vh - 220px); align-content:start;">
                    ${data.growthData ? data.growthData.slice(0, 12).map((item, i) => {
                        const isPositive = item.growth >= 0;
                        const color = isPositive ? '#10b981' : '#ef4444';
                        const lightColor = isPositive ? '#34d399' : '#f87171';
                        const icon = isPositive ? '📈' : '📉';
                        const progressPct = Math.min(Math.abs(item.growth), 100);
                        return `
                            <div class="slide-kpi-card" style="border-left:3px solid ${color}; animation: countUp 0.4s ease-out ${0.1 + i * 0.06}s both;">
                                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.4rem;">
                                    <div style="font-size:0.85rem; font-weight:800; color:white;">${item.name}</div>
                                    <span style="font-size:1.2rem;">${icon}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:0.3rem;">
                                    <div>
                                        <div style="font-size:0.6rem; color:rgba(255,255,255,0.5);">Current</div>
                                        <div style="font-size:1rem; font-weight:800; color:#60a5fa;">${item.current.toLocaleString('id-ID', {maximumFractionDigits:1})} KG</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size:0.6rem; color:rgba(255,255,255,0.5);">Previous</div>
                                        <div style="font-size:0.85rem; font-weight:600; color:rgba(255,255,255,0.6);">${item.previous.toLocaleString('id-ID', {maximumFractionDigits:1})} KG</div>
                                    </div>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div class="slide-progress-bar" style="flex:1; margin-right:0.5rem;">
                                        <div class="slide-progress-fill" style="width:${progressPct}%; background:${color};"></div>
                                    </div>
                                    <span style="font-size:0.85rem; font-weight:800; color:${lightColor}; white-space:nowrap;">${isPositive ? '+' : ''}${item.growth.toFixed(1)}%</span>
                                </div>
                                <div style="font-size:0.6rem; color:rgba(255,255,255,0.4); margin-top:0.2rem;">
                                    ${isPositive ? '↑' : '↓'} ${Math.abs(item.absoluteGrowth).toLocaleString('id-ID', {maximumFractionDigits:1})} KG ${isPositive ? 'increase' : 'decrease'}
                                </div>
                            </div>
                        `;
                    }).join('') : '<div style="color:rgba(255,255,255,0.4); text-align:center; grid-column:1/-1; padding:2rem;">Belum ada data growth</div>'}
                </div>
                
                <div class="slide-footer">
                    <span>Growth Sales Analysis</span>
                    <span>ADVANTA Sales Team</span>
                </div>
            </div>
        `
    },
    {
        id: 'sales-trend',
        name: 'Tren & Chart',
        description: 'Grafik tren penjualan & status PO',
        icon: '📈',
        bg: 'slide-bg-gradient-5',
        generator: (data) => `
            <div class="slide-content" style="padding:0;">
                <div class="slide-dashboard-header">
                    <h2 style="font-size:1.6rem;">📈 Sales Analytics</h2>
                    <div class="slide-brand">
                        <span style="color:#10b981; font-weight:900;">A</span>DVANTA
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; flex:1; min-height:0;">
                    <div class="slide-chart-panel">
                        <div style="font-size:0.8rem; font-weight:700; color:rgba(255,255,255,0.7); margin-bottom:0.5rem;">Tren Penjualan</div>
                        <div style="height:100%; max-height:350px;"><canvas id="slide-sales-chart-2"></canvas></div>
                    </div>
                    <div class="slide-chart-panel">
                        <div style="font-size:0.8rem; font-weight:700; color:rgba(255,255,255,0.7); margin-bottom:0.5rem;">Top 5 Varietas</div>
                        <div style="height:100%; max-height:350px;"><canvas id="slide-varieties-chart-2"></canvas></div>
                    </div>
                </div>
                <div class="slide-footer">
                    <span>Sales Analytics</span>
                    <span>ADVANTA Sales Team</span>
                </div>
            </div>
        `
    },
    {
        id: 'thank-you',
        name: 'Terima Kasih',
        description: 'Slide penutup presentasi',
        icon: '🙏',
        bg: 'slide-bg-advanta',
        generator: (data) => `
            <div class="slide-content text-center" style="justify-content:center; align-items:center;">
                <div style="margin-bottom:2rem;">
                    <div style="font-size:4rem; font-weight:900; color:white; letter-spacing:-2px;">
                        <span style="color:#10b981">A</span>DVANTA
                    </div>
                    <div style="font-size:0.9rem; color:rgba(255,255,255,0.5); letter-spacing:0.2em; text-transform:uppercase;">
                        Modern Science - Traditional Values
                    </div>
                </div>
                <div style="width:100px; height:3px; background:linear-gradient(90deg, #10b981, #3b82f6, #10b981); margin:1.5rem auto; border-radius:2px;"></div>
                <h1 style="font-size:3rem; margin-bottom:0.5rem;">🙏 Terima Kasih</h1>
                <h2 style="font-size:1.5rem; margin-bottom:1.5rem; opacity:0.8;">Thank You for Your Attention</h2>
                <p style="font-size:1.2rem; opacity:0.6;">Keep Growing Together 🌱</p>
                <div style="margin-top:2rem; font-size:0.9rem; color:rgba(255,255,255,0.4);">
                    Advanta Sales Team | ${new Date().getFullYear()}
                </div>
                <div class="slide-footer">
                    <span>ADVANTA Sales Team</span>
                    <span>Confidential</span>
                </div>
            </div>
        `
    }
];

function startSlideshow() {
    // Open settings modal first
    openSettingsModal();
}

function openSettingsModal() {
    prepareSlideshowData();
    
    const modal = document.getElementById('slideshow-settings-modal');
    const container = document.getElementById('slide-checkbox-container');
    
    // Generate checkboxes
    container.innerHTML = slideTemplates.map((slide, index) => `
        <div class="slide-checkbox-item ${index < slideTemplates.length ? 'selected' : ''}" onclick="toggleSlideSelection('${slide.id}', this)">
            <label class="slide-checkbox-label">
                <input type="checkbox" id="slide-${slide.id}" value="${slide.id}" ${index < slideTemplates.length ? 'checked' : ''} onclick="event.stopPropagation()">
                <span>${slide.icon} ${slide.name}</span>
            </label>
            <div class="slide-checkbox-desc">${slide.description}</div>
        </div>
    `).join('');
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Setup auto-play toggle
    document.getElementById('auto-play').addEventListener('change', function() {
        document.getElementById('autoplay-interval-container').style.display = this.checked ? 'block' : 'none';
    });
}

function closeSettingsModal() {
    const modal = document.getElementById('slideshow-settings-modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

function toggleSlideSelection(slideId, element) {
    const checkbox = document.getElementById(`slide-${slideId}`);
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        element.classList.add('selected');
    } else {
        element.classList.remove('selected');
    }
}

function selectAllSlides() {
    slideTemplates.forEach(slide => {
        const checkbox = document.getElementById(`slide-${slide.id}`);
        const item = checkbox.closest('.slide-checkbox-item');
        checkbox.checked = true;
        item.classList.add('selected');
    });
}

function deselectAllSlides() {
    slideTemplates.forEach(slide => {
        const checkbox = document.getElementById(`slide-${slide.id}`);
        const item = checkbox.closest('.slide-checkbox-item');
        checkbox.checked = false;
        item.classList.remove('selected');
    });
}

function startSlideshowWithSettings() {
    // Get selected slides
    selectedSlides = [];
    slideTemplates.forEach(slide => {
        const checkbox = document.getElementById(`slide-${slide.id}`);
        if (checkbox && checkbox.checked) {
            selectedSlides.push(slide);
        }
    });
    
    if (selectedSlides.length === 0) {
        alert('Pilih minimal 1 slide untuk presentasi!');
        return;
    }
    
    // Get settings
    const showTimer = document.getElementById('show-timer').checked;
    const showThumbnails = document.getElementById('show-thumbnails').checked;
    const autoPlay = document.getElementById('auto-play').checked;
    const autoPlayIntervalValue = parseInt(document.getElementById('autoplay-interval').value) || 5;
    
    // Close modal
    closeSettingsModal();
    
    // Generate slides
    generateSlides();
    
    // Show slideshow
    const slideshow = document.getElementById('presentation-slideshow');
    slideshow.classList.add('active');
    
    // Show/hide timer
    if (showTimer) {
        startPresentationTimer();
    }
    
    // Show/hide thumbnails
    if (showThumbnails) {
        generateThumbnails();
        document.getElementById('thumbnail-nav').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('thumbnail-nav').classList.add('visible');
        }, 100);
    }
    
    // Setup auto-play
    if (autoPlay) {
        startAutoPlay(autoPlayIntervalValue);
    }
    
    // Hide sidebar and main content
    document.body.style.overflow = 'hidden';
    
    // Show first slide
    showSlide(0);
    
    // Setup auto-hide controls
    setupAutoHideControls();
}

function prepareSlideshowData() {
    // Safe defaults
    const safeDefaults = {
        filters: { distributor: 'All', month: 'All', year: 'All', period: 'All' },
        metrics: { totalPO: '0', totalSales: 'Rp 0', totalQty: '0', totalDGA: '0', totalDistributors: '0' },
        dgaTypes: { FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0 },
        dgaBSData: [],
        dgaTotals: { FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0, total: 0 },
        farmerReach: '0',
        stockSummary: { totalKG: 0, totalItems: 0, totalVarieties: 0, totalDistributors: 0 },
        stockByVariety: [],
        planSummary: { count: 0, totalQty: 0, distributors: 0, varieties: 0, totalValue: 'Rp 0' },
        planCards: [],
        fyComparison: null,
        growthData: [],
        growthInfo: { currentFY: '', previousFY: '' },
        topCustomers: []
    };
    
    try {
    console.log('[SLIDESHOW] prepareSlideshowData starting...');
    // Get current data from presentation page
    const totalPO = document.getElementById('pres-total-po')?.textContent || '0';
    const totalSales = document.getElementById('pres-total-sales')?.textContent || 'Rp 0';
    const totalQty = document.getElementById('pres-total-qty')?.textContent || '0';
    const totalDGA = document.getElementById('pres-total-dga')?.textContent || '0';
    const totalDistributors = document.getElementById('pres-total-distributors')?.textContent || '0';
    
    // Get filter info
    const distributorEl = document.getElementById('pres-distributor');
    const monthEl = document.getElementById('pres-month');
    const yearEl = document.getElementById('pres-year');
    const periodEl = document.getElementById('pres-period');
    
    const distributor = distributorEl ? distributorEl.options[distributorEl.selectedIndex].text : 'All';
    const month = monthEl ? monthEl.options[monthEl.selectedIndex].text : 'All';
    const year = yearEl ? yearEl.options[yearEl.selectedIndex].text : 'All';
    const period = periodEl ? periodEl.options[periodEl.selectedIndex].text : 'All';
    
    // === DGA Data by Type & BS ===
    let allDGA = [];
    if (Array.isArray(appState.dgaActivities)) {
        allDGA = appState.dgaActivities;
    } else if (appState.dgaActivities && typeof appState.dgaActivities === 'object') {
        allDGA = Object.values(appState.dgaActivities).flat();
    }
    
    // Apply distributor filter to DGA
    const selectedDist = distributorEl?.value || '';
    if (selectedDist) {
        allDGA = allDGA.filter(a => a.distributorId == parseInt(selectedDist));
    }
    
    // DGA by type
    const dgaTypes = { FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0 };
    allDGA.forEach(a => {
        const type = (a.type || '').toUpperCase();
        if (dgaTypes[type] !== undefined) dgaTypes[type] += (a.count || 1);
    });
    
    // Farmer reach calculation
    const multipliers = appState.farmerReachMultipliers || { FM: 25, ODP: 25, FT: 20, FFD: 60, DISPLAY: 0 };
    const farmerReach = Object.entries(dgaTypes).reduce((s, [t, c]) => s + c * (multipliers[t] || 0), 0);
    
    // DGA by Business Solution
    const bsMap = {};
    allDGA.forEach(a => {
        const bsName = a.bsName || 'Unknown';
        if (!bsMap[bsName]) bsMap[bsName] = { name: bsName, FM: 0, ODP: 0, FT: 0, FFD: 0, DISPLAY: 0, total: 0 };
        const type = (a.type || '').toUpperCase();
        if (bsMap[bsName][type] !== undefined) {
            bsMap[bsName][type] += (a.count || 1);
        }
        bsMap[bsName].total += (a.count || 1);
    });
    const dgaBSData = Object.values(bsMap).sort((a, b) => b.total - a.total);
    const dgaTotals = { FM: dgaTypes.FM, ODP: dgaTypes.ODP, FT: dgaTypes.FT, FFD: dgaTypes.FFD, DISPLAY: dgaTypes.DISPLAY, total: Object.values(dgaTypes).reduce((s, v) => s + v, 0) };
    
    // === Stock Distributor Data ===
    const stocks = appState.stockDistributor || [];
    const varieties = appState.varieties || [];
    const distributors = appState.distributors || [];
    const stockByVarietyMap = {};
    let stockTotalKG = 0;
    const stockDistNames = new Set();
    
    stocks.forEach(s => {
        const v = varieties.find(vr => vr.id == s.varietyId);
        const name = v ? v.name : 'Unknown';
        const w = v ? (v.weight || 1000) : 1000;
        let kg = parseFloat(s.qty || 0);
        if ((s.unit || 'KG') !== 'KG') {
            kg = (kg * w) / 1000;
        }
        const pcs = (kg * 1000) / w;
        
        if (!stockByVarietyMap[name]) {
            stockByVarietyMap[name] = { name, totalKG: 0, totalPCS: 0, lots: new Set(), distributors: new Set() };
        }
        stockByVarietyMap[name].totalKG += kg;
        stockByVarietyMap[name].totalPCS += pcs;
        if (s.lotNumber) stockByVarietyMap[name].lots.add(s.lotNumber);
        if (s.distributorName) {
            stockByVarietyMap[name].distributors.add(s.distributorName);
            stockDistNames.add(s.distributorName);
        }
        stockTotalKG += kg;
    });
    
    const stockByVariety = Object.values(stockByVarietyMap).map(v => ({
        ...v,
        lots: Array.from(v.lots),
        distributors: Array.from(v.distributors)
    })).sort((a, b) => b.totalKG - a.totalKG);
    
    const stockSummary = {
        totalKG: stockTotalKG,
        totalItems: stocks.length,
        totalVarieties: Object.keys(stockByVarietyMap).length,
        totalDistributors: stockDistNames.size
    };
    
    // === Plan PO Data ===
    const plans = appState.planPO || [];
    const planCards = plans.map(plan => {
        const v = varieties.find(vr => vr.id == plan.varietyId);
        const d = distributors.find(dr => dr.id == plan.distributorId);
        const planTotal = parseFloat(plan.total || 0);
        
        // Calculate realization from POs
        let realization = 0;
        const pos = appState.purchaseOrders || [];
        pos.forEach(po => {
            if (po.distributorId != plan.distributorId) return;
            (po.items || []).forEach(item => {
                if (item.varietyId != plan.varietyId) return;
                const poDate = new Date(po.poDate);
                const poMonth = poDate.getMonth() + 1;
                if (poMonth !== parseInt(plan.month)) return;
                const w = v ? (v.weight || 1000) : 1000;
                (item.releases || []).forEach(r => {
                    realization += ((r.qty || 0) * w) / 1000;
                });
            });
        });
        
        return {
            variety: v ? v.name : 'N/A',
            distributor: d ? d.name : 'N/A',
            planTotal,
            realization,
            month: ['', 'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'][parseInt(plan.month) || 0],
            fiscalYear: plan.fiscalYear || ''
        };
    });
    
    let planTotalQty = 0, planTotalValue = 0;
    const planDistSet = new Set(), planVarSet = new Set();
    plans.forEach(p => {
        planTotalQty += parseFloat(p.total || 0);
        planDistSet.add(p.distributorId);
        planVarSet.add(p.varietyId);
    });
    
    const planSummary = {
        count: plans.length,
        totalQty: planTotalQty,
        distributors: planDistSet.size,
        varieties: planVarSet.size,
        totalValue: 'Rp ' + planTotalValue.toLocaleString('id-ID')
    };
    
    // === Inline getFiscalYear helper (original is in nested scope) ===
    function _getFY(date) { return date.getMonth() >= 3 ? date.getFullYear() : date.getFullYear() - 1; }
    
    // Inline calculateFYMetrics helper
    function _calcFYMetrics(fiscalYear) {
        const allPOs = appState.purchaseOrders || [];
        let allDGALocal = [];
        if (Array.isArray(appState.dgaActivities)) {
            allDGALocal = appState.dgaActivities;
        } else if (appState.dgaActivities && typeof appState.dgaActivities === 'object') {
            allDGALocal = Object.values(appState.dgaActivities).flat();
        }
        // Filter by distributor
        let fPOs = allPOs, fDGA = allDGALocal;
        if (selectedDist) {
            const distId = parseInt(selectedDist);
            fPOs = fPOs.filter(po => po.distributorId == distId);
            fDGA = fDGA.filter(act => act.distributorId == distId);
        }
        const pos = fPOs.filter(po => po.poDate && _getFY(new Date(po.poDate)) === fiscalYear);
        const dgaActs = fDGA.filter(act => act.month && _getFY(new Date(act.month + '-01')) === fiscalYear);
        const monthlyData = {};
        for (let m = 4; m <= 15; m++) {
            const mo = m > 12 ? m - 12 : m;
            const yr = m > 12 ? fiscalYear + 1 : fiscalYear;
            monthlyData[yr + '-' + String(mo).padStart(2, '0')] = { sales: 0, qty: 0, po: 0 };
        }
        let qty = 0, sales = 0;
        pos.forEach(po => {
            const mk = po.poDate ? po.poDate.substring(0, 7) : null;
            if (mk && monthlyData[mk]) monthlyData[mk].po += 1;
            (po.items || []).forEach(item => {
                const rQty = (item.releases || []).reduce((s, r) => s + (r.qty || 0), 0);
                qty += rQty;
                sales += rQty * (item.price || 0);
                if (mk && monthlyData[mk]) { monthlyData[mk].qty += rQty; monthlyData[mk].sales += rQty * (item.price || 0); }
            });
        });
        return { po: pos.length, sales, qty, dga: dgaActs.length, monthlyData };
    }
    
    // === FY Comparison Data ===
    let fyComparison = null;
    try {
        const fy1Select = document.getElementById('compare-fy1') || document.getElementById('fy-compare-1');
        const fy2Select = document.getElementById('compare-fy2') || document.getElementById('fy-compare-2');
        if (fy1Select && fy2Select && fy1Select.value && fy2Select.value) {
            const fy1Val = parseInt(fy1Select.value);
            const fy2Val = parseInt(fy2Select.value);
            const fy1Data = _calcFYMetrics(fy1Val);
            const fy2Data = _calcFYMetrics(fy2Val);
            const growth = fy1Data.sales > 0 ? ((fy2Data.sales - fy1Data.sales) / fy1Data.sales * 100) : 0;
            
            fyComparison = {
                fy1: { label: fy1Val + '/' + (fy1Val + 1), ...fy1Data },
                fy2: { label: fy2Val + '/' + (fy2Val + 1), ...fy2Data },
                growth
            };
        }
    } catch(e) { console.warn('FY comparison data unavailable:', e); }
    
    // === Growth Data per Variety ===
    const currentFY = _getFY(new Date());
    const previousFY = currentFY - 1;
    const growthData = [];
    
    try {
        const allPOs = appState.purchaseOrders || [];
        const currentFYSales = {};
        const previousFYSales = {};
        
        allPOs.forEach(po => {
            if (!po.poDate || !po.items) return;
            const poFY = _getFY(new Date(po.poDate));
            if (poFY !== currentFY && poFY !== previousFY) return;
            
            // Apply distributor filter
            if (selectedDist && po.distributorId != parseInt(selectedDist)) return;
            
            po.items.forEach(item => {
                const v = varieties.find(vr => vr.id == item.varietyId);
                const name = v ? v.name : (item.name || 'Unknown');
                const w = v ? (v.weight || 1000) : (item.weight || 1000);
                const target = poFY === currentFY ? currentFYSales : previousFYSales;
                
                if (!target[name]) target[name] = { kg: 0, qty: 0, nominal: 0 };
                
                (item.releases || []).forEach(r => {
                    const rQty = r.qty || 0;
                    target[name].kg += (rQty * w) / 1000;
                    target[name].qty += rQty;
                    target[name].nominal += rQty * (item.price || 0);
                });
            });
        });
        
        const allVarietyNames = new Set([...Object.keys(currentFYSales), ...Object.keys(previousFYSales)]);
        allVarietyNames.forEach(name => {
            const current = currentFYSales[name]?.kg || 0;
            const previous = previousFYSales[name]?.kg || 0;
            const growth = previous > 0 ? ((current - previous) / previous * 100) : (current > 0 ? 100 : 0);
            const absoluteGrowth = current - previous;
            
            growthData.push({ name, current, previous, growth, absoluteGrowth });
        });
        
        growthData.sort((a, b) => Math.abs(b.absoluteGrowth) - Math.abs(a.absoluteGrowth));
    } catch(e) { console.warn('Growth data unavailable:', e); }
    
    // === Top Customers ===
    const topCustomers = [];
    try {
        const customerSales = {};
        const allPOs = appState.purchaseOrders || [];
        allPOs.forEach(po => {
            if (!po.items) return;
            if (selectedDist && po.distributorId != parseInt(selectedDist)) return;
            const d = distributors.find(dr => dr.id == po.distributorId);
            const dName = d ? d.name : 'Unknown';
            if (!customerSales[dName]) customerSales[dName] = 0;
            po.items.forEach(item => {
                (item.releases || []).forEach(r => {
                    customerSales[dName] += (r.qty || 0) * (item.price || 0);
                });
            });
        });
        
        Object.entries(customerSales)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .forEach(([name, sales]) => {
                topCustomers.push({ name, sales: 'Rp ' + sales.toLocaleString('id-ID') });
            });
    } catch(e) {}
    
    slideshowData = {
        filters: { distributor, month, year, period },
        metrics: {
            totalPO,
            totalSales,
            totalQty,
            totalDGA,
            totalDistributors
        },
        dgaTypes: dgaTypes || {},
        dgaBSData: dgaBSData || [],
        dgaTotals: dgaTotals || {},
        farmerReach: (typeof farmerReach === 'number' ? farmerReach : 0).toLocaleString('id-ID'),
        stockSummary: stockSummary || { totalKG: 0, totalItems: 0, totalVarieties: 0, totalDistributors: 0 },
        stockByVariety: stockByVariety || [],
        planSummary: planSummary || { count: 0, totalQty: 0, distributors: 0, varieties: 0, totalValue: 'Rp 0' },
        planCards: planCards || [],
        fyComparison: fyComparison || null,
        growthData: growthData || [],
        growthInfo: { currentFY: 'FY' + (currentFY || 0) + '/' + ((currentFY || 0) + 1), previousFY: 'FY' + (previousFY || 0) + '/' + ((previousFY || 0) + 1) },
        topCustomers: topCustomers || []
    };
    console.log('[SLIDESHOW] slideshowData prepared OK, keys:', Object.keys(slideshowData));
    } catch(err) {
        console.error('[SLIDESHOW] Error preparing slideshow data:', err);
        slideshowData = safeDefaults;
    }
}

function generateSlides() {
    // Refresh data before generating slides
    prepareSlideshowData();
    console.log('[SLIDESHOW] generateSlides called, slideshowData is:', slideshowData ? 'SET' : 'NULL', ', selectedSlides:', selectedSlides.length);
    
    const container = document.getElementById('slides-container');
    if (!container) { console.error('[SLIDESHOW] slides-container not found!'); return; }
    container.innerHTML = '';
    
    selectedSlides.forEach((slide, index) => {
        const slideEl = document.createElement('div');
        slideEl.className = `slide ${slide.bg} ${index === 0 ? 'active' : ''}`;
        slideEl.setAttribute('data-slide-id', slide.id);
        try {
            const html = slide.generator(slideshowData);
            slideEl.innerHTML = html;
            console.log('[SLIDESHOW] Slide', index+1, slide.id, '- generated OK,', html.length, 'chars');
        } catch(e) {
            console.error('[SLIDESHOW] Error generating slide:', slide.id, e);
            slideEl.innerHTML = `<div class="slide-content" style="justify-content:center;align-items:center;text-align:center;"><h2 style="color:#ff6b6b; font-size:2rem;">⚠️ Error: ${slide.name}</h2><p style="color:white; font-size:1.2rem; margin-top:1rem;">${e.message}</p></div>`;
        }
        container.appendChild(slideEl);
    });
    
    console.log('[SLIDESHOW] Total slides appended:', container.children.length);
    
    totalSlides = selectedSlides.length;
    updateSlideCounter();
    updateProgress();
    
    // Debug info overlay (temporary)
    let debugDiv = document.getElementById('slide-debug-info');
    if (!debugDiv) {
        debugDiv = document.createElement('div');
        debugDiv.id = 'slide-debug-info';
        debugDiv.style.cssText = 'position:fixed;top:0;left:0;background:rgba(0,0,0,0.9);color:#0f0;font-family:monospace;font-size:10px;padding:8px;z-index:99999;max-width:320px;max-height:250px;overflow:auto;border:1px solid #0f0;border-radius:0 0 8px 0;';
        document.getElementById('presentation-slideshow')?.appendChild(debugDiv);
    }
    
    // Update debug function
    window.updateSlideshowDebug = function() {
        const container = document.getElementById('slides-container');
        const activeSlide = container?.querySelector('.slide.active');
        debugDiv.innerHTML = `<b>SLIDESHOW DEBUG</b><br>
            Slides: ${container?.children.length || 0}<br>
            Data: ${slideshowData ? 'OK' : 'NULL'}<br>
            Current: ${currentSlideIndex + 1}<br>
            Active: ${activeSlide ? activeSlide.getAttribute('data-slide-id') : 'NONE'}<br>
            ${activeSlide ? 'Opacity: ' + window.getComputedStyle(activeSlide).opacity : ''}<br>
            ${selectedSlides.map((s,i) => {
                const el = container?.children[i];
                const hasActive = el?.classList.contains('active');
                const hasContent = el ? el.innerHTML.length > 100 : false;
                return 'S' + (i+1) + (hasActive ? '<b>★</b>' : '') + ' [' + s.id + ']: ' + (hasContent ? '✅' : '❌');
            }).join('<br>')}<br>
            <small>Check console for logs</small>`;
    };
    window.updateSlideshowDebug();
    debugDiv.onclick = () => { debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none'; };
    
    // Render charts after a short delay
    setTimeout(() => {
        renderSlideCharts();
    }, 500);
}

function getDGASummaryForSlide() {
    const dgaSummary = document.getElementById('pres-dga-summary');
    if (!dgaSummary) return '<p class="text-white text-center col-span-3">No DGA data available</p>';
    
    const items = dgaSummary.querySelectorAll('div[class*="bg-"]');
    let html = '';
    let delay = 0;
    
    items.forEach((item, index) => {
        if (index < 6) {
            const label = item.querySelector('.text-xs')?.textContent || '';
            const value = item.querySelector('.text-2xl, .text-xl')?.textContent || '';
            
            if (label && value) {
                html += `
                    <div class="metric-card text-center" style="animation: fadeInScale 0.6s ease-out ${delay}s both">
                        <div class="metric-label mb-2">${label}</div>
                        <div class="metric-value">${value}</div>
                    </div>
                `;
                delay += 0.1;
            }
        }
    });
    
    return html || '<p class="text-white text-center col-span-3">No DGA data available</p>';
}

function renderSlideCharts() {
  try {
    // Helper to create a white-themed chart from an original chart
    function cloneChartToSlide(originalChartId, slideCanvasId, overrides) {
        const originalChart = Chart.getChart(originalChartId);
        if (!originalChart) return;
        const slideCanvas = document.getElementById(slideCanvasId);
        if (!slideCanvas) return;
        
        // Destroy existing chart on this canvas if any
        const existing = Chart.getChart(slideCanvas);
        if (existing) existing.destroy();
        
        const ctx = slideCanvas.getContext('2d');
        const config = {
            type: originalChart.config.type,
            data: JSON.parse(JSON.stringify(originalChart.config.data)),
            options: {
                ...JSON.parse(JSON.stringify(originalChart.config.options || {})),
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    ...(originalChart.config.options?.plugins || {}),
                    legend: {
                        labels: {
                            color: 'rgba(255,255,255,0.8)',
                            font: { size: 11, weight: '600' }
                        }
                    }
                },
                scales: originalChart.config.options?.scales ? {
                    x: {
                        ...(originalChart.config.options.scales.x || {}),
                        ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } },
                        grid: { color: 'rgba(255,255,255,0.08)' }
                    },
                    y: {
                        ...(originalChart.config.options.scales.y || {}),
                        ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } },
                        grid: { color: 'rgba(255,255,255,0.08)' }
                    }
                } : undefined,
                ...overrides
            }
        };
        new Chart(ctx, config);
    }
    
    // Clone sales trend chart
    cloneChartToSlide('sales-trend-chart', 'slide-sales-chart');
    cloneChartToSlide('sales-trend-chart', 'slide-sales-chart-2');
    
    // Clone varieties chart
    cloneChartToSlide('top-varieties-chart', 'slide-varieties-chart');
    cloneChartToSlide('top-varieties-chart', 'slide-varieties-chart-2');
    
    // FY Comparison chart - create from data
    const fySlideCanvas = document.getElementById('slide-fy-comparison-chart');
    if (fySlideCanvas && slideshowData.fyComparison) {
        const existingFY = Chart.getChart(fySlideCanvas);
        if (existingFY) existingFY.destroy();
        
        const fy1Data = slideshowData.fyComparison.fy1;
        const fy2Data = slideshowData.fyComparison.fy2;
        const months = ['Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des', 'Jan', 'Feb', 'Mar'];
        
        const fy1Sales = [];
        const fy2Sales = [];
        
        if (fy1Data.monthlyData && fy2Data.monthlyData) {
            const fy1Keys = Object.keys(fy1Data.monthlyData).sort();
            const fy2Keys = Object.keys(fy2Data.monthlyData).sort();
            
            fy1Keys.forEach(key => fy1Sales.push(fy1Data.monthlyData[key].sales || 0));
            fy2Keys.forEach(key => fy2Sales.push(fy2Data.monthlyData[key].sales || 0));
        }
        
        new Chart(fySlideCanvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'FY ' + fy1Data.label,
                        data: fy1Sales,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96,165,250,0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'FY ' + fy2Data.label,
                        data: fy2Sales,
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52,211,153,0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgba(255,255,255,0.8)',
                            font: { size: 11, weight: '600' }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } },
                        grid: { color: 'rgba(255,255,255,0.08)' }
                    },
                    y: {
                        ticks: {
                            color: 'rgba(255,255,255,0.7)',
                            font: { size: 10 },
                            callback: function(v) { return 'Rp ' + (v / 1000000).toFixed(0) + 'M'; }
                        },
                        grid: { color: 'rgba(255,255,255,0.08)' }
                    }
                }
            }
        });
    }
  } catch(e) { console.warn('Error rendering slide charts:', e); }
}

function showSlide(index) {
    if (index < 0 || index >= totalSlides) return;
    
    const container = document.getElementById('slides-container');
    if (!container) { console.error('[SLIDE] Container not found'); return; }
    const slides = container.querySelectorAll('.slide');
    console.log('[SLIDE] showSlide(' + index + '), found', slides.length, 'slides');
    
    slides.forEach((slide, i) => {
        if (i === index) {
            slide.classList.add('active');
            console.log('[SLIDE] Slide', i, 'SET ACTIVE, classes:', slide.className);
        } else {
            slide.classList.remove('active');
        }
    });
    
    // Verify active slide
    const activeSlide = container.querySelector('.slide.active');
    if (activeSlide) {
        console.log('[SLIDE] Active slide:', activeSlide.getAttribute('data-slide-id'), 'opacity:', window.getComputedStyle(activeSlide).opacity, 'zIndex:', window.getComputedStyle(activeSlide).zIndex);
    } else {
        console.error('[SLIDE] NO ACTIVE SLIDE FOUND!');
    }
    
    currentSlideIndex = index;
    updateSlideCounter();
    updateProgress();
    updateNavigationButtons();
    
    // Update debug panel
    if (window.updateSlideshowDebug) window.updateSlideshowDebug();
}

function nextSlide() {
    if (currentSlideIndex < totalSlides - 1) {
        showSlide(currentSlideIndex + 1);
    }
}

function prevSlide() {
    if (currentSlideIndex > 0) {
        showSlide(currentSlideIndex - 1);
    }
}

function firstSlide() {
    showSlide(0);
}

function lastSlide() {
    showSlide(totalSlides - 1);
}

function updateSlideCounter() {
    const counter = document.getElementById('slide-counter');
    if (counter) {
        counter.textContent = `${currentSlideIndex + 1} / ${totalSlides}`;
    }
}

function updateProgress() {
    const progress = document.getElementById('slide-progress');
    if (progress) {
        const percentage = ((currentSlideIndex + 1) / totalSlides) * 100;
        progress.style.width = `${percentage}%`;
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('slide-prev-btn');
    const nextBtn = document.getElementById('slide-next-btn');
    const firstBtn = document.getElementById('slide-first-btn');
    const lastBtn = document.getElementById('slide-last-btn');
    
    if (prevBtn) prevBtn.disabled = currentSlideIndex === 0;
    if (firstBtn) firstBtn.disabled = currentSlideIndex === 0;
    if (nextBtn) nextBtn.disabled = currentSlideIndex === totalSlides - 1;
    if (lastBtn) lastBtn.disabled = currentSlideIndex === totalSlides - 1;
    
    // Update thumbnails
    updateThumbnails();
}

function generateThumbnails() {
    const thumbnailNav = document.getElementById('thumbnail-nav');
    if (!thumbnailNav) return;
    
    thumbnailNav.innerHTML = '';
    
    selectedSlides.forEach((slide, index) => {
        const thumb = document.createElement('div');
        thumb.className = `thumbnail-item ${slide.bg} ${index === 0 ? 'active' : ''}`;
        thumb.onclick = () => showSlide(index);
        
        const number = document.createElement('div');
        number.className = 'thumbnail-number';
        number.textContent = index + 1;
        
        thumb.appendChild(number);
        thumbnailNav.appendChild(thumb);
    });
}

function updateThumbnails() {
    const thumbs = document.querySelectorAll('.thumbnail-item');
    thumbs.forEach((thumb, index) => {
        if (index === currentSlideIndex) {
            thumb.classList.add('active');
        } else {
            thumb.classList.remove('active');
        }
    });
}

function startPresentationTimer() {
    const timerDisplay = document.getElementById('slide-timer');
    if (!timerDisplay) return;
    
    timerDisplay.style.display = 'flex';
    startTime = Date.now();
    
    presentationTimer = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        document.getElementById('timer-display').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
}

function stopPresentationTimer() {
    if (presentationTimer) {
        clearInterval(presentationTimer);
        presentationTimer = null;
    }
    const timerDisplay = document.getElementById('slide-timer');
    if (timerDisplay) {
        timerDisplay.style.display = 'none';
    }
}

function startAutoPlay(intervalSeconds) {
    stopAutoPlay(); // Clear any existing interval
    
    autoPlayInterval = setInterval(() => {
        if (currentSlideIndex < totalSlides - 1) {
            nextSlide();
        } else {
            // Loop back to first slide or stop
            showSlide(0);
        }
    }, intervalSeconds * 1000);
}

function stopAutoPlay() {
    if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
    }
}

function exitSlideshow() {
    const slideshow = document.getElementById('presentation-slideshow');
    slideshow.classList.remove('active');
    document.body.style.overflow = '';
    currentSlideIndex = 0;
    
    // Clear timers
    if (autoHideTimer) {
        clearTimeout(autoHideTimer);
    }
    stopPresentationTimer();
    stopAutoPlay();
    
    // Hide thumbnails
    const thumbnailNav = document.getElementById('thumbnail-nav');
    if (thumbnailNav) {
        thumbnailNav.classList.remove('visible');
        thumbnailNav.style.display = 'none';
    }
}

function setupAutoHideControls() {
    const slideshow = document.getElementById('presentation-slideshow');
    const controls = document.getElementById('slide-controls');
    
    let hideTimeout;
    
    function showControls() {
        controls.classList.remove('hidden');
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
            controls.classList.add('hidden');
        }, 3000);
    }
    
    function hideControls() {
        controls.classList.add('hidden');
    }
    
    slideshow.addEventListener('mousemove', showControls);
    slideshow.addEventListener('click', showControls);
    controls.addEventListener('mouseenter', () => {
        clearTimeout(hideTimeout);
    });
    controls.addEventListener('mouseleave', () => {
        hideTimeout = setTimeout(() => {
            controls.classList.add('hidden');
        }, 2000);
    });
    
    // Show controls initially
    showControls();
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    const slideshow = document.getElementById('presentation-slideshow');
    if (!slideshow.classList.contains('active')) return;
    
    switch(e.key) {
        case 'ArrowRight':
        case ' ':
        case 'PageDown':
            e.preventDefault();
            nextSlide();
            break;
        case 'ArrowLeft':
        case 'PageUp':
            e.preventDefault();
            prevSlide();
            break;
        case 'Home':
            e.preventDefault();
            firstSlide();
            break;
        case 'End':
            e.preventDefault();
            lastSlide();
            break;
        case 'Escape':
            e.preventDefault();
            exitSlideshow();
            break;
    }
});

</script>

<!-- Slideshow Settings Modal -->
<div id="slideshow-settings-modal" class="slideshow-settings-modal">
    <div class="settings-content">
        <div class="settings-header">
            <h2 class="settings-title">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Pengaturan Slideshow
            </h2>
            <p class="text-white/70 text-sm">Pilih slide yang ingin ditampilkan dalam presentasi</p>
        </div>
        
        <div class="mb-6">
            <div class="flex gap-3 mb-4">
                <button onclick="selectAllSlides()" class="settings-btn settings-btn-secondary flex-1">
                    ✓ Pilih Semua
                </button>
                <button onclick="deselectAllSlides()" class="settings-btn settings-btn-secondary flex-1">
                    ✗ Hapus Semua
                </button>
            </div>
        </div>
        
        <div class="slide-checkbox-container" id="slide-checkbox-container">
            <!-- Checkboxes will be generated here -->
        </div>
        
        <div class="mb-6 p-4 bg-white/5 rounded-lg border border-white/10">
            <label class="text-white font-semibold mb-3 block flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Opsi Timer
            </label>
            <div class="flex items-center gap-4">
                <input type="checkbox" id="show-timer" class="w-5 h-5" checked>
                <label for="show-timer" class="text-white/80">Tampilkan timer presentasi</label>
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-white/5 rounded-lg border border-white/10">
            <label class="text-white font-semibold mb-3 block flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Opsi Navigasi
            </label>
            <div class="space-y-3">
                <div class="flex items-center gap-4">
                    <input type="checkbox" id="show-thumbnails" class="w-5 h-5" checked>
                    <label for="show-thumbnails" class="text-white/80">Tampilkan thumbnail navigasi</label>
                </div>
                <div class="flex items-center gap-4">
                    <input type="checkbox" id="auto-play" class="w-5 h-5">
                    <label for="auto-play" class="text-white/80">Auto-play (otomatis berpindah slide)</label>
                </div>
                <div class="ml-9" id="autoplay-interval-container" style="display: none;">
                    <label class="text-white/70 text-sm block mb-2">Interval (detik):</label>
                    <input type="number" id="autoplay-interval" value="5" min="3" max="60" class="w-32 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                </div>
            </div>
        </div>
        
        <div class="settings-actions">
            <button onclick="closeSettingsModal()" class="settings-btn settings-btn-secondary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Batal
            </button>
            <button onclick="startSlideshowWithSettings()" class="settings-btn settings-btn-primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Mulai Presentasi
            </button>
        </div>
    </div>
</div>

<!-- Slideshow Container (Hidden by default) -->
<div id="presentation-slideshow" class="presentation-slideshow">
    <div class="slide-progress" id="slide-progress"></div>
    
    <!-- Timer Display -->
    <div class="slide-timer" id="slide-timer" style="display: none;">
        <svg class="timer-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span id="timer-display">00:00</span>
    </div>
    
    <button class="exit-slideshow" onclick="exitSlideshow()">
        ✕ Exit Slideshow
    </button>
    
    <!-- Thumbnail Navigation -->
    <div class="thumbnail-nav" id="thumbnail-nav" style="display: none;">
        <!-- Thumbnails will be generated here -->
    </div>
    
    <div class="slide-container" id="slides-container">
        <!-- Slides will be generated here -->
    </div>
    
    <div class="slide-controls" id="slide-controls">
        <button class="slide-btn" id="slide-first-btn" onclick="firstSlide()" title="First Slide">
            ⏮️
        </button>
        <button class="slide-btn" id="slide-prev-btn" onclick="prevSlide()" title="Previous Slide">
            ◀️ Prev
        </button>
        <div class="slide-counter" id="slide-counter">1 / 1</div>
        <button class="slide-btn" id="slide-next-btn" onclick="nextSlide()" title="Next Slide">
            Next ▶️
        </button>
        <button class="slide-btn" id="slide-last-btn" onclick="lastSlide()" title="Last Slide">
            ⏭️
        </button>
    </div>
</div>

</body>
</html>